===== Config file =====
[printer]
kinematics = corexz
max_velocity = 400
max_accel = 1000
max_z_velocity = 200
max_z_accel = 1000
square_corner_velocity = 5.0

[stepper_x]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = X_STEP
dir_pin = X_DIR
enable_pin = !X_ENABLE
endstop_pin = tmc2209_stepper_x:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_y]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = Y_STEP
dir_pin = Y_DIR
enable_pin = !Y_ENABLE
endstop_pin = tmc2209_stepper_y:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_z]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z_STEP
dir_pin = Z_DIR
enable_pin = !Z_ENABLE
endstop_pin = probe:z_virtual_endstop
homing_speed = 15
second_homing_speed = 8
homing_retract_dist = 3.0
position_max = 310
position_min = -5

[stepper_z1]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z1_STEP
dir_pin = Z1_DIR
enable_pin = !Z1_ENABLE

[stepper_z2]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z2_STEP
dir_pin = Z2_DIR
enable_pin = !Z2_ENABLE

[stepper_z3]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z3_STEP
dir_pin = Z3_DIR
enable_pin = !Z3_ENABLE

[gcode_macro _USER_VARIABLES]
variable_extruder_enabled = True
gcode = 
variable_heaterbed_enabled = True
variable_probe_type_enabled = "vorontap"
variable_startprint_actions = "bed_soak", "extruder_preheating", "chamber_soak", "clean", "tilt_calib", "z_offset", "bedmesh", "extruder_heating", "purge", "clean", "primeline"
variable_purgeclean_servo_enabled = True
variable_purgeclean_servo_name = "purgeservo"
variable_status_leds_minidisplay_enabled = True
variable_status_leds_minidisplay_led_name = "btt_mini12864"
variable_bed_mesh_enabled = True
variable_sensorless_homing_enabled = True
variable_qgl_enabled = True
variable_verbose = True
variable_homing_travel_speed = 350
variable_travel_speed = 350
variable_z_drop_speed = 15
variable_brush_clean_speed = 100
variable_probe_dock_speed = 60
variable_homing_travel_accel = 3000
variable_tilting_travel_accel = 3000
variable_brush_clean_accel = 1500
variable_probe_dock_accel = 2000
variable_accel_to_decel_factor = 0.75
variable_zendstop_position = -1, -1
variable_force_homing_in_start_print = False
variable_homing_zhop = 5
variable_homing_first = "X"
variable_homing_backoff_distance_xy = -5, -5
variable_sensorless_current_factor = 75
variable_probe_dock_margin_xy = 0, 0
variable_safe_extruder_temp = 150
variable_prime_line_xy = 5, 2.5
variable_prime_line_direction = "X"
variable_prime_line_length = 40
variable_prime_line_purge_distance = 30
variable_prime_line_flowrate = 10
variable_park_position_xy = -1, -1
variable_park_lift_z = 50
variable_disable_motors_in_end_print = False
variable_turn_off_heaters_in_end_print = True
variable_min_bed_xy = 0, 0
variable_max_bed_xy = 9999, 9999
variable_probe_min_z_travel = 20
variable_probe_dock_location_xy = -1, -1
variable_probe_servo_angle_retracted = 0
variable_probe_servo_angle_deployed = 90
variable_probe_before_attach_position = "front"
variable_probe_after_attach_position = "front"
variable_probe_before_dock_position = "front"
variable_probe_after_dock_position = "left"
variable_probe_move_attach_length = 30
variable_probe_move_dock_length = 30
variable_autodock_on_probe_error = True
variable_tap_max_probing_temp = 150
variable_tap_deactivation_zhop = 5
variable_print_default_bed_temp = 105
variable_print_default_extruder_temp = 240
variable_print_default_chamber_temp = 0
variable_print_default_chamber_max_heating_time = 15
variable_print_default_soak = 8
variable_print_default_material = "XXX"
variable_material_parameters = {
	'PLA': {
	'pressure_advance': 0.0525,
	'retract_length': 0.75,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 0,
	'additional_z_offset': 0
	},
	'PET': {
	'pressure_advance': 0.0650,
	'retract_length': 1.4,
	'unretract_extra_length': 0,
	'retract_speed': 30,
	'unretract_speed': 20,
	'filter_speed': 0,
	'additional_z_offset': 0.020
	},
	'ABS': {
	'pressure_advance': 0.0480,
	'retract_length': 0.5,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 80,
	'additional_z_offset': 0
	}
	}
variable_ercf_unload_on_cancel_print = False
variable_ercf_unload_on_end_print = True
variable_ercf_reset_stats_on_start_print = False
variable_purge_and_brush_enabled = False
variable_force_homing_before_brush = False
variable_brush_over_y_axis = True
variable_brush_xyz = -1, -1, -1
variable_purge_bucket_xyz = -1, -1, -1
variable_purge_distance = 30
variable_purge_ooze_time = 10
variable_purgeclean_servo_angle_retracted = 0
variable_purgeclean_servo_angle_deployed = 90
variable_light_intensity_start_print = 100
variable_light_intensity_printing = 30
variable_light_intensity_end_print = 0
variable_fix_heaters_temperature_settle = False
variable_resonnance_test_point_xy = -1, -1
variable_resonnance_test_z_clearance = 50
variable_status_leds_colors = {
	'logo': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'nozzle': {
	'heating': {'r': 0.8, 'g': 0.35, 'b': 0.0, 'w':0.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'standby': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'caselight': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'minidisplay': {
	'on': {'r': 0.0, 'g': 0.2, 'b': 0.4, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'error': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'thermal': {
	'hot': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cold': {'r': 0.3, 'g': 0.0, 'b': 0.3, 'w': 0.0}
	}
	}
variable_x_driver = "TMC2209"
variable_y_driver = "TMC2209"
variable_z_driver = "TMC2209"
variable_e_driver = "TMC2209"

[extruder]
rotation_distance = 22.6789511
gear_ratio = 50:10
microsteps = 64
full_steps_per_rotation = 200
nozzle_diameter = 0.400
filament_diameter = 1.75
max_extrude_only_distance = 110
max_extrude_cross_section = 5
sensor_type = ATC Semitec 104GT-2
min_temp = 10
max_temp = 270
max_power = 1.0
min_extrude_temp = 172
pressure_advance = 0.0475
pressure_advance_smooth_time = 0.040
step_pin = toolhead:E_STEP
dir_pin = toolhead:E_DIR
enable_pin = !toolhead:E_ENABLE
heater_pin = toolhead:E_HEATER
sensor_pin = toolhead:E_TEMPERATURE

[gcode_macro M109]
rename_existing = M109.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={S}
	{% else %}
	M109.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[heater_bed]
heater_pin = BED_HEATER
sensor_type = NTC 100K MGB18-104F39050L32
sensor_pin = BED_TEMPERATURE
max_power = 1
min_temp = 0
max_temp = 120

[gcode_macro M190]
rename_existing = M190.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={S}
	{% else %}
	M190.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[gcode_macro ACTIVATE_PROBE]
description = Put the machine in a state being able to probe
variable_temperature = 0
gcode = 
	{% set LOCK = params.LOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_max_probing_temp = printer["gcode_macro _USER_VARIABLES"].tap_max_probing_temp|float %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if LOCK %}
	_ATTACH_PROBE_LOCK
	{% else %}
	_ATTACH_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	SAVE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	
	{% set ACTUAL_TEMP = printer.extruder.temperature %}
	{% set TARGET_TEMP = printer.extruder.target %}
	
	SET_GCODE_VARIABLE MACRO=ACTIVATE_PROBE VARIABLE=temperature VALUE={TARGET_TEMP}
	
	{% if TARGET_TEMP > tap_max_probing_temp %}
	{ action_respond_info('Extruder temperature target of %.1fC is too high for TAP probing, lowering to %.1fC' % (TARGET_TEMP, tap_max_probing_temp)) }
	M106 S255
	M109 S{tap_max_probing_temp}
	M106 S0
	{% else %}
	
	{% if ACTUAL_TEMP > tap_max_probing_temp + 3 %}
	M106 S255
	TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={tap_max_probing_temp}
	M106 S0
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro DEACTIVATE_PROBE]
description = Revert the machine to a normal state after probing
gcode = 
	{% set UNLOCK = params.UNLOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_deactivation_zhop = printer["gcode_macro _USER_VARIABLES"].tap_deactivation_zhop %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if UNLOCK %}
	_DOCK_PROBE_UNLOCK
	{% else %}
	_DOCK_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	
	{% set z_safe = printer.toolhead.position.z + tap_deactivation_zhop %}
	{% if z_safe > printer.toolhead.axis_maximum.z %}
	{% set z_safe = printer.toolhead.axis_maximum.z %}
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	
	{% set old_target_temperature = printer["gcode_macro ACTIVATE_PROBE"].temperature %}
	M109 S{old_target_temperature}
	
	RESTORE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	{% endif %}

[probe]
pin = ^toolhead:PROBE_INPUT
x_offset = 0
y_offset = 0
z_offset = 0
speed = 5
lift_speed = 10
samples = 3
samples_result = median
sample_retract_dist = 1.0
samples_tolerance = 0.005
samples_tolerance_retries = 3

[heater_fan hotend_fan]
pin = toolhead:E_FAN
max_power = 1.0
kick_start_time = 0.100
heater = extruder
heater_temp = 50.0

[fan]
pin = toolhead:PART_FAN
kick_start_time = 0.100
cycle_time = 0.010

[gcode_macro _SERVO_DEPLOY]
gcode = 
	{% set item = params.ITEM|string|lower %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_servo_enabled = printer["gcode_macro _USER_VARIABLES"].probe_servo_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% if item == "probe" %}
	{% if verbose %}
	RESPOND MSG="Deploying probe dock using the servo"
	{% endif %}
	
	{% if not probe_servo_enabled %}
	{ action_raise_error("No servo available for probe. Please include one in your config!") }
	{% endif %}
	
	{% set probe_servo_name = printer["gcode_macro _USER_VARIABLES"].probe_servo_name %}
	{% set probe_servo_angle_deployed = printer["gcode_macro _USER_VARIABLES"].probe_servo_angle_deployed %}
	SET_SERVO SERVO={probe_servo_name} ANGLE={probe_servo_angle_deployed}
	G4 P500
	
	{% elif item == "purge" or item == "clean" %}
	{% if verbose %}
	RESPOND MSG="Deploying purge bucket and brush using the servo"
	{% endif %}
	
	{% if not purgeclean_servo_enabled %}
	{ action_raise_error("No servo available for purge or clean. Please include one in your config!") }
	{% endif %}
	
	{% set purgeclean_servo_name = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_name %}
	{% set purgeclean_servo_angle_deployed = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_angle_deployed %}
	SET_SERVO SERVO={purgeclean_servo_name} ANGLE={purgeclean_servo_angle_deployed}
	G4 P500
	
	{% else %}
	{ action_raise_error("Servo ITEM must be specified!") }
	{% endif %}

[gcode_macro _SERVO_RETRACT]
gcode = 
	{% set item = params.ITEM|string|lower %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_servo_enabled = printer["gcode_macro _USER_VARIABLES"].probe_servo_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% if item == "probe" %}
	{% if verbose %}
	RESPOND MSG="Rettracting probe dock using the servo"
	{% endif %}
	
	{% if not probe_servo_enabled %}
	{ action_raise_error("No servo available for probe. Please include one in your config!") }
	{% endif %}
	
	{% set probe_servo_name = printer["gcode_macro _USER_VARIABLES"].probe_servo_name %}
	{% set probe_servo_angle_retracted = printer["gcode_macro _USER_VARIABLES"].probe_servo_angle_retracted %}
	SET_SERVO SERVO={probe_servo_name} ANGLE={probe_servo_angle_retracted}
	G4 P500
	
	{% elif item == "purge" or item == "clean" %}
	{% if verbose %}
	RESPOND MSG="Rettracting purge bucket and brush using the servo"
	{% endif %}
	
	{% if not purgeclean_servo_enabled %}
	{ action_raise_error("No servo available for purge or clean. Please include one in your config!") }
	{% endif %}
	
	{% set purgeclean_servo_name = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_name %}
	{% set purgeclean_servo_angle_retracted = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_angle_retracted %}
	SET_SERVO SERVO={purgeclean_servo_name} ANGLE={purgeclean_servo_angle_retracted}
	G4 P500
	
	{% else %}
	{ action_raise_error("Servo ITEM must be specified!") }
	{% endif %}

[servo purgeservo]
pin = SERVO_PIN
maximum_servo_angle = 90
minimum_pulse_width = 0.0011
maximum_pulse_width = 0.0021

[gcode_macro _SET_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = params.LED|string %}
	{% set idx = (params.IDX|string).split(',') %}
	{% set transmit_last = params.TRANSMIT|default(1) %}
	
	{% for led_index in idx %}
	{% set transmit=transmit_last if loop.last else 0 %}
	SET_LED LED={led} RED={red} GREEN={green} BLUE={blue} WHITE={white} INDEX={led_index} TRANSMIT={transmit}
	{% endfor %}

[gcode_macro _SET_LEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_idx"] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_ALLLEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	SET_LED LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w}  TRANSMIT={transmit}

[gcode_macro _SET_LOGO_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_NOZZLE_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro SET_LOGO_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="logo" COLOR="off" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_ON]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="on" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="off" TRANSMIT={transmit}

[gcode_macro STATUS_LEDS]
gcode = 
	{% set color = params.COLOR|default('off')|lower %}
	
	{% set status_color = {
	'ready': {
	'logo': 'standby',
	'nozzle': 'standby',
	'caselight': 'standby',
	'minidisplay': 'on'
	},
	'busy': {
	'logo': 'busy',
	'nozzle': 'on',
	'caselight': 'busy',
	'minidisplay': 'on'
	},
	'heating': {
	'logo': 'heating',
	'nozzle': 'heating',
	'caselight': 'heating',
	'minidisplay': 'on'
	},
	'leveling': {
	'logo': 'leveling',
	'nozzle': 'on',
	'caselight': 'leveling',
	'minidisplay': 'on'
	},
	'homing': {
	'logo': 'homing',
	'nozzle': 'on',
	'caselight': 'homing',
	'minidisplay': 'on'
	},
	'cleaning': {
	'logo': 'cleaning',
	'nozzle': 'on',
	'caselight': 'cleaning',
	'minidisplay': 'on'
	},
	'meshing': {
	'logo': 'meshing',
	'nozzle': 'on',
	'caselight': 'meshing',
	'minidisplay': 'on'
	},
	'calibrating_z': {
	'logo': 'calibrating_z',
	'nozzle': 'on',
	'caselight': 'calibrating_z',
	'minidisplay': 'on'
	},
	'printing': {
	'logo': 'printing',
	'nozzle': 'on',
	'caselight': 'printing',
	'minidisplay': 'on'
	},
	'off': {
	'logo': 'off',
	'nozzle': 'off',
	'caselight': 'off',
	'minidisplay': 'off'
	},
	'on': {
	'logo': 'on',
	'nozzle': 'on',
	'caselight': 'on',
	'minidisplay': 'on'
	},
	'error': {
	'logo': 'error',
	'nozzle': 'error',
	'caselight': 'error',
	'minidisplay': 'error'
	}
	} %}
	
	{% if not (color in status_color) %}
	{ action_raise_error("COLOR is not valid!") }
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	_SET_LEDS_BY_NAME LEDS="logo" COLOR={status_color[color].logo} TRANSMIT=0
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR={status_color[color].nozzle} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_caselight_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="caselight" COLOR={status_color[color].caselight} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_minidisplay_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="minidisplay" COLOR={status_color[color].minidisplay} TRANSMIT=1
	{% endif %}

[display]
lcd_type = uc1701
cs_pin = EXP1_8
a0_pin = EXP1_7
rst_pin = EXP1_6
encoder_pins = ^EXP2_6, ^EXP2_8
click_pin = ^!EXP1_9
contrast = 63
spi_software_miso_pin = EXP2_10
spi_software_mosi_pin = EXP2_5
spi_software_sclk_pin = EXP2_9

[output_pin beeper]
pin = EXP1_10

[neopixel btt_mini12864]
pin = EXP1_5
chain_count = 3
initial_red = 0.1
initial_green = 0.5
initial_blue = 0.0
color_order = RGB

[delayed_gcode setdisplayneopixel]
initial_duration = 1
gcode = 
	SET_LED LED=btt_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3

[temperature_sensor RaspberryPi]
sensor_type = temperature_host

[temperature_sensor mcu]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 90

[temperature_sensor toolhead_mcu]
sensor_type = temperature_mcu
sensor_mcu = toolhead
min_temp = 0
max_temp = 100

[adxl345]
cs_pin = toolhead:ADXL_CS
spi_software_sclk_pin = toolhead:ADXL_SCLK
spi_software_mosi_pin = toolhead:ADXL_MOSI
spi_software_miso_pin = toolhead:ADXL_MISO
axes_map = x,y,z

[resonance_tester]
accel_chip = adxl345
probe_points = 
	-1,-1,-1

[gcode_macro TEST_RESONANCES]
rename_existing = BASE_TEST_RESONANCES
description = Runs input shaper test at the center of the bed
gcode = 
	{% set Tx, Ty = printer["gcode_macro _USER_VARIABLES"].resonnance_test_point_xy|map('float') %}
	{% set Tz = printer["gcode_macro _USER_VARIABLES"].resonnance_test_z_clearance|float %}
	
	{% if Tx == -1 and Ty == -1 %}
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	BASE_TEST_RESONANCES POINT={max_x / 2},{max_y / 2},{Tz} {rawparams}
	{% else %}
	BASE_TEST_RESONANCES POINT={Tx},{Ty},{Tz} {rawparams}
	{% endif %}

[gcode_macro AXES_SHAPER_CALIBRATION]
description = Run standard input shaper test for all axes
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.3)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=X FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=Y FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=SHAPER

[gcode_macro BELTS_SHAPER_CALIBRATION]
description = Run custom demi-axe test to analyze belts on CoreXY printers
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.33)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=1,1 OUTPUT=raw_data NAME=b FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=a FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=BELTS

[gcode_macro EXCITATE_AXIS_AT_FREQ]
description = Maintain a specified input shaper excitating frequency for some time to diagnose vibrations
gcode = 
	{% set FREQUENCY = params.FREQUENCY|default(25)|int %}
	{% set TIME = params.TIME|default(10)|int %}
	{% set AXIS = params.AXIS|default("x")|string|lower %}
	
	TEST_RESONANCES OUTPUT=raw_data AXIS={AXIS} FREQ_START={FREQUENCY-1} FREQ_END={FREQUENCY+1} HZ_PER_SEC={1/(TIME/3)}
	M400

[gcode_macro VIBRATIONS_CALIBRATION]
gcode = 
	
	
	
	{% set size = params.SIZE|default(60)|int %}
	{% set direction = params.DIRECTION|default('XY') %}
	{% set z_height = params.Z_HEIGHT|default(20)|int %}
	{% set verbose = params.VERBOSE|default(true) %}
	
	{% set min_speed = params.MIN_SPEED|default(20)|int * 60 %}
	{% set max_speed = params.MAX_SPEED|default(200)|int * 60 %}
	{% set speed_increment = params.SPEED_INCREMENT|default(2)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	
	{% set accel_chip = params.ACCEL_CHIP|default("adxl345") %}
	
	
	
	
	{% set mid_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set mid_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% set direction_factor = {
	'XY'  : {
	'start' : {'x': -0.5, 'y': -0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': -0.5, 'y': -0.5, 'z': 0.0 }
	}
	},
	'AB' : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': 0.0, 'y': 0.0, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	},
	'ABXY' : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'B'  : {
	'start' : {'x': 0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'A'  : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'X'  : {
	'start' : {'x': -0.5, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': 0.0, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.0, 'z': 0.0 }
	}
	},
	'Y'  : {
	'start' : {'x': 0.0, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.0, 'y': 0.5, 'z': 0.0 }
	}
	},
	'Z'  : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': 0.0, 'z': 1.0 },
	'1' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	}
	}
	%}
	
	
	
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	{% if (size / (max_speed / 60)) < 0.25 %}
	{ action_raise_error("SIZE is too small for this MAX_SPEED. Increase SIZE or decrease MAX_SPEED!") }
	{% endif %}
	
	{% if not (direction in direction_factor) %}
	{ action_raise_error("DIRECTION is not valid. Only XY, AB, ABXY, A, B, X, Y or Z is allowed!") }
	{% endif %}
	
	{action_respond_info("")}
	{action_respond_info("Starting speed and vibration calibration")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION
	
	G90
	
	
	G1 Z{z_height}
	G1 X{mid_x + (size * direction_factor[direction].start.x) } Y{mid_y + (size * direction_factor[direction].start.y)} F{feedrate_travel}
	
	
	{% for curr_speed in range(min_speed, max_speed + speed_increment) %}
	{% if (curr_speed - min_speed) % speed_increment == 0 %}
	{% if verbose %}
	RESPOND MSG="Current speed: {(curr_speed / 60)|int} mm/s"
	{% endif %}
	
	ACCELEROMETER_MEASURE CHIP={accel_chip}
	{% for key, factor in direction_factor[direction].move_factors|dictsort %}
	G1 X{mid_x + (size * factor.x) } Y{mid_y + (size * factor.y)} Z{z_height + (size * factor.z)} F{curr_speed}
	{% endfor %}
	ACCELEROMETER_MEASURE CHIP={accel_chip} NAME=sp{(curr_speed / 60)|int}n1
	
	G4 P300
	M400
	{% endif %}
	{% endfor %}
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS="VIBRATIONS {direction}"
	
	RESTORE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = _BASE_BED_MESH_CALIBRATE
description = Perform Mesh Bed Leveling with klicky automount
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if verbose %}
	{ action_respond_info("Bed Mesh Calibrate") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	_BASE_BED_MESH_CALIBRATE  {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	DEACTIVATE_PROBE

[gcode_macro _ADAPTIVE_MESH_VARIABLES]
variable_ready = False
variable_do_mesh = False
variable_do_nominal = False
variable_mesh_min = 0,0
variable_mesh_max = 0,0
variable_mesh_center = 0,0
variable_probe_count = 0,0
variable_rri = 0
variable_algo = "bicubic"
gcode = 

[gcode_macro COMPUTE_MESH_PARAMETERS]
description = Compute the mesh parameters and store them for later use
gcode = 
	
	{% set xMinConf, yMinConf = printer["configfile"].config["bed_mesh"]["mesh_min"].split(',')|map('trim')|map('int') %}
	{% set xMaxConf, yMaxConf = printer["configfile"].config["bed_mesh"]["mesh_max"].split(',')|map('trim')|map('int') %}
	{% set xProbeCntConf, yProbeCntConf = printer["configfile"].config["bed_mesh"]["probe_count"].split(',')|map('trim')|map('int') %}
	{% set algo = printer["configfile"].config["bed_mesh"]["algorithm"]|lower %}
	{% set xMeshPPS, yMeshPPS = (printer["configfile"].config["bed_mesh"]["mesh_pps"]|default('2,2')).split(',')|map('trim')|map('int') %}
	
	{% set margin = params.MARGIN|default(5)|int %}
	{% set force_mesh = params.FORCE_MESH|default(False) %}
	
	
	
	
	{% if params.SIZE is defined and params.SIZE != "0_0_0_0" %}
	RESPOND MSG="Got a SIZE parameter for the adaptive bed mesh"
	{% set xMinSpec, yMinSpec, xMaxSpec, yMaxSpec = params.SIZE.split('_')|map('trim')|map('int') %}
	
	{% elif printer.exclude_object.objects %}
	
	
	RESPOND MSG="No SIZE parameter, using the [exclude_object] tags for the adaptive bed mesh"
	{% set eo_points = printer.exclude_object.objects|map(attribute='polygon')|sum(start=[]) %}
	{% set xMinSpec = eo_points|map(attribute=0)|min %}
	{% set yMinSpec = eo_points|map(attribute=1)|min %}
	{% set xMaxSpec = eo_points|map(attribute=0)|max %}
	{% set yMaxSpec = eo_points|map(attribute=1)|max %}
	
	{% else %}
	
	
	RESPOND MSG="No info about the first layer coordinates, doing a nominal bed mesh instead of adaptive"
	{% endif %}
	
	
	
	
	{% if xMinSpec and yMinSpec and xMaxSpec and yMaxSpec %}
	
	
	
	
	{% set xMin = [xMinConf, (xMinSpec - margin)]|max %}
	{% set xMax = [xMaxConf, (xMaxSpec + margin)]|min %}
	{% set yMin = [yMinConf, (yMinSpec - margin)]|max %}
	{% set yMax = [yMaxConf, (yMaxSpec + margin)]|min %}
	
	
	
	
	{% set xProbeCnt = ((xMax - xMin) * xProbeCntConf / (xMaxConf - xMinConf))|round(0, 'ceil')|int %}
	{% set yProbeCnt = ((yMax - yMin) * yProbeCntConf / (yMaxConf - yMinConf))|round(0, 'ceil')|int %}
	
	
	
	
	
	
	
	
	{% if xProbeCnt < 3 and yProbeCnt < 3 %}
	{% if force_mesh %}
	RESPOND MSG="Bed mesh forced (small part detected): meshing 3x3..."
	{% set xProbeCnt = 3 %}
	{% set yProbeCnt = 3 %}
	{% set rRefIndex = 4 %}
	{% set algo = "lagrange" %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% else %}
	RESPOND MSG="Computed mesh parameters: none, bed mesh not needed for very small parts"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={False}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	{% else %}
	{% set xProbeCnt = [3, xProbeCnt]|max %}
	{% set yProbeCnt = [3, yProbeCnt]|max %}
	
	
	
	{% if xProbeCnt % 2 == 0 %}
	{% set xProbeCnt = xProbeCnt + 1 %}
	{% endif %}
	{% if yProbeCnt % 2 == 0 %}
	{% set yProbeCnt = yProbeCnt + 1 %}
	{% endif %}
	
	
	{% if xMeshPPS != 0 or yMeshPPS != 0 %}
	{% set probeCntMin = [xProbeCnt, yProbeCnt]|min %}
	{% set probeCntMax = [xProbeCnt, yProbeCnt]|max %}
	{% if algo == "lagrange" and probeCntMax > 6 %}
	
	{% set algo = "bicubic" %}
	{% endif %}
	{% if algo == "bicubic" and probeCntMin < 4 %}
	{% if probeCntMax > 6 %}
	
	{% if xProbeCnt > yProbeCnt %}
	{% set yProbeCnt = 5 %}
	{% else %}
	{% set xProbeCnt = 5 %}
	{% endif %}
	{% else %}
	
	{% set algo = "lagrange" %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	{% set rRefIndex = (((xProbeCnt * yProbeCnt) - 1) / 2)|int %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	
	
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% endif %}
	{% else %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={True}
	
	{% set xCenter = xMinConf + ((xMaxConf - xMinConf) / 2) %}
	{% set yCenter = yMinConf + ((yMaxConf - yMinConf) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={True}

[gcode_macro ADAPTIVE_BED_MESH]
description = Perform a bed mesh, but only where and when it's needed
gcode = 
	{% set ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	
	{% if ready %}
	_DO_ADAPTIVE_MESH
	
	
	
	{% else %}
	RESPOND MSG="Adaptive bed mesh: parameters not already computed, automatically calling the COMPUTE_MESH_PARAMETERS macro prior to the mesh"
	COMPUTE_MESH_PARAMETERS {rawparams}
	M400
	_DO_ADAPTIVE_MESH
	{% endif %}

[gcode_macro _DO_ADAPTIVE_MESH]
gcode = 
	
	{% set do_mesh = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_mesh %}
	{% set do_nominal = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_nominal %}
	{% set mesh_min = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_min %}
	{% set mesh_max = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_max %}
	{% set probe_count = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].probe_count %}
	{% set rRefIndex = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].rri %}
	{% set algo = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].algo %}
	
	
	
	
	{% if do_mesh %}
	
	{% if do_nominal %}
	RESPOND MSG="Adaptive bed mesh: nominal bed mesh"
	BED_MESH_CALIBRATE
	{% else %}
	{% if printer["configfile"].config["bed_mesh"]["relative_reference_index"] is defined %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}
	{% endif %}
	{% endif %}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: no mesh to be done"
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={False}

[bed_mesh]
speed = 350
horizontal_move_z = 12
mesh_min = 25, 25
mesh_max = 325, 325
probe_count = 9, 9
fade_start = 0.6
fade_end = 10.0
algorithm = bicubic
relative_reference_index = 40

[tmc2209 stepper_x]
diag_pin = ^X_STOP
driver_sgthrs = 255
uart_pin = X_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_y]
diag_pin = ^Y_STOP
driver_sgthrs = 255
uart_pin = Y_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[input_shaper]
shaper_freq_x = 56.4
shaper_type_x = zv
shaper_freq_y = 38.4
shaper_type_y = mzv

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing = _BASE_QUAD_GANTRY_LEVEL
description = Conform a moving, twistable gantry to the shape of a stationary bed with klicky automount
gcode = 
	{% set tilting_travel_accel = printer["gcode_macro _USER_VARIABLES"].tilting_travel_accel %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if verbose %}
	{ action_respond_info("Quad gantry leveling") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{tilting_travel_accel}
	
	_BASE_QUAD_GANTRY_LEVEL {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	DEACTIVATE_PROBE

[gcode_macro _TILT_CALIBRATE]
description = Do a QGL, Z_tilt, etc... depending of the machine configuration
gcode = 
	{% set FORCE_OPERATION = params.FORCE|default(true) %}
	{% set conf_QGL = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set conf_ztilt = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="LEVELING"
	{% endif %}
	
	{% if conf_QGL %}
	{% if printer.quad_gantry_level.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="QGL..."
	{% endif %}
	QUAD_GANTRY_LEVEL
	{% endif %}
	{% elif conf_ztilt %}
	{% if printer.z_tilt.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="Z tilt adjust..."
	{% endif %}
	Z_TILT_ADJUST
	{% endif %}
	{% else %}
	{% if verbose %}
	RESPOND MSG="No tilt calibration needed on this machine. Continuing..."
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[quad_gantry_level]
gantry_corners = 
	-60,-10
	410,420
points = 
	50,25
	50,275
	300,275
	300,25
speed = 350
horizontal_move_z = 12
retries = 5
retry_tolerance = 0.0075
max_adjust = 10

[virtual_sdcard]
path = ~/printer_data/gcodes
on_error_gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	STATUS_LEDS COLOR="ERROR"
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	_PROBE_ON_ERROR_ACTION
	{% endif %}

[exclude_object]

[idle_timeout]
timeout = 1800

[pause_resume]

[display_status]

[respond]

[force_move]
enable_force_move = True

[gcode_arcs]
resolution = 0.1

[gcode_macro CANCEL_PRINT]
rename_existing = BASE_CANCEL_PRINT
description = Cancel the print, retract 10mm of filament and park
gcode = 
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload_on_cancel_print = printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_cancel_print %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload_on_cancel_print %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	SDCARD_RESET_FILE
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_OFF
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}
	
	BASE_CANCEL_PRINT

[gcode_macro END_PRINT]
description = Stop the print and filter the atmosphere for 10min before shuting down
gcode = 
	{% set disable_motors_in_end_print = printer["gcode_macro _USER_VARIABLES"].disable_motors_in_end_print %}
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set light_intensity_end_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_end_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload = params.ERCF_UNLOAD_AT_END|default(printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_end_print)|int %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G92 E0
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if disable_motors_in_end_print %}
	M84
	{% endif %}
	
	
	
	
	{% if filter_enabled %}
	{% set FILTER_TIME = params.FILTER_TIME|default(600)|int %}
	START_FILTER SPEED=1
	UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED DURATION={FILTER_TIME}
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_end_print}
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}

[gcode_macro PARK]
description = Park the toolhead at the back and retract some filament if the nozzle is hot
gcode = 
	{% set E = params.E|default(1.7)|float %}
	
	{% set Px, Py = printer["gcode_macro _USER_VARIABLES"].park_position_xy|map('float') %}
	{% set park_lift_z = printer["gcode_macro _USER_VARIABLES"].park_lift_z %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	
	{% set z_safe = act_z + park_lift_z %}
	{% if z_safe > max_z %}
	{% set z_safe = max_z %}
	{% endif %}
	
	
	{% if printer.extruder.temperature > 185 and firmware_retraction_enabled %}
	G10
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	G0 X{Px} Y{Py} F{St}

[gcode_macro PAUSE]
rename_existing = BASE_PAUSE
description = Pause the print and park
gcode = 
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	
	{% if printer.pause_resume.is_paused %}
	RESPOND MSG="Print is already paused"
	{% else %}
	SAVE_GCODE_STATE NAME=PAUSE_state
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	BASE_PAUSE
	PARK
	{% endif %}

[gcode_macro RESUME]
rename_existing = BASE_RESUME
description = Resume the print after an optional unretract
gcode = 
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	
	{% if not printer.pause_resume.is_paused %}
	RESPOND MSG="Print is not paused. Resume ignored"
	{% else %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={St}
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	BASE_RESUME
	{% endif %}

[gcode_macro START_PRINT]
description = Machine heatup procedure before starting a print
variable_bed_temp = 0
variable_extruder_temp = 0
variable_z_adjust = 0
variable_soak = 0
variable_chamber_temp = 0
variable_chamber_maxtime = 0
variable_initial_tool = 0
variable_material = "XXX"
variable_fl_size = "0_0_0_0"
gcode = 
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_ADJUST = params.Z_ADJUST|default(0)|float %}
	{% set SOAK = params.SOAK|default(printer["gcode_macro _USER_VARIABLES"].print_default_soak)|int %}
	{% set CHAMBER_TEMP = params.CHAMBER|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_temp)|int %}
	{% set CHAMBER_MAXTIME = params.CHAMBER_MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	{% set INITIAL_TOOL = params.INITIAL_TOOL|default(0)|int %}
	{% set MATERIAL = params.MATERIAL|default(printer["gcode_macro _USER_VARIABLES"].print_default_material)|string %}
	{% set FL_SIZE = params.SIZE|default("0_0_0_0")|string %}
	
	
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=bed_temp VALUE={BED_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=extruder_temp VALUE={EXTRUDER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=soak VALUE={SOAK}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_temp VALUE={CHAMBER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_maxtime VALUE={CHAMBER_MAXTIME}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=initial_tool VALUE={INITIAL_TOOL}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=material VALUE='"{MATERIAL}"'
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=fl_size VALUE='"{FL_SIZE}"'
	
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_reset_stats_on_start_print = printer["gcode_macro _USER_VARIABLES"].ercf_reset_stats_on_start_print %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% if MATERIAL not in printer["gcode_macro _USER_VARIABLES"].material_parameters %}
	RESPOND MSG="Material '{MATERIAL}' is unknown!"
	{ action_raise_error("Add this new material to your material_parameters variable!") }
	{% else %}
	RESPOND MSG="Material '{MATERIAL}' is used"
	{% set material = printer["gcode_macro _USER_VARIABLES"].material_parameters[MATERIAL] %}
	{% endif %}
	
	
	
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="BUSY"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if ercf_reset_stats_on_start_print %}
	ERCF_RESET_STATS
	{% endif %}
	{% endif %}
	{% endif %}
	
	SET_GCODE_OFFSET Z=0
	M221 S100
	M220 S100
	G90
	M83
	
	
	{% if firmware_retraction_enabled %}
	SET_RETRACTION RETRACT_LENGTH={material.retract_length} RETRACT_SPEED={material.retract_speed} UNRETRACT_EXTRA_LENGTH={material.unretract_extra_length} UNRETRACT_SPEED={material.unretract_speed}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={material.pressure_advance}
	
	
	{% if force_homing_in_start_print %}
	G28
	{% else %}
	_CG28
	{% endif %}
	
	
	
	{% set sp_actions = printer["gcode_macro _USER_VARIABLES"].startprint_actions %}
	{% for action in sp_actions %}
	{% if action == "bed_soak" %}
	_MODULE_HEATSOAK_BED
	{% elif action == "chamber_soak" %}
	_MODULE_HEATSOAK_CHAMBER
	{% elif action == "tilt_calib" %}
	_MODULE_TILTING
	{% elif action == "extruder_heating" %}
	_MODULE_EXTRUDER_HEATING
	{% elif action == "purge" %}
	_MODULE_PURGE
	{% elif action == "clean" %}
	_MODULE_CLEAN
	{% elif action == "z_offset" %}
	_MODULE_Z_CALIB
	{% elif action == "bedmesh" %}
	_MODULE_BED_MESH
	{% elif action == "primeline" %}
	_MODULE_PRIMELINE
	{% elif action == "extruder_preheating" %}
	_MODULE_EXTRUDER_PREHEATING
	{% elif action == "custom1" %}
	_MODULE_CUSTOM1
	{% elif action == "custom2" %}
	_MODULE_CUSTOM2
	{% elif action == "custom3" %}
	_MODULE_CUSTOM3
	{% else %}
	{ action_raise_error("Unknown module called in START_PRINT! Please verify your startprint_actions variable override!") }
	{% endif %}
	{% endfor %}
	
	
	
	SET_GCODE_OFFSET Z_ADJUST={Z_ADJUST} MOVE=1
	
	
	SET_GCODE_OFFSET Z_ADJUST={material.additional_z_offset} MOVE=1
	{% if filter_enabled %}
	START_FILTER SPEED={material.filter_speed / 100}
	{% endif %}
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="PRINTING"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Start printing !"
	{% endif %}
	
	G92 E0.0

[gcode_macro _MODULE_PRIMELINE]
gcode = 
	PRIMELINE

[gcode_macro _MODULE_HEATSOAK_BED]
gcode = 
	
	
	
	
	
	{% set BED_TEMP = printer["gcode_macro START_PRINT"].bed_temp %}
	{% set SOAK = printer["gcode_macro START_PRINT"].soak %}
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if printer.heater_bed.target < (BED_TEMP - 8) %}
	
	
	{% if (CHAMBER_TEMP > 0) and filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	{% if SOAK > 0 %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME={SOAK}
	{% else %}
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME=0
	{% endif %}

[gcode_macro _MODULE_HEATSOAK_CHAMBER]
gcode = 
	
	
	
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	{% set CHAMBER_MAXTIME = printer["gcode_macro START_PRINT"].chamber_maxtime %}
	
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if chamber_sensor_enabled %}
	{% if CHAMBER_TEMP > 0 %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	
	{% if CURRENT_TEMP <= CHAMBER_TEMP %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	
	
	{% if filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	HEATSOAK_CHAMBER TEMP={CHAMBER_TEMP} MAXTIME={CHAMBER_MAXTIME}
	
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_TILTING]
gcode = 
	
	
	
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	_TILT_CALIBRATE FORCE={force_homing_in_start_print}

[gcode_macro _MODULE_EXTRUDER_HEATING]
gcode = 
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	{% set INITIAL_TOOL = printer["gcode_macro START_PRINT"].initial_tool %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder heating to print temperature..."
	{% endif %}
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET
	{% if not purge_and_brush_enabled %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	M109 S{EXTRUDER_TEMP}
	
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	ERCF_CHANGE_TOOL STANDALONE=1 TOOL={INITIAL_TOOL}
	_ERCF_ERROR_CHECK
	{% endif %}
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder temperature OK"
	{% endif %}

[gcode_macro _MODULE_PURGE]
gcode = 
	
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	
	{% if purge_and_brush_enabled %}
	PURGE TEMP={EXTRUDER_TEMP}
	{% endif %}

[gcode_macro _MODULE_CLEAN]
gcode = 
	
	
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set force_homing_before_brush = printer["gcode_macro _USER_VARIABLES"].force_homing_before_brush %}
	
	{% if purge_and_brush_enabled %}
	{% if force_homing_before_brush %}
	G28 Z
	{% endif %}
	CLEAN_NOZZLE
	{% endif %}

[gcode_macro _MODULE_Z_CALIB]
gcode = 
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% if bed_mesh_enabled and printer.bed_mesh.profile_name == "" %}
	COMPUTE_MESH_PARAMETERS SIZE={FL_SIZE}
	{% endif %}
	
	{% if zcalib_plugin_enabled %}
	G28 Z
	CALIBRATE_Z
	{% else %}
	G28 Z
	{% endif %}

[gcode_macro _MODULE_BED_MESH]
gcode = 
	
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if bed_mesh_enabled %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="MESHING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Bed mesh measurement..."
	{% endif %}
	
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	ADAPTIVE_BED_MESH
	{% else %}
	ADAPTIVE_BED_MESH SIZE={FL_SIZE}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_EXTRUDER_PREHEATING]
gcode = 
	
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Pre-heating the nozzle to a safe temperature..."
	{% endif %}
	
	M109 S{safe_extruder_temp}
	
	{% if verbose %}
	RESPOND MSG="Extruder at safe temperature of {safe_extruder_temp} degrees"
	{% endif %}

[gcode_macro _MODULE_CUSTOM1]
gcode = 

[gcode_macro _MODULE_CUSTOM2]
gcode = 

[gcode_macro _MODULE_CUSTOM3]
gcode = 

[gcode_macro _CG28]
description = Homing only if necessary
gcode = 
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	{% if "xyz" not in printer.toolhead.homed_axes %}
	G28
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[homing_override]
axes = xyz
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set homing_zhop = printer["gcode_macro _USER_VARIABLES"].homing_zhop|float %}
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed * 60 %}
	{% set homing_travel_accel = printer["gcode_macro _USER_VARIABLES"].homing_travel_accel %}
	{% set sensorless_homing_enabled = printer["gcode_macro _USER_VARIABLES"].sensorless_homing_enabled %}
	{% set sensorless_current_factor = printer["gcode_macro _USER_VARIABLES"].sensorless_current_factor / 100 %}
	{% set z_drop_speed = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% set homing_first = printer["gcode_macro _USER_VARIABLES"].homing_first|string|upper %}
	{% set x_homing_backoff, y_homing_backoff = printer["gcode_macro _USER_VARIABLES"].homing_backoff_distance_xy|map('float') %}
	
	{% set x_position_endstop = printer["configfile"].config["stepper_x"]["position_endstop"]|float %}
	{% set y_position_endstop = printer["configfile"].config["stepper_y"]["position_endstop"]|float %}
	{% set x_position_center = printer.toolhead.axis_maximum.x|int/2 - printer.toolhead.axis_minimum.x|int/2 %}
	{% set y_position_center = printer.toolhead.axis_maximum.y|int/2 - printer.toolhead.axis_minimum.y|int/2 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	{% set X, Y, Z = False, False, False %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	
	{% if not 'X' in params
	and not 'Y' in params
	and not 'Z' in params %}
	
	{% set X, Y, Z = True, True, True %}
	
	{% else %}
	{% if 'X' in params %}
	{% set X = True %}
	{% endif %}
	
	{% if 'Y' in params %}
	{% set Y = True %}
	{% endif %}
	
	{% if 'Z' in params %}
	{% set Z = True %}
	{% endif %}
	
	{% if 'X' in params
	and 'Y' in params
	and 'Z' in params %}
	
	
	_HOMING_VARIABLES reset=1
	{% endif %}
	
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_ENTRY_POINT FUNCTION=homing_override
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{homing_travel_accel}
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	G90
	
	{% if Z %}
	{% if ('z' in printer.toolhead.homed_axes) %}
	{% if (printer.toolhead.position.z < homing_zhop) %}
	{% if verbose %}
	{ action_respond_info("Z too low, performing ZHOP") }
	{% endif %}
	G0 Z{homing_zhop} F{z_drop_speed}
	{% endif %}
	{% elif ('xy' in printer.toolhead.homed_axes) %}
	{% if verbose %}
	{ action_respond_info("X and Y already homed, no ZHOP needed to home Z") }
	{% endif %}
	{% else %}
	{% if verbose %}
	{ action_respond_info("X and Y not homed, forcing full G28 to home Z properly") }
	{% endif %}
	SET_KINEMATIC_POSITION X=0 Y=0 Z=0
	G0 Z{homing_zhop} F{z_drop_speed}
	{% set X, Y, Z = True, True, True %}
	{% endif %}
	{% endif %}
	
	{% if homing_first == "X" %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% elif homing_first == "Y" %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% else %}
	{ action_respond_error("Axis homing order not valid. Choose either X or Y first in the variables.cfg file!") }
	{% endif %}
	
	
	
	{% if Z %}
	{% if verbose %}
	{ action_respond_info("Homing Z") }
	{% endif %}
	
	
	
	
	
	
	{% if printer["configfile"].config["stepper_z"]["endstop_pin"]|lower == "probe:z_virtual_endstop" %}
	
	{% if probe_type_enabled == "dockable_virtual" %}
	ACTIVATE_PROBE
	{% endif %}
	{% if bed_mesh_enabled %}
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	{% set mesh_center = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_center %}
	{% set x_mesh_center, y_mesh_center = mesh_center.split(',')|map('trim')|map('float') %}
	RESPOND MSG="Z homing: a mesh is computed and ready, probing mesh center: {mesh_center}"
	G0 X{x_mesh_center} Y{y_mesh_center} F{homing_travel_speed}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	
	
	{% else %}
	_GOTO_Z_PROBE
	{% endif %}
	
	
	{% if probe_type_enabled == "vorontap" %}
	ACTIVATE_PROBE
	{% endif %}
	
	G28 Z0
	
	G91
	G0 Z{homing_zhop} F{z_drop_speed}
	G90
	
	
	
	{% if probe_type_enabled == "vorontap" or probe_type_enabled == "dockable_virtual" %}
	DEACTIVATE_PROBE
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_EXIT_POINT FUNCTION=homing_override
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _GOTO_Z_PROBE]
description = Move to z probe avoiding the probe dock
gcode = 
	
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% if zcalib_plugin_enabled %}
	{% set z_endstop_x, z_endstop_y = printer["configfile"].config["z_calibration"]["nozzle_xy_position"].split(',')|map('trim')|map('float') %}
	{% else %}
	{% set z_endstop_x, z_endstop_y = printer["gcode_macro _USER_VARIABLES"].zendstop_position|map('float') %}
	{% endif %}
	
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed|float * 60 %}
	
	{% set probe_dock_location_x, probe_dock_location_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_location_xy|map('float') %}
	{% set probe_dock_margin_x, probe_dock_margin_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_margin_xy|map('float') %}
	
	{% set current_x = printer.toolhead.position.x|float %}
	{% set current_y = printer.toolhead.position.y|float %}
	
	SAVE_GCODE_STATE NAME=goto_ZProbe
	G90
	
	
	{% set avoid_dock = false %}
	{% if probe_dock_location_x < z_endstop_x|float %}
	
	
	{% if current_x < (probe_dock_location_x + probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% else %}
	
	
	{% if current_x > (probe_dock_location_x - probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% endif %}
	
	
	{% if avoid_dock == true  %}
	
	G0 Y{probe_dock_location_y - probe_dock_margin_y} F{homing_travel_speed}
	
	G0 X{z_endstop_x} F{homing_travel_speed}
	{% endif %}
	
	G0 X{z_endstop_x} Y{z_endstop_y} F{homing_travel_speed}
	
	RESTORE_GCODE_STATE NAME=goto_ZProbe

[gcode_macro CALIBRATE]
description = Calibrate the printer flow or pressure advance
gcode = 
	
	{% set TYPE = params.TYPE|default("")|string|lower %}
	
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set MATERIAL = params.MATERIAL|default("ABS")|string %}
	
	{% set center_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set center_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% if TYPE=="flow" %}
	
	{% set computed_size = (center_x - 20)|string + '_' + (center_y - 20)|string + '_' + (center_x + 20)|string + '_' + (center_y + 20)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	FLOW_MULTIPLIER_CALIBRATION EXTRUSION_WIDTH=0.471
	END_PRINT FILTER_TIME=0
	
	{% elif TYPE=="pressure_advance" %}
	
	{% set computed_size = (center_x - 60)|string + '_' + (center_y - 60)|string + '_' + (center_x + 60)|string + '_' + (center_y + 60)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	PRESSURE_ADVANCE_CALIBRATION
	END_PRINT FILTER_TIME=0
	
	{% else %}
	{action_respond_info("Please call this macro using TYPE= \"flow\" or \"pressure_advance\"")}
	{action_raise_error("not enough parameters to start a calibration!")}
	
	{% endif %}

[gcode_macro _FLOW_CALIB_VARIABLES]
variable_last_shell_thickness = 0.0
variable_last_evalue = 0.0
gcode = 

[gcode_macro FLOW_MULTIPLIER_CALIBRATION]
description = Print a small tower to calibrate the extrusion flow multiplier by measuring the shell
gcode = 
	
	
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	{% set do_retract = params.DO_RECTRACT|default(0)|int %}
	{% set print_size = params.PRINT_SIZE|default(40)|int %}
	{% set print_height = params.HEIGHT|default(15)|int %}
	{% set corner_radius = params.CORNER_RADIUS|default(8)|int %}
	{% set number_of_perimeters = params.PERIMETERS|default(2)|int %}
	{% set fan_speed = params.FAN_SPEED|default(20)|int %}
	
	{% set e_multiplier = params.EXTRUSION_MULTIPLIER|default(1.00)|float %}
	{% set filament_diameter = params.FILAMENT_DIAMETER|default(1.75)|float %}
	{% set extrusion_width = params.EXTRUSION_WIDTH|default(0.4)|float %}
	{% set layer_height = params.LAYER_HEIGHT|default(0.2)|float %}
	
	{% set retract_length = params.RETRACT_LENGTH|default(0.5)|float %}
	{% set initial_purge = params.PURGE_MM|default(1)|int %}
	{% set z_hop_height  = 2 * layer_height %}
	
	{% set feedrate_print = params.CONTROL_SPEED|default(100)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft = params.RAFT_SPEED|default(60)|int * 60 %}
	{% set feedrate_z = params.Z_LIFT_SPEED|default(20)|int * 60 %}
	{% set feedrate_retract = params.RETRACT_SPEED|default(50)|int * 60 %}
	
	
	
	
	{% set e_per_mm = ((extrusion_width - layer_height) * layer_height + 3.14159 * (layer_height / 2)**2) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set spacing = extrusion_width - layer_height * (1 - 3.14159 / 4) %}
	{% set shell_thickness = extrusion_width + (number_of_perimeters|float - 1) * spacing %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set x_start = max_x / 2 - print_size / 2 %}
	{% set y_start = max_y / 2 - print_size / 2 %}
	{% set x_end = x_start + print_size %}
	{% set y_end = y_start + print_size %}
	
	{% set num_raft_lines = ([print_size, max_x]|min / spacing)|round(0, 'floor')|int %}
	{% set raft_size = num_raft_lines * spacing %}
	
	
	
	
	{action_respond_info("")}
	{action_respond_info("Starting extrusion flow calibration print")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	{action_respond_info("Exrusion multiplier used: %.4f" % e_multiplier)}
	{action_respond_info("Number of perimeters to print: %d" % number_of_perimeters)}
	{action_respond_info("THEORIC SHELL THICKNESS: %.4f" % shell_thickness)}
	{action_respond_info("")}
	{action_respond_info("Measure the shell thickness using a caliper or micrometer. Then call the computation macro with the measured value:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION
	
	
	
	
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_shell_thickness VALUE={shell_thickness}
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_evalue VALUE={e_multiplier}
	
	
	
	
	G90
	M83
	G92 E0.0
	G0 X{x_start} Y{y_start - 5} Z{layer_height} F{feedrate_travel}
	
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{raft_size} E{raft_size * e_per_mm * 1.5} F{feedrate_raft / 2}
	G1 Y-{extrusion_width} E{extrusion_width * e_per_mm} F{feedrate_raft / 2}
	G1 X-{raft_size} E{raft_size * e_per_mm} F{feedrate_raft / 2}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G90
	G0 X{x_start} Y{y_start} F{feedrate_travel}
	G1 Z{layer_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	
	
	M221 S{e_multiplier * 100}
	
	
	
	
	{% if do_raft == 1 %}
	G91
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	G1 Y{loop.cycle(1.0, -1.0) * raft_size} E{raft_size * e_per_mm} F{feedrate_raft}
	
	
	{% if not loop.last %}
	G1 X{spacing} E{spacing * e_per_mm} F{feedrate_raft}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	
	
	
	
	G90
	M106 S{fan_speed * 255 / 100}
	
	
	{% for curr_layer in range(1, (print_height / layer_height)|round|int) %}
	G0 X{x_start + corner_radius} Y{y_start} F{feedrate_travel}
	G1 Z{(curr_layer * layer_height) + (layer_height if do_raft == 1 else 0)} F{feedrate_z}
	
	
	{% for perim_num in range(number_of_perimeters) %}
	
	{% set perim_offset = perim_num * spacing %}
	{% set perim_radius = corner_radius - (perim_num * spacing) %}
	
	
	G1 X{x_start + corner_radius} Y{y_start + perim_offset} F{feedrate_travel}
	{% if do_retract == 1 %}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	
	
	G1 X{x_end - corner_radius} Y{y_start + perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - perim_offset} Y{y_start + corner_radius} J{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_end - perim_offset} Y{y_end - corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - corner_radius} Y{y_end - perim_offset} I-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + corner_radius} Y{y_end - perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + perim_offset} Y{y_end - corner_radius} J-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + perim_offset} Y{y_start + corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + corner_radius} Y{y_start + perim_offset} I{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	
	{% if do_retract == 1 %}
	G1 E-{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	
	{% if do_retract == 1 %}
	G91
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G91
	G0 Z20 F{feedrate_travel}
	
	RESTORE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION

[gcode_macro COMPUTE_FLOW_MULTIPLIER]
description = Compute a new flow multiplier by using the measured shell thickness on the calibration print
gcode = 
	{% set evalue = params.OLD_EXTRUSION_MULTIPLIER|default(0.0)|float %}
	{% set theorical_thickness = params.THEORICAL_THICKNESS|default(0.0)|float %}
	{% set measured_thickness = params.MEASURED_THICKNESS|default(0.0)|float %}
	
	
	{% if evalue == 0.0 %}
	{% set last_evalue = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_evalue %}
	
	
	{% if last_evalue == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_evalue = last_evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	{% else %}
	{% set final_evalue = evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	
	
	{% if theorical_thickness == 0.0 %}
	{% set last_shell_thickness = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_shell_thickness %}
	
	
	{% if last_shell_thickness == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_theorical_thickness = last_shell_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	{% else %}
	{% set final_theorical_thickness = theorical_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	
	
	{% if measured_thickness == 0.0 %}
	{action_respond_info("You must use a caliper or micrometer to measure the calibration print shell thickness and call this macro with the measured value !!!")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set new_evalue = final_theorical_thickness * final_evalue / measured_thickness %}
	{action_respond_info("NEW COMPUTED FLOW VALUE: %.3f" % new_evalue)}
	{action_respond_info("Use this new value as extrusion multiplier in your slicer of choice")}
	{action_respond_info("")}
	{% endif %}

[gcode_macro PRESSURE_ADVANCE_CALIBRATION]
description = Calibrate the pressure advance by printing a grid pattern
gcode = 
	
	
	
	{% set pa_start     = params.START|default(0.02)|float %}
	{% set pa_increment = params.INCREMENT|default(0.005)|float %}
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	
	{% set print_size      = params.PRINT_SIZE|default(120)|int %}
	{% set num_bands       = params.BANDS_LIMIT|default(999)|int %}
	{% set lines_per_band  = params.LINES_PER_BAND|default(6)|int %}
	{% set e_multiplier    = params.EXTRUSION_MULTIPLIER|default(1.25 if do_raft == 1 else 1.5)|float %},
	{% set retract_length  = params.RETRACT_LENGTH|default(0.6)|float %}
	{% set initial_purge   = params.PURGE_MM|default(8)|int %}
	
	{% set feedrate_control = params.CONTROL_SPEED|default(30)|int * 60 %}
	{% set feedrate_outer   = params.OUTER_SPEED|default(40)|int * 60 %}
	{% set feedrate_inner   = params.INNER_SPEED|default(120)|int * 60 %}
	{% set feedrate_travel  = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft    = params.RAFT_SPEED|default(120)|int * 60 %}
	{% set feedrate_z       = 5 * 60 %}
	{% set feedrate_retract = 50 * 60 %}
	
	{% set spacing_line  = params.LINE_SPACING|default(0.4)|float %}
	{% set spacing_band  = 2 %}
	{% set spacing_raft  = 2 %}
	
	{% set fast_line_ratio_percent = 50 %}
	
	{% set lines_per_band    = [2, lines_per_band]|max %}
	{% set e_multiplier      = [1, e_multiplier]|max %}
	{% set num_lines_control = (lines_per_band / 2)|round(0, 'floor')|int %}
	{% set num_lines_test    = (lines_per_band / 2)|round(0, 'ceil')|int %}
	{% set spacing_line      = spacing_line * (1 + e_multiplier - 1.25) %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set nozzle_diameter = printer.configfile.config['extruder'].nozzle_diameter|float %}
	{% set line_width    = nozzle_diameter * 1.25 %}
	{% set line_height   = nozzle_diameter / 2 %}
	{% set z_hop_height  = 2 * line_height %}
	{% set e_per_mm      = (line_width * line_height) / (3.1415 * (1.75/2)**2) %}
	{% set spacing_purge = line_height * 0.8 %}
	
	{% set spacing_raft   = (spacing_raft / line_width)|round * line_width %}
	{% set num_raft_lines = ([print_size, max_x]|min / spacing_raft)|round(0, 'floor')|int %}
	{% set print_width    = num_raft_lines * spacing_raft %}
	
	{% set band_height      = lines_per_band * line_width + (lines_per_band - 1) * spacing_line + spacing_band %}
	{% set bands_per_height = (([print_size, max_y]|min  - spacing_purge - 2 * line_width + spacing_band) / band_height)|round(0, 'floor')|int %}
	{% set num_bands        = [num_bands, bands_per_height]|min %}
	{% set print_height     = num_bands * band_height - spacing_band + spacing_purge +  2 * line_width %}
	
	{% set slow_line_length = ((print_width * (1 - fast_line_ratio_percent / 100) / 2) / spacing_raft)|round * spacing_raft + spacing_raft / 2 %}
	{% set fast_line_length = print_width - slow_line_length * 2 %}
	{% set thick_raft_num1 = (slow_line_length / spacing_raft)|round|int %}
	{% set thick_raft_num2  = num_raft_lines - thick_raft_num1 + 1 %}
	
	{% set x_start = max_x / 2 - print_width  / 2 %}
	{% set y_start = max_y / 2 - print_height / 2 %}
	
	{action_respond_info("")}
	{action_respond_info("Starting Pressure Advance calibration print.")}
	{action_respond_info("")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button once the print starts exhibiting PA values that are obviously too high.")}
	{action_respond_info("")}
	{action_respond_info("PA of first band: %.4f" % pa_start)}
	{action_respond_info("PA of last band: %.4f" % (pa_start + ((num_bands - 1) * pa_increment)))}
	{action_respond_info("PA increment per band: %.4f" % pa_increment)}
	{action_respond_info("Number of bands: %d" % num_bands)}
	{action_respond_info("")}
	{action_respond_info("Inspect the printed model. "
	"Look at the top and bottom lines in each band, on the right side of the two vertical raft bars (where the print speeds change). "
	"Find the highest band from the bottom where the lines at its top still resemble the lines at its bottom, with no visible extrusion width irregularities. "
	"Your final Pressure Advance value would then be:"
	)}
	{action_respond_info("")}
	{action_respond_info("Assuming that first band_number is 0")}
	{action_respond_info("PA = %.4f + (%.4f * band_number)" % (pa_start, pa_increment))}
	{action_respond_info("")}
	{action_respond_info("Update your [extruder] config section and set \"pressure_advance\" to the value you calculated.")}
	{action_respond_info("")}
	
	
	
	
	
	
	
	
	
	SAVE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION
	{% set pa_saved = printer.configfile.settings['extruder'].pressure_advance %}
	SET_PRESSURE_ADVANCE ADVANCE={pa_start}
	
	
	
	
	M221 S100
	
	
	
	
	M117 Priming
	G90
	G0 X{x_start} Y{y_start} Z{line_height} F{feedrate_travel}
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{print_width}  E{print_width * e_per_mm} F{feedrate_raft / 2}
	G1 Y{line_width}   E{line_width * e_per_mm}  F{feedrate_raft / 2}
	G1 X-{print_width} E{print_width * e_per_mm} F{feedrate_raft / 2}
	
	
	
	
	{% if do_raft == 1 %}
	G0 F{feedrate_raft}
	
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	{% if curr_raft_line == thick_raft_num1 or curr_raft_line == thick_raft_num2 %}
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	G1 Y{loop.cycle(-1.0, 1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	{% endif %}
	
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	
	
	{% if not loop.last %}
	{% set horizontal_move = spacing_raft - (2 * line_width if curr_raft_line == thick_raft_num1 - 1 or curr_raft_line == thick_raft_num2 - 1 else 0) %}
	G1 X{horizontal_move} E{horizontal_move * e_per_mm}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	{% endif %}
	
	
	
	
	M117 Printing bands
	G90
	G0 X{x_start} Y{y_start + 2 * line_width + spacing_purge} F{feedrate_travel}
	G0 Z{line_height + (line_height if do_raft == 1 else 0)} F{feedrate_z}
	G91
	G1 E{retract_length} F{feedrate_retract}
	
	
	{% for curr_band_num in range(0, num_bands ) %}
	{% set outer_loop = loop %}
	
	{% set curr_pa_value = pa_start + curr_band_num * pa_increment %}
	SET_PRESSURE_ADVANCE ADVANCE={curr_pa_value}
	M117 Band {curr_band_num} PA {curr_pa_value|round(4)}
	
	
	{% for _ in range(num_lines_control) %}
	G1 X{print_width} E{print_width * e_per_mm * e_multiplier} F{feedrate_control}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G0 X-{print_width} Y{spacing_line + line_width} F{feedrate_travel}
	
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endfor %}
	
	
	{% for _ in range(num_lines_test) %}
	{% for data in [{'mm': slow_line_length, 'f': feedrate_outer}, {'mm': fast_line_length, 'f': feedrate_inner}, {'mm': slow_line_length, 'f': feedrate_outer}] %}
	G1 X{data.mm} E{data.mm * e_per_mm * e_multiplier} F{data.f}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	{% if not (outer_loop.last and loop.last) %}
	G0 X-{print_width} Y{(spacing_line if not loop.last else spacing_band) + line_width} F{feedrate_travel}
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z20 F{feedrate_z}
	G0 X-{print_width / 2} Y{[50, max_y - (y_start + print_height)]|min} F{feedrate_travel}
	
	M117
	SET_PRESSURE_ADVANCE ADVANCE={pa_saved}
	RESTORE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION

[gcode_macro CHANGE_FILAMENT]
description = Do a PAUSE, park the toolhead over the purge bucket and unload the filament
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	SAVE_GCODE_STATE NAME=CHANGE_FILAMENT_state
	PAUSE
	UNLOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=CHANGE_FILAMENT_state

[gcode_macro UNLOAD_FILAMENT]
description = Basic unload of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to unload filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to unload filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	
	_TIP_SHAPING
	M83
	G1 E-20 F3600
	G4 P3000
	G1 E{DISTANCE|float * -1} F3000
	
	RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament unloaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament unloaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro LOAD_FILAMENT]
description = Basic load of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to load filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to load filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=LOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	M83
	G92 E0
	G1 E{DISTANCE|float} F200
	G1 E50 F150
	
	G92 E0
	RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament loaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament loaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _TIP_SHAPING]
description = Filament tip shaping sequence
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=TIP_SHAPING_state
	_LOW_TEMP_CHECK T={TEMP}
	
	{% set old_pressure_advance = printer.extruder.pressure_advance|default(0) %}
	
	SET_PRESSURE_ADVANCE ADVANCE=0
	
	M82
	G92 E0
	G1 E2 F3600
	G1 E0 F3600
	G1 E3 F3600
	G1 E0 F3600
	G1 E4 F3600
	G1 E0 F3600
	
	
	SET_PRESSURE_ADVANCE ADVANCE={old_pressure_advance}
	RESTORE_GCODE_STATE NAME=TIP_SHAPING_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_CHAMBER]
description = Heatsoak chamber to a specific temperature with a timeout
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set MAXTIME = params.MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% for _ in range(1, MAXTIME) %}
	_WAIT_CHAMBER_TEMP TEMP={SETPOINT_TEMP}
	{% endfor %}
	{% if verbose %}
	RESPOND MSG="Chamber temperature OK !"
	{% endif %}
	{% endif %}

[gcode_macro _WAIT_CHAMBER_TEMP]
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	{% if CURRENT_TEMP <= SETPOINT_TEMP %}
	RESPOND MSG="Heating up the chamber : {CURRENT_TEMP}/{SETPOINT_TEMP}"
	G4 P{60000 * 1}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_BED]
description = Heatsoak bed at specified temperature and wait for a specific amount of time
gcode = 
	{% set SETPOINT_TEMP = params.TEMP|default(0)|int %}
	{% set TIME = params.SOAKTIME|default(8)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set heaterbed_enabled = printer["gcode_macro _USER_VARIABLES"].heaterbed_enabled %}
	
	{% if heaterbed_enabled %}
	{% if verbose %}
	RESPOND MSG="Heating up bed..."
	{% endif %}
	
	M190 S{SETPOINT_TEMP}
	
	{% if TIME > 0 %}
	{% for i in range(0, TIME) %}
	RESPOND MSG="Heatsoak bed, {TIME-i}mn left..."
	G4 P{60000 * 1}
	{% endfor %}
	{% else %}
	RESPOND MSG="No heatsoak needed, continue"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Bed temperature OK"
	{% endif %}
	
	{% else %}
	{% if verbose %}
	RESPOND MSG="No bed heater defined: nothing to do, continuing..."
	{% endif %}
	{% endif %}

[gcode_macro PRIMELINE]
gcode = 
	
	{% set prime_line_length = params.LINE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_length)|float %}
	{% set prime_line_purge_distance = params.PURGE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_purge_distance)|float %}
	{% set prime_line_flowrate = params.FLOWRATE|default(printer["gcode_macro _USER_VARIABLES"].prime_line_flowrate)|float %}
	
	
	{% set prime_line_x, prime_line_y = printer["gcode_macro _USER_VARIABLES"].prime_line_xy|map('float') %}
	{% set prime_line_direction = printer["gcode_macro _USER_VARIABLES"].prime_line_direction|string|upper %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% set max_extrude_cross_section = printer["configfile"].config["extruder"]["max_extrude_cross_section"]|float %}
	{% set filament_diameter = printer["configfile"].config["extruder"]["filament_diameter"]|float %}
	
	{% set line_height = 0.6 %}
	
	
	{% set prime_line_x = params.START_X|default(prime_line_x)|float %}
	{% set prime_line_y = params.START_Y|default(prime_line_y)|float %}
	{% set prime_line_direction = params.LINE_DIRECTION|default(printer["gcode_macro _USER_VARIABLES"].prime_line_direction)|string|upper %}
	
	
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	
	
	
	{% if (line_height * line_width) > max_extrude_cross_section %}
	{% if verbose %}
	{action_respond_info("The prime_line_purge_distance of %.4f mm is too high and will exceed the max_extrude_cross_section!" % prime_line_purge_distance)}
	{% endif %}
	{% set prime_line_purge_distance = 0.98 * (max_extrude_cross_section * prime_line_length) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	{% if verbose %}
	{action_respond_info("Klippain corrected the prime_line_purge_distance to %.4f mm" % prime_line_purge_distance)}
	{% endif %}
	{% endif %}
	
	
	{% if (line_height / line_width) >= 0.5 %}
	{% if verbose %}
	{action_raise_error("The prime line will be too thin and will probably not stick properly to the bed. Increase its purge distance or decrease its length! Aborting...")}
	{% endif %}
	{% endif %}
	
	
	{% set speed = (prime_line_flowrate / (line_height * line_width)) * 60 |float %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% endif %}
	{% endif %}
	{% endif %}
	
	G91
	M83
	G1 Z5 F{Sz}
	
	
	G90
	G0 X{prime_line_x} Y{prime_line_y} F{St}
	G1 Z{line_height} F{Sz|int / 2}
	
	
	G92 E0
	G1 E18 F300
	
	
	G92 E0
	{% if prime_line_direction == "X" %}
	G1 X{prime_line_x + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% elif prime_line_direction == "Y" %}
	G1 Y{prime_line_y + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% else %}
	{ action_respond_error("Prime line direction is not valid. Choose either X or Y in the variables.cfg file!") }
	{% endif %}
	
	
	G92 E0
	G1 E-0.2 F2100
	G92 E0
	G1 Z3 F{Sz}
	M400
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection reactivated after the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro CLEAN_NOZZLE]
description = Wipe the nozzle on the brush
gcode = 
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set brush_clean_accel = printer["gcode_macro _USER_VARIABLES"].brush_clean_accel %}
	{% set brush_over_y_axis = printer["gcode_macro _USER_VARIABLES"].brush_over_y_axis %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set Sc = printer["gcode_macro _USER_VARIABLES"].brush_clean_speed * 60 %}
	
	{% set Bx, By, Bz = printer["gcode_macro _USER_VARIABLES"].brush_xyz|map('float') %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Nozzle cleaning..."
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{brush_clean_accel}
	
	
	G90
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP=1
	
	G1 X{Bx} Y{By} Z{Bz} F{St}
	
	
	G91
	{% if brush_over_y_axis %}
	{% for wipe in range(6) %}
	G1 Y-5 F{Sc}
	G1 Y+5 F{Sc}
	{% endfor %}
	{% endif %}
	
	G1 X+20 F{Sc}
	
	{% for wipe in range(6) %}
	G1 X-40 F{Sc}
	G1 X+40 F{Sc}
	{% endfor %}
	
	G90
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="clean"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro PURGE]
description = Purge a specific amount of filament ontop of the purge bucket
gcode = 
	{% set DISTANCE = params.DISTANCE|default(printer["gcode_macro _USER_VARIABLES"].purge_distance)|int %}
	{% set OOZE_TIME = params.OOZE_TIME|default(printer["gcode_macro _USER_VARIABLES"].purge_ooze_time)|int %}
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Purge filament..."
	{% endif %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% endif %}
	
	G90
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP={Z_DROP}
	
	
	_LOW_TEMP_CHECK T={TEMP}
	G92 E0
	G1 E{DISTANCE|float} F150
	
	
	G92 E0
	G1 E-1.7 F2100
	G1 E-18.3 F150
	G92 E0
	
	
	G4 P{OOZE_TIME * 1000}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _CONDITIONAL_MOVE_TO_PURGE_BUCKET]
description = Move over the purge bucket
gcode = 
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	
	{% if purge_and_brush_enabled %}
	SAVE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	G90
	
	{% if Z_DROP == 1 %}
	{% if purgeclean_servo_enabled %}
	G1 Z{Pz} F{Sz}
	_SERVO_DEPLOY ITEM="purge"
	{% endif %}
	G1 X{Px} Y{Py} Z{Pz} F{St}
	{% else %}
	
	
	
	G1 X{Px} Y{Py} F{St}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	{% endif %}

[gcode_macro _LOW_TEMP_CHECK]
description = Check the nozzle is at temperature and heat it if needed
gcode = 
	{% set T = params.T|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% if printer.extruder.target != 0 %}
	{% if printer.extruder.temperature < printer.extruder.target %}
	M109 S{printer.extruder.target|float}
	{% endif %}
	{% else %}
	{% if printer.extruder.target < T %}
	M109 S{T}
	{% endif %}
	{% endif %}

[gcode_macro M701]
description = Map M701 to LOAD_FILAMENT
gcode = 
	LOAD_FILAMENT

[gcode_macro M702]
description = Map M702 to UNLOAD_FILAMENT
gcode = 
	UNLOAD_FILAMENT

[gcode_macro M600]
description = Map M600 to CHANGE_FILAMENT
gcode = 
	CHANGE_FILAMENT

[gcode_macro M125]
description = Map M125 to PARK
gcode = 
	PARK

[gcode_macro M900]
description = Map M900 to SET_PRESSURE_ADVANCE
gcode = 
	{% if 'K' in params %}
	{% if 'E' in params %}
	SET_PRESSURE_ADVANCE EXTRUDER={params.E} ADVANCE={params.K}
	{% else %}
	SET_PRESSURE_ADVANCE ADVANCE={params.K}
	{% endif %}
	{% endif %}

[gcode_macro M204]
description = Map M204 to SET_VELOCITY_LIMIT for ACCEL and ACCEL_TO_DECEL
rename_existing = M204.1
gcode = 
	{% set F = params.F|default(printer["gcode_macro _USER_VARIABLES"].accel_to_decel_factor)|float %}
	
	{% if 'S' in params %}
	{% set S = params.S|float %}
	SET_VELOCITY_LIMIT ACCEL={S} ACCEL_TO_DECEL={S * F}
	{% endif %}

[gcode_macro M205]
description = Map M205 to SET_VELOCITY_LIMIT for SQUARE_CORNER_VELOCITY
gcode = 
	{% if 'X' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.X}
	{% elif 'Y' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.Y}
	{% endif %}

[gcode_macro G00]
gcode = 
	G0 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G01]
gcode = 
	G1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G02]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G03]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G04]
gcode = 
	G4 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro _SEARCH_VARS]
description = Search for variables in the "printer" object from Klipper
gcode = 
	{% set search = params.S|lower %}
	{% set ns = namespace() %}
	{% for item in printer  %}
	{% if ' ' in item %}
	{% set ns.path = ['printer', "['%s']" % (item), ''] %}
	{% else %}
	{% set ns.path = ['printer.', item, ''] %}
	{% endif %}
	
	{% if search in ns.path|lower %}
	{ action_respond_info(ns.path|join) }
	{% endif %}
	
	{% if printer[item].items() %}
	{% for childkey, child in printer[item].items() recursive %}
	{% set ns.path = ns.path[:loop.depth|int + 1] %}
	
	{% if ' ' in childkey %}
	{% set null = ns.path.append("['%s']" % (childkey)) %}
	{% else %}
	{% set null = ns.path.append(".%s" % (childkey)) %}
	{% endif %}
	
	{% if child is mapping  %}
	{ loop(child.items()) }
	{% else %}
	{% if search in ns.path|lower %}
	{ action_respond_info("%s : %s" % (ns.path|join, child)) }
	{% endif %}
	{% endif %}
	
	{% endfor %}
	{% endif %}
	{% endfor %}

[delayed_gcode KLIPPAIN_STARTUP]
initial_duration = 1
gcode = 
	_KLIPPAIN_STARTUP

[gcode_macro _KLIPPAIN_STARTUP]
gcode = 
	
	RUN_SHELL_COMMAND CMD=system_info
	
	
	_INIT_MCU_VER
	
	
	{% set extruder_enabled = printer["gcode_macro _USER_VARIABLES"].extruder_enabled %}
	{% if not extruder_enabled %}
	{ action_raise_error("Klippain need to have an extruder defined to work properly. Check your printer.cfg includes!") }
	{% endif %}
	
	
	_INIT_CHECKPROBECONF
	
	
	{% set e_driver = printer["gcode_macro _USER_VARIABLES"].e_driver|string %}
	{% if e_driver == "TMC2240" %}
	_INIT_TMC2240
	{% endif %}
	
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% if klippain_ercf_enabled %}
	_INIT_CHECK_ERCF
	{% endif %}
	
	
	_INIT_USERCUSTOM
	
	RESPOND MSG="Klippain started and ready !"

[gcode_macro _INIT_TMC2240]
gcode = 

[gcode_macro _INIT_CHECKPROBECONF]
gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled|string %}
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set qgl_enabled = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set ztilt_enabled = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	
	{% if zcalib_plugin_enabled %}
	{% if probe_type_enabled == "vorontap" %}
	{ action_raise_error("Voron TAP Probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "inductive" %}
	{ action_raise_error("Inductive probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "dockable_virtual" or probe_type_enabled == "inductive_virtual" %}
	{ action_raise_error("Virtual Z endstop probes are not compatible with the Z calibration plugin!") }
	{% elif probe_type_enabled == "none" %}
	{ action_raise_error("You need a probe to use the Z calibration plugin in Klippain!") }
	{% endif %}
	{% endif %}
	
	{% if bed_mesh_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a bed mesh in Klippain!") }
	{% endif %}
	
	{% if qgl_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a quad gantry leveling in Klippain!") }
	{% endif %}
	
	{% if ztilt_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a Z tilt adjust in Klippain!") }
	{% endif %}

[gcode_macro _INIT_MCU_VER]
gcode = 
	{% set parameters = namespace(output = 'Currently configured MCU(s): \n') %}
	{% for name1 in printer %}
	{% for name2 in printer[name1] %}
	{% set show = ['mcu_version'] %}
	{% if name2 is in show %}
	{% set param = "%s: %s" % (name1, printer[name1][name2]) %}
	{% set parameters.output = parameters.output +  param + "\n" %}
	{% endif %}
	{% endfor %}
	{% endfor %}
	{action_respond_info(parameters.output)}

[gcode_macro _INIT_CHECK_ERCF]
gcode = 
	{% if not printer.ercf.enabled %}
	{ action_raise_error("ERCF is enabled in Klippain, but Happy Hare, the supported ERCF backend software is not detected. Please install it now from https://github.com/moggieuk/ERCF-Software-V3 !") }
	{% endif %}

[gcode_macro _INIT_USERCUSTOM]
gcode = 

[gcode_shell_command plot_graph]
command = bash /home/pi/printer_data/config/scripts/plot_graphs.sh
timeout = 500.0
verbose = True

[gcode_shell_command system_info]
command = python3 /home/pi/printer_data/config/scripts/system_info.py
timeout = 5.0
verbose = True

[save_variables]
filename = ~/printer_data/config/save_variables.cfg

[tmc2209 stepper_z]
uart_pin = Z_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z1]
uart_pin = Z1_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z2]
uart_pin = Z2_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z3]
uart_pin = Z3_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 extruder]
uart_pin = toolhead:E_TMCUART
interpolate = false
run_current = 0.45
sense_resistor = 0.110
stealthchop_threshold = 0

[mcu]
canbus_uuid = f04ddc949bb2

[board_pins mcu_manufacturer]
aliases = 
	MCU_MOTOR0_STEP=PF13   , MCU_MOTOR0_DIR=PF12   , MCU_MOTOR0_ENABLE=PF14   , MCU_MOTOR0_UART=PC4    ,
	MCU_MOTOR1_STEP=PG0    , MCU_MOTOR1_DIR=PG1    , MCU_MOTOR1_ENABLE=PF15   , MCU_MOTOR1_UART=PD11   ,
	MCU_MOTOR2_1_STEP=PF11 , MCU_MOTOR2_1_DIR=PG3  , MCU_MOTOR2_1_ENABLE=PG5  , MCU_MOTOR2_1_UART=PC6  ,
	MCU_MOTOR3_STEP=PG4    , MCU_MOTOR3_DIR=PC1    , MCU_MOTOR3_ENABLE=PA0    , MCU_MOTOR3_UART=PC7    ,
	MCU_MOTOR4_STEP=PF9    , MCU_MOTOR4_DIR=PF10   , MCU_MOTOR4_ENABLE=PG2    , MCU_MOTOR4_UART=PF2    ,
	MCU_MOTOR5_STEP=PC13   , MCU_MOTOR5_DIR=PF0    , MCU_MOTOR5_ENABLE=PF1    , MCU_MOTOR5_UART=PE4    ,
	MCU_MOTOR6_STEP=PE2    , MCU_MOTOR6_DIR=PE3    , MCU_MOTOR6_ENABLE=PD4    , MCU_MOTOR6_UART=PE1    ,
	MCU_MOTOR7_STEP=PE6    , MCU_MOTOR7_DIR=PA14   , MCU_MOTOR7_ENABLE=PE0    , MCU_MOTOR7_UART=PD3    ,
	
	MCU_STOP0=PG6  , MCU_STOP1=PG9  , MCU_STOP2=PG10 , MCU_STOP3=PG11 ,
	MCU_STOP4=PG12 , MCU_STOP5=PG13 , MCU_STOP6=PG14 , MCU_STOP7=PG15 ,
	MCU_PROBE=PB7  ,
	MCU_SERVOS=PB6 ,
	
	MCU_HE0=PA2 , MCU_HE1=PA3 , MCU_HE2=PB10 , MCU_HE3=PB11 ,
	
	MCU_BED0=PA1 ,
	
	MCU_TB=PF3 ,
	MCU_T0=PF4 , MCU_T1=PF5 , MCU_T2=PF6 , MCU_T3=PF7 ,
	
	MCU_FAN0=PA8 , MCU_FAN1=PE5 , MCU_FAN2=PD12 , MCU_FAN3=PD13 , MCU_FAN4=PD14 , MCU_FAN5=PD15 ,
	
	MCU_NEOPIXEL=PB0  ,
	MCU_PS_ON=PE11    ,
	MCU_POWER_DET=PC0 ,
	
	
	EXP1_1=PE8   , EXP1_2=PE7   ,
	EXP1_3=PE9   , EXP1_4=PE10  ,
	EXP1_5=PE12  , EXP1_6=PE13  ,
	EXP1_7=PE14  , EXP1_8=PE15  ,
	EXP1_9=<GND> , EXP1_10=<5V> ,
	
	
	EXP2_1=PA6   , EXP2_2=PA5   ,
	EXP2_3=PB1   , EXP2_4=PA4   ,
	EXP2_5=PB2   , EXP2_6=PA7   ,
	EXP2_7=PC15  , EXP2_8=<RST> ,
	EXP2_9=<GND> , EXP2_10=<5V> ,

[board_pins octopus_mcu]
mcu = mcu
aliases = 
	X_STEP=MCU_MOTOR0_STEP   , X_DIR=MCU_MOTOR0_DIR   , X_ENABLE=MCU_MOTOR0_ENABLE   , X_TMCUART=MCU_MOTOR0_UART   ,
	Y_STEP=MCU_MOTOR1_STEP   , Y_DIR=MCU_MOTOR1_DIR   , Y_ENABLE=MCU_MOTOR1_ENABLE   , Y_TMCUART=MCU_MOTOR1_UART   ,
	
	Z_STEP=MCU_MOTOR2_1_STEP , Z_DIR=MCU_MOTOR2_1_DIR , Z_ENABLE=MCU_MOTOR2_1_ENABLE , Z_TMCUART=MCU_MOTOR2_1_UART ,
	Z1_STEP=MCU_MOTOR3_STEP  , Z1_DIR=MCU_MOTOR3_DIR  , Z1_ENABLE=MCU_MOTOR3_ENABLE  , Z1_TMCUART=MCU_MOTOR3_UART  ,
	Z2_STEP=MCU_MOTOR4_STEP  , Z2_DIR=MCU_MOTOR4_DIR  , Z2_ENABLE=MCU_MOTOR4_ENABLE  , Z2_TMCUART=MCU_MOTOR4_UART  ,
	Z3_STEP=MCU_MOTOR5_STEP  , Z3_DIR=MCU_MOTOR5_DIR  , Z3_ENABLE=MCU_MOTOR5_ENABLE  , Z3_TMCUART=MCU_MOTOR5_UART  ,
	
	E_STEP=MCU_MOTOR6_STEP   , E_DIR=MCU_MOTOR6_DIR   , E_ENABLE=MCU_MOTOR6_ENABLE   , E_TMCUART=MCU_MOTOR6_UART   ,
	
	X_STOP=MCU_STOP0 , Y_STOP=MCU_STOP1 , Z_STOP=MCU_STOP2 ,
	PROBE_INPUT=MCU_STOP7  ,
	RUNOUT_SENSOR=MCU_STOP3 ,
	
	E_HEATER=MCU_HE0   , E_TEMPERATURE=MCU_T0   ,
	BED_HEATER=MCU_HE1 , BED_TEMPERATURE=MCU_TB ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	CONTROLLER_FAN=MCU_FAN2        ,
	EXHAUST_FAN=MCU_FAN3           ,
	FILTER_FAN=MCU_FAN4            ,
	HOST_CONTROLLER_FAN=MCU_FAN5   ,
	
	CHAMBER_TEMPERATURE=MCU_T1 , ELECTRICAL_CABINET_TEMPERATURE=MCU_T2 ,
	
	LIGHT_OUTPUT=MCU_HE2         ,
	LIGHT_NEOPIXEL=MCU_STOP5     ,
	STATUS_NEOPIXEL=MCU_NEOPIXEL ,

[mcu toolhead]
canbus_uuid = 1b44cf5169c3

[board_pins toolhead_manufacturer]
mcu = toolhead
aliases = 
	MCU_EMOT_EN=gpio7 , MCU_EMOT_STEP=gpio9 , MCU_EMOT_DIR=gpio10 , MCU_EMOT_UART=gpio8 ,
	
	MCU_5V_ENDSTOP=gpio28 ,
	MCU_ENDSTOP=gpio29    ,
	MCU_HV_ENDSTOP=gpio25 ,
	
	MCU_FAN0=gpio13 , MCU_FAN1=gpio14 , MCU_FAN2=gpio15 ,
	
	MCU_TEMP=gpio27 , MCU_ONBOARD_NTCK100K=gpio26 ,
	
	MCU_HEAT=gpio6 ,
	
	MCU_RGB=gpio12 ,
	MCU_PWM0=gpio16 , MCU_PWM1=gpio17 ,
	
	MCU_ADXL_CS=gpio1 , MCU_ADXL_SCK=gpio0 , MCU_ADXL_MOSI=gpio3 , MCU_ADXL_MISO=gpio2 ,

[board_pins sb2040_mcu]
mcu = toolhead
aliases = 
	E_STEP=MCU_EMOT_STEP , E_DIR=MCU_EMOT_DIR , E_ENABLE=MCU_EMOT_EN , E_TMCUART=MCU_EMOT_UART ,
	
	X_STOP=MCU_ENDSTOP ,
	PROBE_INPUT=MCU_HV_ENDSTOP ,
	TOOLHEAD_SENSOR=MCU_5V_ENDSTOP ,
	
	E_HEATER=MCU_HEAT , E_TEMPERATURE=MCU_TEMP , CHAMBER_TEMPERATURE=MCU_ONBOARD_NTCK100K ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	
	STATUS_NEOPIXEL=MCU_RGB ,
	
	ADXL_CS=MCU_ADXL_CS , ADXL_SCLK=MCU_ADXL_SCK , ADXL_MOSI=MCU_ADXL_MOSI , ADXL_MISO=MCU_ADXL_MISO ,

[neopixel status_leds]
pin = toolhead:STATUS_NEOPIXEL
=======================
Args: ['/home/orangepi/klipper/klippy/klippy.py', '/home/orangepi/printer_data/config/printer.cfg', '-I', '/home/orangepi/printer_data/comms/klippy.serial', '-l', '/home/orangepi/printer_data/logs/klippy.log', '-a', '/home/orangepi/printer_data/comms/klippy.sock']
Git version: 'v0.11.0-241-gffb5105b-dirty'
Untracked files: klippy/extras/gcode_shell_command.py
Branch: master
Remote: origin
Tracked URL: https://github.com/Klipper3d/klipper
CPU: 4 core ?
Python: '3.9.2 (default, Feb 28 2021, 17:03:44) \n[GCC 10.2.1 20210110]'
=============== Log rollover at Tue Jul 11 14:33:54 2023 ===============
Unable to issue reset command on MCU 'mcu'
Unable to issue reset command on MCU 'toolhead'
webhooks client 281472983492352: Disconnected
Restarting printer
Start printer at Tue Jul 11 14:33:55 2023 (1689104035.5 72157.8)
===== Config file =====
[printer]
kinematics = corexz
max_velocity = 400
max_accel = 1000
max_z_velocity = 200
max_z_accel = 1000
square_corner_velocity = 5.0

[stepper_x]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = X_STEP
dir_pin = X_DIR
enable_pin = !X_ENABLE
endstop_pin = tmc2209_stepper_x:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_y]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = Y_STEP
dir_pin = Y_DIR
enable_pin = !Y_ENABLE
endstop_pin = tmc2209_stepper_y:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_z]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z_STEP
dir_pin = !Z_DIR
enable_pin = !Z_ENABLE
endstop_pin = probe:z_virtual_endstop
homing_speed = 15
second_homing_speed = 8
homing_retract_dist = 3.0
position_max = 310
position_min = -5

[stepper_z1]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z1_STEP
dir_pin = !Z1_DIR
enable_pin = !Z1_ENABLE

[stepper_z2]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z2_STEP
dir_pin = !Z2_DIR
enable_pin = !Z2_ENABLE

[stepper_z3]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z3_STEP
dir_pin = Z3_DIR
enable_pin = !Z3_ENABLE

[gcode_macro _USER_VARIABLES]
variable_extruder_enabled = True
gcode = 
variable_heaterbed_enabled = True
variable_probe_type_enabled = "vorontap"
variable_startprint_actions = "bed_soak", "extruder_preheating", "chamber_soak", "clean", "tilt_calib", "z_offset", "bedmesh", "extruder_heating", "purge", "clean", "primeline"
variable_purgeclean_servo_enabled = True
variable_purgeclean_servo_name = "purgeservo"
variable_status_leds_minidisplay_enabled = True
variable_status_leds_minidisplay_led_name = "btt_mini12864"
variable_bed_mesh_enabled = True
variable_sensorless_homing_enabled = True
variable_qgl_enabled = True
variable_verbose = True
variable_homing_travel_speed = 350
variable_travel_speed = 350
variable_z_drop_speed = 15
variable_brush_clean_speed = 100
variable_probe_dock_speed = 60
variable_homing_travel_accel = 3000
variable_tilting_travel_accel = 3000
variable_brush_clean_accel = 1500
variable_probe_dock_accel = 2000
variable_accel_to_decel_factor = 0.75
variable_zendstop_position = -1, -1
variable_force_homing_in_start_print = False
variable_homing_zhop = 5
variable_homing_first = "X"
variable_homing_backoff_distance_xy = -5, -5
variable_sensorless_current_factor = 75
variable_probe_dock_margin_xy = 0, 0
variable_safe_extruder_temp = 150
variable_prime_line_xy = 5, 2.5
variable_prime_line_direction = "X"
variable_prime_line_length = 40
variable_prime_line_purge_distance = 30
variable_prime_line_flowrate = 10
variable_park_position_xy = -1, -1
variable_park_lift_z = 50
variable_disable_motors_in_end_print = False
variable_turn_off_heaters_in_end_print = True
variable_min_bed_xy = 0, 0
variable_max_bed_xy = 9999, 9999
variable_probe_min_z_travel = 20
variable_probe_dock_location_xy = -1, -1
variable_probe_servo_angle_retracted = 0
variable_probe_servo_angle_deployed = 90
variable_probe_before_attach_position = "front"
variable_probe_after_attach_position = "front"
variable_probe_before_dock_position = "front"
variable_probe_after_dock_position = "left"
variable_probe_move_attach_length = 30
variable_probe_move_dock_length = 30
variable_autodock_on_probe_error = True
variable_tap_max_probing_temp = 150
variable_tap_deactivation_zhop = 5
variable_print_default_bed_temp = 105
variable_print_default_extruder_temp = 240
variable_print_default_chamber_temp = 0
variable_print_default_chamber_max_heating_time = 15
variable_print_default_soak = 8
variable_print_default_material = "XXX"
variable_material_parameters = {
	'PLA': {
	'pressure_advance': 0.0525,
	'retract_length': 0.75,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 0,
	'additional_z_offset': 0
	},
	'PET': {
	'pressure_advance': 0.0650,
	'retract_length': 1.4,
	'unretract_extra_length': 0,
	'retract_speed': 30,
	'unretract_speed': 20,
	'filter_speed': 0,
	'additional_z_offset': 0.020
	},
	'ABS': {
	'pressure_advance': 0.0480,
	'retract_length': 0.5,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 80,
	'additional_z_offset': 0
	}
	}
variable_ercf_unload_on_cancel_print = False
variable_ercf_unload_on_end_print = True
variable_ercf_reset_stats_on_start_print = False
variable_purge_and_brush_enabled = False
variable_force_homing_before_brush = False
variable_brush_over_y_axis = True
variable_brush_xyz = -1, -1, -1
variable_purge_bucket_xyz = -1, -1, -1
variable_purge_distance = 30
variable_purge_ooze_time = 10
variable_purgeclean_servo_angle_retracted = 0
variable_purgeclean_servo_angle_deployed = 90
variable_light_intensity_start_print = 100
variable_light_intensity_printing = 30
variable_light_intensity_end_print = 0
variable_fix_heaters_temperature_settle = False
variable_resonnance_test_point_xy = -1, -1
variable_resonnance_test_z_clearance = 50
variable_status_leds_colors = {
	'logo': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'nozzle': {
	'heating': {'r': 0.8, 'g': 0.35, 'b': 0.0, 'w':0.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'standby': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'caselight': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'minidisplay': {
	'on': {'r': 0.0, 'g': 0.2, 'b': 0.4, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'error': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'thermal': {
	'hot': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cold': {'r': 0.3, 'g': 0.0, 'b': 0.3, 'w': 0.0}
	}
	}
variable_x_driver = "TMC2209"
variable_y_driver = "TMC2209"
variable_z_driver = "TMC2209"
variable_e_driver = "TMC2209"

[extruder]
rotation_distance = 22.79234586
gear_ratio = 50:10
microsteps = 64
full_steps_per_rotation = 200
nozzle_diameter = 0.400
filament_diameter = 1.75
max_extrude_only_distance = 110
max_extrude_cross_section = 5
sensor_type = ATC Semitec 104GT-2
min_temp = 5
max_temp = 310
max_power = 1.0
min_extrude_temp = 170
pressure_advance = 0.045
pressure_advance_smooth_time = 0.040
step_pin = toolhead:E_STEP
dir_pin = toolhead:E_DIR
enable_pin = !toolhead:E_ENABLE
heater_pin = toolhead:E_HEATER
sensor_pin = toolhead:E_TEMPERATURE
control = pid
pid_kp = 34.626
pid_ki = 4.050
pid_kd = 74.014

[gcode_macro M109]
rename_existing = M109.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={S}
	{% else %}
	M109.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[heater_bed]
heater_pin = BED_HEATER
sensor_type = NTC 100K MGB18-104F39050L32
sensor_pin = BED_TEMPERATURE
max_power = 1
min_temp = 0
max_temp = 120
control = pid
pid_kp = 40.783
pid_ki = 1.007
pid_kd = 412.931

[gcode_macro M190]
rename_existing = M190.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={S}
	{% else %}
	M190.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[gcode_macro ACTIVATE_PROBE]
description = Put the machine in a state being able to probe
variable_temperature = 0
gcode = 
	{% set LOCK = params.LOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_max_probing_temp = printer["gcode_macro _USER_VARIABLES"].tap_max_probing_temp|float %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if LOCK %}
	_ATTACH_PROBE_LOCK
	{% else %}
	_ATTACH_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	SAVE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	
	{% set ACTUAL_TEMP = printer.extruder.temperature %}
	{% set TARGET_TEMP = printer.extruder.target %}
	
	SET_GCODE_VARIABLE MACRO=ACTIVATE_PROBE VARIABLE=temperature VALUE={TARGET_TEMP}
	
	{% if TARGET_TEMP > tap_max_probing_temp %}
	{ action_respond_info('Extruder temperature target of %.1fC is too high for TAP probing, lowering to %.1fC' % (TARGET_TEMP, tap_max_probing_temp)) }
	M106 S255
	M109 S{tap_max_probing_temp}
	M106 S0
	{% else %}
	
	{% if ACTUAL_TEMP > tap_max_probing_temp + 3 %}
	M106 S255
	TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={tap_max_probing_temp}
	M106 S0
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro DEACTIVATE_PROBE]
description = Revert the machine to a normal state after probing
gcode = 
	{% set UNLOCK = params.UNLOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_deactivation_zhop = printer["gcode_macro _USER_VARIABLES"].tap_deactivation_zhop %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if UNLOCK %}
	_DOCK_PROBE_UNLOCK
	{% else %}
	_DOCK_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	
	{% set z_safe = printer.toolhead.position.z + tap_deactivation_zhop %}
	{% if z_safe > printer.toolhead.axis_maximum.z %}
	{% set z_safe = printer.toolhead.axis_maximum.z %}
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	
	{% set old_target_temperature = printer["gcode_macro ACTIVATE_PROBE"].temperature %}
	M109 S{old_target_temperature}
	
	RESTORE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	{% endif %}

[probe]
pin = ^toolhead:MCU_ENDSTOP1
x_offset = 0
y_offset = 0
z_offset = -0.45
speed = 3
lift_speed = 10
samples = 3
samples_result = median
sample_retract_dist = 1.0
samples_tolerance = 0.007
samples_tolerance_retries = 3

[heater_fan hotend_fan]
pin = toolhead:E_FAN
max_power = 1.0
kick_start_time = 0.100
heater = extruder
heater_temp = 50.0

[fan]
pin = toolhead:PART_FAN
kick_start_time = 0.100
cycle_time = 0.010

[gcode_macro _SERVO_DEPLOY]
gcode = 
	{% set item = params.ITEM|string|lower %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_servo_enabled = printer["gcode_macro _USER_VARIABLES"].probe_servo_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% if item == "probe" %}
	{% if verbose %}
	RESPOND MSG="Deploying probe dock using the servo"
	{% endif %}
	
	{% if not probe_servo_enabled %}
	{ action_raise_error("No servo available for probe. Please include one in your config!") }
	{% endif %}
	
	{% set probe_servo_name = printer["gcode_macro _USER_VARIABLES"].probe_servo_name %}
	{% set probe_servo_angle_deployed = printer["gcode_macro _USER_VARIABLES"].probe_servo_angle_deployed %}
	SET_SERVO SERVO={probe_servo_name} ANGLE={probe_servo_angle_deployed}
	G4 P500
	
	{% elif item == "purge" or item == "clean" %}
	{% if verbose %}
	RESPOND MSG="Deploying purge bucket and brush using the servo"
	{% endif %}
	
	{% if not purgeclean_servo_enabled %}
	{ action_raise_error("No servo available for purge or clean. Please include one in your config!") }
	{% endif %}
	
	{% set purgeclean_servo_name = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_name %}
	{% set purgeclean_servo_angle_deployed = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_angle_deployed %}
	SET_SERVO SERVO={purgeclean_servo_name} ANGLE={purgeclean_servo_angle_deployed}
	G4 P500
	
	{% else %}
	{ action_raise_error("Servo ITEM must be specified!") }
	{% endif %}

[gcode_macro _SERVO_RETRACT]
gcode = 
	{% set item = params.ITEM|string|lower %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_servo_enabled = printer["gcode_macro _USER_VARIABLES"].probe_servo_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% if item == "probe" %}
	{% if verbose %}
	RESPOND MSG="Rettracting probe dock using the servo"
	{% endif %}
	
	{% if not probe_servo_enabled %}
	{ action_raise_error("No servo available for probe. Please include one in your config!") }
	{% endif %}
	
	{% set probe_servo_name = printer["gcode_macro _USER_VARIABLES"].probe_servo_name %}
	{% set probe_servo_angle_retracted = printer["gcode_macro _USER_VARIABLES"].probe_servo_angle_retracted %}
	SET_SERVO SERVO={probe_servo_name} ANGLE={probe_servo_angle_retracted}
	G4 P500
	
	{% elif item == "purge" or item == "clean" %}
	{% if verbose %}
	RESPOND MSG="Rettracting purge bucket and brush using the servo"
	{% endif %}
	
	{% if not purgeclean_servo_enabled %}
	{ action_raise_error("No servo available for purge or clean. Please include one in your config!") }
	{% endif %}
	
	{% set purgeclean_servo_name = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_name %}
	{% set purgeclean_servo_angle_retracted = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_angle_retracted %}
	SET_SERVO SERVO={purgeclean_servo_name} ANGLE={purgeclean_servo_angle_retracted}
	G4 P500
	
	{% else %}
	{ action_raise_error("Servo ITEM must be specified!") }
	{% endif %}

[servo purgeservo]
pin = SERVO_PIN
maximum_servo_angle = 90
minimum_pulse_width = 0.0011
maximum_pulse_width = 0.0021

[gcode_macro _SET_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = params.LED|string %}
	{% set idx = (params.IDX|string).split(',') %}
	{% set transmit_last = params.TRANSMIT|default(1) %}
	
	{% for led_index in idx %}
	{% set transmit=transmit_last if loop.last else 0 %}
	SET_LED LED={led} RED={red} GREEN={green} BLUE={blue} WHITE={white} INDEX={led_index} TRANSMIT={transmit}
	{% endfor %}

[gcode_macro _SET_LEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_idx"] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_ALLLEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	SET_LED LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w}  TRANSMIT={transmit}

[gcode_macro _SET_LOGO_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_NOZZLE_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro SET_LOGO_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="logo" COLOR="off" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_ON]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="on" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="off" TRANSMIT={transmit}

[gcode_macro STATUS_LEDS]
gcode = 
	{% set color = params.COLOR|default('off')|lower %}
	
	{% set status_color = {
	'ready': {
	'logo': 'standby',
	'nozzle': 'standby',
	'caselight': 'standby',
	'minidisplay': 'on'
	},
	'busy': {
	'logo': 'busy',
	'nozzle': 'on',
	'caselight': 'busy',
	'minidisplay': 'on'
	},
	'heating': {
	'logo': 'heating',
	'nozzle': 'heating',
	'caselight': 'heating',
	'minidisplay': 'on'
	},
	'leveling': {
	'logo': 'leveling',
	'nozzle': 'on',
	'caselight': 'leveling',
	'minidisplay': 'on'
	},
	'homing': {
	'logo': 'homing',
	'nozzle': 'on',
	'caselight': 'homing',
	'minidisplay': 'on'
	},
	'cleaning': {
	'logo': 'cleaning',
	'nozzle': 'on',
	'caselight': 'cleaning',
	'minidisplay': 'on'
	},
	'meshing': {
	'logo': 'meshing',
	'nozzle': 'on',
	'caselight': 'meshing',
	'minidisplay': 'on'
	},
	'calibrating_z': {
	'logo': 'calibrating_z',
	'nozzle': 'on',
	'caselight': 'calibrating_z',
	'minidisplay': 'on'
	},
	'printing': {
	'logo': 'printing',
	'nozzle': 'on',
	'caselight': 'printing',
	'minidisplay': 'on'
	},
	'off': {
	'logo': 'off',
	'nozzle': 'off',
	'caselight': 'off',
	'minidisplay': 'off'
	},
	'on': {
	'logo': 'on',
	'nozzle': 'on',
	'caselight': 'on',
	'minidisplay': 'on'
	},
	'error': {
	'logo': 'error',
	'nozzle': 'error',
	'caselight': 'error',
	'minidisplay': 'error'
	}
	} %}
	
	{% if not (color in status_color) %}
	{ action_raise_error("COLOR is not valid!") }
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	_SET_LEDS_BY_NAME LEDS="logo" COLOR={status_color[color].logo} TRANSMIT=0
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR={status_color[color].nozzle} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_caselight_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="caselight" COLOR={status_color[color].caselight} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_minidisplay_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="minidisplay" COLOR={status_color[color].minidisplay} TRANSMIT=1
	{% endif %}

[display]
lcd_type = uc1701
cs_pin = EXP1_8
a0_pin = EXP1_7
rst_pin = EXP1_6
encoder_pins = ^EXP2_6, ^EXP2_8
click_pin = ^!EXP1_9
contrast = 63
spi_software_miso_pin = EXP2_10
spi_software_mosi_pin = EXP2_5
spi_software_sclk_pin = EXP2_9

[output_pin beeper]
pin = EXP1_10

[neopixel btt_mini12864]
pin = EXP1_5
chain_count = 3
initial_red = 0.1
initial_green = 0.5
initial_blue = 0.0
color_order = RGB

[delayed_gcode setdisplayneopixel]
initial_duration = 1
gcode = 
	SET_LED LED=btt_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3

[temperature_sensor RaspberryPi]
sensor_type = temperature_host

[temperature_sensor mcu]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 90

[temperature_sensor toolhead_mcu]
sensor_type = temperature_mcu
sensor_mcu = toolhead
min_temp = 0
max_temp = 100

[adxl345]
cs_pin = toolhead:ADXL_CS
spi_software_sclk_pin = toolhead:ADXL_SCLK
spi_software_mosi_pin = toolhead:ADXL_MOSI
spi_software_miso_pin = toolhead:ADXL_MISO
axes_map = x,y,z

[resonance_tester]
accel_chip = adxl345
probe_points = 
	-1,-1,-1

[gcode_macro TEST_RESONANCES]
rename_existing = BASE_TEST_RESONANCES
description = Runs input shaper test at the center of the bed
gcode = 
	{% set Tx, Ty = printer["gcode_macro _USER_VARIABLES"].resonnance_test_point_xy|map('float') %}
	{% set Tz = printer["gcode_macro _USER_VARIABLES"].resonnance_test_z_clearance|float %}
	
	{% if Tx == -1 and Ty == -1 %}
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	BASE_TEST_RESONANCES POINT={max_x / 2},{max_y / 2},{Tz} {rawparams}
	{% else %}
	BASE_TEST_RESONANCES POINT={Tx},{Ty},{Tz} {rawparams}
	{% endif %}

[gcode_macro AXES_SHAPER_CALIBRATION]
description = Run standard input shaper test for all axes
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.3)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=X FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=Y FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=SHAPER

[gcode_macro BELTS_SHAPER_CALIBRATION]
description = Run custom demi-axe test to analyze belts on CoreXY printers
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.33)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=1,1 OUTPUT=raw_data NAME=b FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=a FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=BELTS

[gcode_macro EXCITATE_AXIS_AT_FREQ]
description = Maintain a specified input shaper excitating frequency for some time to diagnose vibrations
gcode = 
	{% set FREQUENCY = params.FREQUENCY|default(25)|int %}
	{% set TIME = params.TIME|default(10)|int %}
	{% set AXIS = params.AXIS|default("x")|string|lower %}
	
	TEST_RESONANCES OUTPUT=raw_data AXIS={AXIS} FREQ_START={FREQUENCY-1} FREQ_END={FREQUENCY+1} HZ_PER_SEC={1/(TIME/3)}
	M400

[gcode_macro VIBRATIONS_CALIBRATION]
gcode = 
	
	
	
	{% set size = params.SIZE|default(60)|int %}
	{% set direction = params.DIRECTION|default('XY') %}
	{% set z_height = params.Z_HEIGHT|default(20)|int %}
	{% set verbose = params.VERBOSE|default(true) %}
	
	{% set min_speed = params.MIN_SPEED|default(20)|int * 60 %}
	{% set max_speed = params.MAX_SPEED|default(200)|int * 60 %}
	{% set speed_increment = params.SPEED_INCREMENT|default(2)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	
	{% set accel_chip = params.ACCEL_CHIP|default("adxl345") %}
	
	
	
	
	{% set mid_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set mid_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% set direction_factor = {
	'XY'  : {
	'start' : {'x': -0.5, 'y': -0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': -0.5, 'y': -0.5, 'z': 0.0 }
	}
	},
	'AB' : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': 0.0, 'y': 0.0, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	},
	'ABXY' : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'B'  : {
	'start' : {'x': 0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'A'  : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'X'  : {
	'start' : {'x': -0.5, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': 0.0, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.0, 'z': 0.0 }
	}
	},
	'Y'  : {
	'start' : {'x': 0.0, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.0, 'y': 0.5, 'z': 0.0 }
	}
	},
	'Z'  : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': 0.0, 'z': 1.0 },
	'1' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	}
	}
	%}
	
	
	
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	{% if (size / (max_speed / 60)) < 0.25 %}
	{ action_raise_error("SIZE is too small for this MAX_SPEED. Increase SIZE or decrease MAX_SPEED!") }
	{% endif %}
	
	{% if not (direction in direction_factor) %}
	{ action_raise_error("DIRECTION is not valid. Only XY, AB, ABXY, A, B, X, Y or Z is allowed!") }
	{% endif %}
	
	{action_respond_info("")}
	{action_respond_info("Starting speed and vibration calibration")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION
	
	G90
	
	
	G1 Z{z_height}
	G1 X{mid_x + (size * direction_factor[direction].start.x) } Y{mid_y + (size * direction_factor[direction].start.y)} F{feedrate_travel}
	
	
	{% for curr_speed in range(min_speed, max_speed + speed_increment) %}
	{% if (curr_speed - min_speed) % speed_increment == 0 %}
	{% if verbose %}
	RESPOND MSG="Current speed: {(curr_speed / 60)|int} mm/s"
	{% endif %}
	
	ACCELEROMETER_MEASURE CHIP={accel_chip}
	{% for key, factor in direction_factor[direction].move_factors|dictsort %}
	G1 X{mid_x + (size * factor.x) } Y{mid_y + (size * factor.y)} Z{z_height + (size * factor.z)} F{curr_speed}
	{% endfor %}
	ACCELEROMETER_MEASURE CHIP={accel_chip} NAME=sp{(curr_speed / 60)|int}n1
	
	G4 P300
	M400
	{% endif %}
	{% endfor %}
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS="VIBRATIONS {direction}"
	
	RESTORE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = _BASE_BED_MESH_CALIBRATE
description = Perform Mesh Bed Leveling with klicky automount
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if verbose %}
	{ action_respond_info("Bed Mesh Calibrate") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	_BASE_BED_MESH_CALIBRATE  {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	DEACTIVATE_PROBE

[gcode_macro _ADAPTIVE_MESH_VARIABLES]
variable_ready = False
variable_do_mesh = False
variable_do_nominal = False
variable_mesh_min = 0,0
variable_mesh_max = 0,0
variable_mesh_center = 0,0
variable_probe_count = 0,0
variable_rri = 0
variable_algo = "bicubic"
gcode = 

[gcode_macro COMPUTE_MESH_PARAMETERS]
description = Compute the mesh parameters and store them for later use
gcode = 
	
	{% set xMinConf, yMinConf = printer["configfile"].config["bed_mesh"]["mesh_min"].split(',')|map('trim')|map('int') %}
	{% set xMaxConf, yMaxConf = printer["configfile"].config["bed_mesh"]["mesh_max"].split(',')|map('trim')|map('int') %}
	{% set xProbeCntConf, yProbeCntConf = printer["configfile"].config["bed_mesh"]["probe_count"].split(',')|map('trim')|map('int') %}
	{% set algo = printer["configfile"].config["bed_mesh"]["algorithm"]|lower %}
	{% set xMeshPPS, yMeshPPS = (printer["configfile"].config["bed_mesh"]["mesh_pps"]|default('2,2')).split(',')|map('trim')|map('int') %}
	
	{% set margin = params.MARGIN|default(5)|int %}
	{% set force_mesh = params.FORCE_MESH|default(False) %}
	
	
	
	
	{% if params.SIZE is defined and params.SIZE != "0_0_0_0" %}
	RESPOND MSG="Got a SIZE parameter for the adaptive bed mesh"
	{% set xMinSpec, yMinSpec, xMaxSpec, yMaxSpec = params.SIZE.split('_')|map('trim')|map('int') %}
	
	{% elif printer.exclude_object.objects %}
	
	
	RESPOND MSG="No SIZE parameter, using the [exclude_object] tags for the adaptive bed mesh"
	{% set eo_points = printer.exclude_object.objects|map(attribute='polygon')|sum(start=[]) %}
	{% set xMinSpec = eo_points|map(attribute=0)|min %}
	{% set yMinSpec = eo_points|map(attribute=1)|min %}
	{% set xMaxSpec = eo_points|map(attribute=0)|max %}
	{% set yMaxSpec = eo_points|map(attribute=1)|max %}
	
	{% else %}
	
	
	RESPOND MSG="No info about the first layer coordinates, doing a nominal bed mesh instead of adaptive"
	{% endif %}
	
	
	
	
	{% if xMinSpec and yMinSpec and xMaxSpec and yMaxSpec %}
	
	
	
	
	{% set xMin = [xMinConf, (xMinSpec - margin)]|max %}
	{% set xMax = [xMaxConf, (xMaxSpec + margin)]|min %}
	{% set yMin = [yMinConf, (yMinSpec - margin)]|max %}
	{% set yMax = [yMaxConf, (yMaxSpec + margin)]|min %}
	
	
	
	
	{% set xProbeCnt = ((xMax - xMin) * xProbeCntConf / (xMaxConf - xMinConf))|round(0, 'ceil')|int %}
	{% set yProbeCnt = ((yMax - yMin) * yProbeCntConf / (yMaxConf - yMinConf))|round(0, 'ceil')|int %}
	
	
	
	
	
	
	
	
	{% if xProbeCnt < 3 and yProbeCnt < 3 %}
	{% if force_mesh %}
	RESPOND MSG="Bed mesh forced (small part detected): meshing 3x3..."
	{% set xProbeCnt = 3 %}
	{% set yProbeCnt = 3 %}
	{% set rRefIndex = 4 %}
	{% set algo = "lagrange" %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% else %}
	RESPOND MSG="Computed mesh parameters: none, bed mesh not needed for very small parts"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={False}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	{% else %}
	{% set xProbeCnt = [3, xProbeCnt]|max %}
	{% set yProbeCnt = [3, yProbeCnt]|max %}
	
	
	
	{% if xProbeCnt % 2 == 0 %}
	{% set xProbeCnt = xProbeCnt + 1 %}
	{% endif %}
	{% if yProbeCnt % 2 == 0 %}
	{% set yProbeCnt = yProbeCnt + 1 %}
	{% endif %}
	
	
	{% if xMeshPPS != 0 or yMeshPPS != 0 %}
	{% set probeCntMin = [xProbeCnt, yProbeCnt]|min %}
	{% set probeCntMax = [xProbeCnt, yProbeCnt]|max %}
	{% if algo == "lagrange" and probeCntMax > 6 %}
	
	{% set algo = "bicubic" %}
	{% endif %}
	{% if algo == "bicubic" and probeCntMin < 4 %}
	{% if probeCntMax > 6 %}
	
	{% if xProbeCnt > yProbeCnt %}
	{% set yProbeCnt = 5 %}
	{% else %}
	{% set xProbeCnt = 5 %}
	{% endif %}
	{% else %}
	
	{% set algo = "lagrange" %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	{% set rRefIndex = (((xProbeCnt * yProbeCnt) - 1) / 2)|int %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	
	
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% endif %}
	{% else %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={True}
	
	{% set xCenter = xMinConf + ((xMaxConf - xMinConf) / 2) %}
	{% set yCenter = yMinConf + ((yMaxConf - yMinConf) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={True}

[gcode_macro ADAPTIVE_BED_MESH]
description = Perform a bed mesh, but only where and when it's needed
gcode = 
	{% set ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	
	{% if ready %}
	_DO_ADAPTIVE_MESH
	
	
	
	{% else %}
	RESPOND MSG="Adaptive bed mesh: parameters not already computed, automatically calling the COMPUTE_MESH_PARAMETERS macro prior to the mesh"
	COMPUTE_MESH_PARAMETERS {rawparams}
	M400
	_DO_ADAPTIVE_MESH
	{% endif %}

[gcode_macro _DO_ADAPTIVE_MESH]
gcode = 
	
	{% set do_mesh = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_mesh %}
	{% set do_nominal = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_nominal %}
	{% set mesh_min = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_min %}
	{% set mesh_max = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_max %}
	{% set probe_count = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].probe_count %}
	{% set rRefIndex = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].rri %}
	{% set algo = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].algo %}
	
	
	
	
	{% if do_mesh %}
	
	{% if do_nominal %}
	RESPOND MSG="Adaptive bed mesh: nominal bed mesh"
	BED_MESH_CALIBRATE
	{% else %}
	{% if printer["configfile"].config["bed_mesh"]["relative_reference_index"] is defined %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}
	{% endif %}
	{% endif %}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: no mesh to be done"
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={False}

[bed_mesh]
speed = 350
horizontal_move_z = 12
mesh_min = 25, 25
mesh_max = 325, 325
probe_count = 9, 9
fade_start = 0.6
fade_end = 10.0
algorithm = bicubic
relative_reference_index = 40

[tmc2209 stepper_x]
diag_pin = ^X_STOP
driver_sgthrs = 50
uart_pin = X_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_y]
diag_pin = ^Y_STOP
driver_sgthrs = 60
uart_pin = Y_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[input_shaper]
shaper_freq_x = 56.4
shaper_type_x = zv
shaper_freq_y = 38.4
shaper_type_y = mzv

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing = _BASE_QUAD_GANTRY_LEVEL
description = Conform a moving, twistable gantry to the shape of a stationary bed with klicky automount
gcode = 
	{% set tilting_travel_accel = printer["gcode_macro _USER_VARIABLES"].tilting_travel_accel %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if verbose %}
	{ action_respond_info("Quad gantry leveling") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{tilting_travel_accel}
	
	_BASE_QUAD_GANTRY_LEVEL {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	DEACTIVATE_PROBE

[gcode_macro _TILT_CALIBRATE]
description = Do a QGL, Z_tilt, etc... depending of the machine configuration
gcode = 
	{% set FORCE_OPERATION = params.FORCE|default(true) %}
	{% set conf_QGL = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set conf_ztilt = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="LEVELING"
	{% endif %}
	
	{% if conf_QGL %}
	{% if printer.quad_gantry_level.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="QGL..."
	{% endif %}
	QUAD_GANTRY_LEVEL
	{% endif %}
	{% elif conf_ztilt %}
	{% if printer.z_tilt.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="Z tilt adjust..."
	{% endif %}
	Z_TILT_ADJUST
	{% endif %}
	{% else %}
	{% if verbose %}
	RESPOND MSG="No tilt calibration needed on this machine. Continuing..."
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[quad_gantry_level]
gantry_corners = 
	-60,-10
	410,420
points = 
	50,25
	50,275
	300,275
	300,25
speed = 350
horizontal_move_z = 12
retries = 5
retry_tolerance = 0.0075
max_adjust = 10

[virtual_sdcard]
path = ~/printer_data/gcodes
on_error_gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	STATUS_LEDS COLOR="ERROR"
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	_PROBE_ON_ERROR_ACTION
	{% endif %}

[exclude_object]

[idle_timeout]
timeout = 1800

[pause_resume]

[display_status]

[respond]

[force_move]
enable_force_move = True

[gcode_arcs]
resolution = 0.1

[gcode_macro CANCEL_PRINT]
rename_existing = BASE_CANCEL_PRINT
description = Cancel the print, retract 10mm of filament and park
gcode = 
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload_on_cancel_print = printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_cancel_print %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload_on_cancel_print %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	SDCARD_RESET_FILE
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_OFF
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}
	
	BASE_CANCEL_PRINT

[gcode_macro END_PRINT]
description = Stop the print and filter the atmosphere for 10min before shuting down
gcode = 
	{% set disable_motors_in_end_print = printer["gcode_macro _USER_VARIABLES"].disable_motors_in_end_print %}
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set light_intensity_end_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_end_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload = params.ERCF_UNLOAD_AT_END|default(printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_end_print)|int %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G92 E0
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if disable_motors_in_end_print %}
	M84
	{% endif %}
	
	
	
	
	{% if filter_enabled %}
	{% set FILTER_TIME = params.FILTER_TIME|default(600)|int %}
	START_FILTER SPEED=1
	UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED DURATION={FILTER_TIME}
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_end_print}
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}

[gcode_macro PARK]
description = Park the toolhead at the back and retract some filament if the nozzle is hot
gcode = 
	{% set E = params.E|default(1.7)|float %}
	
	{% set Px, Py = printer["gcode_macro _USER_VARIABLES"].park_position_xy|map('float') %}
	{% set park_lift_z = printer["gcode_macro _USER_VARIABLES"].park_lift_z %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	
	{% set z_safe = act_z + park_lift_z %}
	{% if z_safe > max_z %}
	{% set z_safe = max_z %}
	{% endif %}
	
	
	{% if printer.extruder.temperature > 185 and firmware_retraction_enabled %}
	G10
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	G0 X{Px} Y{Py} F{St}

[gcode_macro PAUSE]
rename_existing = BASE_PAUSE
description = Pause the print and park
gcode = 
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	
	{% if printer.pause_resume.is_paused %}
	RESPOND MSG="Print is already paused"
	{% else %}
	SAVE_GCODE_STATE NAME=PAUSE_state
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	BASE_PAUSE
	PARK
	{% endif %}

[gcode_macro RESUME]
rename_existing = BASE_RESUME
description = Resume the print after an optional unretract
gcode = 
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	
	{% if not printer.pause_resume.is_paused %}
	RESPOND MSG="Print is not paused. Resume ignored"
	{% else %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={St}
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	BASE_RESUME
	{% endif %}

[gcode_macro START_PRINT]
description = Machine heatup procedure before starting a print
variable_bed_temp = 0
variable_extruder_temp = 0
variable_z_adjust = 0
variable_soak = 0
variable_chamber_temp = 0
variable_chamber_maxtime = 0
variable_initial_tool = 0
variable_material = "XXX"
variable_fl_size = "0_0_0_0"
gcode = 
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_ADJUST = params.Z_ADJUST|default(0)|float %}
	{% set SOAK = params.SOAK|default(printer["gcode_macro _USER_VARIABLES"].print_default_soak)|int %}
	{% set CHAMBER_TEMP = params.CHAMBER|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_temp)|int %}
	{% set CHAMBER_MAXTIME = params.CHAMBER_MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	{% set INITIAL_TOOL = params.INITIAL_TOOL|default(0)|int %}
	{% set MATERIAL = params.MATERIAL|default(printer["gcode_macro _USER_VARIABLES"].print_default_material)|string %}
	{% set FL_SIZE = params.SIZE|default("0_0_0_0")|string %}
	
	
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=bed_temp VALUE={BED_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=extruder_temp VALUE={EXTRUDER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=soak VALUE={SOAK}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_temp VALUE={CHAMBER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_maxtime VALUE={CHAMBER_MAXTIME}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=initial_tool VALUE={INITIAL_TOOL}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=material VALUE='"{MATERIAL}"'
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=fl_size VALUE='"{FL_SIZE}"'
	
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_reset_stats_on_start_print = printer["gcode_macro _USER_VARIABLES"].ercf_reset_stats_on_start_print %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% if MATERIAL not in printer["gcode_macro _USER_VARIABLES"].material_parameters %}
	RESPOND MSG="Material '{MATERIAL}' is unknown!"
	{ action_raise_error("Add this new material to your material_parameters variable!") }
	{% else %}
	RESPOND MSG="Material '{MATERIAL}' is used"
	{% set material = printer["gcode_macro _USER_VARIABLES"].material_parameters[MATERIAL] %}
	{% endif %}
	
	
	
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="BUSY"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if ercf_reset_stats_on_start_print %}
	ERCF_RESET_STATS
	{% endif %}
	{% endif %}
	{% endif %}
	
	SET_GCODE_OFFSET Z=0
	M221 S100
	M220 S100
	G90
	M83
	
	
	{% if firmware_retraction_enabled %}
	SET_RETRACTION RETRACT_LENGTH={material.retract_length} RETRACT_SPEED={material.retract_speed} UNRETRACT_EXTRA_LENGTH={material.unretract_extra_length} UNRETRACT_SPEED={material.unretract_speed}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={material.pressure_advance}
	
	
	{% if force_homing_in_start_print %}
	G28
	{% else %}
	_CG28
	{% endif %}
	
	
	
	{% set sp_actions = printer["gcode_macro _USER_VARIABLES"].startprint_actions %}
	{% for action in sp_actions %}
	{% if action == "bed_soak" %}
	_MODULE_HEATSOAK_BED
	{% elif action == "chamber_soak" %}
	_MODULE_HEATSOAK_CHAMBER
	{% elif action == "tilt_calib" %}
	_MODULE_TILTING
	{% elif action == "extruder_heating" %}
	_MODULE_EXTRUDER_HEATING
	{% elif action == "purge" %}
	_MODULE_PURGE
	{% elif action == "clean" %}
	_MODULE_CLEAN
	{% elif action == "z_offset" %}
	_MODULE_Z_CALIB
	{% elif action == "bedmesh" %}
	_MODULE_BED_MESH
	{% elif action == "primeline" %}
	_MODULE_PRIMELINE
	{% elif action == "extruder_preheating" %}
	_MODULE_EXTRUDER_PREHEATING
	{% elif action == "custom1" %}
	_MODULE_CUSTOM1
	{% elif action == "custom2" %}
	_MODULE_CUSTOM2
	{% elif action == "custom3" %}
	_MODULE_CUSTOM3
	{% else %}
	{ action_raise_error("Unknown module called in START_PRINT! Please verify your startprint_actions variable override!") }
	{% endif %}
	{% endfor %}
	
	
	
	SET_GCODE_OFFSET Z_ADJUST={Z_ADJUST} MOVE=1
	
	
	SET_GCODE_OFFSET Z_ADJUST={material.additional_z_offset} MOVE=1
	{% if filter_enabled %}
	START_FILTER SPEED={material.filter_speed / 100}
	{% endif %}
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="PRINTING"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Start printing !"
	{% endif %}
	
	G92 E0.0

[gcode_macro _MODULE_PRIMELINE]
gcode = 
	PRIMELINE

[gcode_macro _MODULE_HEATSOAK_BED]
gcode = 
	
	
	
	
	
	{% set BED_TEMP = printer["gcode_macro START_PRINT"].bed_temp %}
	{% set SOAK = printer["gcode_macro START_PRINT"].soak %}
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if printer.heater_bed.target < (BED_TEMP - 8) %}
	
	
	{% if (CHAMBER_TEMP > 0) and filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	{% if SOAK > 0 %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME={SOAK}
	{% else %}
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME=0
	{% endif %}

[gcode_macro _MODULE_HEATSOAK_CHAMBER]
gcode = 
	
	
	
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	{% set CHAMBER_MAXTIME = printer["gcode_macro START_PRINT"].chamber_maxtime %}
	
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if chamber_sensor_enabled %}
	{% if CHAMBER_TEMP > 0 %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	
	{% if CURRENT_TEMP <= CHAMBER_TEMP %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	
	
	{% if filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	HEATSOAK_CHAMBER TEMP={CHAMBER_TEMP} MAXTIME={CHAMBER_MAXTIME}
	
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_TILTING]
gcode = 
	
	
	
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	_TILT_CALIBRATE FORCE={force_homing_in_start_print}

[gcode_macro _MODULE_EXTRUDER_HEATING]
gcode = 
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	{% set INITIAL_TOOL = printer["gcode_macro START_PRINT"].initial_tool %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder heating to print temperature..."
	{% endif %}
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET
	{% if not purge_and_brush_enabled %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	M109 S{EXTRUDER_TEMP}
	
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	ERCF_CHANGE_TOOL STANDALONE=1 TOOL={INITIAL_TOOL}
	_ERCF_ERROR_CHECK
	{% endif %}
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder temperature OK"
	{% endif %}

[gcode_macro _MODULE_PURGE]
gcode = 
	
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	
	{% if purge_and_brush_enabled %}
	PURGE TEMP={EXTRUDER_TEMP}
	{% endif %}

[gcode_macro _MODULE_CLEAN]
gcode = 
	
	
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set force_homing_before_brush = printer["gcode_macro _USER_VARIABLES"].force_homing_before_brush %}
	
	{% if purge_and_brush_enabled %}
	{% if force_homing_before_brush %}
	G28 Z
	{% endif %}
	CLEAN_NOZZLE
	{% endif %}

[gcode_macro _MODULE_Z_CALIB]
gcode = 
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% if bed_mesh_enabled and printer.bed_mesh.profile_name == "" %}
	COMPUTE_MESH_PARAMETERS SIZE={FL_SIZE}
	{% endif %}
	
	{% if zcalib_plugin_enabled %}
	G28 Z
	CALIBRATE_Z
	{% else %}
	G28 Z
	{% endif %}

[gcode_macro _MODULE_BED_MESH]
gcode = 
	
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if bed_mesh_enabled %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="MESHING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Bed mesh measurement..."
	{% endif %}
	
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	ADAPTIVE_BED_MESH
	{% else %}
	ADAPTIVE_BED_MESH SIZE={FL_SIZE}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_EXTRUDER_PREHEATING]
gcode = 
	
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Pre-heating the nozzle to a safe temperature..."
	{% endif %}
	
	M109 S{safe_extruder_temp}
	
	{% if verbose %}
	RESPOND MSG="Extruder at safe temperature of {safe_extruder_temp} degrees"
	{% endif %}

[gcode_macro _MODULE_CUSTOM1]
gcode = 

[gcode_macro _MODULE_CUSTOM2]
gcode = 

[gcode_macro _MODULE_CUSTOM3]
gcode = 

[gcode_macro _CG28]
description = Homing only if necessary
gcode = 
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	{% if "xyz" not in printer.toolhead.homed_axes %}
	G28
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[homing_override]
axes = xyz
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set homing_zhop = printer["gcode_macro _USER_VARIABLES"].homing_zhop|float %}
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed * 60 %}
	{% set homing_travel_accel = printer["gcode_macro _USER_VARIABLES"].homing_travel_accel %}
	{% set sensorless_homing_enabled = printer["gcode_macro _USER_VARIABLES"].sensorless_homing_enabled %}
	{% set sensorless_current_factor = printer["gcode_macro _USER_VARIABLES"].sensorless_current_factor / 100 %}
	{% set z_drop_speed = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% set homing_first = printer["gcode_macro _USER_VARIABLES"].homing_first|string|upper %}
	{% set x_homing_backoff, y_homing_backoff = printer["gcode_macro _USER_VARIABLES"].homing_backoff_distance_xy|map('float') %}
	
	{% set x_position_endstop = printer["configfile"].config["stepper_x"]["position_endstop"]|float %}
	{% set y_position_endstop = printer["configfile"].config["stepper_y"]["position_endstop"]|float %}
	{% set x_position_center = printer.toolhead.axis_maximum.x|int/2 - printer.toolhead.axis_minimum.x|int/2 %}
	{% set y_position_center = printer.toolhead.axis_maximum.y|int/2 - printer.toolhead.axis_minimum.y|int/2 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	{% set X, Y, Z = False, False, False %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	
	{% if not 'X' in params
	and not 'Y' in params
	and not 'Z' in params %}
	
	{% set X, Y, Z = True, True, True %}
	
	{% else %}
	{% if 'X' in params %}
	{% set X = True %}
	{% endif %}
	
	{% if 'Y' in params %}
	{% set Y = True %}
	{% endif %}
	
	{% if 'Z' in params %}
	{% set Z = True %}
	{% endif %}
	
	{% if 'X' in params
	and 'Y' in params
	and 'Z' in params %}
	
	
	_HOMING_VARIABLES reset=1
	{% endif %}
	
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_ENTRY_POINT FUNCTION=homing_override
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{homing_travel_accel}
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	G90
	
	{% if Z %}
	{% if ('z' in printer.toolhead.homed_axes) %}
	{% if (printer.toolhead.position.z < homing_zhop) %}
	{% if verbose %}
	{ action_respond_info("Z too low, performing ZHOP") }
	{% endif %}
	G0 Z{homing_zhop} F{z_drop_speed}
	{% endif %}
	{% elif ('xy' in printer.toolhead.homed_axes) %}
	{% if verbose %}
	{ action_respond_info("X and Y already homed, no ZHOP needed to home Z") }
	{% endif %}
	{% else %}
	{% if verbose %}
	{ action_respond_info("X and Y not homed, forcing full G28 to home Z properly") }
	{% endif %}
	SET_KINEMATIC_POSITION X=0 Y=0 Z=0
	G0 Z{homing_zhop} F{z_drop_speed}
	{% set X, Y, Z = True, True, True %}
	{% endif %}
	{% endif %}
	
	{% if homing_first == "X" %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% elif homing_first == "Y" %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% else %}
	{ action_respond_error("Axis homing order not valid. Choose either X or Y first in the variables.cfg file!") }
	{% endif %}
	
	
	
	{% if Z %}
	{% if verbose %}
	{ action_respond_info("Homing Z") }
	{% endif %}
	
	
	
	
	
	
	{% if printer["configfile"].config["stepper_z"]["endstop_pin"]|lower == "probe:z_virtual_endstop" %}
	
	{% if probe_type_enabled == "dockable_virtual" %}
	ACTIVATE_PROBE
	{% endif %}
	{% if bed_mesh_enabled %}
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	{% set mesh_center = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_center %}
	{% set x_mesh_center, y_mesh_center = mesh_center.split(',')|map('trim')|map('float') %}
	RESPOND MSG="Z homing: a mesh is computed and ready, probing mesh center: {mesh_center}"
	G0 X{x_mesh_center} Y{y_mesh_center} F{homing_travel_speed}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	
	
	{% else %}
	_GOTO_Z_PROBE
	{% endif %}
	
	
	{% if probe_type_enabled == "vorontap" %}
	ACTIVATE_PROBE
	{% endif %}
	
	G28 Z0
	
	G91
	G0 Z{homing_zhop} F{z_drop_speed}
	G90
	
	
	
	{% if probe_type_enabled == "vorontap" or probe_type_enabled == "dockable_virtual" %}
	DEACTIVATE_PROBE
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_EXIT_POINT FUNCTION=homing_override
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _GOTO_Z_PROBE]
description = Move to z probe avoiding the probe dock
gcode = 
	
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% if zcalib_plugin_enabled %}
	{% set z_endstop_x, z_endstop_y = printer["configfile"].config["z_calibration"]["nozzle_xy_position"].split(',')|map('trim')|map('float') %}
	{% else %}
	{% set z_endstop_x, z_endstop_y = printer["gcode_macro _USER_VARIABLES"].zendstop_position|map('float') %}
	{% endif %}
	
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed|float * 60 %}
	
	{% set probe_dock_location_x, probe_dock_location_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_location_xy|map('float') %}
	{% set probe_dock_margin_x, probe_dock_margin_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_margin_xy|map('float') %}
	
	{% set current_x = printer.toolhead.position.x|float %}
	{% set current_y = printer.toolhead.position.y|float %}
	
	SAVE_GCODE_STATE NAME=goto_ZProbe
	G90
	
	
	{% set avoid_dock = false %}
	{% if probe_dock_location_x < z_endstop_x|float %}
	
	
	{% if current_x < (probe_dock_location_x + probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% else %}
	
	
	{% if current_x > (probe_dock_location_x - probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% endif %}
	
	
	{% if avoid_dock == true  %}
	
	G0 Y{probe_dock_location_y - probe_dock_margin_y} F{homing_travel_speed}
	
	G0 X{z_endstop_x} F{homing_travel_speed}
	{% endif %}
	
	G0 X{z_endstop_x} Y{z_endstop_y} F{homing_travel_speed}
	
	RESTORE_GCODE_STATE NAME=goto_ZProbe

[gcode_macro CALIBRATE]
description = Calibrate the printer flow or pressure advance
gcode = 
	
	{% set TYPE = params.TYPE|default("")|string|lower %}
	
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set MATERIAL = params.MATERIAL|default("ABS")|string %}
	
	{% set center_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set center_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% if TYPE=="flow" %}
	
	{% set computed_size = (center_x - 20)|string + '_' + (center_y - 20)|string + '_' + (center_x + 20)|string + '_' + (center_y + 20)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	FLOW_MULTIPLIER_CALIBRATION EXTRUSION_WIDTH=0.471
	END_PRINT FILTER_TIME=0
	
	{% elif TYPE=="pressure_advance" %}
	
	{% set computed_size = (center_x - 60)|string + '_' + (center_y - 60)|string + '_' + (center_x + 60)|string + '_' + (center_y + 60)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	PRESSURE_ADVANCE_CALIBRATION
	END_PRINT FILTER_TIME=0
	
	{% else %}
	{action_respond_info("Please call this macro using TYPE= \"flow\" or \"pressure_advance\"")}
	{action_raise_error("not enough parameters to start a calibration!")}
	
	{% endif %}

[gcode_macro _FLOW_CALIB_VARIABLES]
variable_last_shell_thickness = 0.0
variable_last_evalue = 0.0
gcode = 

[gcode_macro FLOW_MULTIPLIER_CALIBRATION]
description = Print a small tower to calibrate the extrusion flow multiplier by measuring the shell
gcode = 
	
	
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	{% set do_retract = params.DO_RECTRACT|default(0)|int %}
	{% set print_size = params.PRINT_SIZE|default(40)|int %}
	{% set print_height = params.HEIGHT|default(15)|int %}
	{% set corner_radius = params.CORNER_RADIUS|default(8)|int %}
	{% set number_of_perimeters = params.PERIMETERS|default(2)|int %}
	{% set fan_speed = params.FAN_SPEED|default(20)|int %}
	
	{% set e_multiplier = params.EXTRUSION_MULTIPLIER|default(1.00)|float %}
	{% set filament_diameter = params.FILAMENT_DIAMETER|default(1.75)|float %}
	{% set extrusion_width = params.EXTRUSION_WIDTH|default(0.4)|float %}
	{% set layer_height = params.LAYER_HEIGHT|default(0.2)|float %}
	
	{% set retract_length = params.RETRACT_LENGTH|default(0.5)|float %}
	{% set initial_purge = params.PURGE_MM|default(1)|int %}
	{% set z_hop_height  = 2 * layer_height %}
	
	{% set feedrate_print = params.CONTROL_SPEED|default(100)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft = params.RAFT_SPEED|default(60)|int * 60 %}
	{% set feedrate_z = params.Z_LIFT_SPEED|default(20)|int * 60 %}
	{% set feedrate_retract = params.RETRACT_SPEED|default(50)|int * 60 %}
	
	
	
	
	{% set e_per_mm = ((extrusion_width - layer_height) * layer_height + 3.14159 * (layer_height / 2)**2) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set spacing = extrusion_width - layer_height * (1 - 3.14159 / 4) %}
	{% set shell_thickness = extrusion_width + (number_of_perimeters|float - 1) * spacing %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set x_start = max_x / 2 - print_size / 2 %}
	{% set y_start = max_y / 2 - print_size / 2 %}
	{% set x_end = x_start + print_size %}
	{% set y_end = y_start + print_size %}
	
	{% set num_raft_lines = ([print_size, max_x]|min / spacing)|round(0, 'floor')|int %}
	{% set raft_size = num_raft_lines * spacing %}
	
	
	
	
	{action_respond_info("")}
	{action_respond_info("Starting extrusion flow calibration print")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	{action_respond_info("Exrusion multiplier used: %.4f" % e_multiplier)}
	{action_respond_info("Number of perimeters to print: %d" % number_of_perimeters)}
	{action_respond_info("THEORIC SHELL THICKNESS: %.4f" % shell_thickness)}
	{action_respond_info("")}
	{action_respond_info("Measure the shell thickness using a caliper or micrometer. Then call the computation macro with the measured value:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION
	
	
	
	
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_shell_thickness VALUE={shell_thickness}
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_evalue VALUE={e_multiplier}
	
	
	
	
	G90
	M83
	G92 E0.0
	G0 X{x_start} Y{y_start - 5} Z{layer_height} F{feedrate_travel}
	
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{raft_size} E{raft_size * e_per_mm * 1.5} F{feedrate_raft / 2}
	G1 Y-{extrusion_width} E{extrusion_width * e_per_mm} F{feedrate_raft / 2}
	G1 X-{raft_size} E{raft_size * e_per_mm} F{feedrate_raft / 2}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G90
	G0 X{x_start} Y{y_start} F{feedrate_travel}
	G1 Z{layer_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	
	
	M221 S{e_multiplier * 100}
	
	
	
	
	{% if do_raft == 1 %}
	G91
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	G1 Y{loop.cycle(1.0, -1.0) * raft_size} E{raft_size * e_per_mm} F{feedrate_raft}
	
	
	{% if not loop.last %}
	G1 X{spacing} E{spacing * e_per_mm} F{feedrate_raft}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	
	
	
	
	G90
	M106 S{fan_speed * 255 / 100}
	
	
	{% for curr_layer in range(1, (print_height / layer_height)|round|int) %}
	G0 X{x_start + corner_radius} Y{y_start} F{feedrate_travel}
	G1 Z{(curr_layer * layer_height) + (layer_height if do_raft == 1 else 0)} F{feedrate_z}
	
	
	{% for perim_num in range(number_of_perimeters) %}
	
	{% set perim_offset = perim_num * spacing %}
	{% set perim_radius = corner_radius - (perim_num * spacing) %}
	
	
	G1 X{x_start + corner_radius} Y{y_start + perim_offset} F{feedrate_travel}
	{% if do_retract == 1 %}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	
	
	G1 X{x_end - corner_radius} Y{y_start + perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - perim_offset} Y{y_start + corner_radius} J{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_end - perim_offset} Y{y_end - corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - corner_radius} Y{y_end - perim_offset} I-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + corner_radius} Y{y_end - perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + perim_offset} Y{y_end - corner_radius} J-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + perim_offset} Y{y_start + corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + corner_radius} Y{y_start + perim_offset} I{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	
	{% if do_retract == 1 %}
	G1 E-{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	
	{% if do_retract == 1 %}
	G91
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G91
	G0 Z20 F{feedrate_travel}
	
	RESTORE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION

[gcode_macro COMPUTE_FLOW_MULTIPLIER]
description = Compute a new flow multiplier by using the measured shell thickness on the calibration print
gcode = 
	{% set evalue = params.OLD_EXTRUSION_MULTIPLIER|default(0.0)|float %}
	{% set theorical_thickness = params.THEORICAL_THICKNESS|default(0.0)|float %}
	{% set measured_thickness = params.MEASURED_THICKNESS|default(0.0)|float %}
	
	
	{% if evalue == 0.0 %}
	{% set last_evalue = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_evalue %}
	
	
	{% if last_evalue == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_evalue = last_evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	{% else %}
	{% set final_evalue = evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	
	
	{% if theorical_thickness == 0.0 %}
	{% set last_shell_thickness = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_shell_thickness %}
	
	
	{% if last_shell_thickness == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_theorical_thickness = last_shell_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	{% else %}
	{% set final_theorical_thickness = theorical_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	
	
	{% if measured_thickness == 0.0 %}
	{action_respond_info("You must use a caliper or micrometer to measure the calibration print shell thickness and call this macro with the measured value !!!")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set new_evalue = final_theorical_thickness * final_evalue / measured_thickness %}
	{action_respond_info("NEW COMPUTED FLOW VALUE: %.3f" % new_evalue)}
	{action_respond_info("Use this new value as extrusion multiplier in your slicer of choice")}
	{action_respond_info("")}
	{% endif %}

[gcode_macro PRESSURE_ADVANCE_CALIBRATION]
description = Calibrate the pressure advance by printing a grid pattern
gcode = 
	
	
	
	{% set pa_start     = params.START|default(0.02)|float %}
	{% set pa_increment = params.INCREMENT|default(0.005)|float %}
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	
	{% set print_size      = params.PRINT_SIZE|default(120)|int %}
	{% set num_bands       = params.BANDS_LIMIT|default(999)|int %}
	{% set lines_per_band  = params.LINES_PER_BAND|default(6)|int %}
	{% set e_multiplier    = params.EXTRUSION_MULTIPLIER|default(1.25 if do_raft == 1 else 1.5)|float %},
	{% set retract_length  = params.RETRACT_LENGTH|default(0.6)|float %}
	{% set initial_purge   = params.PURGE_MM|default(8)|int %}
	
	{% set feedrate_control = params.CONTROL_SPEED|default(30)|int * 60 %}
	{% set feedrate_outer   = params.OUTER_SPEED|default(40)|int * 60 %}
	{% set feedrate_inner   = params.INNER_SPEED|default(120)|int * 60 %}
	{% set feedrate_travel  = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft    = params.RAFT_SPEED|default(120)|int * 60 %}
	{% set feedrate_z       = 5 * 60 %}
	{% set feedrate_retract = 50 * 60 %}
	
	{% set spacing_line  = params.LINE_SPACING|default(0.4)|float %}
	{% set spacing_band  = 2 %}
	{% set spacing_raft  = 2 %}
	
	{% set fast_line_ratio_percent = 50 %}
	
	{% set lines_per_band    = [2, lines_per_band]|max %}
	{% set e_multiplier      = [1, e_multiplier]|max %}
	{% set num_lines_control = (lines_per_band / 2)|round(0, 'floor')|int %}
	{% set num_lines_test    = (lines_per_band / 2)|round(0, 'ceil')|int %}
	{% set spacing_line      = spacing_line * (1 + e_multiplier - 1.25) %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set nozzle_diameter = printer.configfile.config['extruder'].nozzle_diameter|float %}
	{% set line_width    = nozzle_diameter * 1.25 %}
	{% set line_height   = nozzle_diameter / 2 %}
	{% set z_hop_height  = 2 * line_height %}
	{% set e_per_mm      = (line_width * line_height) / (3.1415 * (1.75/2)**2) %}
	{% set spacing_purge = line_height * 0.8 %}
	
	{% set spacing_raft   = (spacing_raft / line_width)|round * line_width %}
	{% set num_raft_lines = ([print_size, max_x]|min / spacing_raft)|round(0, 'floor')|int %}
	{% set print_width    = num_raft_lines * spacing_raft %}
	
	{% set band_height      = lines_per_band * line_width + (lines_per_band - 1) * spacing_line + spacing_band %}
	{% set bands_per_height = (([print_size, max_y]|min  - spacing_purge - 2 * line_width + spacing_band) / band_height)|round(0, 'floor')|int %}
	{% set num_bands        = [num_bands, bands_per_height]|min %}
	{% set print_height     = num_bands * band_height - spacing_band + spacing_purge +  2 * line_width %}
	
	{% set slow_line_length = ((print_width * (1 - fast_line_ratio_percent / 100) / 2) / spacing_raft)|round * spacing_raft + spacing_raft / 2 %}
	{% set fast_line_length = print_width - slow_line_length * 2 %}
	{% set thick_raft_num1 = (slow_line_length / spacing_raft)|round|int %}
	{% set thick_raft_num2  = num_raft_lines - thick_raft_num1 + 1 %}
	
	{% set x_start = max_x / 2 - print_width  / 2 %}
	{% set y_start = max_y / 2 - print_height / 2 %}
	
	{action_respond_info("")}
	{action_respond_info("Starting Pressure Advance calibration print.")}
	{action_respond_info("")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button once the print starts exhibiting PA values that are obviously too high.")}
	{action_respond_info("")}
	{action_respond_info("PA of first band: %.4f" % pa_start)}
	{action_respond_info("PA of last band: %.4f" % (pa_start + ((num_bands - 1) * pa_increment)))}
	{action_respond_info("PA increment per band: %.4f" % pa_increment)}
	{action_respond_info("Number of bands: %d" % num_bands)}
	{action_respond_info("")}
	{action_respond_info("Inspect the printed model. "
	"Look at the top and bottom lines in each band, on the right side of the two vertical raft bars (where the print speeds change). "
	"Find the highest band from the bottom where the lines at its top still resemble the lines at its bottom, with no visible extrusion width irregularities. "
	"Your final Pressure Advance value would then be:"
	)}
	{action_respond_info("")}
	{action_respond_info("Assuming that first band_number is 0")}
	{action_respond_info("PA = %.4f + (%.4f * band_number)" % (pa_start, pa_increment))}
	{action_respond_info("")}
	{action_respond_info("Update your [extruder] config section and set \"pressure_advance\" to the value you calculated.")}
	{action_respond_info("")}
	
	
	
	
	
	
	
	
	
	SAVE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION
	{% set pa_saved = printer.configfile.settings['extruder'].pressure_advance %}
	SET_PRESSURE_ADVANCE ADVANCE={pa_start}
	
	
	
	
	M221 S100
	
	
	
	
	M117 Priming
	G90
	G0 X{x_start} Y{y_start} Z{line_height} F{feedrate_travel}
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{print_width}  E{print_width * e_per_mm} F{feedrate_raft / 2}
	G1 Y{line_width}   E{line_width * e_per_mm}  F{feedrate_raft / 2}
	G1 X-{print_width} E{print_width * e_per_mm} F{feedrate_raft / 2}
	
	
	
	
	{% if do_raft == 1 %}
	G0 F{feedrate_raft}
	
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	{% if curr_raft_line == thick_raft_num1 or curr_raft_line == thick_raft_num2 %}
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	G1 Y{loop.cycle(-1.0, 1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	{% endif %}
	
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	
	
	{% if not loop.last %}
	{% set horizontal_move = spacing_raft - (2 * line_width if curr_raft_line == thick_raft_num1 - 1 or curr_raft_line == thick_raft_num2 - 1 else 0) %}
	G1 X{horizontal_move} E{horizontal_move * e_per_mm}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	{% endif %}
	
	
	
	
	M117 Printing bands
	G90
	G0 X{x_start} Y{y_start + 2 * line_width + spacing_purge} F{feedrate_travel}
	G0 Z{line_height + (line_height if do_raft == 1 else 0)} F{feedrate_z}
	G91
	G1 E{retract_length} F{feedrate_retract}
	
	
	{% for curr_band_num in range(0, num_bands ) %}
	{% set outer_loop = loop %}
	
	{% set curr_pa_value = pa_start + curr_band_num * pa_increment %}
	SET_PRESSURE_ADVANCE ADVANCE={curr_pa_value}
	M117 Band {curr_band_num} PA {curr_pa_value|round(4)}
	
	
	{% for _ in range(num_lines_control) %}
	G1 X{print_width} E{print_width * e_per_mm * e_multiplier} F{feedrate_control}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G0 X-{print_width} Y{spacing_line + line_width} F{feedrate_travel}
	
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endfor %}
	
	
	{% for _ in range(num_lines_test) %}
	{% for data in [{'mm': slow_line_length, 'f': feedrate_outer}, {'mm': fast_line_length, 'f': feedrate_inner}, {'mm': slow_line_length, 'f': feedrate_outer}] %}
	G1 X{data.mm} E{data.mm * e_per_mm * e_multiplier} F{data.f}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	{% if not (outer_loop.last and loop.last) %}
	G0 X-{print_width} Y{(spacing_line if not loop.last else spacing_band) + line_width} F{feedrate_travel}
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z20 F{feedrate_z}
	G0 X-{print_width / 2} Y{[50, max_y - (y_start + print_height)]|min} F{feedrate_travel}
	
	M117
	SET_PRESSURE_ADVANCE ADVANCE={pa_saved}
	RESTORE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION

[gcode_macro CHANGE_FILAMENT]
description = Do a PAUSE, park the toolhead over the purge bucket and unload the filament
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	SAVE_GCODE_STATE NAME=CHANGE_FILAMENT_state
	PAUSE
	UNLOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=CHANGE_FILAMENT_state

[gcode_macro UNLOAD_FILAMENT]
description = Basic unload of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to unload filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to unload filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	
	_TIP_SHAPING
	M83
	G1 E-20 F3600
	G4 P3000
	G1 E{DISTANCE|float * -1} F3000
	
	RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament unloaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament unloaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro LOAD_FILAMENT]
description = Basic load of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to load filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to load filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=LOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	M83
	G92 E0
	G1 E{DISTANCE|float} F200
	G1 E50 F150
	
	G92 E0
	RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament loaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament loaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _TIP_SHAPING]
description = Filament tip shaping sequence
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=TIP_SHAPING_state
	_LOW_TEMP_CHECK T={TEMP}
	
	{% set old_pressure_advance = printer.extruder.pressure_advance|default(0) %}
	
	SET_PRESSURE_ADVANCE ADVANCE=0
	
	M82
	G92 E0
	G1 E2 F3600
	G1 E0 F3600
	G1 E3 F3600
	G1 E0 F3600
	G1 E4 F3600
	G1 E0 F3600
	
	
	SET_PRESSURE_ADVANCE ADVANCE={old_pressure_advance}
	RESTORE_GCODE_STATE NAME=TIP_SHAPING_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_CHAMBER]
description = Heatsoak chamber to a specific temperature with a timeout
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set MAXTIME = params.MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% for _ in range(1, MAXTIME) %}
	_WAIT_CHAMBER_TEMP TEMP={SETPOINT_TEMP}
	{% endfor %}
	{% if verbose %}
	RESPOND MSG="Chamber temperature OK !"
	{% endif %}
	{% endif %}

[gcode_macro _WAIT_CHAMBER_TEMP]
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	{% if CURRENT_TEMP <= SETPOINT_TEMP %}
	RESPOND MSG="Heating up the chamber : {CURRENT_TEMP}/{SETPOINT_TEMP}"
	G4 P{60000 * 1}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_BED]
description = Heatsoak bed at specified temperature and wait for a specific amount of time
gcode = 
	{% set SETPOINT_TEMP = params.TEMP|default(0)|int %}
	{% set TIME = params.SOAKTIME|default(8)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set heaterbed_enabled = printer["gcode_macro _USER_VARIABLES"].heaterbed_enabled %}
	
	{% if heaterbed_enabled %}
	{% if verbose %}
	RESPOND MSG="Heating up bed..."
	{% endif %}
	
	M190 S{SETPOINT_TEMP}
	
	{% if TIME > 0 %}
	{% for i in range(0, TIME) %}
	RESPOND MSG="Heatsoak bed, {TIME-i}mn left..."
	G4 P{60000 * 1}
	{% endfor %}
	{% else %}
	RESPOND MSG="No heatsoak needed, continue"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Bed temperature OK"
	{% endif %}
	
	{% else %}
	{% if verbose %}
	RESPOND MSG="No bed heater defined: nothing to do, continuing..."
	{% endif %}
	{% endif %}

[gcode_macro PRIMELINE]
gcode = 
	
	{% set prime_line_length = params.LINE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_length)|float %}
	{% set prime_line_purge_distance = params.PURGE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_purge_distance)|float %}
	{% set prime_line_flowrate = params.FLOWRATE|default(printer["gcode_macro _USER_VARIABLES"].prime_line_flowrate)|float %}
	
	
	{% set prime_line_x, prime_line_y = printer["gcode_macro _USER_VARIABLES"].prime_line_xy|map('float') %}
	{% set prime_line_direction = printer["gcode_macro _USER_VARIABLES"].prime_line_direction|string|upper %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% set max_extrude_cross_section = printer["configfile"].config["extruder"]["max_extrude_cross_section"]|float %}
	{% set filament_diameter = printer["configfile"].config["extruder"]["filament_diameter"]|float %}
	
	{% set line_height = 0.6 %}
	
	
	{% set prime_line_x = params.START_X|default(prime_line_x)|float %}
	{% set prime_line_y = params.START_Y|default(prime_line_y)|float %}
	{% set prime_line_direction = params.LINE_DIRECTION|default(printer["gcode_macro _USER_VARIABLES"].prime_line_direction)|string|upper %}
	
	
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	
	
	
	{% if (line_height * line_width) > max_extrude_cross_section %}
	{% if verbose %}
	{action_respond_info("The prime_line_purge_distance of %.4f mm is too high and will exceed the max_extrude_cross_section!" % prime_line_purge_distance)}
	{% endif %}
	{% set prime_line_purge_distance = 0.98 * (max_extrude_cross_section * prime_line_length) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	{% if verbose %}
	{action_respond_info("Klippain corrected the prime_line_purge_distance to %.4f mm" % prime_line_purge_distance)}
	{% endif %}
	{% endif %}
	
	
	{% if (line_height / line_width) >= 0.5 %}
	{% if verbose %}
	{action_raise_error("The prime line will be too thin and will probably not stick properly to the bed. Increase its purge distance or decrease its length! Aborting...")}
	{% endif %}
	{% endif %}
	
	
	{% set speed = (prime_line_flowrate / (line_height * line_width)) * 60 |float %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% endif %}
	{% endif %}
	{% endif %}
	
	G91
	M83
	G1 Z5 F{Sz}
	
	
	G90
	G0 X{prime_line_x} Y{prime_line_y} F{St}
	G1 Z{line_height} F{Sz|int / 2}
	
	
	G92 E0
	G1 E18 F300
	
	
	G92 E0
	{% if prime_line_direction == "X" %}
	G1 X{prime_line_x + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% elif prime_line_direction == "Y" %}
	G1 Y{prime_line_y + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% else %}
	{ action_respond_error("Prime line direction is not valid. Choose either X or Y in the variables.cfg file!") }
	{% endif %}
	
	
	G92 E0
	G1 E-0.2 F2100
	G92 E0
	G1 Z3 F{Sz}
	M400
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection reactivated after the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro CLEAN_NOZZLE]
description = Wipe the nozzle on the brush
gcode = 
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set brush_clean_accel = printer["gcode_macro _USER_VARIABLES"].brush_clean_accel %}
	{% set brush_over_y_axis = printer["gcode_macro _USER_VARIABLES"].brush_over_y_axis %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set Sc = printer["gcode_macro _USER_VARIABLES"].brush_clean_speed * 60 %}
	
	{% set Bx, By, Bz = printer["gcode_macro _USER_VARIABLES"].brush_xyz|map('float') %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Nozzle cleaning..."
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{brush_clean_accel}
	
	
	G90
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP=1
	
	G1 X{Bx} Y{By} Z{Bz} F{St}
	
	
	G91
	{% if brush_over_y_axis %}
	{% for wipe in range(6) %}
	G1 Y-5 F{Sc}
	G1 Y+5 F{Sc}
	{% endfor %}
	{% endif %}
	
	G1 X+20 F{Sc}
	
	{% for wipe in range(6) %}
	G1 X-40 F{Sc}
	G1 X+40 F{Sc}
	{% endfor %}
	
	G90
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="clean"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro PURGE]
description = Purge a specific amount of filament ontop of the purge bucket
gcode = 
	{% set DISTANCE = params.DISTANCE|default(printer["gcode_macro _USER_VARIABLES"].purge_distance)|int %}
	{% set OOZE_TIME = params.OOZE_TIME|default(printer["gcode_macro _USER_VARIABLES"].purge_ooze_time)|int %}
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Purge filament..."
	{% endif %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% endif %}
	
	G90
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP={Z_DROP}
	
	
	_LOW_TEMP_CHECK T={TEMP}
	G92 E0
	G1 E{DISTANCE|float} F150
	
	
	G92 E0
	G1 E-1.7 F2100
	G1 E-18.3 F150
	G92 E0
	
	
	G4 P{OOZE_TIME * 1000}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _CONDITIONAL_MOVE_TO_PURGE_BUCKET]
description = Move over the purge bucket
gcode = 
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	
	{% if purge_and_brush_enabled %}
	SAVE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	G90
	
	{% if Z_DROP == 1 %}
	{% if purgeclean_servo_enabled %}
	G1 Z{Pz} F{Sz}
	_SERVO_DEPLOY ITEM="purge"
	{% endif %}
	G1 X{Px} Y{Py} Z{Pz} F{St}
	{% else %}
	
	
	
	G1 X{Px} Y{Py} F{St}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	{% endif %}

[gcode_macro _LOW_TEMP_CHECK]
description = Check the nozzle is at temperature and heat it if needed
gcode = 
	{% set T = params.T|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% if printer.extruder.target != 0 %}
	{% if printer.extruder.temperature < printer.extruder.target %}
	M109 S{printer.extruder.target|float}
	{% endif %}
	{% else %}
	{% if printer.extruder.target < T %}
	M109 S{T}
	{% endif %}
	{% endif %}

[gcode_macro M701]
description = Map M701 to LOAD_FILAMENT
gcode = 
	LOAD_FILAMENT

[gcode_macro M702]
description = Map M702 to UNLOAD_FILAMENT
gcode = 
	UNLOAD_FILAMENT

[gcode_macro M600]
description = Map M600 to CHANGE_FILAMENT
gcode = 
	CHANGE_FILAMENT

[gcode_macro M125]
description = Map M125 to PARK
gcode = 
	PARK

[gcode_macro M900]
description = Map M900 to SET_PRESSURE_ADVANCE
gcode = 
	{% if 'K' in params %}
	{% if 'E' in params %}
	SET_PRESSURE_ADVANCE EXTRUDER={params.E} ADVANCE={params.K}
	{% else %}
	SET_PRESSURE_ADVANCE ADVANCE={params.K}
	{% endif %}
	{% endif %}

[gcode_macro M204]
description = Map M204 to SET_VELOCITY_LIMIT for ACCEL and ACCEL_TO_DECEL
rename_existing = M204.1
gcode = 
	{% set F = params.F|default(printer["gcode_macro _USER_VARIABLES"].accel_to_decel_factor)|float %}
	
	{% if 'S' in params %}
	{% set S = params.S|float %}
	SET_VELOCITY_LIMIT ACCEL={S} ACCEL_TO_DECEL={S * F}
	{% endif %}

[gcode_macro M205]
description = Map M205 to SET_VELOCITY_LIMIT for SQUARE_CORNER_VELOCITY
gcode = 
	{% if 'X' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.X}
	{% elif 'Y' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.Y}
	{% endif %}

[gcode_macro G00]
gcode = 
	G0 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G01]
gcode = 
	G1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G02]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G03]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G04]
gcode = 
	G4 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro _SEARCH_VARS]
description = Search for variables in the "printer" object from Klipper
gcode = 
	{% set search = params.S|lower %}
	{% set ns = namespace() %}
	{% for item in printer  %}
	{% if ' ' in item %}
	{% set ns.path = ['printer', "['%s']" % (item), ''] %}
	{% else %}
	{% set ns.path = ['printer.', item, ''] %}
	{% endif %}
	
	{% if search in ns.path|lower %}
	{ action_respond_info(ns.path|join) }
	{% endif %}
	
	{% if printer[item].items() %}
	{% for childkey, child in printer[item].items() recursive %}
	{% set ns.path = ns.path[:loop.depth|int + 1] %}
	
	{% if ' ' in childkey %}
	{% set null = ns.path.append("['%s']" % (childkey)) %}
	{% else %}
	{% set null = ns.path.append(".%s" % (childkey)) %}
	{% endif %}
	
	{% if child is mapping  %}
	{ loop(child.items()) }
	{% else %}
	{% if search in ns.path|lower %}
	{ action_respond_info("%s : %s" % (ns.path|join, child)) }
	{% endif %}
	{% endif %}
	
	{% endfor %}
	{% endif %}
	{% endfor %}

[delayed_gcode KLIPPAIN_STARTUP]
initial_duration = 1
gcode = 
	_KLIPPAIN_STARTUP

[gcode_macro _KLIPPAIN_STARTUP]
gcode = 
	
	RUN_SHELL_COMMAND CMD=system_info
	
	
	_INIT_MCU_VER
	
	
	{% set extruder_enabled = printer["gcode_macro _USER_VARIABLES"].extruder_enabled %}
	{% if not extruder_enabled %}
	{ action_raise_error("Klippain need to have an extruder defined to work properly. Check your printer.cfg includes!") }
	{% endif %}
	
	
	_INIT_CHECKPROBECONF
	
	
	{% set e_driver = printer["gcode_macro _USER_VARIABLES"].e_driver|string %}
	{% if e_driver == "TMC2240" %}
	_INIT_TMC2240
	{% endif %}
	
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% if klippain_ercf_enabled %}
	_INIT_CHECK_ERCF
	{% endif %}
	
	
	_INIT_USERCUSTOM
	
	RESPOND MSG="Klippain started and ready !"

[gcode_macro _INIT_TMC2240]
gcode = 

[gcode_macro _INIT_CHECKPROBECONF]
gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled|string %}
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set qgl_enabled = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set ztilt_enabled = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	
	{% if zcalib_plugin_enabled %}
	{% if probe_type_enabled == "vorontap" %}
	{ action_raise_error("Voron TAP Probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "inductive" %}
	{ action_raise_error("Inductive probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "dockable_virtual" or probe_type_enabled == "inductive_virtual" %}
	{ action_raise_error("Virtual Z endstop probes are not compatible with the Z calibration plugin!") }
	{% elif probe_type_enabled == "none" %}
	{ action_raise_error("You need a probe to use the Z calibration plugin in Klippain!") }
	{% endif %}
	{% endif %}
	
	{% if bed_mesh_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a bed mesh in Klippain!") }
	{% endif %}
	
	{% if qgl_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a quad gantry leveling in Klippain!") }
	{% endif %}
	
	{% if ztilt_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a Z tilt adjust in Klippain!") }
	{% endif %}

[gcode_macro _INIT_MCU_VER]
gcode = 
	{% set parameters = namespace(output = 'Currently configured MCU(s): \n') %}
	{% for name1 in printer %}
	{% for name2 in printer[name1] %}
	{% set show = ['mcu_version'] %}
	{% if name2 is in show %}
	{% set param = "%s: %s" % (name1, printer[name1][name2]) %}
	{% set parameters.output = parameters.output +  param + "\n" %}
	{% endif %}
	{% endfor %}
	{% endfor %}
	{action_respond_info(parameters.output)}

[gcode_macro _INIT_CHECK_ERCF]
gcode = 
	{% if not printer.ercf.enabled %}
	{ action_raise_error("ERCF is enabled in Klippain, but Happy Hare, the supported ERCF backend software is not detected. Please install it now from https://github.com/moggieuk/ERCF-Software-V3 !") }
	{% endif %}

[gcode_macro _INIT_USERCUSTOM]
gcode = 

[gcode_shell_command plot_graph]
command = bash /home/pi/printer_data/config/scripts/plot_graphs.sh
timeout = 500.0
verbose = True

[gcode_shell_command system_info]
command = python3 /home/pi/printer_data/config/scripts/system_info.py
timeout = 5.0
verbose = True

[save_variables]
filename = ~/printer_data/config/save_variables.cfg

[tmc2209 stepper_z]
uart_pin = Z_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z1]
uart_pin = Z1_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z2]
uart_pin = Z2_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z3]
uart_pin = Z3_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 extruder]
uart_pin = toolhead:E_TMCUART
interpolate = false
run_current = 0.45
sense_resistor = 0.110
stealthchop_threshold = 0

[mcu]
canbus_uuid = f04ddc949bb2

[board_pins mcu_manufacturer]
aliases = 
	MCU_MOTOR0_STEP=PF13   , MCU_MOTOR0_DIR=PF12   , MCU_MOTOR0_ENABLE=PF14   , MCU_MOTOR0_UART=PC4    ,
	MCU_MOTOR1_STEP=PG0    , MCU_MOTOR1_DIR=PG1    , MCU_MOTOR1_ENABLE=PF15   , MCU_MOTOR1_UART=PD11   ,
	MCU_MOTOR2_1_STEP=PF11 , MCU_MOTOR2_1_DIR=PG3  , MCU_MOTOR2_1_ENABLE=PG5  , MCU_MOTOR2_1_UART=PC6  ,
	MCU_MOTOR3_STEP=PG4    , MCU_MOTOR3_DIR=PC1    , MCU_MOTOR3_ENABLE=PA0    , MCU_MOTOR3_UART=PC7    ,
	MCU_MOTOR4_STEP=PF9    , MCU_MOTOR4_DIR=PF10   , MCU_MOTOR4_ENABLE=PG2    , MCU_MOTOR4_UART=PF2    ,
	MCU_MOTOR5_STEP=PC13   , MCU_MOTOR5_DIR=PF0    , MCU_MOTOR5_ENABLE=PF1    , MCU_MOTOR5_UART=PE4    ,
	MCU_MOTOR6_STEP=PE2    , MCU_MOTOR6_DIR=PE3    , MCU_MOTOR6_ENABLE=PD4    , MCU_MOTOR6_UART=PE1    ,
	MCU_MOTOR7_STEP=PE6    , MCU_MOTOR7_DIR=PA14   , MCU_MOTOR7_ENABLE=PE0    , MCU_MOTOR7_UART=PD3    ,
	
	MCU_STOP0=PG6  , MCU_STOP1=PG9  , MCU_STOP2=PG10 , MCU_STOP3=PG11 ,
	MCU_STOP4=PG12 , MCU_STOP5=PG13 , MCU_STOP6=PG14 , MCU_STOP7=PG15 ,
	MCU_PROBE=PB7  ,
	MCU_SERVOS=PB6 ,
	
	MCU_HE0=PA2 , MCU_HE1=PA3 , MCU_HE2=PB10 , MCU_HE3=PB11 ,
	
	MCU_BED0=PA1 ,
	
	MCU_TB=PF3 ,
	MCU_T0=PF4 , MCU_T1=PF5 , MCU_T2=PF6 , MCU_T3=PF7 ,
	
	MCU_FAN0=PA8 , MCU_FAN1=PE5 , MCU_FAN2=PD12 , MCU_FAN3=PD13 , MCU_FAN4=PD14 , MCU_FAN5=PD15 ,
	
	MCU_NEOPIXEL=PB0  ,
	MCU_PS_ON=PE11    ,
	MCU_POWER_DET=PC0 ,
	
	
	EXP1_1=PE8   , EXP1_2=PE7   ,
	EXP1_3=PE9   , EXP1_4=PE10  ,
	EXP1_5=PE12  , EXP1_6=PE13  ,
	EXP1_7=PE14  , EXP1_8=PE15  ,
	EXP1_9=<GND> , EXP1_10=<5V> ,
	
	
	EXP2_1=PA6   , EXP2_2=PA5   ,
	EXP2_3=PB1   , EXP2_4=PA4   ,
	EXP2_5=PB2   , EXP2_6=PA7   ,
	EXP2_7=PC15  , EXP2_8=<RST> ,
	EXP2_9=<GND> , EXP2_10=<5V> ,

[board_pins octopus_mcu]
mcu = mcu
aliases = 
	X_STEP=MCU_MOTOR0_STEP   , X_DIR=MCU_MOTOR0_DIR   , X_ENABLE=MCU_MOTOR0_ENABLE   , X_TMCUART=MCU_MOTOR0_UART   ,
	Y_STEP=MCU_MOTOR1_STEP   , Y_DIR=MCU_MOTOR1_DIR   , Y_ENABLE=MCU_MOTOR1_ENABLE   , Y_TMCUART=MCU_MOTOR1_UART   ,
	
	Z_STEP=MCU_MOTOR2_1_STEP , Z_DIR=MCU_MOTOR2_1_DIR , Z_ENABLE=MCU_MOTOR2_1_ENABLE , Z_TMCUART=MCU_MOTOR2_1_UART ,
	Z1_STEP=MCU_MOTOR3_STEP  , Z1_DIR=MCU_MOTOR3_DIR  , Z1_ENABLE=MCU_MOTOR3_ENABLE  , Z1_TMCUART=MCU_MOTOR3_UART  ,
	Z2_STEP=MCU_MOTOR4_STEP  , Z2_DIR=MCU_MOTOR4_DIR  , Z2_ENABLE=MCU_MOTOR4_ENABLE  , Z2_TMCUART=MCU_MOTOR4_UART  ,
	Z3_STEP=MCU_MOTOR5_STEP  , Z3_DIR=MCU_MOTOR5_DIR  , Z3_ENABLE=MCU_MOTOR5_ENABLE  , Z3_TMCUART=MCU_MOTOR5_UART  ,
	
	E_STEP=MCU_MOTOR6_STEP   , E_DIR=MCU_MOTOR6_DIR   , E_ENABLE=MCU_MOTOR6_ENABLE   , E_TMCUART=MCU_MOTOR6_UART   ,
	
	X_STOP=MCU_STOP0 , Y_STOP=MCU_STOP1 , Z_STOP=MCU_STOP2 ,
	PROBE_INPUT=MCU_STOP7  ,
	RUNOUT_SENSOR=MCU_STOP3 ,
	
	E_HEATER=MCU_HE0   , E_TEMPERATURE=MCU_T0   ,
	BED_HEATER=MCU_HE1 , BED_TEMPERATURE=MCU_TB ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	CONTROLLER_FAN=MCU_FAN2        ,
	EXHAUST_FAN=MCU_FAN3           ,
	FILTER_FAN=MCU_FAN4            ,
	HOST_CONTROLLER_FAN=MCU_FAN5   ,
	
	CHAMBER_TEMPERATURE=MCU_T1 , ELECTRICAL_CABINET_TEMPERATURE=MCU_T2 ,
	
	LIGHT_OUTPUT=MCU_HE2         ,
	LIGHT_NEOPIXEL=MCU_STOP5     ,
	STATUS_NEOPIXEL=MCU_NEOPIXEL ,

[mcu toolhead]
canbus_uuid = 1b44cf5169c3

[board_pins toolhead_manufacturer]
mcu = toolhead
aliases = 
	MCU_EMOT_EN=gpio7 , MCU_EMOT_STEP=gpio9 , MCU_EMOT_DIR=gpio10 , MCU_EMOT_UART=gpio8 ,
	
	MCU_5V_ENDSTOP=gpio28 ,
	MCU_ENDSTOP=gpio29    ,
	MCU_HV_ENDSTOP=gpio25 ,
	
	MCU_FAN0=gpio13 , MCU_FAN1=gpio14 , MCU_FAN2=gpio15 ,
	
	MCU_TEMP=gpio27 , MCU_ONBOARD_NTCK100K=gpio26 ,
	
	MCU_HEAT=gpio6 ,
	
	MCU_RGB=gpio12 ,
	MCU_PWM0=gpio16 , MCU_PWM1=gpio17 ,
	
	MCU_ADXL_CS=gpio1 , MCU_ADXL_SCK=gpio0 , MCU_ADXL_MOSI=gpio3 , MCU_ADXL_MISO=gpio2 ,

[board_pins sb2040_mcu]
mcu = toolhead
aliases = 
	E_STEP=MCU_EMOT_STEP , E_DIR=MCU_EMOT_DIR , E_ENABLE=MCU_EMOT_EN , E_TMCUART=MCU_EMOT_UART ,
	
	X_STOP=MCU_ENDSTOP ,
	PROBE_INPUT=MCU_HV_ENDSTOP ,
	TOOLHEAD_SENSOR=MCU_5V_ENDSTOP ,
	
	E_HEATER=MCU_HEAT , E_TEMPERATURE=MCU_TEMP , CHAMBER_TEMPERATURE=MCU_ONBOARD_NTCK100K ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	
	STATUS_NEOPIXEL=MCU_RGB ,
	
	ADXL_CS=MCU_ADXL_CS , ADXL_SCLK=MCU_ADXL_SCK , ADXL_MOSI=MCU_ADXL_MOSI , ADXL_MISO=MCU_ADXL_MISO ,

[neopixel status_leds]
pin = toolhead:STATUS_NEOPIXEL
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting CAN connect
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
webhooks client 281472970122144: New connection
webhooks client 281472970122144: Client info {'program': 'Moonraker', 'version': 'v0.8.0-92-g504a3a7'}
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Unable to issue reset command on MCU 'mcu'
Unable to issue reset command on MCU 'toolhead'
webhooks client 281472970122144: Disconnected
Restarting printer
Start printer at Tue Jul 11 14:35:15 2023 (1689104115.8 72238.1)
===== Config file =====
[printer]
kinematics = corexz
max_velocity = 400
max_accel = 1000
max_z_velocity = 200
max_z_accel = 1000
square_corner_velocity = 5.0

[stepper_x]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = X_STEP
dir_pin = X_DIR
enable_pin = !X_ENABLE
endstop_pin = tmc2209_stepper_x:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_y]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = Y_STEP
dir_pin = Y_DIR
enable_pin = !Y_ENABLE
endstop_pin = tmc2209_stepper_y:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_z]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z_STEP
dir_pin = !Z_DIR
enable_pin = !Z_ENABLE
endstop_pin = probe:z_virtual_endstop
homing_speed = 15
second_homing_speed = 8
homing_retract_dist = 3.0
position_max = 310
position_min = -5

[stepper_z1]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z1_STEP
dir_pin = !Z1_DIR
enable_pin = !Z1_ENABLE

[stepper_z2]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z2_STEP
dir_pin = !Z2_DIR
enable_pin = !Z2_ENABLE

[stepper_z3]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z3_STEP
dir_pin = Z3_DIR
enable_pin = !Z3_ENABLE

[gcode_macro _USER_VARIABLES]
variable_extruder_enabled = True
gcode = 
variable_heaterbed_enabled = True
variable_probe_type_enabled = "vorontap"
variable_startprint_actions = "bed_soak", "extruder_preheating", "chamber_soak", "clean", "tilt_calib", "z_offset", "bedmesh", "extruder_heating", "purge", "clean", "primeline"
variable_purgeclean_servo_enabled = True
variable_purgeclean_servo_name = "purgeservo"
variable_status_leds_minidisplay_enabled = True
variable_status_leds_minidisplay_led_name = "btt_mini12864"
variable_bed_mesh_enabled = True
variable_sensorless_homing_enabled = True
variable_qgl_enabled = True
variable_verbose = True
variable_homing_travel_speed = 350
variable_travel_speed = 350
variable_z_drop_speed = 15
variable_brush_clean_speed = 100
variable_probe_dock_speed = 60
variable_homing_travel_accel = 3000
variable_tilting_travel_accel = 3000
variable_brush_clean_accel = 1500
variable_probe_dock_accel = 2000
variable_accel_to_decel_factor = 0.75
variable_zendstop_position = -1, -1
variable_force_homing_in_start_print = False
variable_homing_zhop = 5
variable_homing_first = "X"
variable_homing_backoff_distance_xy = -5, -5
variable_sensorless_current_factor = 75
variable_probe_dock_margin_xy = 0, 0
variable_safe_extruder_temp = 150
variable_prime_line_xy = 5, 2.5
variable_prime_line_direction = "X"
variable_prime_line_length = 40
variable_prime_line_purge_distance = 30
variable_prime_line_flowrate = 10
variable_park_position_xy = -1, -1
variable_park_lift_z = 50
variable_disable_motors_in_end_print = False
variable_turn_off_heaters_in_end_print = True
variable_min_bed_xy = 0, 0
variable_max_bed_xy = 9999, 9999
variable_probe_min_z_travel = 20
variable_probe_dock_location_xy = -1, -1
variable_probe_servo_angle_retracted = 0
variable_probe_servo_angle_deployed = 90
variable_probe_before_attach_position = "front"
variable_probe_after_attach_position = "front"
variable_probe_before_dock_position = "front"
variable_probe_after_dock_position = "left"
variable_probe_move_attach_length = 30
variable_probe_move_dock_length = 30
variable_autodock_on_probe_error = True
variable_tap_max_probing_temp = 150
variable_tap_deactivation_zhop = 5
variable_print_default_bed_temp = 105
variable_print_default_extruder_temp = 240
variable_print_default_chamber_temp = 0
variable_print_default_chamber_max_heating_time = 15
variable_print_default_soak = 8
variable_print_default_material = "XXX"
variable_material_parameters = {
	'PLA': {
	'pressure_advance': 0.0525,
	'retract_length': 0.75,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 0,
	'additional_z_offset': 0
	},
	'PET': {
	'pressure_advance': 0.0650,
	'retract_length': 1.4,
	'unretract_extra_length': 0,
	'retract_speed': 30,
	'unretract_speed': 20,
	'filter_speed': 0,
	'additional_z_offset': 0.020
	},
	'ABS': {
	'pressure_advance': 0.0480,
	'retract_length': 0.5,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 80,
	'additional_z_offset': 0
	}
	}
variable_ercf_unload_on_cancel_print = False
variable_ercf_unload_on_end_print = True
variable_ercf_reset_stats_on_start_print = False
variable_purge_and_brush_enabled = False
variable_force_homing_before_brush = False
variable_brush_over_y_axis = True
variable_brush_xyz = -1, -1, -1
variable_purge_bucket_xyz = -1, -1, -1
variable_purge_distance = 30
variable_purge_ooze_time = 10
variable_purgeclean_servo_angle_retracted = 0
variable_purgeclean_servo_angle_deployed = 90
variable_light_intensity_start_print = 100
variable_light_intensity_printing = 30
variable_light_intensity_end_print = 0
variable_fix_heaters_temperature_settle = False
variable_resonnance_test_point_xy = -1, -1
variable_resonnance_test_z_clearance = 50
variable_status_leds_colors = {
	'logo': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'nozzle': {
	'heating': {'r': 0.8, 'g': 0.35, 'b': 0.0, 'w':0.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'standby': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'caselight': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'minidisplay': {
	'on': {'r': 0.0, 'g': 0.2, 'b': 0.4, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'error': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'thermal': {
	'hot': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cold': {'r': 0.3, 'g': 0.0, 'b': 0.3, 'w': 0.0}
	}
	}
variable_x_driver = "TMC2209"
variable_y_driver = "TMC2209"
variable_z_driver = "TMC2209"
variable_e_driver = "TMC2209"

[extruder]
rotation_distance = 22.79234586
gear_ratio = 50:10
microsteps = 64
full_steps_per_rotation = 200
nozzle_diameter = 0.400
filament_diameter = 1.75
max_extrude_only_distance = 110
max_extrude_cross_section = 5
sensor_type = ATC Semitec 104GT-2
min_temp = 5
max_temp = 310
max_power = 1.0
min_extrude_temp = 170
pressure_advance = 0.045
pressure_advance_smooth_time = 0.040
step_pin = toolhead:E_STEP
dir_pin = toolhead:E_DIR
enable_pin = !toolhead:E_ENABLE
heater_pin = toolhead:E_HEATER
sensor_pin = toolhead:E_TEMPERATURE
control = pid
pid_kp = 34.626
pid_ki = 4.050
pid_kd = 74.014

[gcode_macro M109]
rename_existing = M109.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={S}
	{% else %}
	M109.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[heater_bed]
heater_pin = BED_HEATER
sensor_type = NTC 100K MGB18-104F39050L32
sensor_pin = BED_TEMPERATURE
max_power = 1
min_temp = 0
max_temp = 120
control = pid
pid_kp = 40.783
pid_ki = 1.007
pid_kd = 412.931

[gcode_macro M190]
rename_existing = M190.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={S}
	{% else %}
	M190.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[gcode_macro ACTIVATE_PROBE]
description = Put the machine in a state being able to probe
variable_temperature = 0
gcode = 
	{% set LOCK = params.LOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_max_probing_temp = printer["gcode_macro _USER_VARIABLES"].tap_max_probing_temp|float %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if LOCK %}
	_ATTACH_PROBE_LOCK
	{% else %}
	_ATTACH_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	SAVE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	
	{% set ACTUAL_TEMP = printer.extruder.temperature %}
	{% set TARGET_TEMP = printer.extruder.target %}
	
	SET_GCODE_VARIABLE MACRO=ACTIVATE_PROBE VARIABLE=temperature VALUE={TARGET_TEMP}
	
	{% if TARGET_TEMP > tap_max_probing_temp %}
	{ action_respond_info('Extruder temperature target of %.1fC is too high for TAP probing, lowering to %.1fC' % (TARGET_TEMP, tap_max_probing_temp)) }
	M106 S255
	M109 S{tap_max_probing_temp}
	M106 S0
	{% else %}
	
	{% if ACTUAL_TEMP > tap_max_probing_temp + 3 %}
	M106 S255
	TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={tap_max_probing_temp}
	M106 S0
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro DEACTIVATE_PROBE]
description = Revert the machine to a normal state after probing
gcode = 
	{% set UNLOCK = params.UNLOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_deactivation_zhop = printer["gcode_macro _USER_VARIABLES"].tap_deactivation_zhop %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if UNLOCK %}
	_DOCK_PROBE_UNLOCK
	{% else %}
	_DOCK_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	
	{% set z_safe = printer.toolhead.position.z + tap_deactivation_zhop %}
	{% if z_safe > printer.toolhead.axis_maximum.z %}
	{% set z_safe = printer.toolhead.axis_maximum.z %}
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	
	{% set old_target_temperature = printer["gcode_macro ACTIVATE_PROBE"].temperature %}
	M109 S{old_target_temperature}
	
	RESTORE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	{% endif %}

[probe]
pin = ^toolhead:MCU_ENDSTOP1
x_offset = 0
y_offset = 0
z_offset = -0.45
speed = 3
lift_speed = 10
samples = 3
samples_result = median
sample_retract_dist = 1.0
samples_tolerance = 0.007
samples_tolerance_retries = 3

[heater_fan hotend_fan]
pin = toolhead:E_FAN
max_power = 1.0
kick_start_time = 0.100
heater = extruder
heater_temp = 50.0

[fan]
pin = toolhead:PART_FAN
kick_start_time = 0.100
cycle_time = 0.010

[gcode_macro _SERVO_DEPLOY]
gcode = 
	{% set item = params.ITEM|string|lower %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_servo_enabled = printer["gcode_macro _USER_VARIABLES"].probe_servo_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% if item == "probe" %}
	{% if verbose %}
	RESPOND MSG="Deploying probe dock using the servo"
	{% endif %}
	
	{% if not probe_servo_enabled %}
	{ action_raise_error("No servo available for probe. Please include one in your config!") }
	{% endif %}
	
	{% set probe_servo_name = printer["gcode_macro _USER_VARIABLES"].probe_servo_name %}
	{% set probe_servo_angle_deployed = printer["gcode_macro _USER_VARIABLES"].probe_servo_angle_deployed %}
	SET_SERVO SERVO={probe_servo_name} ANGLE={probe_servo_angle_deployed}
	G4 P500
	
	{% elif item == "purge" or item == "clean" %}
	{% if verbose %}
	RESPOND MSG="Deploying purge bucket and brush using the servo"
	{% endif %}
	
	{% if not purgeclean_servo_enabled %}
	{ action_raise_error("No servo available for purge or clean. Please include one in your config!") }
	{% endif %}
	
	{% set purgeclean_servo_name = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_name %}
	{% set purgeclean_servo_angle_deployed = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_angle_deployed %}
	SET_SERVO SERVO={purgeclean_servo_name} ANGLE={purgeclean_servo_angle_deployed}
	G4 P500
	
	{% else %}
	{ action_raise_error("Servo ITEM must be specified!") }
	{% endif %}

[gcode_macro _SERVO_RETRACT]
gcode = 
	{% set item = params.ITEM|string|lower %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_servo_enabled = printer["gcode_macro _USER_VARIABLES"].probe_servo_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% if item == "probe" %}
	{% if verbose %}
	RESPOND MSG="Rettracting probe dock using the servo"
	{% endif %}
	
	{% if not probe_servo_enabled %}
	{ action_raise_error("No servo available for probe. Please include one in your config!") }
	{% endif %}
	
	{% set probe_servo_name = printer["gcode_macro _USER_VARIABLES"].probe_servo_name %}
	{% set probe_servo_angle_retracted = printer["gcode_macro _USER_VARIABLES"].probe_servo_angle_retracted %}
	SET_SERVO SERVO={probe_servo_name} ANGLE={probe_servo_angle_retracted}
	G4 P500
	
	{% elif item == "purge" or item == "clean" %}
	{% if verbose %}
	RESPOND MSG="Rettracting purge bucket and brush using the servo"
	{% endif %}
	
	{% if not purgeclean_servo_enabled %}
	{ action_raise_error("No servo available for purge or clean. Please include one in your config!") }
	{% endif %}
	
	{% set purgeclean_servo_name = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_name %}
	{% set purgeclean_servo_angle_retracted = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_angle_retracted %}
	SET_SERVO SERVO={purgeclean_servo_name} ANGLE={purgeclean_servo_angle_retracted}
	G4 P500
	
	{% else %}
	{ action_raise_error("Servo ITEM must be specified!") }
	{% endif %}

[servo purgeservo]
pin = SERVO_PIN
maximum_servo_angle = 90
minimum_pulse_width = 0.0011
maximum_pulse_width = 0.0021

[gcode_macro _SET_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = params.LED|string %}
	{% set idx = (params.IDX|string).split(',') %}
	{% set transmit_last = params.TRANSMIT|default(1) %}
	
	{% for led_index in idx %}
	{% set transmit=transmit_last if loop.last else 0 %}
	SET_LED LED={led} RED={red} GREEN={green} BLUE={blue} WHITE={white} INDEX={led_index} TRANSMIT={transmit}
	{% endfor %}

[gcode_macro _SET_LEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_idx"] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_ALLLEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	SET_LED LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w}  TRANSMIT={transmit}

[gcode_macro _SET_LOGO_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_NOZZLE_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro SET_LOGO_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="logo" COLOR="off" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_ON]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="on" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="off" TRANSMIT={transmit}

[gcode_macro STATUS_LEDS]
gcode = 
	{% set color = params.COLOR|default('off')|lower %}
	
	{% set status_color = {
	'ready': {
	'logo': 'standby',
	'nozzle': 'standby',
	'caselight': 'standby',
	'minidisplay': 'on'
	},
	'busy': {
	'logo': 'busy',
	'nozzle': 'on',
	'caselight': 'busy',
	'minidisplay': 'on'
	},
	'heating': {
	'logo': 'heating',
	'nozzle': 'heating',
	'caselight': 'heating',
	'minidisplay': 'on'
	},
	'leveling': {
	'logo': 'leveling',
	'nozzle': 'on',
	'caselight': 'leveling',
	'minidisplay': 'on'
	},
	'homing': {
	'logo': 'homing',
	'nozzle': 'on',
	'caselight': 'homing',
	'minidisplay': 'on'
	},
	'cleaning': {
	'logo': 'cleaning',
	'nozzle': 'on',
	'caselight': 'cleaning',
	'minidisplay': 'on'
	},
	'meshing': {
	'logo': 'meshing',
	'nozzle': 'on',
	'caselight': 'meshing',
	'minidisplay': 'on'
	},
	'calibrating_z': {
	'logo': 'calibrating_z',
	'nozzle': 'on',
	'caselight': 'calibrating_z',
	'minidisplay': 'on'
	},
	'printing': {
	'logo': 'printing',
	'nozzle': 'on',
	'caselight': 'printing',
	'minidisplay': 'on'
	},
	'off': {
	'logo': 'off',
	'nozzle': 'off',
	'caselight': 'off',
	'minidisplay': 'off'
	},
	'on': {
	'logo': 'on',
	'nozzle': 'on',
	'caselight': 'on',
	'minidisplay': 'on'
	},
	'error': {
	'logo': 'error',
	'nozzle': 'error',
	'caselight': 'error',
	'minidisplay': 'error'
	}
	} %}
	
	{% if not (color in status_color) %}
	{ action_raise_error("COLOR is not valid!") }
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	_SET_LEDS_BY_NAME LEDS="logo" COLOR={status_color[color].logo} TRANSMIT=0
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR={status_color[color].nozzle} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_caselight_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="caselight" COLOR={status_color[color].caselight} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_minidisplay_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="minidisplay" COLOR={status_color[color].minidisplay} TRANSMIT=1
	{% endif %}

[display]
lcd_type = uc1701
cs_pin = EXP1_8
a0_pin = EXP1_7
rst_pin = EXP1_6
encoder_pins = ^EXP2_6, ^EXP2_8
click_pin = ^!EXP1_9
contrast = 63
spi_software_miso_pin = EXP2_10
spi_software_mosi_pin = EXP2_5
spi_software_sclk_pin = EXP2_9

[output_pin beeper]
pin = EXP1_10

[neopixel btt_mini12864]
pin = EXP1_5
chain_count = 3
initial_red = 0.1
initial_green = 0.5
initial_blue = 0.0
color_order = RGB

[delayed_gcode setdisplayneopixel]
initial_duration = 1
gcode = 
	SET_LED LED=btt_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3

[temperature_sensor RaspberryPi]
sensor_type = temperature_host

[temperature_sensor mcu]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 90

[temperature_sensor toolhead_mcu]
sensor_type = temperature_mcu
sensor_mcu = toolhead
min_temp = 0
max_temp = 100

[adxl345]
cs_pin = toolhead:ADXL_CS
spi_software_sclk_pin = toolhead:ADXL_SCLK
spi_software_mosi_pin = toolhead:ADXL_MOSI
spi_software_miso_pin = toolhead:ADXL_MISO
axes_map = x,y,z

[resonance_tester]
accel_chip = adxl345
probe_points = 
	-1,-1,-1

[gcode_macro TEST_RESONANCES]
rename_existing = BASE_TEST_RESONANCES
description = Runs input shaper test at the center of the bed
gcode = 
	{% set Tx, Ty = printer["gcode_macro _USER_VARIABLES"].resonnance_test_point_xy|map('float') %}
	{% set Tz = printer["gcode_macro _USER_VARIABLES"].resonnance_test_z_clearance|float %}
	
	{% if Tx == -1 and Ty == -1 %}
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	BASE_TEST_RESONANCES POINT={max_x / 2},{max_y / 2},{Tz} {rawparams}
	{% else %}
	BASE_TEST_RESONANCES POINT={Tx},{Ty},{Tz} {rawparams}
	{% endif %}

[gcode_macro AXES_SHAPER_CALIBRATION]
description = Run standard input shaper test for all axes
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.3)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=X FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=Y FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=SHAPER

[gcode_macro BELTS_SHAPER_CALIBRATION]
description = Run custom demi-axe test to analyze belts on CoreXY printers
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.33)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=1,1 OUTPUT=raw_data NAME=b FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=a FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=BELTS

[gcode_macro EXCITATE_AXIS_AT_FREQ]
description = Maintain a specified input shaper excitating frequency for some time to diagnose vibrations
gcode = 
	{% set FREQUENCY = params.FREQUENCY|default(25)|int %}
	{% set TIME = params.TIME|default(10)|int %}
	{% set AXIS = params.AXIS|default("x")|string|lower %}
	
	TEST_RESONANCES OUTPUT=raw_data AXIS={AXIS} FREQ_START={FREQUENCY-1} FREQ_END={FREQUENCY+1} HZ_PER_SEC={1/(TIME/3)}
	M400

[gcode_macro VIBRATIONS_CALIBRATION]
gcode = 
	
	
	
	{% set size = params.SIZE|default(60)|int %}
	{% set direction = params.DIRECTION|default('XY') %}
	{% set z_height = params.Z_HEIGHT|default(20)|int %}
	{% set verbose = params.VERBOSE|default(true) %}
	
	{% set min_speed = params.MIN_SPEED|default(20)|int * 60 %}
	{% set max_speed = params.MAX_SPEED|default(200)|int * 60 %}
	{% set speed_increment = params.SPEED_INCREMENT|default(2)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	
	{% set accel_chip = params.ACCEL_CHIP|default("adxl345") %}
	
	
	
	
	{% set mid_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set mid_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% set direction_factor = {
	'XY'  : {
	'start' : {'x': -0.5, 'y': -0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': -0.5, 'y': -0.5, 'z': 0.0 }
	}
	},
	'AB' : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': 0.0, 'y': 0.0, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	},
	'ABXY' : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'B'  : {
	'start' : {'x': 0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'A'  : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'X'  : {
	'start' : {'x': -0.5, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': 0.0, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.0, 'z': 0.0 }
	}
	},
	'Y'  : {
	'start' : {'x': 0.0, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.0, 'y': 0.5, 'z': 0.0 }
	}
	},
	'Z'  : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': 0.0, 'z': 1.0 },
	'1' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	}
	}
	%}
	
	
	
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	{% if (size / (max_speed / 60)) < 0.25 %}
	{ action_raise_error("SIZE is too small for this MAX_SPEED. Increase SIZE or decrease MAX_SPEED!") }
	{% endif %}
	
	{% if not (direction in direction_factor) %}
	{ action_raise_error("DIRECTION is not valid. Only XY, AB, ABXY, A, B, X, Y or Z is allowed!") }
	{% endif %}
	
	{action_respond_info("")}
	{action_respond_info("Starting speed and vibration calibration")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION
	
	G90
	
	
	G1 Z{z_height}
	G1 X{mid_x + (size * direction_factor[direction].start.x) } Y{mid_y + (size * direction_factor[direction].start.y)} F{feedrate_travel}
	
	
	{% for curr_speed in range(min_speed, max_speed + speed_increment) %}
	{% if (curr_speed - min_speed) % speed_increment == 0 %}
	{% if verbose %}
	RESPOND MSG="Current speed: {(curr_speed / 60)|int} mm/s"
	{% endif %}
	
	ACCELEROMETER_MEASURE CHIP={accel_chip}
	{% for key, factor in direction_factor[direction].move_factors|dictsort %}
	G1 X{mid_x + (size * factor.x) } Y{mid_y + (size * factor.y)} Z{z_height + (size * factor.z)} F{curr_speed}
	{% endfor %}
	ACCELEROMETER_MEASURE CHIP={accel_chip} NAME=sp{(curr_speed / 60)|int}n1
	
	G4 P300
	M400
	{% endif %}
	{% endfor %}
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS="VIBRATIONS {direction}"
	
	RESTORE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = _BASE_BED_MESH_CALIBRATE
description = Perform Mesh Bed Leveling with klicky automount
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if verbose %}
	{ action_respond_info("Bed Mesh Calibrate") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	_BASE_BED_MESH_CALIBRATE  {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	DEACTIVATE_PROBE

[gcode_macro _ADAPTIVE_MESH_VARIABLES]
variable_ready = False
variable_do_mesh = False
variable_do_nominal = False
variable_mesh_min = 0,0
variable_mesh_max = 0,0
variable_mesh_center = 0,0
variable_probe_count = 0,0
variable_rri = 0
variable_algo = "bicubic"
gcode = 

[gcode_macro COMPUTE_MESH_PARAMETERS]
description = Compute the mesh parameters and store them for later use
gcode = 
	
	{% set xMinConf, yMinConf = printer["configfile"].config["bed_mesh"]["mesh_min"].split(',')|map('trim')|map('int') %}
	{% set xMaxConf, yMaxConf = printer["configfile"].config["bed_mesh"]["mesh_max"].split(',')|map('trim')|map('int') %}
	{% set xProbeCntConf, yProbeCntConf = printer["configfile"].config["bed_mesh"]["probe_count"].split(',')|map('trim')|map('int') %}
	{% set algo = printer["configfile"].config["bed_mesh"]["algorithm"]|lower %}
	{% set xMeshPPS, yMeshPPS = (printer["configfile"].config["bed_mesh"]["mesh_pps"]|default('2,2')).split(',')|map('trim')|map('int') %}
	
	{% set margin = params.MARGIN|default(5)|int %}
	{% set force_mesh = params.FORCE_MESH|default(False) %}
	
	
	
	
	{% if params.SIZE is defined and params.SIZE != "0_0_0_0" %}
	RESPOND MSG="Got a SIZE parameter for the adaptive bed mesh"
	{% set xMinSpec, yMinSpec, xMaxSpec, yMaxSpec = params.SIZE.split('_')|map('trim')|map('int') %}
	
	{% elif printer.exclude_object.objects %}
	
	
	RESPOND MSG="No SIZE parameter, using the [exclude_object] tags for the adaptive bed mesh"
	{% set eo_points = printer.exclude_object.objects|map(attribute='polygon')|sum(start=[]) %}
	{% set xMinSpec = eo_points|map(attribute=0)|min %}
	{% set yMinSpec = eo_points|map(attribute=1)|min %}
	{% set xMaxSpec = eo_points|map(attribute=0)|max %}
	{% set yMaxSpec = eo_points|map(attribute=1)|max %}
	
	{% else %}
	
	
	RESPOND MSG="No info about the first layer coordinates, doing a nominal bed mesh instead of adaptive"
	{% endif %}
	
	
	
	
	{% if xMinSpec and yMinSpec and xMaxSpec and yMaxSpec %}
	
	
	
	
	{% set xMin = [xMinConf, (xMinSpec - margin)]|max %}
	{% set xMax = [xMaxConf, (xMaxSpec + margin)]|min %}
	{% set yMin = [yMinConf, (yMinSpec - margin)]|max %}
	{% set yMax = [yMaxConf, (yMaxSpec + margin)]|min %}
	
	
	
	
	{% set xProbeCnt = ((xMax - xMin) * xProbeCntConf / (xMaxConf - xMinConf))|round(0, 'ceil')|int %}
	{% set yProbeCnt = ((yMax - yMin) * yProbeCntConf / (yMaxConf - yMinConf))|round(0, 'ceil')|int %}
	
	
	
	
	
	
	
	
	{% if xProbeCnt < 3 and yProbeCnt < 3 %}
	{% if force_mesh %}
	RESPOND MSG="Bed mesh forced (small part detected): meshing 3x3..."
	{% set xProbeCnt = 3 %}
	{% set yProbeCnt = 3 %}
	{% set rRefIndex = 4 %}
	{% set algo = "lagrange" %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% else %}
	RESPOND MSG="Computed mesh parameters: none, bed mesh not needed for very small parts"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={False}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	{% else %}
	{% set xProbeCnt = [3, xProbeCnt]|max %}
	{% set yProbeCnt = [3, yProbeCnt]|max %}
	
	
	
	{% if xProbeCnt % 2 == 0 %}
	{% set xProbeCnt = xProbeCnt + 1 %}
	{% endif %}
	{% if yProbeCnt % 2 == 0 %}
	{% set yProbeCnt = yProbeCnt + 1 %}
	{% endif %}
	
	
	{% if xMeshPPS != 0 or yMeshPPS != 0 %}
	{% set probeCntMin = [xProbeCnt, yProbeCnt]|min %}
	{% set probeCntMax = [xProbeCnt, yProbeCnt]|max %}
	{% if algo == "lagrange" and probeCntMax > 6 %}
	
	{% set algo = "bicubic" %}
	{% endif %}
	{% if algo == "bicubic" and probeCntMin < 4 %}
	{% if probeCntMax > 6 %}
	
	{% if xProbeCnt > yProbeCnt %}
	{% set yProbeCnt = 5 %}
	{% else %}
	{% set xProbeCnt = 5 %}
	{% endif %}
	{% else %}
	
	{% set algo = "lagrange" %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	{% set rRefIndex = (((xProbeCnt * yProbeCnt) - 1) / 2)|int %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	
	
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% endif %}
	{% else %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={True}
	
	{% set xCenter = xMinConf + ((xMaxConf - xMinConf) / 2) %}
	{% set yCenter = yMinConf + ((yMaxConf - yMinConf) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={True}

[gcode_macro ADAPTIVE_BED_MESH]
description = Perform a bed mesh, but only where and when it's needed
gcode = 
	{% set ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	
	{% if ready %}
	_DO_ADAPTIVE_MESH
	
	
	
	{% else %}
	RESPOND MSG="Adaptive bed mesh: parameters not already computed, automatically calling the COMPUTE_MESH_PARAMETERS macro prior to the mesh"
	COMPUTE_MESH_PARAMETERS {rawparams}
	M400
	_DO_ADAPTIVE_MESH
	{% endif %}

[gcode_macro _DO_ADAPTIVE_MESH]
gcode = 
	
	{% set do_mesh = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_mesh %}
	{% set do_nominal = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_nominal %}
	{% set mesh_min = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_min %}
	{% set mesh_max = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_max %}
	{% set probe_count = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].probe_count %}
	{% set rRefIndex = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].rri %}
	{% set algo = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].algo %}
	
	
	
	
	{% if do_mesh %}
	
	{% if do_nominal %}
	RESPOND MSG="Adaptive bed mesh: nominal bed mesh"
	BED_MESH_CALIBRATE
	{% else %}
	{% if printer["configfile"].config["bed_mesh"]["relative_reference_index"] is defined %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}
	{% endif %}
	{% endif %}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: no mesh to be done"
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={False}

[bed_mesh]
speed = 350
horizontal_move_z = 12
mesh_min = 25, 25
mesh_max = 325, 325
probe_count = 9, 9
fade_start = 0.6
fade_end = 10.0
algorithm = bicubic
relative_reference_index = 40

[tmc2209 stepper_x]
diag_pin = ^X_STOP
driver_sgthrs = 50
uart_pin = X_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_y]
diag_pin = ^Y_STOP
driver_sgthrs = 60
uart_pin = Y_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[input_shaper]
shaper_freq_x = 56.4
shaper_type_x = zv
shaper_freq_y = 38.4
shaper_type_y = mzv

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing = _BASE_QUAD_GANTRY_LEVEL
description = Conform a moving, twistable gantry to the shape of a stationary bed with klicky automount
gcode = 
	{% set tilting_travel_accel = printer["gcode_macro _USER_VARIABLES"].tilting_travel_accel %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if verbose %}
	{ action_respond_info("Quad gantry leveling") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{tilting_travel_accel}
	
	_BASE_QUAD_GANTRY_LEVEL {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	DEACTIVATE_PROBE

[gcode_macro _TILT_CALIBRATE]
description = Do a QGL, Z_tilt, etc... depending of the machine configuration
gcode = 
	{% set FORCE_OPERATION = params.FORCE|default(true) %}
	{% set conf_QGL = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set conf_ztilt = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="LEVELING"
	{% endif %}
	
	{% if conf_QGL %}
	{% if printer.quad_gantry_level.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="QGL..."
	{% endif %}
	QUAD_GANTRY_LEVEL
	{% endif %}
	{% elif conf_ztilt %}
	{% if printer.z_tilt.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="Z tilt adjust..."
	{% endif %}
	Z_TILT_ADJUST
	{% endif %}
	{% else %}
	{% if verbose %}
	RESPOND MSG="No tilt calibration needed on this machine. Continuing..."
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[quad_gantry_level]
gantry_corners = 
	-60,-10
	410,420
points = 
	50,25
	50,275
	300,275
	300,25
speed = 350
horizontal_move_z = 12
retries = 5
retry_tolerance = 0.0075
max_adjust = 10

[virtual_sdcard]
path = ~/printer_data/gcodes
on_error_gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	STATUS_LEDS COLOR="ERROR"
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	_PROBE_ON_ERROR_ACTION
	{% endif %}

[exclude_object]

[idle_timeout]
timeout = 1800

[pause_resume]

[display_status]

[respond]

[force_move]
enable_force_move = True

[gcode_arcs]
resolution = 0.1

[gcode_macro CANCEL_PRINT]
rename_existing = BASE_CANCEL_PRINT
description = Cancel the print, retract 10mm of filament and park
gcode = 
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload_on_cancel_print = printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_cancel_print %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload_on_cancel_print %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	SDCARD_RESET_FILE
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_OFF
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}
	
	BASE_CANCEL_PRINT

[gcode_macro END_PRINT]
description = Stop the print and filter the atmosphere for 10min before shuting down
gcode = 
	{% set disable_motors_in_end_print = printer["gcode_macro _USER_VARIABLES"].disable_motors_in_end_print %}
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set light_intensity_end_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_end_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload = params.ERCF_UNLOAD_AT_END|default(printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_end_print)|int %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G92 E0
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if disable_motors_in_end_print %}
	M84
	{% endif %}
	
	
	
	
	{% if filter_enabled %}
	{% set FILTER_TIME = params.FILTER_TIME|default(600)|int %}
	START_FILTER SPEED=1
	UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED DURATION={FILTER_TIME}
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_end_print}
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}

[gcode_macro PARK]
description = Park the toolhead at the back and retract some filament if the nozzle is hot
gcode = 
	{% set E = params.E|default(1.7)|float %}
	
	{% set Px, Py = printer["gcode_macro _USER_VARIABLES"].park_position_xy|map('float') %}
	{% set park_lift_z = printer["gcode_macro _USER_VARIABLES"].park_lift_z %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	
	{% set z_safe = act_z + park_lift_z %}
	{% if z_safe > max_z %}
	{% set z_safe = max_z %}
	{% endif %}
	
	
	{% if printer.extruder.temperature > 185 and firmware_retraction_enabled %}
	G10
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	G0 X{Px} Y{Py} F{St}

[gcode_macro PAUSE]
rename_existing = BASE_PAUSE
description = Pause the print and park
gcode = 
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	
	{% if printer.pause_resume.is_paused %}
	RESPOND MSG="Print is already paused"
	{% else %}
	SAVE_GCODE_STATE NAME=PAUSE_state
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	BASE_PAUSE
	PARK
	{% endif %}

[gcode_macro RESUME]
rename_existing = BASE_RESUME
description = Resume the print after an optional unretract
gcode = 
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	
	{% if not printer.pause_resume.is_paused %}
	RESPOND MSG="Print is not paused. Resume ignored"
	{% else %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={St}
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	BASE_RESUME
	{% endif %}

[gcode_macro START_PRINT]
description = Machine heatup procedure before starting a print
variable_bed_temp = 0
variable_extruder_temp = 0
variable_z_adjust = 0
variable_soak = 0
variable_chamber_temp = 0
variable_chamber_maxtime = 0
variable_initial_tool = 0
variable_material = "XXX"
variable_fl_size = "0_0_0_0"
gcode = 
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_ADJUST = params.Z_ADJUST|default(0)|float %}
	{% set SOAK = params.SOAK|default(printer["gcode_macro _USER_VARIABLES"].print_default_soak)|int %}
	{% set CHAMBER_TEMP = params.CHAMBER|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_temp)|int %}
	{% set CHAMBER_MAXTIME = params.CHAMBER_MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	{% set INITIAL_TOOL = params.INITIAL_TOOL|default(0)|int %}
	{% set MATERIAL = params.MATERIAL|default(printer["gcode_macro _USER_VARIABLES"].print_default_material)|string %}
	{% set FL_SIZE = params.SIZE|default("0_0_0_0")|string %}
	
	
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=bed_temp VALUE={BED_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=extruder_temp VALUE={EXTRUDER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=soak VALUE={SOAK}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_temp VALUE={CHAMBER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_maxtime VALUE={CHAMBER_MAXTIME}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=initial_tool VALUE={INITIAL_TOOL}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=material VALUE='"{MATERIAL}"'
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=fl_size VALUE='"{FL_SIZE}"'
	
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_reset_stats_on_start_print = printer["gcode_macro _USER_VARIABLES"].ercf_reset_stats_on_start_print %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% if MATERIAL not in printer["gcode_macro _USER_VARIABLES"].material_parameters %}
	RESPOND MSG="Material '{MATERIAL}' is unknown!"
	{ action_raise_error("Add this new material to your material_parameters variable!") }
	{% else %}
	RESPOND MSG="Material '{MATERIAL}' is used"
	{% set material = printer["gcode_macro _USER_VARIABLES"].material_parameters[MATERIAL] %}
	{% endif %}
	
	
	
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="BUSY"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if ercf_reset_stats_on_start_print %}
	ERCF_RESET_STATS
	{% endif %}
	{% endif %}
	{% endif %}
	
	SET_GCODE_OFFSET Z=0
	M221 S100
	M220 S100
	G90
	M83
	
	
	{% if firmware_retraction_enabled %}
	SET_RETRACTION RETRACT_LENGTH={material.retract_length} RETRACT_SPEED={material.retract_speed} UNRETRACT_EXTRA_LENGTH={material.unretract_extra_length} UNRETRACT_SPEED={material.unretract_speed}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={material.pressure_advance}
	
	
	{% if force_homing_in_start_print %}
	G28
	{% else %}
	_CG28
	{% endif %}
	
	
	
	{% set sp_actions = printer["gcode_macro _USER_VARIABLES"].startprint_actions %}
	{% for action in sp_actions %}
	{% if action == "bed_soak" %}
	_MODULE_HEATSOAK_BED
	{% elif action == "chamber_soak" %}
	_MODULE_HEATSOAK_CHAMBER
	{% elif action == "tilt_calib" %}
	_MODULE_TILTING
	{% elif action == "extruder_heating" %}
	_MODULE_EXTRUDER_HEATING
	{% elif action == "purge" %}
	_MODULE_PURGE
	{% elif action == "clean" %}
	_MODULE_CLEAN
	{% elif action == "z_offset" %}
	_MODULE_Z_CALIB
	{% elif action == "bedmesh" %}
	_MODULE_BED_MESH
	{% elif action == "primeline" %}
	_MODULE_PRIMELINE
	{% elif action == "extruder_preheating" %}
	_MODULE_EXTRUDER_PREHEATING
	{% elif action == "custom1" %}
	_MODULE_CUSTOM1
	{% elif action == "custom2" %}
	_MODULE_CUSTOM2
	{% elif action == "custom3" %}
	_MODULE_CUSTOM3
	{% else %}
	{ action_raise_error("Unknown module called in START_PRINT! Please verify your startprint_actions variable override!") }
	{% endif %}
	{% endfor %}
	
	
	
	SET_GCODE_OFFSET Z_ADJUST={Z_ADJUST} MOVE=1
	
	
	SET_GCODE_OFFSET Z_ADJUST={material.additional_z_offset} MOVE=1
	{% if filter_enabled %}
	START_FILTER SPEED={material.filter_speed / 100}
	{% endif %}
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="PRINTING"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Start printing !"
	{% endif %}
	
	G92 E0.0

[gcode_macro _MODULE_PRIMELINE]
gcode = 
	PRIMELINE

[gcode_macro _MODULE_HEATSOAK_BED]
gcode = 
	
	
	
	
	
	{% set BED_TEMP = printer["gcode_macro START_PRINT"].bed_temp %}
	{% set SOAK = printer["gcode_macro START_PRINT"].soak %}
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if printer.heater_bed.target < (BED_TEMP - 8) %}
	
	
	{% if (CHAMBER_TEMP > 0) and filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	{% if SOAK > 0 %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME={SOAK}
	{% else %}
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME=0
	{% endif %}

[gcode_macro _MODULE_HEATSOAK_CHAMBER]
gcode = 
	
	
	
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	{% set CHAMBER_MAXTIME = printer["gcode_macro START_PRINT"].chamber_maxtime %}
	
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if chamber_sensor_enabled %}
	{% if CHAMBER_TEMP > 0 %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	
	{% if CURRENT_TEMP <= CHAMBER_TEMP %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	
	
	{% if filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	HEATSOAK_CHAMBER TEMP={CHAMBER_TEMP} MAXTIME={CHAMBER_MAXTIME}
	
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_TILTING]
gcode = 
	
	
	
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	_TILT_CALIBRATE FORCE={force_homing_in_start_print}

[gcode_macro _MODULE_EXTRUDER_HEATING]
gcode = 
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	{% set INITIAL_TOOL = printer["gcode_macro START_PRINT"].initial_tool %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder heating to print temperature..."
	{% endif %}
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET
	{% if not purge_and_brush_enabled %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	M109 S{EXTRUDER_TEMP}
	
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	ERCF_CHANGE_TOOL STANDALONE=1 TOOL={INITIAL_TOOL}
	_ERCF_ERROR_CHECK
	{% endif %}
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder temperature OK"
	{% endif %}

[gcode_macro _MODULE_PURGE]
gcode = 
	
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	
	{% if purge_and_brush_enabled %}
	PURGE TEMP={EXTRUDER_TEMP}
	{% endif %}

[gcode_macro _MODULE_CLEAN]
gcode = 
	
	
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set force_homing_before_brush = printer["gcode_macro _USER_VARIABLES"].force_homing_before_brush %}
	
	{% if purge_and_brush_enabled %}
	{% if force_homing_before_brush %}
	G28 Z
	{% endif %}
	CLEAN_NOZZLE
	{% endif %}

[gcode_macro _MODULE_Z_CALIB]
gcode = 
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% if bed_mesh_enabled and printer.bed_mesh.profile_name == "" %}
	COMPUTE_MESH_PARAMETERS SIZE={FL_SIZE}
	{% endif %}
	
	{% if zcalib_plugin_enabled %}
	G28 Z
	CALIBRATE_Z
	{% else %}
	G28 Z
	{% endif %}

[gcode_macro _MODULE_BED_MESH]
gcode = 
	
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if bed_mesh_enabled %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="MESHING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Bed mesh measurement..."
	{% endif %}
	
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	ADAPTIVE_BED_MESH
	{% else %}
	ADAPTIVE_BED_MESH SIZE={FL_SIZE}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_EXTRUDER_PREHEATING]
gcode = 
	
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Pre-heating the nozzle to a safe temperature..."
	{% endif %}
	
	M109 S{safe_extruder_temp}
	
	{% if verbose %}
	RESPOND MSG="Extruder at safe temperature of {safe_extruder_temp} degrees"
	{% endif %}

[gcode_macro _MODULE_CUSTOM1]
gcode = 

[gcode_macro _MODULE_CUSTOM2]
gcode = 

[gcode_macro _MODULE_CUSTOM3]
gcode = 

[gcode_macro _CG28]
description = Homing only if necessary
gcode = 
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	{% if "xyz" not in printer.toolhead.homed_axes %}
	G28
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[homing_override]
axes = xyz
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set homing_zhop = printer["gcode_macro _USER_VARIABLES"].homing_zhop|float %}
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed * 60 %}
	{% set homing_travel_accel = printer["gcode_macro _USER_VARIABLES"].homing_travel_accel %}
	{% set sensorless_homing_enabled = printer["gcode_macro _USER_VARIABLES"].sensorless_homing_enabled %}
	{% set sensorless_current_factor = printer["gcode_macro _USER_VARIABLES"].sensorless_current_factor / 100 %}
	{% set z_drop_speed = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% set homing_first = printer["gcode_macro _USER_VARIABLES"].homing_first|string|upper %}
	{% set x_homing_backoff, y_homing_backoff = printer["gcode_macro _USER_VARIABLES"].homing_backoff_distance_xy|map('float') %}
	
	{% set x_position_endstop = printer["configfile"].config["stepper_x"]["position_endstop"]|float %}
	{% set y_position_endstop = printer["configfile"].config["stepper_y"]["position_endstop"]|float %}
	{% set x_position_center = printer.toolhead.axis_maximum.x|int/2 - printer.toolhead.axis_minimum.x|int/2 %}
	{% set y_position_center = printer.toolhead.axis_maximum.y|int/2 - printer.toolhead.axis_minimum.y|int/2 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	{% set X, Y, Z = False, False, False %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	
	{% if not 'X' in params
	and not 'Y' in params
	and not 'Z' in params %}
	
	{% set X, Y, Z = True, True, True %}
	
	{% else %}
	{% if 'X' in params %}
	{% set X = True %}
	{% endif %}
	
	{% if 'Y' in params %}
	{% set Y = True %}
	{% endif %}
	
	{% if 'Z' in params %}
	{% set Z = True %}
	{% endif %}
	
	{% if 'X' in params
	and 'Y' in params
	and 'Z' in params %}
	
	
	_HOMING_VARIABLES reset=1
	{% endif %}
	
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_ENTRY_POINT FUNCTION=homing_override
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{homing_travel_accel}
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	G90
	
	{% if Z %}
	{% if ('z' in printer.toolhead.homed_axes) %}
	{% if (printer.toolhead.position.z < homing_zhop) %}
	{% if verbose %}
	{ action_respond_info("Z too low, performing ZHOP") }
	{% endif %}
	G0 Z{homing_zhop} F{z_drop_speed}
	{% endif %}
	{% elif ('xy' in printer.toolhead.homed_axes) %}
	{% if verbose %}
	{ action_respond_info("X and Y already homed, no ZHOP needed to home Z") }
	{% endif %}
	{% else %}
	{% if verbose %}
	{ action_respond_info("X and Y not homed, forcing full G28 to home Z properly") }
	{% endif %}
	SET_KINEMATIC_POSITION X=0 Y=0 Z=0
	G0 Z{homing_zhop} F{z_drop_speed}
	{% set X, Y, Z = True, True, True %}
	{% endif %}
	{% endif %}
	
	{% if homing_first == "X" %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% elif homing_first == "Y" %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% else %}
	{ action_respond_error("Axis homing order not valid. Choose either X or Y first in the variables.cfg file!") }
	{% endif %}
	
	
	
	{% if Z %}
	{% if verbose %}
	{ action_respond_info("Homing Z") }
	{% endif %}
	
	
	
	
	
	
	{% if printer["configfile"].config["stepper_z"]["endstop_pin"]|lower == "probe:z_virtual_endstop" %}
	
	{% if probe_type_enabled == "dockable_virtual" %}
	ACTIVATE_PROBE
	{% endif %}
	{% if bed_mesh_enabled %}
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	{% set mesh_center = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_center %}
	{% set x_mesh_center, y_mesh_center = mesh_center.split(',')|map('trim')|map('float') %}
	RESPOND MSG="Z homing: a mesh is computed and ready, probing mesh center: {mesh_center}"
	G0 X{x_mesh_center} Y{y_mesh_center} F{homing_travel_speed}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	
	
	{% else %}
	_GOTO_Z_PROBE
	{% endif %}
	
	
	{% if probe_type_enabled == "vorontap" %}
	ACTIVATE_PROBE
	{% endif %}
	
	G28 Z0
	
	G91
	G0 Z{homing_zhop} F{z_drop_speed}
	G90
	
	
	
	{% if probe_type_enabled == "vorontap" or probe_type_enabled == "dockable_virtual" %}
	DEACTIVATE_PROBE
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_EXIT_POINT FUNCTION=homing_override
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _GOTO_Z_PROBE]
description = Move to z probe avoiding the probe dock
gcode = 
	
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% if zcalib_plugin_enabled %}
	{% set z_endstop_x, z_endstop_y = printer["configfile"].config["z_calibration"]["nozzle_xy_position"].split(',')|map('trim')|map('float') %}
	{% else %}
	{% set z_endstop_x, z_endstop_y = printer["gcode_macro _USER_VARIABLES"].zendstop_position|map('float') %}
	{% endif %}
	
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed|float * 60 %}
	
	{% set probe_dock_location_x, probe_dock_location_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_location_xy|map('float') %}
	{% set probe_dock_margin_x, probe_dock_margin_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_margin_xy|map('float') %}
	
	{% set current_x = printer.toolhead.position.x|float %}
	{% set current_y = printer.toolhead.position.y|float %}
	
	SAVE_GCODE_STATE NAME=goto_ZProbe
	G90
	
	
	{% set avoid_dock = false %}
	{% if probe_dock_location_x < z_endstop_x|float %}
	
	
	{% if current_x < (probe_dock_location_x + probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% else %}
	
	
	{% if current_x > (probe_dock_location_x - probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% endif %}
	
	
	{% if avoid_dock == true  %}
	
	G0 Y{probe_dock_location_y - probe_dock_margin_y} F{homing_travel_speed}
	
	G0 X{z_endstop_x} F{homing_travel_speed}
	{% endif %}
	
	G0 X{z_endstop_x} Y{z_endstop_y} F{homing_travel_speed}
	
	RESTORE_GCODE_STATE NAME=goto_ZProbe

[gcode_macro CALIBRATE]
description = Calibrate the printer flow or pressure advance
gcode = 
	
	{% set TYPE = params.TYPE|default("")|string|lower %}
	
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set MATERIAL = params.MATERIAL|default("ABS")|string %}
	
	{% set center_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set center_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% if TYPE=="flow" %}
	
	{% set computed_size = (center_x - 20)|string + '_' + (center_y - 20)|string + '_' + (center_x + 20)|string + '_' + (center_y + 20)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	FLOW_MULTIPLIER_CALIBRATION EXTRUSION_WIDTH=0.471
	END_PRINT FILTER_TIME=0
	
	{% elif TYPE=="pressure_advance" %}
	
	{% set computed_size = (center_x - 60)|string + '_' + (center_y - 60)|string + '_' + (center_x + 60)|string + '_' + (center_y + 60)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	PRESSURE_ADVANCE_CALIBRATION
	END_PRINT FILTER_TIME=0
	
	{% else %}
	{action_respond_info("Please call this macro using TYPE= \"flow\" or \"pressure_advance\"")}
	{action_raise_error("not enough parameters to start a calibration!")}
	
	{% endif %}

[gcode_macro _FLOW_CALIB_VARIABLES]
variable_last_shell_thickness = 0.0
variable_last_evalue = 0.0
gcode = 

[gcode_macro FLOW_MULTIPLIER_CALIBRATION]
description = Print a small tower to calibrate the extrusion flow multiplier by measuring the shell
gcode = 
	
	
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	{% set do_retract = params.DO_RECTRACT|default(0)|int %}
	{% set print_size = params.PRINT_SIZE|default(40)|int %}
	{% set print_height = params.HEIGHT|default(15)|int %}
	{% set corner_radius = params.CORNER_RADIUS|default(8)|int %}
	{% set number_of_perimeters = params.PERIMETERS|default(2)|int %}
	{% set fan_speed = params.FAN_SPEED|default(20)|int %}
	
	{% set e_multiplier = params.EXTRUSION_MULTIPLIER|default(1.00)|float %}
	{% set filament_diameter = params.FILAMENT_DIAMETER|default(1.75)|float %}
	{% set extrusion_width = params.EXTRUSION_WIDTH|default(0.4)|float %}
	{% set layer_height = params.LAYER_HEIGHT|default(0.2)|float %}
	
	{% set retract_length = params.RETRACT_LENGTH|default(0.5)|float %}
	{% set initial_purge = params.PURGE_MM|default(1)|int %}
	{% set z_hop_height  = 2 * layer_height %}
	
	{% set feedrate_print = params.CONTROL_SPEED|default(100)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft = params.RAFT_SPEED|default(60)|int * 60 %}
	{% set feedrate_z = params.Z_LIFT_SPEED|default(20)|int * 60 %}
	{% set feedrate_retract = params.RETRACT_SPEED|default(50)|int * 60 %}
	
	
	
	
	{% set e_per_mm = ((extrusion_width - layer_height) * layer_height + 3.14159 * (layer_height / 2)**2) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set spacing = extrusion_width - layer_height * (1 - 3.14159 / 4) %}
	{% set shell_thickness = extrusion_width + (number_of_perimeters|float - 1) * spacing %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set x_start = max_x / 2 - print_size / 2 %}
	{% set y_start = max_y / 2 - print_size / 2 %}
	{% set x_end = x_start + print_size %}
	{% set y_end = y_start + print_size %}
	
	{% set num_raft_lines = ([print_size, max_x]|min / spacing)|round(0, 'floor')|int %}
	{% set raft_size = num_raft_lines * spacing %}
	
	
	
	
	{action_respond_info("")}
	{action_respond_info("Starting extrusion flow calibration print")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	{action_respond_info("Exrusion multiplier used: %.4f" % e_multiplier)}
	{action_respond_info("Number of perimeters to print: %d" % number_of_perimeters)}
	{action_respond_info("THEORIC SHELL THICKNESS: %.4f" % shell_thickness)}
	{action_respond_info("")}
	{action_respond_info("Measure the shell thickness using a caliper or micrometer. Then call the computation macro with the measured value:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION
	
	
	
	
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_shell_thickness VALUE={shell_thickness}
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_evalue VALUE={e_multiplier}
	
	
	
	
	G90
	M83
	G92 E0.0
	G0 X{x_start} Y{y_start - 5} Z{layer_height} F{feedrate_travel}
	
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{raft_size} E{raft_size * e_per_mm * 1.5} F{feedrate_raft / 2}
	G1 Y-{extrusion_width} E{extrusion_width * e_per_mm} F{feedrate_raft / 2}
	G1 X-{raft_size} E{raft_size * e_per_mm} F{feedrate_raft / 2}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G90
	G0 X{x_start} Y{y_start} F{feedrate_travel}
	G1 Z{layer_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	
	
	M221 S{e_multiplier * 100}
	
	
	
	
	{% if do_raft == 1 %}
	G91
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	G1 Y{loop.cycle(1.0, -1.0) * raft_size} E{raft_size * e_per_mm} F{feedrate_raft}
	
	
	{% if not loop.last %}
	G1 X{spacing} E{spacing * e_per_mm} F{feedrate_raft}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	
	
	
	
	G90
	M106 S{fan_speed * 255 / 100}
	
	
	{% for curr_layer in range(1, (print_height / layer_height)|round|int) %}
	G0 X{x_start + corner_radius} Y{y_start} F{feedrate_travel}
	G1 Z{(curr_layer * layer_height) + (layer_height if do_raft == 1 else 0)} F{feedrate_z}
	
	
	{% for perim_num in range(number_of_perimeters) %}
	
	{% set perim_offset = perim_num * spacing %}
	{% set perim_radius = corner_radius - (perim_num * spacing) %}
	
	
	G1 X{x_start + corner_radius} Y{y_start + perim_offset} F{feedrate_travel}
	{% if do_retract == 1 %}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	
	
	G1 X{x_end - corner_radius} Y{y_start + perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - perim_offset} Y{y_start + corner_radius} J{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_end - perim_offset} Y{y_end - corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - corner_radius} Y{y_end - perim_offset} I-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + corner_radius} Y{y_end - perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + perim_offset} Y{y_end - corner_radius} J-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + perim_offset} Y{y_start + corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + corner_radius} Y{y_start + perim_offset} I{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	
	{% if do_retract == 1 %}
	G1 E-{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	
	{% if do_retract == 1 %}
	G91
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G91
	G0 Z20 F{feedrate_travel}
	
	RESTORE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION

[gcode_macro COMPUTE_FLOW_MULTIPLIER]
description = Compute a new flow multiplier by using the measured shell thickness on the calibration print
gcode = 
	{% set evalue = params.OLD_EXTRUSION_MULTIPLIER|default(0.0)|float %}
	{% set theorical_thickness = params.THEORICAL_THICKNESS|default(0.0)|float %}
	{% set measured_thickness = params.MEASURED_THICKNESS|default(0.0)|float %}
	
	
	{% if evalue == 0.0 %}
	{% set last_evalue = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_evalue %}
	
	
	{% if last_evalue == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_evalue = last_evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	{% else %}
	{% set final_evalue = evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	
	
	{% if theorical_thickness == 0.0 %}
	{% set last_shell_thickness = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_shell_thickness %}
	
	
	{% if last_shell_thickness == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_theorical_thickness = last_shell_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	{% else %}
	{% set final_theorical_thickness = theorical_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	
	
	{% if measured_thickness == 0.0 %}
	{action_respond_info("You must use a caliper or micrometer to measure the calibration print shell thickness and call this macro with the measured value !!!")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set new_evalue = final_theorical_thickness * final_evalue / measured_thickness %}
	{action_respond_info("NEW COMPUTED FLOW VALUE: %.3f" % new_evalue)}
	{action_respond_info("Use this new value as extrusion multiplier in your slicer of choice")}
	{action_respond_info("")}
	{% endif %}

[gcode_macro PRESSURE_ADVANCE_CALIBRATION]
description = Calibrate the pressure advance by printing a grid pattern
gcode = 
	
	
	
	{% set pa_start     = params.START|default(0.02)|float %}
	{% set pa_increment = params.INCREMENT|default(0.005)|float %}
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	
	{% set print_size      = params.PRINT_SIZE|default(120)|int %}
	{% set num_bands       = params.BANDS_LIMIT|default(999)|int %}
	{% set lines_per_band  = params.LINES_PER_BAND|default(6)|int %}
	{% set e_multiplier    = params.EXTRUSION_MULTIPLIER|default(1.25 if do_raft == 1 else 1.5)|float %},
	{% set retract_length  = params.RETRACT_LENGTH|default(0.6)|float %}
	{% set initial_purge   = params.PURGE_MM|default(8)|int %}
	
	{% set feedrate_control = params.CONTROL_SPEED|default(30)|int * 60 %}
	{% set feedrate_outer   = params.OUTER_SPEED|default(40)|int * 60 %}
	{% set feedrate_inner   = params.INNER_SPEED|default(120)|int * 60 %}
	{% set feedrate_travel  = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft    = params.RAFT_SPEED|default(120)|int * 60 %}
	{% set feedrate_z       = 5 * 60 %}
	{% set feedrate_retract = 50 * 60 %}
	
	{% set spacing_line  = params.LINE_SPACING|default(0.4)|float %}
	{% set spacing_band  = 2 %}
	{% set spacing_raft  = 2 %}
	
	{% set fast_line_ratio_percent = 50 %}
	
	{% set lines_per_band    = [2, lines_per_band]|max %}
	{% set e_multiplier      = [1, e_multiplier]|max %}
	{% set num_lines_control = (lines_per_band / 2)|round(0, 'floor')|int %}
	{% set num_lines_test    = (lines_per_band / 2)|round(0, 'ceil')|int %}
	{% set spacing_line      = spacing_line * (1 + e_multiplier - 1.25) %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set nozzle_diameter = printer.configfile.config['extruder'].nozzle_diameter|float %}
	{% set line_width    = nozzle_diameter * 1.25 %}
	{% set line_height   = nozzle_diameter / 2 %}
	{% set z_hop_height  = 2 * line_height %}
	{% set e_per_mm      = (line_width * line_height) / (3.1415 * (1.75/2)**2) %}
	{% set spacing_purge = line_height * 0.8 %}
	
	{% set spacing_raft   = (spacing_raft / line_width)|round * line_width %}
	{% set num_raft_lines = ([print_size, max_x]|min / spacing_raft)|round(0, 'floor')|int %}
	{% set print_width    = num_raft_lines * spacing_raft %}
	
	{% set band_height      = lines_per_band * line_width + (lines_per_band - 1) * spacing_line + spacing_band %}
	{% set bands_per_height = (([print_size, max_y]|min  - spacing_purge - 2 * line_width + spacing_band) / band_height)|round(0, 'floor')|int %}
	{% set num_bands        = [num_bands, bands_per_height]|min %}
	{% set print_height     = num_bands * band_height - spacing_band + spacing_purge +  2 * line_width %}
	
	{% set slow_line_length = ((print_width * (1 - fast_line_ratio_percent / 100) / 2) / spacing_raft)|round * spacing_raft + spacing_raft / 2 %}
	{% set fast_line_length = print_width - slow_line_length * 2 %}
	{% set thick_raft_num1 = (slow_line_length / spacing_raft)|round|int %}
	{% set thick_raft_num2  = num_raft_lines - thick_raft_num1 + 1 %}
	
	{% set x_start = max_x / 2 - print_width  / 2 %}
	{% set y_start = max_y / 2 - print_height / 2 %}
	
	{action_respond_info("")}
	{action_respond_info("Starting Pressure Advance calibration print.")}
	{action_respond_info("")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button once the print starts exhibiting PA values that are obviously too high.")}
	{action_respond_info("")}
	{action_respond_info("PA of first band: %.4f" % pa_start)}
	{action_respond_info("PA of last band: %.4f" % (pa_start + ((num_bands - 1) * pa_increment)))}
	{action_respond_info("PA increment per band: %.4f" % pa_increment)}
	{action_respond_info("Number of bands: %d" % num_bands)}
	{action_respond_info("")}
	{action_respond_info("Inspect the printed model. "
	"Look at the top and bottom lines in each band, on the right side of the two vertical raft bars (where the print speeds change). "
	"Find the highest band from the bottom where the lines at its top still resemble the lines at its bottom, with no visible extrusion width irregularities. "
	"Your final Pressure Advance value would then be:"
	)}
	{action_respond_info("")}
	{action_respond_info("Assuming that first band_number is 0")}
	{action_respond_info("PA = %.4f + (%.4f * band_number)" % (pa_start, pa_increment))}
	{action_respond_info("")}
	{action_respond_info("Update your [extruder] config section and set \"pressure_advance\" to the value you calculated.")}
	{action_respond_info("")}
	
	
	
	
	
	
	
	
	
	SAVE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION
	{% set pa_saved = printer.configfile.settings['extruder'].pressure_advance %}
	SET_PRESSURE_ADVANCE ADVANCE={pa_start}
	
	
	
	
	M221 S100
	
	
	
	
	M117 Priming
	G90
	G0 X{x_start} Y{y_start} Z{line_height} F{feedrate_travel}
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{print_width}  E{print_width * e_per_mm} F{feedrate_raft / 2}
	G1 Y{line_width}   E{line_width * e_per_mm}  F{feedrate_raft / 2}
	G1 X-{print_width} E{print_width * e_per_mm} F{feedrate_raft / 2}
	
	
	
	
	{% if do_raft == 1 %}
	G0 F{feedrate_raft}
	
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	{% if curr_raft_line == thick_raft_num1 or curr_raft_line == thick_raft_num2 %}
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	G1 Y{loop.cycle(-1.0, 1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	{% endif %}
	
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	
	
	{% if not loop.last %}
	{% set horizontal_move = spacing_raft - (2 * line_width if curr_raft_line == thick_raft_num1 - 1 or curr_raft_line == thick_raft_num2 - 1 else 0) %}
	G1 X{horizontal_move} E{horizontal_move * e_per_mm}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	{% endif %}
	
	
	
	
	M117 Printing bands
	G90
	G0 X{x_start} Y{y_start + 2 * line_width + spacing_purge} F{feedrate_travel}
	G0 Z{line_height + (line_height if do_raft == 1 else 0)} F{feedrate_z}
	G91
	G1 E{retract_length} F{feedrate_retract}
	
	
	{% for curr_band_num in range(0, num_bands ) %}
	{% set outer_loop = loop %}
	
	{% set curr_pa_value = pa_start + curr_band_num * pa_increment %}
	SET_PRESSURE_ADVANCE ADVANCE={curr_pa_value}
	M117 Band {curr_band_num} PA {curr_pa_value|round(4)}
	
	
	{% for _ in range(num_lines_control) %}
	G1 X{print_width} E{print_width * e_per_mm * e_multiplier} F{feedrate_control}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G0 X-{print_width} Y{spacing_line + line_width} F{feedrate_travel}
	
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endfor %}
	
	
	{% for _ in range(num_lines_test) %}
	{% for data in [{'mm': slow_line_length, 'f': feedrate_outer}, {'mm': fast_line_length, 'f': feedrate_inner}, {'mm': slow_line_length, 'f': feedrate_outer}] %}
	G1 X{data.mm} E{data.mm * e_per_mm * e_multiplier} F{data.f}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	{% if not (outer_loop.last and loop.last) %}
	G0 X-{print_width} Y{(spacing_line if not loop.last else spacing_band) + line_width} F{feedrate_travel}
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z20 F{feedrate_z}
	G0 X-{print_width / 2} Y{[50, max_y - (y_start + print_height)]|min} F{feedrate_travel}
	
	M117
	SET_PRESSURE_ADVANCE ADVANCE={pa_saved}
	RESTORE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION

[gcode_macro CHANGE_FILAMENT]
description = Do a PAUSE, park the toolhead over the purge bucket and unload the filament
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	SAVE_GCODE_STATE NAME=CHANGE_FILAMENT_state
	PAUSE
	UNLOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=CHANGE_FILAMENT_state

[gcode_macro UNLOAD_FILAMENT]
description = Basic unload of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to unload filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to unload filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	
	_TIP_SHAPING
	M83
	G1 E-20 F3600
	G4 P3000
	G1 E{DISTANCE|float * -1} F3000
	
	RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament unloaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament unloaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro LOAD_FILAMENT]
description = Basic load of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to load filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to load filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=LOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	M83
	G92 E0
	G1 E{DISTANCE|float} F200
	G1 E50 F150
	
	G92 E0
	RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament loaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament loaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _TIP_SHAPING]
description = Filament tip shaping sequence
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=TIP_SHAPING_state
	_LOW_TEMP_CHECK T={TEMP}
	
	{% set old_pressure_advance = printer.extruder.pressure_advance|default(0) %}
	
	SET_PRESSURE_ADVANCE ADVANCE=0
	
	M82
	G92 E0
	G1 E2 F3600
	G1 E0 F3600
	G1 E3 F3600
	G1 E0 F3600
	G1 E4 F3600
	G1 E0 F3600
	
	
	SET_PRESSURE_ADVANCE ADVANCE={old_pressure_advance}
	RESTORE_GCODE_STATE NAME=TIP_SHAPING_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_CHAMBER]
description = Heatsoak chamber to a specific temperature with a timeout
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set MAXTIME = params.MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% for _ in range(1, MAXTIME) %}
	_WAIT_CHAMBER_TEMP TEMP={SETPOINT_TEMP}
	{% endfor %}
	{% if verbose %}
	RESPOND MSG="Chamber temperature OK !"
	{% endif %}
	{% endif %}

[gcode_macro _WAIT_CHAMBER_TEMP]
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	{% if CURRENT_TEMP <= SETPOINT_TEMP %}
	RESPOND MSG="Heating up the chamber : {CURRENT_TEMP}/{SETPOINT_TEMP}"
	G4 P{60000 * 1}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_BED]
description = Heatsoak bed at specified temperature and wait for a specific amount of time
gcode = 
	{% set SETPOINT_TEMP = params.TEMP|default(0)|int %}
	{% set TIME = params.SOAKTIME|default(8)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set heaterbed_enabled = printer["gcode_macro _USER_VARIABLES"].heaterbed_enabled %}
	
	{% if heaterbed_enabled %}
	{% if verbose %}
	RESPOND MSG="Heating up bed..."
	{% endif %}
	
	M190 S{SETPOINT_TEMP}
	
	{% if TIME > 0 %}
	{% for i in range(0, TIME) %}
	RESPOND MSG="Heatsoak bed, {TIME-i}mn left..."
	G4 P{60000 * 1}
	{% endfor %}
	{% else %}
	RESPOND MSG="No heatsoak needed, continue"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Bed temperature OK"
	{% endif %}
	
	{% else %}
	{% if verbose %}
	RESPOND MSG="No bed heater defined: nothing to do, continuing..."
	{% endif %}
	{% endif %}

[gcode_macro PRIMELINE]
gcode = 
	
	{% set prime_line_length = params.LINE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_length)|float %}
	{% set prime_line_purge_distance = params.PURGE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_purge_distance)|float %}
	{% set prime_line_flowrate = params.FLOWRATE|default(printer["gcode_macro _USER_VARIABLES"].prime_line_flowrate)|float %}
	
	
	{% set prime_line_x, prime_line_y = printer["gcode_macro _USER_VARIABLES"].prime_line_xy|map('float') %}
	{% set prime_line_direction = printer["gcode_macro _USER_VARIABLES"].prime_line_direction|string|upper %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% set max_extrude_cross_section = printer["configfile"].config["extruder"]["max_extrude_cross_section"]|float %}
	{% set filament_diameter = printer["configfile"].config["extruder"]["filament_diameter"]|float %}
	
	{% set line_height = 0.6 %}
	
	
	{% set prime_line_x = params.START_X|default(prime_line_x)|float %}
	{% set prime_line_y = params.START_Y|default(prime_line_y)|float %}
	{% set prime_line_direction = params.LINE_DIRECTION|default(printer["gcode_macro _USER_VARIABLES"].prime_line_direction)|string|upper %}
	
	
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	
	
	
	{% if (line_height * line_width) > max_extrude_cross_section %}
	{% if verbose %}
	{action_respond_info("The prime_line_purge_distance of %.4f mm is too high and will exceed the max_extrude_cross_section!" % prime_line_purge_distance)}
	{% endif %}
	{% set prime_line_purge_distance = 0.98 * (max_extrude_cross_section * prime_line_length) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	{% if verbose %}
	{action_respond_info("Klippain corrected the prime_line_purge_distance to %.4f mm" % prime_line_purge_distance)}
	{% endif %}
	{% endif %}
	
	
	{% if (line_height / line_width) >= 0.5 %}
	{% if verbose %}
	{action_raise_error("The prime line will be too thin and will probably not stick properly to the bed. Increase its purge distance or decrease its length! Aborting...")}
	{% endif %}
	{% endif %}
	
	
	{% set speed = (prime_line_flowrate / (line_height * line_width)) * 60 |float %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% endif %}
	{% endif %}
	{% endif %}
	
	G91
	M83
	G1 Z5 F{Sz}
	
	
	G90
	G0 X{prime_line_x} Y{prime_line_y} F{St}
	G1 Z{line_height} F{Sz|int / 2}
	
	
	G92 E0
	G1 E18 F300
	
	
	G92 E0
	{% if prime_line_direction == "X" %}
	G1 X{prime_line_x + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% elif prime_line_direction == "Y" %}
	G1 Y{prime_line_y + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% else %}
	{ action_respond_error("Prime line direction is not valid. Choose either X or Y in the variables.cfg file!") }
	{% endif %}
	
	
	G92 E0
	G1 E-0.2 F2100
	G92 E0
	G1 Z3 F{Sz}
	M400
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection reactivated after the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro CLEAN_NOZZLE]
description = Wipe the nozzle on the brush
gcode = 
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set brush_clean_accel = printer["gcode_macro _USER_VARIABLES"].brush_clean_accel %}
	{% set brush_over_y_axis = printer["gcode_macro _USER_VARIABLES"].brush_over_y_axis %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set Sc = printer["gcode_macro _USER_VARIABLES"].brush_clean_speed * 60 %}
	
	{% set Bx, By, Bz = printer["gcode_macro _USER_VARIABLES"].brush_xyz|map('float') %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Nozzle cleaning..."
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{brush_clean_accel}
	
	
	G90
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP=1
	
	G1 X{Bx} Y{By} Z{Bz} F{St}
	
	
	G91
	{% if brush_over_y_axis %}
	{% for wipe in range(6) %}
	G1 Y-5 F{Sc}
	G1 Y+5 F{Sc}
	{% endfor %}
	{% endif %}
	
	G1 X+20 F{Sc}
	
	{% for wipe in range(6) %}
	G1 X-40 F{Sc}
	G1 X+40 F{Sc}
	{% endfor %}
	
	G90
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="clean"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro PURGE]
description = Purge a specific amount of filament ontop of the purge bucket
gcode = 
	{% set DISTANCE = params.DISTANCE|default(printer["gcode_macro _USER_VARIABLES"].purge_distance)|int %}
	{% set OOZE_TIME = params.OOZE_TIME|default(printer["gcode_macro _USER_VARIABLES"].purge_ooze_time)|int %}
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Purge filament..."
	{% endif %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% endif %}
	
	G90
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP={Z_DROP}
	
	
	_LOW_TEMP_CHECK T={TEMP}
	G92 E0
	G1 E{DISTANCE|float} F150
	
	
	G92 E0
	G1 E-1.7 F2100
	G1 E-18.3 F150
	G92 E0
	
	
	G4 P{OOZE_TIME * 1000}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _CONDITIONAL_MOVE_TO_PURGE_BUCKET]
description = Move over the purge bucket
gcode = 
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	
	{% if purge_and_brush_enabled %}
	SAVE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	G90
	
	{% if Z_DROP == 1 %}
	{% if purgeclean_servo_enabled %}
	G1 Z{Pz} F{Sz}
	_SERVO_DEPLOY ITEM="purge"
	{% endif %}
	G1 X{Px} Y{Py} Z{Pz} F{St}
	{% else %}
	
	
	
	G1 X{Px} Y{Py} F{St}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	{% endif %}

[gcode_macro _LOW_TEMP_CHECK]
description = Check the nozzle is at temperature and heat it if needed
gcode = 
	{% set T = params.T|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% if printer.extruder.target != 0 %}
	{% if printer.extruder.temperature < printer.extruder.target %}
	M109 S{printer.extruder.target|float}
	{% endif %}
	{% else %}
	{% if printer.extruder.target < T %}
	M109 S{T}
	{% endif %}
	{% endif %}

[gcode_macro M701]
description = Map M701 to LOAD_FILAMENT
gcode = 
	LOAD_FILAMENT

[gcode_macro M702]
description = Map M702 to UNLOAD_FILAMENT
gcode = 
	UNLOAD_FILAMENT

[gcode_macro M600]
description = Map M600 to CHANGE_FILAMENT
gcode = 
	CHANGE_FILAMENT

[gcode_macro M125]
description = Map M125 to PARK
gcode = 
	PARK

[gcode_macro M900]
description = Map M900 to SET_PRESSURE_ADVANCE
gcode = 
	{% if 'K' in params %}
	{% if 'E' in params %}
	SET_PRESSURE_ADVANCE EXTRUDER={params.E} ADVANCE={params.K}
	{% else %}
	SET_PRESSURE_ADVANCE ADVANCE={params.K}
	{% endif %}
	{% endif %}

[gcode_macro M204]
description = Map M204 to SET_VELOCITY_LIMIT for ACCEL and ACCEL_TO_DECEL
rename_existing = M204.1
gcode = 
	{% set F = params.F|default(printer["gcode_macro _USER_VARIABLES"].accel_to_decel_factor)|float %}
	
	{% if 'S' in params %}
	{% set S = params.S|float %}
	SET_VELOCITY_LIMIT ACCEL={S} ACCEL_TO_DECEL={S * F}
	{% endif %}

[gcode_macro M205]
description = Map M205 to SET_VELOCITY_LIMIT for SQUARE_CORNER_VELOCITY
gcode = 
	{% if 'X' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.X}
	{% elif 'Y' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.Y}
	{% endif %}

[gcode_macro G00]
gcode = 
	G0 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G01]
gcode = 
	G1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G02]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G03]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G04]
gcode = 
	G4 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro _SEARCH_VARS]
description = Search for variables in the "printer" object from Klipper
gcode = 
	{% set search = params.S|lower %}
	{% set ns = namespace() %}
	{% for item in printer  %}
	{% if ' ' in item %}
	{% set ns.path = ['printer', "['%s']" % (item), ''] %}
	{% else %}
	{% set ns.path = ['printer.', item, ''] %}
	{% endif %}
	
	{% if search in ns.path|lower %}
	{ action_respond_info(ns.path|join) }
	{% endif %}
	
	{% if printer[item].items() %}
	{% for childkey, child in printer[item].items() recursive %}
	{% set ns.path = ns.path[:loop.depth|int + 1] %}
	
	{% if ' ' in childkey %}
	{% set null = ns.path.append("['%s']" % (childkey)) %}
	{% else %}
	{% set null = ns.path.append(".%s" % (childkey)) %}
	{% endif %}
	
	{% if child is mapping  %}
	{ loop(child.items()) }
	{% else %}
	{% if search in ns.path|lower %}
	{ action_respond_info("%s : %s" % (ns.path|join, child)) }
	{% endif %}
	{% endif %}
	
	{% endfor %}
	{% endif %}
	{% endfor %}

[delayed_gcode KLIPPAIN_STARTUP]
initial_duration = 1
gcode = 
	_KLIPPAIN_STARTUP

[gcode_macro _KLIPPAIN_STARTUP]
gcode = 
	
	RUN_SHELL_COMMAND CMD=system_info
	
	
	_INIT_MCU_VER
	
	
	{% set extruder_enabled = printer["gcode_macro _USER_VARIABLES"].extruder_enabled %}
	{% if not extruder_enabled %}
	{ action_raise_error("Klippain need to have an extruder defined to work properly. Check your printer.cfg includes!") }
	{% endif %}
	
	
	_INIT_CHECKPROBECONF
	
	
	{% set e_driver = printer["gcode_macro _USER_VARIABLES"].e_driver|string %}
	{% if e_driver == "TMC2240" %}
	_INIT_TMC2240
	{% endif %}
	
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% if klippain_ercf_enabled %}
	_INIT_CHECK_ERCF
	{% endif %}
	
	
	_INIT_USERCUSTOM
	
	RESPOND MSG="Klippain started and ready !"

[gcode_macro _INIT_TMC2240]
gcode = 

[gcode_macro _INIT_CHECKPROBECONF]
gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled|string %}
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set qgl_enabled = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set ztilt_enabled = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	
	{% if zcalib_plugin_enabled %}
	{% if probe_type_enabled == "vorontap" %}
	{ action_raise_error("Voron TAP Probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "inductive" %}
	{ action_raise_error("Inductive probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "dockable_virtual" or probe_type_enabled == "inductive_virtual" %}
	{ action_raise_error("Virtual Z endstop probes are not compatible with the Z calibration plugin!") }
	{% elif probe_type_enabled == "none" %}
	{ action_raise_error("You need a probe to use the Z calibration plugin in Klippain!") }
	{% endif %}
	{% endif %}
	
	{% if bed_mesh_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a bed mesh in Klippain!") }
	{% endif %}
	
	{% if qgl_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a quad gantry leveling in Klippain!") }
	{% endif %}
	
	{% if ztilt_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a Z tilt adjust in Klippain!") }
	{% endif %}

[gcode_macro _INIT_MCU_VER]
gcode = 
	{% set parameters = namespace(output = 'Currently configured MCU(s): \n') %}
	{% for name1 in printer %}
	{% for name2 in printer[name1] %}
	{% set show = ['mcu_version'] %}
	{% if name2 is in show %}
	{% set param = "%s: %s" % (name1, printer[name1][name2]) %}
	{% set parameters.output = parameters.output +  param + "\n" %}
	{% endif %}
	{% endfor %}
	{% endfor %}
	{action_respond_info(parameters.output)}

[gcode_macro _INIT_CHECK_ERCF]
gcode = 
	{% if not printer.ercf.enabled %}
	{ action_raise_error("ERCF is enabled in Klippain, but Happy Hare, the supported ERCF backend software is not detected. Please install it now from https://github.com/moggieuk/ERCF-Software-V3 !") }
	{% endif %}

[gcode_macro _INIT_USERCUSTOM]
gcode = 

[gcode_shell_command plot_graph]
command = bash /home/pi/printer_data/config/scripts/plot_graphs.sh
timeout = 500.0
verbose = True

[gcode_shell_command system_info]
command = python3 /home/pi/printer_data/config/scripts/system_info.py
timeout = 5.0
verbose = True

[save_variables]
filename = ~/printer_data/config/save_variables.cfg

[tmc2209 stepper_z]
uart_pin = Z_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z1]
uart_pin = Z1_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z2]
uart_pin = Z2_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z3]
uart_pin = Z3_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 extruder]
uart_pin = toolhead:E_TMCUART
interpolate = false
run_current = 0.45
sense_resistor = 0.110
stealthchop_threshold = 0

[mcu]
canbus_uuid = f981df077b2c

[board_pins mcu_manufacturer]
aliases = 
	MCU_MOTOR0_STEP=PF13   , MCU_MOTOR0_DIR=PF12   , MCU_MOTOR0_ENABLE=PF14   , MCU_MOTOR0_UART=PC4    ,
	MCU_MOTOR1_STEP=PG0    , MCU_MOTOR1_DIR=PG1    , MCU_MOTOR1_ENABLE=PF15   , MCU_MOTOR1_UART=PD11   ,
	MCU_MOTOR2_1_STEP=PF11 , MCU_MOTOR2_1_DIR=PG3  , MCU_MOTOR2_1_ENABLE=PG5  , MCU_MOTOR2_1_UART=PC6  ,
	MCU_MOTOR3_STEP=PG4    , MCU_MOTOR3_DIR=PC1    , MCU_MOTOR3_ENABLE=PA0    , MCU_MOTOR3_UART=PC7    ,
	MCU_MOTOR4_STEP=PF9    , MCU_MOTOR4_DIR=PF10   , MCU_MOTOR4_ENABLE=PG2    , MCU_MOTOR4_UART=PF2    ,
	MCU_MOTOR5_STEP=PC13   , MCU_MOTOR5_DIR=PF0    , MCU_MOTOR5_ENABLE=PF1    , MCU_MOTOR5_UART=PE4    ,
	MCU_MOTOR6_STEP=PE2    , MCU_MOTOR6_DIR=PE3    , MCU_MOTOR6_ENABLE=PD4    , MCU_MOTOR6_UART=PE1    ,
	MCU_MOTOR7_STEP=PE6    , MCU_MOTOR7_DIR=PA14   , MCU_MOTOR7_ENABLE=PE0    , MCU_MOTOR7_UART=PD3    ,
	
	MCU_STOP0=PG6  , MCU_STOP1=PG9  , MCU_STOP2=PG10 , MCU_STOP3=PG11 ,
	MCU_STOP4=PG12 , MCU_STOP5=PG13 , MCU_STOP6=PG14 , MCU_STOP7=PG15 ,
	MCU_PROBE=PB7  ,
	MCU_SERVOS=PB6 ,
	
	MCU_HE0=PA2 , MCU_HE1=PA3 , MCU_HE2=PB10 , MCU_HE3=PB11 ,
	
	MCU_BED0=PA1 ,
	
	MCU_TB=PF3 ,
	MCU_T0=PF4 , MCU_T1=PF5 , MCU_T2=PF6 , MCU_T3=PF7 ,
	
	MCU_FAN0=PA8 , MCU_FAN1=PE5 , MCU_FAN2=PD12 , MCU_FAN3=PD13 , MCU_FAN4=PD14 , MCU_FAN5=PD15 ,
	
	MCU_NEOPIXEL=PB0  ,
	MCU_PS_ON=PE11    ,
	MCU_POWER_DET=PC0 ,
	
	
	EXP1_1=PE8   , EXP1_2=PE7   ,
	EXP1_3=PE9   , EXP1_4=PE10  ,
	EXP1_5=PE12  , EXP1_6=PE13  ,
	EXP1_7=PE14  , EXP1_8=PE15  ,
	EXP1_9=<GND> , EXP1_10=<5V> ,
	
	
	EXP2_1=PA6   , EXP2_2=PA5   ,
	EXP2_3=PB1   , EXP2_4=PA4   ,
	EXP2_5=PB2   , EXP2_6=PA7   ,
	EXP2_7=PC15  , EXP2_8=<RST> ,
	EXP2_9=<GND> , EXP2_10=<5V> ,

[board_pins octopus_mcu]
mcu = mcu
aliases = 
	X_STEP=MCU_MOTOR0_STEP   , X_DIR=MCU_MOTOR0_DIR   , X_ENABLE=MCU_MOTOR0_ENABLE   , X_TMCUART=MCU_MOTOR0_UART   ,
	Y_STEP=MCU_MOTOR1_STEP   , Y_DIR=MCU_MOTOR1_DIR   , Y_ENABLE=MCU_MOTOR1_ENABLE   , Y_TMCUART=MCU_MOTOR1_UART   ,
	
	Z_STEP=MCU_MOTOR2_1_STEP , Z_DIR=MCU_MOTOR2_1_DIR , Z_ENABLE=MCU_MOTOR2_1_ENABLE , Z_TMCUART=MCU_MOTOR2_1_UART ,
	Z1_STEP=MCU_MOTOR3_STEP  , Z1_DIR=MCU_MOTOR3_DIR  , Z1_ENABLE=MCU_MOTOR3_ENABLE  , Z1_TMCUART=MCU_MOTOR3_UART  ,
	Z2_STEP=MCU_MOTOR4_STEP  , Z2_DIR=MCU_MOTOR4_DIR  , Z2_ENABLE=MCU_MOTOR4_ENABLE  , Z2_TMCUART=MCU_MOTOR4_UART  ,
	Z3_STEP=MCU_MOTOR5_STEP  , Z3_DIR=MCU_MOTOR5_DIR  , Z3_ENABLE=MCU_MOTOR5_ENABLE  , Z3_TMCUART=MCU_MOTOR5_UART  ,
	
	E_STEP=MCU_MOTOR6_STEP   , E_DIR=MCU_MOTOR6_DIR   , E_ENABLE=MCU_MOTOR6_ENABLE   , E_TMCUART=MCU_MOTOR6_UART   ,
	
	X_STOP=MCU_STOP0 , Y_STOP=MCU_STOP1 , Z_STOP=MCU_STOP2 ,
	PROBE_INPUT=MCU_STOP7  ,
	RUNOUT_SENSOR=MCU_STOP3 ,
	
	E_HEATER=MCU_HE0   , E_TEMPERATURE=MCU_T0   ,
	BED_HEATER=MCU_HE1 , BED_TEMPERATURE=MCU_TB ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	CONTROLLER_FAN=MCU_FAN2        ,
	EXHAUST_FAN=MCU_FAN3           ,
	FILTER_FAN=MCU_FAN4            ,
	HOST_CONTROLLER_FAN=MCU_FAN5   ,
	
	CHAMBER_TEMPERATURE=MCU_T1 , ELECTRICAL_CABINET_TEMPERATURE=MCU_T2 ,
	
	LIGHT_OUTPUT=MCU_HE2         ,
	LIGHT_NEOPIXEL=MCU_STOP5     ,
	STATUS_NEOPIXEL=MCU_NEOPIXEL ,

[mcu toolhead]
canbus_uuid = 1b44cf5169c3

[board_pins toolhead_manufacturer]
mcu = toolhead
aliases = 
	MCU_EMOT_EN=gpio7 , MCU_EMOT_STEP=gpio9 , MCU_EMOT_DIR=gpio10 , MCU_EMOT_UART=gpio8 ,
	
	MCU_5V_ENDSTOP=gpio28 ,
	MCU_ENDSTOP=gpio29    ,
	MCU_HV_ENDSTOP=gpio25 ,
	
	MCU_FAN0=gpio13 , MCU_FAN1=gpio14 , MCU_FAN2=gpio15 ,
	
	MCU_TEMP=gpio27 , MCU_ONBOARD_NTCK100K=gpio26 ,
	
	MCU_HEAT=gpio6 ,
	
	MCU_RGB=gpio12 ,
	MCU_PWM0=gpio16 , MCU_PWM1=gpio17 ,
	
	MCU_ADXL_CS=gpio1 , MCU_ADXL_SCK=gpio0 , MCU_ADXL_MOSI=gpio3 , MCU_ADXL_MISO=gpio2 ,

[board_pins sb2040_mcu]
mcu = toolhead
aliases = 
	E_STEP=MCU_EMOT_STEP , E_DIR=MCU_EMOT_DIR , E_ENABLE=MCU_EMOT_EN , E_TMCUART=MCU_EMOT_UART ,
	
	X_STOP=MCU_ENDSTOP ,
	PROBE_INPUT=MCU_HV_ENDSTOP ,
	TOOLHEAD_SENSOR=MCU_5V_ENDSTOP ,
	
	E_HEATER=MCU_HEAT , E_TEMPERATURE=MCU_TEMP , CHAMBER_TEMPERATURE=MCU_ONBOARD_NTCK100K ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	
	STATUS_NEOPIXEL=MCU_RGB ,
	
	ADXL_CS=MCU_ADXL_CS , ADXL_SCLK=MCU_ADXL_SCK , ADXL_MOSI=MCU_ADXL_MOSI , ADXL_MISO=MCU_ADXL_MISO ,

[neopixel status_leds]
pin = toolhead:STATUS_NEOPIXEL
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting CAN connect
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
webhooks client 281472981817184: New connection
webhooks client 281472981817184: Client info {'program': 'Moonraker', 'version': 'v0.8.0-92-g504a3a7'}
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
Created a socket
mcu 'mcu': Unable to open CAN port: Failed to transmit: [Errno 100] Network is down
MCU error during connect
Traceback (most recent call last):
  File "/home/orangepi/klipper/klippy/mcu.py", line 792, in _mcu_identify
    self._serial.connect_canbus(self._serialport, nodeid,
  File "/home/orangepi/klipper/klippy/serialhdl.py", line 133, in connect_canbus
    self._error("Unable to connect")
  File "/home/orangepi/klipper/klippy/serialhdl.py", line 61, in _error
    raise error(self.warn_prefix + (msg % params))
serialhdl.error: mcu 'mcu': Unable to connect

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/orangepi/klipper/klippy/klippy.py", line 176, in _connect
    self.send_event("klippy:mcu_identify")
  File "/home/orangepi/klipper/klippy/klippy.py", line 263, in send_event
    return [cb(*params) for cb in self.event_handlers.get(event, [])]
  File "/home/orangepi/klipper/klippy/klippy.py", line 263, in <listcomp>
    return [cb(*params) for cb in self.event_handlers.get(event, [])]
  File "/home/orangepi/klipper/klippy/mcu.py", line 803, in _mcu_identify
    raise error(str(e))
mcu.error: mcu 'mcu': Unable to connect
No build file /home/orangepi/klipper/klippy/../.config
No build file /home/orangepi/klipper/klippy/../out/klipper.dict
No build file /home/orangepi/klipper/klippy/../out/klipper.elf
Starting Klippy...
Args: ['/home/orangepi/klipper/klippy/klippy.py', '/home/orangepi/printer_data/config/printer.cfg', '-I', '/home/orangepi/printer_data/comms/klippy.serial', '-l', '/home/orangepi/printer_data/logs/klippy.log', '-a', '/home/orangepi/printer_data/comms/klippy.sock']
Git version: 'v0.11.0-241-gffb5105b-dirty'
Untracked files: klippy/extras/gcode_shell_command.py
Branch: master
Remote: origin
Tracked URL: https://github.com/Klipper3d/klipper
CPU: 4 core ?
Python: '3.9.2 (default, Feb 28 2021, 17:03:44) \n[GCC 10.2.1 20210110]'
Start printer at Tue Jul 11 14:39:34 2023 (1689104374.0 25.7)
===== Config file =====
[printer]
kinematics = corexz
max_velocity = 400
max_accel = 1000
max_z_velocity = 200
max_z_accel = 1000
square_corner_velocity = 5.0

[stepper_x]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = X_STEP
dir_pin = X_DIR
enable_pin = !X_ENABLE
endstop_pin = tmc2209_stepper_x:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_y]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = Y_STEP
dir_pin = Y_DIR
enable_pin = !Y_ENABLE
endstop_pin = tmc2209_stepper_y:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_z]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z_STEP
dir_pin = !Z_DIR
enable_pin = !Z_ENABLE
endstop_pin = probe:z_virtual_endstop
homing_speed = 15
second_homing_speed = 8
homing_retract_dist = 3.0
position_max = 310
position_min = -5

[stepper_z1]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z1_STEP
dir_pin = !Z1_DIR
enable_pin = !Z1_ENABLE

[stepper_z2]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z2_STEP
dir_pin = !Z2_DIR
enable_pin = !Z2_ENABLE

[stepper_z3]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z3_STEP
dir_pin = Z3_DIR
enable_pin = !Z3_ENABLE

[gcode_macro _USER_VARIABLES]
variable_extruder_enabled = True
gcode = 
variable_heaterbed_enabled = True
variable_probe_type_enabled = "vorontap"
variable_startprint_actions = "bed_soak", "extruder_preheating", "chamber_soak", "clean", "tilt_calib", "z_offset", "bedmesh", "extruder_heating", "purge", "clean", "primeline"
variable_purgeclean_servo_enabled = True
variable_purgeclean_servo_name = "purgeservo"
variable_status_leds_minidisplay_enabled = True
variable_status_leds_minidisplay_led_name = "btt_mini12864"
variable_bed_mesh_enabled = True
variable_sensorless_homing_enabled = True
variable_qgl_enabled = True
variable_verbose = True
variable_homing_travel_speed = 350
variable_travel_speed = 350
variable_z_drop_speed = 15
variable_brush_clean_speed = 100
variable_probe_dock_speed = 60
variable_homing_travel_accel = 3000
variable_tilting_travel_accel = 3000
variable_brush_clean_accel = 1500
variable_probe_dock_accel = 2000
variable_accel_to_decel_factor = 0.75
variable_zendstop_position = -1, -1
variable_force_homing_in_start_print = False
variable_homing_zhop = 5
variable_homing_first = "X"
variable_homing_backoff_distance_xy = -5, -5
variable_sensorless_current_factor = 75
variable_probe_dock_margin_xy = 0, 0
variable_safe_extruder_temp = 150
variable_prime_line_xy = 5, 2.5
variable_prime_line_direction = "X"
variable_prime_line_length = 40
variable_prime_line_purge_distance = 30
variable_prime_line_flowrate = 10
variable_park_position_xy = -1, -1
variable_park_lift_z = 50
variable_disable_motors_in_end_print = False
variable_turn_off_heaters_in_end_print = True
variable_min_bed_xy = 0, 0
variable_max_bed_xy = 9999, 9999
variable_probe_min_z_travel = 20
variable_probe_dock_location_xy = -1, -1
variable_probe_servo_angle_retracted = 0
variable_probe_servo_angle_deployed = 90
variable_probe_before_attach_position = "front"
variable_probe_after_attach_position = "front"
variable_probe_before_dock_position = "front"
variable_probe_after_dock_position = "left"
variable_probe_move_attach_length = 30
variable_probe_move_dock_length = 30
variable_autodock_on_probe_error = True
variable_tap_max_probing_temp = 150
variable_tap_deactivation_zhop = 5
variable_print_default_bed_temp = 105
variable_print_default_extruder_temp = 240
variable_print_default_chamber_temp = 0
variable_print_default_chamber_max_heating_time = 15
variable_print_default_soak = 8
variable_print_default_material = "XXX"
variable_material_parameters = {
	'PLA': {
	'pressure_advance': 0.0525,
	'retract_length': 0.75,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 0,
	'additional_z_offset': 0
	},
	'PET': {
	'pressure_advance': 0.0650,
	'retract_length': 1.4,
	'unretract_extra_length': 0,
	'retract_speed': 30,
	'unretract_speed': 20,
	'filter_speed': 0,
	'additional_z_offset': 0.020
	},
	'ABS': {
	'pressure_advance': 0.0480,
	'retract_length': 0.5,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 80,
	'additional_z_offset': 0
	}
	}
variable_ercf_unload_on_cancel_print = False
variable_ercf_unload_on_end_print = True
variable_ercf_reset_stats_on_start_print = False
variable_purge_and_brush_enabled = False
variable_force_homing_before_brush = False
variable_brush_over_y_axis = True
variable_brush_xyz = -1, -1, -1
variable_purge_bucket_xyz = -1, -1, -1
variable_purge_distance = 30
variable_purge_ooze_time = 10
variable_purgeclean_servo_angle_retracted = 0
variable_purgeclean_servo_angle_deployed = 90
variable_light_intensity_start_print = 100
variable_light_intensity_printing = 30
variable_light_intensity_end_print = 0
variable_fix_heaters_temperature_settle = False
variable_resonnance_test_point_xy = -1, -1
variable_resonnance_test_z_clearance = 50
variable_status_leds_colors = {
	'logo': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'nozzle': {
	'heating': {'r': 0.8, 'g': 0.35, 'b': 0.0, 'w':0.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'standby': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'caselight': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'minidisplay': {
	'on': {'r': 0.0, 'g': 0.2, 'b': 0.4, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'error': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'thermal': {
	'hot': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cold': {'r': 0.3, 'g': 0.0, 'b': 0.3, 'w': 0.0}
	}
	}
variable_x_driver = "TMC2209"
variable_y_driver = "TMC2209"
variable_z_driver = "TMC2209"
variable_e_driver = "TMC2209"

[extruder]
rotation_distance = 22.79234586
gear_ratio = 50:10
microsteps = 64
full_steps_per_rotation = 200
nozzle_diameter = 0.400
filament_diameter = 1.75
max_extrude_only_distance = 110
max_extrude_cross_section = 5
sensor_type = ATC Semitec 104GT-2
min_temp = 5
max_temp = 310
max_power = 1.0
min_extrude_temp = 170
pressure_advance = 0.045
pressure_advance_smooth_time = 0.040
step_pin = toolhead:E_STEP
dir_pin = toolhead:E_DIR
enable_pin = !toolhead:E_ENABLE
heater_pin = toolhead:E_HEATER
sensor_pin = toolhead:E_TEMPERATURE
control = pid
pid_kp = 34.626
pid_ki = 4.050
pid_kd = 74.014

[gcode_macro M109]
rename_existing = M109.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={S}
	{% else %}
	M109.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[heater_bed]
heater_pin = BED_HEATER
sensor_type = NTC 100K MGB18-104F39050L32
sensor_pin = BED_TEMPERATURE
max_power = 1
min_temp = 0
max_temp = 120
control = pid
pid_kp = 40.783
pid_ki = 1.007
pid_kd = 412.931

[gcode_macro M190]
rename_existing = M190.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={S}
	{% else %}
	M190.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[gcode_macro ACTIVATE_PROBE]
description = Put the machine in a state being able to probe
variable_temperature = 0
gcode = 
	{% set LOCK = params.LOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_max_probing_temp = printer["gcode_macro _USER_VARIABLES"].tap_max_probing_temp|float %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if LOCK %}
	_ATTACH_PROBE_LOCK
	{% else %}
	_ATTACH_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	SAVE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	
	{% set ACTUAL_TEMP = printer.extruder.temperature %}
	{% set TARGET_TEMP = printer.extruder.target %}
	
	SET_GCODE_VARIABLE MACRO=ACTIVATE_PROBE VARIABLE=temperature VALUE={TARGET_TEMP}
	
	{% if TARGET_TEMP > tap_max_probing_temp %}
	{ action_respond_info('Extruder temperature target of %.1fC is too high for TAP probing, lowering to %.1fC' % (TARGET_TEMP, tap_max_probing_temp)) }
	M106 S255
	M109 S{tap_max_probing_temp}
	M106 S0
	{% else %}
	
	{% if ACTUAL_TEMP > tap_max_probing_temp + 3 %}
	M106 S255
	TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={tap_max_probing_temp}
	M106 S0
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro DEACTIVATE_PROBE]
description = Revert the machine to a normal state after probing
gcode = 
	{% set UNLOCK = params.UNLOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_deactivation_zhop = printer["gcode_macro _USER_VARIABLES"].tap_deactivation_zhop %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if UNLOCK %}
	_DOCK_PROBE_UNLOCK
	{% else %}
	_DOCK_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	
	{% set z_safe = printer.toolhead.position.z + tap_deactivation_zhop %}
	{% if z_safe > printer.toolhead.axis_maximum.z %}
	{% set z_safe = printer.toolhead.axis_maximum.z %}
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	
	{% set old_target_temperature = printer["gcode_macro ACTIVATE_PROBE"].temperature %}
	M109 S{old_target_temperature}
	
	RESTORE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	{% endif %}

[probe]
pin = ^toolhead:MCU_ENDSTOP1
x_offset = 0
y_offset = 0
z_offset = -0.45
speed = 3
lift_speed = 10
samples = 3
samples_result = median
sample_retract_dist = 1.0
samples_tolerance = 0.007
samples_tolerance_retries = 3

[heater_fan hotend_fan]
pin = toolhead:E_FAN
max_power = 1.0
kick_start_time = 0.100
heater = extruder
heater_temp = 50.0

[fan]
pin = toolhead:PART_FAN
kick_start_time = 0.100
cycle_time = 0.010

[gcode_macro _SERVO_DEPLOY]
gcode = 
	{% set item = params.ITEM|string|lower %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_servo_enabled = printer["gcode_macro _USER_VARIABLES"].probe_servo_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% if item == "probe" %}
	{% if verbose %}
	RESPOND MSG="Deploying probe dock using the servo"
	{% endif %}
	
	{% if not probe_servo_enabled %}
	{ action_raise_error("No servo available for probe. Please include one in your config!") }
	{% endif %}
	
	{% set probe_servo_name = printer["gcode_macro _USER_VARIABLES"].probe_servo_name %}
	{% set probe_servo_angle_deployed = printer["gcode_macro _USER_VARIABLES"].probe_servo_angle_deployed %}
	SET_SERVO SERVO={probe_servo_name} ANGLE={probe_servo_angle_deployed}
	G4 P500
	
	{% elif item == "purge" or item == "clean" %}
	{% if verbose %}
	RESPOND MSG="Deploying purge bucket and brush using the servo"
	{% endif %}
	
	{% if not purgeclean_servo_enabled %}
	{ action_raise_error("No servo available for purge or clean. Please include one in your config!") }
	{% endif %}
	
	{% set purgeclean_servo_name = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_name %}
	{% set purgeclean_servo_angle_deployed = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_angle_deployed %}
	SET_SERVO SERVO={purgeclean_servo_name} ANGLE={purgeclean_servo_angle_deployed}
	G4 P500
	
	{% else %}
	{ action_raise_error("Servo ITEM must be specified!") }
	{% endif %}

[gcode_macro _SERVO_RETRACT]
gcode = 
	{% set item = params.ITEM|string|lower %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_servo_enabled = printer["gcode_macro _USER_VARIABLES"].probe_servo_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% if item == "probe" %}
	{% if verbose %}
	RESPOND MSG="Rettracting probe dock using the servo"
	{% endif %}
	
	{% if not probe_servo_enabled %}
	{ action_raise_error("No servo available for probe. Please include one in your config!") }
	{% endif %}
	
	{% set probe_servo_name = printer["gcode_macro _USER_VARIABLES"].probe_servo_name %}
	{% set probe_servo_angle_retracted = printer["gcode_macro _USER_VARIABLES"].probe_servo_angle_retracted %}
	SET_SERVO SERVO={probe_servo_name} ANGLE={probe_servo_angle_retracted}
	G4 P500
	
	{% elif item == "purge" or item == "clean" %}
	{% if verbose %}
	RESPOND MSG="Rettracting purge bucket and brush using the servo"
	{% endif %}
	
	{% if not purgeclean_servo_enabled %}
	{ action_raise_error("No servo available for purge or clean. Please include one in your config!") }
	{% endif %}
	
	{% set purgeclean_servo_name = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_name %}
	{% set purgeclean_servo_angle_retracted = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_angle_retracted %}
	SET_SERVO SERVO={purgeclean_servo_name} ANGLE={purgeclean_servo_angle_retracted}
	G4 P500
	
	{% else %}
	{ action_raise_error("Servo ITEM must be specified!") }
	{% endif %}

[servo purgeservo]
pin = SERVO_PIN
maximum_servo_angle = 90
minimum_pulse_width = 0.0011
maximum_pulse_width = 0.0021

[gcode_macro _SET_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = params.LED|string %}
	{% set idx = (params.IDX|string).split(',') %}
	{% set transmit_last = params.TRANSMIT|default(1) %}
	
	{% for led_index in idx %}
	{% set transmit=transmit_last if loop.last else 0 %}
	SET_LED LED={led} RED={red} GREEN={green} BLUE={blue} WHITE={white} INDEX={led_index} TRANSMIT={transmit}
	{% endfor %}

[gcode_macro _SET_LEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_idx"] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_ALLLEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	SET_LED LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w}  TRANSMIT={transmit}

[gcode_macro _SET_LOGO_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_NOZZLE_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro SET_LOGO_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="logo" COLOR="off" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_ON]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="on" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="off" TRANSMIT={transmit}

[gcode_macro STATUS_LEDS]
gcode = 
	{% set color = params.COLOR|default('off')|lower %}
	
	{% set status_color = {
	'ready': {
	'logo': 'standby',
	'nozzle': 'standby',
	'caselight': 'standby',
	'minidisplay': 'on'
	},
	'busy': {
	'logo': 'busy',
	'nozzle': 'on',
	'caselight': 'busy',
	'minidisplay': 'on'
	},
	'heating': {
	'logo': 'heating',
	'nozzle': 'heating',
	'caselight': 'heating',
	'minidisplay': 'on'
	},
	'leveling': {
	'logo': 'leveling',
	'nozzle': 'on',
	'caselight': 'leveling',
	'minidisplay': 'on'
	},
	'homing': {
	'logo': 'homing',
	'nozzle': 'on',
	'caselight': 'homing',
	'minidisplay': 'on'
	},
	'cleaning': {
	'logo': 'cleaning',
	'nozzle': 'on',
	'caselight': 'cleaning',
	'minidisplay': 'on'
	},
	'meshing': {
	'logo': 'meshing',
	'nozzle': 'on',
	'caselight': 'meshing',
	'minidisplay': 'on'
	},
	'calibrating_z': {
	'logo': 'calibrating_z',
	'nozzle': 'on',
	'caselight': 'calibrating_z',
	'minidisplay': 'on'
	},
	'printing': {
	'logo': 'printing',
	'nozzle': 'on',
	'caselight': 'printing',
	'minidisplay': 'on'
	},
	'off': {
	'logo': 'off',
	'nozzle': 'off',
	'caselight': 'off',
	'minidisplay': 'off'
	},
	'on': {
	'logo': 'on',
	'nozzle': 'on',
	'caselight': 'on',
	'minidisplay': 'on'
	},
	'error': {
	'logo': 'error',
	'nozzle': 'error',
	'caselight': 'error',
	'minidisplay': 'error'
	}
	} %}
	
	{% if not (color in status_color) %}
	{ action_raise_error("COLOR is not valid!") }
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	_SET_LEDS_BY_NAME LEDS="logo" COLOR={status_color[color].logo} TRANSMIT=0
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR={status_color[color].nozzle} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_caselight_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="caselight" COLOR={status_color[color].caselight} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_minidisplay_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="minidisplay" COLOR={status_color[color].minidisplay} TRANSMIT=1
	{% endif %}

[display]
lcd_type = uc1701
cs_pin = EXP1_8
a0_pin = EXP1_7
rst_pin = EXP1_6
encoder_pins = ^EXP2_6, ^EXP2_8
click_pin = ^!EXP1_9
contrast = 63
spi_software_miso_pin = EXP2_10
spi_software_mosi_pin = EXP2_5
spi_software_sclk_pin = EXP2_9

[output_pin beeper]
pin = EXP1_10

[neopixel btt_mini12864]
pin = EXP1_5
chain_count = 3
initial_red = 0.1
initial_green = 0.5
initial_blue = 0.0
color_order = RGB

[delayed_gcode setdisplayneopixel]
initial_duration = 1
gcode = 
	SET_LED LED=btt_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3

[temperature_sensor RaspberryPi]
sensor_type = temperature_host

[temperature_sensor mcu]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 90

[temperature_sensor toolhead_mcu]
sensor_type = temperature_mcu
sensor_mcu = toolhead
min_temp = 0
max_temp = 100

[adxl345]
cs_pin = toolhead:ADXL_CS
spi_software_sclk_pin = toolhead:ADXL_SCLK
spi_software_mosi_pin = toolhead:ADXL_MOSI
spi_software_miso_pin = toolhead:ADXL_MISO
axes_map = x,y,z

[resonance_tester]
accel_chip = adxl345
probe_points = 
	-1,-1,-1

[gcode_macro TEST_RESONANCES]
rename_existing = BASE_TEST_RESONANCES
description = Runs input shaper test at the center of the bed
gcode = 
	{% set Tx, Ty = printer["gcode_macro _USER_VARIABLES"].resonnance_test_point_xy|map('float') %}
	{% set Tz = printer["gcode_macro _USER_VARIABLES"].resonnance_test_z_clearance|float %}
	
	{% if Tx == -1 and Ty == -1 %}
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	BASE_TEST_RESONANCES POINT={max_x / 2},{max_y / 2},{Tz} {rawparams}
	{% else %}
	BASE_TEST_RESONANCES POINT={Tx},{Ty},{Tz} {rawparams}
	{% endif %}

[gcode_macro AXES_SHAPER_CALIBRATION]
description = Run standard input shaper test for all axes
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.3)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=X FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=Y FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=SHAPER

[gcode_macro BELTS_SHAPER_CALIBRATION]
description = Run custom demi-axe test to analyze belts on CoreXY printers
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.33)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=1,1 OUTPUT=raw_data NAME=b FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=a FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=BELTS

[gcode_macro EXCITATE_AXIS_AT_FREQ]
description = Maintain a specified input shaper excitating frequency for some time to diagnose vibrations
gcode = 
	{% set FREQUENCY = params.FREQUENCY|default(25)|int %}
	{% set TIME = params.TIME|default(10)|int %}
	{% set AXIS = params.AXIS|default("x")|string|lower %}
	
	TEST_RESONANCES OUTPUT=raw_data AXIS={AXIS} FREQ_START={FREQUENCY-1} FREQ_END={FREQUENCY+1} HZ_PER_SEC={1/(TIME/3)}
	M400

[gcode_macro VIBRATIONS_CALIBRATION]
gcode = 
	
	
	
	{% set size = params.SIZE|default(60)|int %}
	{% set direction = params.DIRECTION|default('XY') %}
	{% set z_height = params.Z_HEIGHT|default(20)|int %}
	{% set verbose = params.VERBOSE|default(true) %}
	
	{% set min_speed = params.MIN_SPEED|default(20)|int * 60 %}
	{% set max_speed = params.MAX_SPEED|default(200)|int * 60 %}
	{% set speed_increment = params.SPEED_INCREMENT|default(2)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	
	{% set accel_chip = params.ACCEL_CHIP|default("adxl345") %}
	
	
	
	
	{% set mid_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set mid_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% set direction_factor = {
	'XY'  : {
	'start' : {'x': -0.5, 'y': -0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': -0.5, 'y': -0.5, 'z': 0.0 }
	}
	},
	'AB' : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': 0.0, 'y': 0.0, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	},
	'ABXY' : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'B'  : {
	'start' : {'x': 0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'A'  : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'X'  : {
	'start' : {'x': -0.5, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': 0.0, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.0, 'z': 0.0 }
	}
	},
	'Y'  : {
	'start' : {'x': 0.0, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.0, 'y': 0.5, 'z': 0.0 }
	}
	},
	'Z'  : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': 0.0, 'z': 1.0 },
	'1' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	}
	}
	%}
	
	
	
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	{% if (size / (max_speed / 60)) < 0.25 %}
	{ action_raise_error("SIZE is too small for this MAX_SPEED. Increase SIZE or decrease MAX_SPEED!") }
	{% endif %}
	
	{% if not (direction in direction_factor) %}
	{ action_raise_error("DIRECTION is not valid. Only XY, AB, ABXY, A, B, X, Y or Z is allowed!") }
	{% endif %}
	
	{action_respond_info("")}
	{action_respond_info("Starting speed and vibration calibration")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION
	
	G90
	
	
	G1 Z{z_height}
	G1 X{mid_x + (size * direction_factor[direction].start.x) } Y{mid_y + (size * direction_factor[direction].start.y)} F{feedrate_travel}
	
	
	{% for curr_speed in range(min_speed, max_speed + speed_increment) %}
	{% if (curr_speed - min_speed) % speed_increment == 0 %}
	{% if verbose %}
	RESPOND MSG="Current speed: {(curr_speed / 60)|int} mm/s"
	{% endif %}
	
	ACCELEROMETER_MEASURE CHIP={accel_chip}
	{% for key, factor in direction_factor[direction].move_factors|dictsort %}
	G1 X{mid_x + (size * factor.x) } Y{mid_y + (size * factor.y)} Z{z_height + (size * factor.z)} F{curr_speed}
	{% endfor %}
	ACCELEROMETER_MEASURE CHIP={accel_chip} NAME=sp{(curr_speed / 60)|int}n1
	
	G4 P300
	M400
	{% endif %}
	{% endfor %}
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS="VIBRATIONS {direction}"
	
	RESTORE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = _BASE_BED_MESH_CALIBRATE
description = Perform Mesh Bed Leveling with klicky automount
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if verbose %}
	{ action_respond_info("Bed Mesh Calibrate") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	_BASE_BED_MESH_CALIBRATE  {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	DEACTIVATE_PROBE

[gcode_macro _ADAPTIVE_MESH_VARIABLES]
variable_ready = False
variable_do_mesh = False
variable_do_nominal = False
variable_mesh_min = 0,0
variable_mesh_max = 0,0
variable_mesh_center = 0,0
variable_probe_count = 0,0
variable_rri = 0
variable_algo = "bicubic"
gcode = 

[gcode_macro COMPUTE_MESH_PARAMETERS]
description = Compute the mesh parameters and store them for later use
gcode = 
	
	{% set xMinConf, yMinConf = printer["configfile"].config["bed_mesh"]["mesh_min"].split(',')|map('trim')|map('int') %}
	{% set xMaxConf, yMaxConf = printer["configfile"].config["bed_mesh"]["mesh_max"].split(',')|map('trim')|map('int') %}
	{% set xProbeCntConf, yProbeCntConf = printer["configfile"].config["bed_mesh"]["probe_count"].split(',')|map('trim')|map('int') %}
	{% set algo = printer["configfile"].config["bed_mesh"]["algorithm"]|lower %}
	{% set xMeshPPS, yMeshPPS = (printer["configfile"].config["bed_mesh"]["mesh_pps"]|default('2,2')).split(',')|map('trim')|map('int') %}
	
	{% set margin = params.MARGIN|default(5)|int %}
	{% set force_mesh = params.FORCE_MESH|default(False) %}
	
	
	
	
	{% if params.SIZE is defined and params.SIZE != "0_0_0_0" %}
	RESPOND MSG="Got a SIZE parameter for the adaptive bed mesh"
	{% set xMinSpec, yMinSpec, xMaxSpec, yMaxSpec = params.SIZE.split('_')|map('trim')|map('int') %}
	
	{% elif printer.exclude_object.objects %}
	
	
	RESPOND MSG="No SIZE parameter, using the [exclude_object] tags for the adaptive bed mesh"
	{% set eo_points = printer.exclude_object.objects|map(attribute='polygon')|sum(start=[]) %}
	{% set xMinSpec = eo_points|map(attribute=0)|min %}
	{% set yMinSpec = eo_points|map(attribute=1)|min %}
	{% set xMaxSpec = eo_points|map(attribute=0)|max %}
	{% set yMaxSpec = eo_points|map(attribute=1)|max %}
	
	{% else %}
	
	
	RESPOND MSG="No info about the first layer coordinates, doing a nominal bed mesh instead of adaptive"
	{% endif %}
	
	
	
	
	{% if xMinSpec and yMinSpec and xMaxSpec and yMaxSpec %}
	
	
	
	
	{% set xMin = [xMinConf, (xMinSpec - margin)]|max %}
	{% set xMax = [xMaxConf, (xMaxSpec + margin)]|min %}
	{% set yMin = [yMinConf, (yMinSpec - margin)]|max %}
	{% set yMax = [yMaxConf, (yMaxSpec + margin)]|min %}
	
	
	
	
	{% set xProbeCnt = ((xMax - xMin) * xProbeCntConf / (xMaxConf - xMinConf))|round(0, 'ceil')|int %}
	{% set yProbeCnt = ((yMax - yMin) * yProbeCntConf / (yMaxConf - yMinConf))|round(0, 'ceil')|int %}
	
	
	
	
	
	
	
	
	{% if xProbeCnt < 3 and yProbeCnt < 3 %}
	{% if force_mesh %}
	RESPOND MSG="Bed mesh forced (small part detected): meshing 3x3..."
	{% set xProbeCnt = 3 %}
	{% set yProbeCnt = 3 %}
	{% set rRefIndex = 4 %}
	{% set algo = "lagrange" %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% else %}
	RESPOND MSG="Computed mesh parameters: none, bed mesh not needed for very small parts"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={False}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	{% else %}
	{% set xProbeCnt = [3, xProbeCnt]|max %}
	{% set yProbeCnt = [3, yProbeCnt]|max %}
	
	
	
	{% if xProbeCnt % 2 == 0 %}
	{% set xProbeCnt = xProbeCnt + 1 %}
	{% endif %}
	{% if yProbeCnt % 2 == 0 %}
	{% set yProbeCnt = yProbeCnt + 1 %}
	{% endif %}
	
	
	{% if xMeshPPS != 0 or yMeshPPS != 0 %}
	{% set probeCntMin = [xProbeCnt, yProbeCnt]|min %}
	{% set probeCntMax = [xProbeCnt, yProbeCnt]|max %}
	{% if algo == "lagrange" and probeCntMax > 6 %}
	
	{% set algo = "bicubic" %}
	{% endif %}
	{% if algo == "bicubic" and probeCntMin < 4 %}
	{% if probeCntMax > 6 %}
	
	{% if xProbeCnt > yProbeCnt %}
	{% set yProbeCnt = 5 %}
	{% else %}
	{% set xProbeCnt = 5 %}
	{% endif %}
	{% else %}
	
	{% set algo = "lagrange" %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	{% set rRefIndex = (((xProbeCnt * yProbeCnt) - 1) / 2)|int %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	
	
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% endif %}
	{% else %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={True}
	
	{% set xCenter = xMinConf + ((xMaxConf - xMinConf) / 2) %}
	{% set yCenter = yMinConf + ((yMaxConf - yMinConf) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={True}

[gcode_macro ADAPTIVE_BED_MESH]
description = Perform a bed mesh, but only where and when it's needed
gcode = 
	{% set ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	
	{% if ready %}
	_DO_ADAPTIVE_MESH
	
	
	
	{% else %}
	RESPOND MSG="Adaptive bed mesh: parameters not already computed, automatically calling the COMPUTE_MESH_PARAMETERS macro prior to the mesh"
	COMPUTE_MESH_PARAMETERS {rawparams}
	M400
	_DO_ADAPTIVE_MESH
	{% endif %}

[gcode_macro _DO_ADAPTIVE_MESH]
gcode = 
	
	{% set do_mesh = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_mesh %}
	{% set do_nominal = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_nominal %}
	{% set mesh_min = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_min %}
	{% set mesh_max = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_max %}
	{% set probe_count = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].probe_count %}
	{% set rRefIndex = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].rri %}
	{% set algo = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].algo %}
	
	
	
	
	{% if do_mesh %}
	
	{% if do_nominal %}
	RESPOND MSG="Adaptive bed mesh: nominal bed mesh"
	BED_MESH_CALIBRATE
	{% else %}
	{% if printer["configfile"].config["bed_mesh"]["relative_reference_index"] is defined %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}
	{% endif %}
	{% endif %}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: no mesh to be done"
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={False}

[bed_mesh]
speed = 350
horizontal_move_z = 12
mesh_min = 25, 25
mesh_max = 325, 325
probe_count = 9, 9
fade_start = 0.6
fade_end = 10.0
algorithm = bicubic
relative_reference_index = 40

[tmc2209 stepper_x]
diag_pin = ^X_STOP
driver_sgthrs = 50
uart_pin = X_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_y]
diag_pin = ^Y_STOP
driver_sgthrs = 60
uart_pin = Y_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[input_shaper]
shaper_freq_x = 56.4
shaper_type_x = zv
shaper_freq_y = 38.4
shaper_type_y = mzv

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing = _BASE_QUAD_GANTRY_LEVEL
description = Conform a moving, twistable gantry to the shape of a stationary bed with klicky automount
gcode = 
	{% set tilting_travel_accel = printer["gcode_macro _USER_VARIABLES"].tilting_travel_accel %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if verbose %}
	{ action_respond_info("Quad gantry leveling") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{tilting_travel_accel}
	
	_BASE_QUAD_GANTRY_LEVEL {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	DEACTIVATE_PROBE

[gcode_macro _TILT_CALIBRATE]
description = Do a QGL, Z_tilt, etc... depending of the machine configuration
gcode = 
	{% set FORCE_OPERATION = params.FORCE|default(true) %}
	{% set conf_QGL = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set conf_ztilt = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="LEVELING"
	{% endif %}
	
	{% if conf_QGL %}
	{% if printer.quad_gantry_level.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="QGL..."
	{% endif %}
	QUAD_GANTRY_LEVEL
	{% endif %}
	{% elif conf_ztilt %}
	{% if printer.z_tilt.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="Z tilt adjust..."
	{% endif %}
	Z_TILT_ADJUST
	{% endif %}
	{% else %}
	{% if verbose %}
	RESPOND MSG="No tilt calibration needed on this machine. Continuing..."
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[quad_gantry_level]
gantry_corners = 
	-60,-10
	410,420
points = 
	50,25
	50,275
	300,275
	300,25
speed = 350
horizontal_move_z = 12
retries = 5
retry_tolerance = 0.0075
max_adjust = 10

[virtual_sdcard]
path = ~/printer_data/gcodes
on_error_gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	STATUS_LEDS COLOR="ERROR"
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	_PROBE_ON_ERROR_ACTION
	{% endif %}

[exclude_object]

[idle_timeout]
timeout = 1800

[pause_resume]

[display_status]

[respond]

[force_move]
enable_force_move = True

[gcode_arcs]
resolution = 0.1

[gcode_macro CANCEL_PRINT]
rename_existing = BASE_CANCEL_PRINT
description = Cancel the print, retract 10mm of filament and park
gcode = 
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload_on_cancel_print = printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_cancel_print %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload_on_cancel_print %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	SDCARD_RESET_FILE
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_OFF
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}
	
	BASE_CANCEL_PRINT

[gcode_macro END_PRINT]
description = Stop the print and filter the atmosphere for 10min before shuting down
gcode = 
	{% set disable_motors_in_end_print = printer["gcode_macro _USER_VARIABLES"].disable_motors_in_end_print %}
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set light_intensity_end_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_end_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload = params.ERCF_UNLOAD_AT_END|default(printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_end_print)|int %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G92 E0
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if disable_motors_in_end_print %}
	M84
	{% endif %}
	
	
	
	
	{% if filter_enabled %}
	{% set FILTER_TIME = params.FILTER_TIME|default(600)|int %}
	START_FILTER SPEED=1
	UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED DURATION={FILTER_TIME}
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_end_print}
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}

[gcode_macro PARK]
description = Park the toolhead at the back and retract some filament if the nozzle is hot
gcode = 
	{% set E = params.E|default(1.7)|float %}
	
	{% set Px, Py = printer["gcode_macro _USER_VARIABLES"].park_position_xy|map('float') %}
	{% set park_lift_z = printer["gcode_macro _USER_VARIABLES"].park_lift_z %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	
	{% set z_safe = act_z + park_lift_z %}
	{% if z_safe > max_z %}
	{% set z_safe = max_z %}
	{% endif %}
	
	
	{% if printer.extruder.temperature > 185 and firmware_retraction_enabled %}
	G10
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	G0 X{Px} Y{Py} F{St}

[gcode_macro PAUSE]
rename_existing = BASE_PAUSE
description = Pause the print and park
gcode = 
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	
	{% if printer.pause_resume.is_paused %}
	RESPOND MSG="Print is already paused"
	{% else %}
	SAVE_GCODE_STATE NAME=PAUSE_state
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	BASE_PAUSE
	PARK
	{% endif %}

[gcode_macro RESUME]
rename_existing = BASE_RESUME
description = Resume the print after an optional unretract
gcode = 
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	
	{% if not printer.pause_resume.is_paused %}
	RESPOND MSG="Print is not paused. Resume ignored"
	{% else %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={St}
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	BASE_RESUME
	{% endif %}

[gcode_macro START_PRINT]
description = Machine heatup procedure before starting a print
variable_bed_temp = 0
variable_extruder_temp = 0
variable_z_adjust = 0
variable_soak = 0
variable_chamber_temp = 0
variable_chamber_maxtime = 0
variable_initial_tool = 0
variable_material = "XXX"
variable_fl_size = "0_0_0_0"
gcode = 
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_ADJUST = params.Z_ADJUST|default(0)|float %}
	{% set SOAK = params.SOAK|default(printer["gcode_macro _USER_VARIABLES"].print_default_soak)|int %}
	{% set CHAMBER_TEMP = params.CHAMBER|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_temp)|int %}
	{% set CHAMBER_MAXTIME = params.CHAMBER_MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	{% set INITIAL_TOOL = params.INITIAL_TOOL|default(0)|int %}
	{% set MATERIAL = params.MATERIAL|default(printer["gcode_macro _USER_VARIABLES"].print_default_material)|string %}
	{% set FL_SIZE = params.SIZE|default("0_0_0_0")|string %}
	
	
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=bed_temp VALUE={BED_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=extruder_temp VALUE={EXTRUDER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=soak VALUE={SOAK}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_temp VALUE={CHAMBER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_maxtime VALUE={CHAMBER_MAXTIME}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=initial_tool VALUE={INITIAL_TOOL}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=material VALUE='"{MATERIAL}"'
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=fl_size VALUE='"{FL_SIZE}"'
	
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_reset_stats_on_start_print = printer["gcode_macro _USER_VARIABLES"].ercf_reset_stats_on_start_print %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% if MATERIAL not in printer["gcode_macro _USER_VARIABLES"].material_parameters %}
	RESPOND MSG="Material '{MATERIAL}' is unknown!"
	{ action_raise_error("Add this new material to your material_parameters variable!") }
	{% else %}
	RESPOND MSG="Material '{MATERIAL}' is used"
	{% set material = printer["gcode_macro _USER_VARIABLES"].material_parameters[MATERIAL] %}
	{% endif %}
	
	
	
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="BUSY"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if ercf_reset_stats_on_start_print %}
	ERCF_RESET_STATS
	{% endif %}
	{% endif %}
	{% endif %}
	
	SET_GCODE_OFFSET Z=0
	M221 S100
	M220 S100
	G90
	M83
	
	
	{% if firmware_retraction_enabled %}
	SET_RETRACTION RETRACT_LENGTH={material.retract_length} RETRACT_SPEED={material.retract_speed} UNRETRACT_EXTRA_LENGTH={material.unretract_extra_length} UNRETRACT_SPEED={material.unretract_speed}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={material.pressure_advance}
	
	
	{% if force_homing_in_start_print %}
	G28
	{% else %}
	_CG28
	{% endif %}
	
	
	
	{% set sp_actions = printer["gcode_macro _USER_VARIABLES"].startprint_actions %}
	{% for action in sp_actions %}
	{% if action == "bed_soak" %}
	_MODULE_HEATSOAK_BED
	{% elif action == "chamber_soak" %}
	_MODULE_HEATSOAK_CHAMBER
	{% elif action == "tilt_calib" %}
	_MODULE_TILTING
	{% elif action == "extruder_heating" %}
	_MODULE_EXTRUDER_HEATING
	{% elif action == "purge" %}
	_MODULE_PURGE
	{% elif action == "clean" %}
	_MODULE_CLEAN
	{% elif action == "z_offset" %}
	_MODULE_Z_CALIB
	{% elif action == "bedmesh" %}
	_MODULE_BED_MESH
	{% elif action == "primeline" %}
	_MODULE_PRIMELINE
	{% elif action == "extruder_preheating" %}
	_MODULE_EXTRUDER_PREHEATING
	{% elif action == "custom1" %}
	_MODULE_CUSTOM1
	{% elif action == "custom2" %}
	_MODULE_CUSTOM2
	{% elif action == "custom3" %}
	_MODULE_CUSTOM3
	{% else %}
	{ action_raise_error("Unknown module called in START_PRINT! Please verify your startprint_actions variable override!") }
	{% endif %}
	{% endfor %}
	
	
	
	SET_GCODE_OFFSET Z_ADJUST={Z_ADJUST} MOVE=1
	
	
	SET_GCODE_OFFSET Z_ADJUST={material.additional_z_offset} MOVE=1
	{% if filter_enabled %}
	START_FILTER SPEED={material.filter_speed / 100}
	{% endif %}
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="PRINTING"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Start printing !"
	{% endif %}
	
	G92 E0.0

[gcode_macro _MODULE_PRIMELINE]
gcode = 
	PRIMELINE

[gcode_macro _MODULE_HEATSOAK_BED]
gcode = 
	
	
	
	
	
	{% set BED_TEMP = printer["gcode_macro START_PRINT"].bed_temp %}
	{% set SOAK = printer["gcode_macro START_PRINT"].soak %}
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if printer.heater_bed.target < (BED_TEMP - 8) %}
	
	
	{% if (CHAMBER_TEMP > 0) and filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	{% if SOAK > 0 %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME={SOAK}
	{% else %}
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME=0
	{% endif %}

[gcode_macro _MODULE_HEATSOAK_CHAMBER]
gcode = 
	
	
	
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	{% set CHAMBER_MAXTIME = printer["gcode_macro START_PRINT"].chamber_maxtime %}
	
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if chamber_sensor_enabled %}
	{% if CHAMBER_TEMP > 0 %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	
	{% if CURRENT_TEMP <= CHAMBER_TEMP %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	
	
	{% if filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	HEATSOAK_CHAMBER TEMP={CHAMBER_TEMP} MAXTIME={CHAMBER_MAXTIME}
	
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_TILTING]
gcode = 
	
	
	
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	_TILT_CALIBRATE FORCE={force_homing_in_start_print}

[gcode_macro _MODULE_EXTRUDER_HEATING]
gcode = 
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	{% set INITIAL_TOOL = printer["gcode_macro START_PRINT"].initial_tool %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder heating to print temperature..."
	{% endif %}
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET
	{% if not purge_and_brush_enabled %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	M109 S{EXTRUDER_TEMP}
	
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	ERCF_CHANGE_TOOL STANDALONE=1 TOOL={INITIAL_TOOL}
	_ERCF_ERROR_CHECK
	{% endif %}
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder temperature OK"
	{% endif %}

[gcode_macro _MODULE_PURGE]
gcode = 
	
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	
	{% if purge_and_brush_enabled %}
	PURGE TEMP={EXTRUDER_TEMP}
	{% endif %}

[gcode_macro _MODULE_CLEAN]
gcode = 
	
	
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set force_homing_before_brush = printer["gcode_macro _USER_VARIABLES"].force_homing_before_brush %}
	
	{% if purge_and_brush_enabled %}
	{% if force_homing_before_brush %}
	G28 Z
	{% endif %}
	CLEAN_NOZZLE
	{% endif %}

[gcode_macro _MODULE_Z_CALIB]
gcode = 
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% if bed_mesh_enabled and printer.bed_mesh.profile_name == "" %}
	COMPUTE_MESH_PARAMETERS SIZE={FL_SIZE}
	{% endif %}
	
	{% if zcalib_plugin_enabled %}
	G28 Z
	CALIBRATE_Z
	{% else %}
	G28 Z
	{% endif %}

[gcode_macro _MODULE_BED_MESH]
gcode = 
	
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if bed_mesh_enabled %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="MESHING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Bed mesh measurement..."
	{% endif %}
	
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	ADAPTIVE_BED_MESH
	{% else %}
	ADAPTIVE_BED_MESH SIZE={FL_SIZE}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_EXTRUDER_PREHEATING]
gcode = 
	
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Pre-heating the nozzle to a safe temperature..."
	{% endif %}
	
	M109 S{safe_extruder_temp}
	
	{% if verbose %}
	RESPOND MSG="Extruder at safe temperature of {safe_extruder_temp} degrees"
	{% endif %}

[gcode_macro _MODULE_CUSTOM1]
gcode = 

[gcode_macro _MODULE_CUSTOM2]
gcode = 

[gcode_macro _MODULE_CUSTOM3]
gcode = 

[gcode_macro _CG28]
description = Homing only if necessary
gcode = 
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	{% if "xyz" not in printer.toolhead.homed_axes %}
	G28
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[homing_override]
axes = xyz
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set homing_zhop = printer["gcode_macro _USER_VARIABLES"].homing_zhop|float %}
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed * 60 %}
	{% set homing_travel_accel = printer["gcode_macro _USER_VARIABLES"].homing_travel_accel %}
	{% set sensorless_homing_enabled = printer["gcode_macro _USER_VARIABLES"].sensorless_homing_enabled %}
	{% set sensorless_current_factor = printer["gcode_macro _USER_VARIABLES"].sensorless_current_factor / 100 %}
	{% set z_drop_speed = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% set homing_first = printer["gcode_macro _USER_VARIABLES"].homing_first|string|upper %}
	{% set x_homing_backoff, y_homing_backoff = printer["gcode_macro _USER_VARIABLES"].homing_backoff_distance_xy|map('float') %}
	
	{% set x_position_endstop = printer["configfile"].config["stepper_x"]["position_endstop"]|float %}
	{% set y_position_endstop = printer["configfile"].config["stepper_y"]["position_endstop"]|float %}
	{% set x_position_center = printer.toolhead.axis_maximum.x|int/2 - printer.toolhead.axis_minimum.x|int/2 %}
	{% set y_position_center = printer.toolhead.axis_maximum.y|int/2 - printer.toolhead.axis_minimum.y|int/2 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	{% set X, Y, Z = False, False, False %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	
	{% if not 'X' in params
	and not 'Y' in params
	and not 'Z' in params %}
	
	{% set X, Y, Z = True, True, True %}
	
	{% else %}
	{% if 'X' in params %}
	{% set X = True %}
	{% endif %}
	
	{% if 'Y' in params %}
	{% set Y = True %}
	{% endif %}
	
	{% if 'Z' in params %}
	{% set Z = True %}
	{% endif %}
	
	{% if 'X' in params
	and 'Y' in params
	and 'Z' in params %}
	
	
	_HOMING_VARIABLES reset=1
	{% endif %}
	
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_ENTRY_POINT FUNCTION=homing_override
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{homing_travel_accel}
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	G90
	
	{% if Z %}
	{% if ('z' in printer.toolhead.homed_axes) %}
	{% if (printer.toolhead.position.z < homing_zhop) %}
	{% if verbose %}
	{ action_respond_info("Z too low, performing ZHOP") }
	{% endif %}
	G0 Z{homing_zhop} F{z_drop_speed}
	{% endif %}
	{% elif ('xy' in printer.toolhead.homed_axes) %}
	{% if verbose %}
	{ action_respond_info("X and Y already homed, no ZHOP needed to home Z") }
	{% endif %}
	{% else %}
	{% if verbose %}
	{ action_respond_info("X and Y not homed, forcing full G28 to home Z properly") }
	{% endif %}
	SET_KINEMATIC_POSITION X=0 Y=0 Z=0
	G0 Z{homing_zhop} F{z_drop_speed}
	{% set X, Y, Z = True, True, True %}
	{% endif %}
	{% endif %}
	
	{% if homing_first == "X" %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% elif homing_first == "Y" %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% else %}
	{ action_respond_error("Axis homing order not valid. Choose either X or Y first in the variables.cfg file!") }
	{% endif %}
	
	
	
	{% if Z %}
	{% if verbose %}
	{ action_respond_info("Homing Z") }
	{% endif %}
	
	
	
	
	
	
	{% if printer["configfile"].config["stepper_z"]["endstop_pin"]|lower == "probe:z_virtual_endstop" %}
	
	{% if probe_type_enabled == "dockable_virtual" %}
	ACTIVATE_PROBE
	{% endif %}
	{% if bed_mesh_enabled %}
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	{% set mesh_center = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_center %}
	{% set x_mesh_center, y_mesh_center = mesh_center.split(',')|map('trim')|map('float') %}
	RESPOND MSG="Z homing: a mesh is computed and ready, probing mesh center: {mesh_center}"
	G0 X{x_mesh_center} Y{y_mesh_center} F{homing_travel_speed}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	
	
	{% else %}
	_GOTO_Z_PROBE
	{% endif %}
	
	
	{% if probe_type_enabled == "vorontap" %}
	ACTIVATE_PROBE
	{% endif %}
	
	G28 Z0
	
	G91
	G0 Z{homing_zhop} F{z_drop_speed}
	G90
	
	
	
	{% if probe_type_enabled == "vorontap" or probe_type_enabled == "dockable_virtual" %}
	DEACTIVATE_PROBE
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_EXIT_POINT FUNCTION=homing_override
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _GOTO_Z_PROBE]
description = Move to z probe avoiding the probe dock
gcode = 
	
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% if zcalib_plugin_enabled %}
	{% set z_endstop_x, z_endstop_y = printer["configfile"].config["z_calibration"]["nozzle_xy_position"].split(',')|map('trim')|map('float') %}
	{% else %}
	{% set z_endstop_x, z_endstop_y = printer["gcode_macro _USER_VARIABLES"].zendstop_position|map('float') %}
	{% endif %}
	
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed|float * 60 %}
	
	{% set probe_dock_location_x, probe_dock_location_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_location_xy|map('float') %}
	{% set probe_dock_margin_x, probe_dock_margin_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_margin_xy|map('float') %}
	
	{% set current_x = printer.toolhead.position.x|float %}
	{% set current_y = printer.toolhead.position.y|float %}
	
	SAVE_GCODE_STATE NAME=goto_ZProbe
	G90
	
	
	{% set avoid_dock = false %}
	{% if probe_dock_location_x < z_endstop_x|float %}
	
	
	{% if current_x < (probe_dock_location_x + probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% else %}
	
	
	{% if current_x > (probe_dock_location_x - probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% endif %}
	
	
	{% if avoid_dock == true  %}
	
	G0 Y{probe_dock_location_y - probe_dock_margin_y} F{homing_travel_speed}
	
	G0 X{z_endstop_x} F{homing_travel_speed}
	{% endif %}
	
	G0 X{z_endstop_x} Y{z_endstop_y} F{homing_travel_speed}
	
	RESTORE_GCODE_STATE NAME=goto_ZProbe

[gcode_macro CALIBRATE]
description = Calibrate the printer flow or pressure advance
gcode = 
	
	{% set TYPE = params.TYPE|default("")|string|lower %}
	
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set MATERIAL = params.MATERIAL|default("ABS")|string %}
	
	{% set center_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set center_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% if TYPE=="flow" %}
	
	{% set computed_size = (center_x - 20)|string + '_' + (center_y - 20)|string + '_' + (center_x + 20)|string + '_' + (center_y + 20)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	FLOW_MULTIPLIER_CALIBRATION EXTRUSION_WIDTH=0.471
	END_PRINT FILTER_TIME=0
	
	{% elif TYPE=="pressure_advance" %}
	
	{% set computed_size = (center_x - 60)|string + '_' + (center_y - 60)|string + '_' + (center_x + 60)|string + '_' + (center_y + 60)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	PRESSURE_ADVANCE_CALIBRATION
	END_PRINT FILTER_TIME=0
	
	{% else %}
	{action_respond_info("Please call this macro using TYPE= \"flow\" or \"pressure_advance\"")}
	{action_raise_error("not enough parameters to start a calibration!")}
	
	{% endif %}

[gcode_macro _FLOW_CALIB_VARIABLES]
variable_last_shell_thickness = 0.0
variable_last_evalue = 0.0
gcode = 

[gcode_macro FLOW_MULTIPLIER_CALIBRATION]
description = Print a small tower to calibrate the extrusion flow multiplier by measuring the shell
gcode = 
	
	
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	{% set do_retract = params.DO_RECTRACT|default(0)|int %}
	{% set print_size = params.PRINT_SIZE|default(40)|int %}
	{% set print_height = params.HEIGHT|default(15)|int %}
	{% set corner_radius = params.CORNER_RADIUS|default(8)|int %}
	{% set number_of_perimeters = params.PERIMETERS|default(2)|int %}
	{% set fan_speed = params.FAN_SPEED|default(20)|int %}
	
	{% set e_multiplier = params.EXTRUSION_MULTIPLIER|default(1.00)|float %}
	{% set filament_diameter = params.FILAMENT_DIAMETER|default(1.75)|float %}
	{% set extrusion_width = params.EXTRUSION_WIDTH|default(0.4)|float %}
	{% set layer_height = params.LAYER_HEIGHT|default(0.2)|float %}
	
	{% set retract_length = params.RETRACT_LENGTH|default(0.5)|float %}
	{% set initial_purge = params.PURGE_MM|default(1)|int %}
	{% set z_hop_height  = 2 * layer_height %}
	
	{% set feedrate_print = params.CONTROL_SPEED|default(100)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft = params.RAFT_SPEED|default(60)|int * 60 %}
	{% set feedrate_z = params.Z_LIFT_SPEED|default(20)|int * 60 %}
	{% set feedrate_retract = params.RETRACT_SPEED|default(50)|int * 60 %}
	
	
	
	
	{% set e_per_mm = ((extrusion_width - layer_height) * layer_height + 3.14159 * (layer_height / 2)**2) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set spacing = extrusion_width - layer_height * (1 - 3.14159 / 4) %}
	{% set shell_thickness = extrusion_width + (number_of_perimeters|float - 1) * spacing %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set x_start = max_x / 2 - print_size / 2 %}
	{% set y_start = max_y / 2 - print_size / 2 %}
	{% set x_end = x_start + print_size %}
	{% set y_end = y_start + print_size %}
	
	{% set num_raft_lines = ([print_size, max_x]|min / spacing)|round(0, 'floor')|int %}
	{% set raft_size = num_raft_lines * spacing %}
	
	
	
	
	{action_respond_info("")}
	{action_respond_info("Starting extrusion flow calibration print")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	{action_respond_info("Exrusion multiplier used: %.4f" % e_multiplier)}
	{action_respond_info("Number of perimeters to print: %d" % number_of_perimeters)}
	{action_respond_info("THEORIC SHELL THICKNESS: %.4f" % shell_thickness)}
	{action_respond_info("")}
	{action_respond_info("Measure the shell thickness using a caliper or micrometer. Then call the computation macro with the measured value:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION
	
	
	
	
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_shell_thickness VALUE={shell_thickness}
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_evalue VALUE={e_multiplier}
	
	
	
	
	G90
	M83
	G92 E0.0
	G0 X{x_start} Y{y_start - 5} Z{layer_height} F{feedrate_travel}
	
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{raft_size} E{raft_size * e_per_mm * 1.5} F{feedrate_raft / 2}
	G1 Y-{extrusion_width} E{extrusion_width * e_per_mm} F{feedrate_raft / 2}
	G1 X-{raft_size} E{raft_size * e_per_mm} F{feedrate_raft / 2}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G90
	G0 X{x_start} Y{y_start} F{feedrate_travel}
	G1 Z{layer_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	
	
	M221 S{e_multiplier * 100}
	
	
	
	
	{% if do_raft == 1 %}
	G91
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	G1 Y{loop.cycle(1.0, -1.0) * raft_size} E{raft_size * e_per_mm} F{feedrate_raft}
	
	
	{% if not loop.last %}
	G1 X{spacing} E{spacing * e_per_mm} F{feedrate_raft}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	
	
	
	
	G90
	M106 S{fan_speed * 255 / 100}
	
	
	{% for curr_layer in range(1, (print_height / layer_height)|round|int) %}
	G0 X{x_start + corner_radius} Y{y_start} F{feedrate_travel}
	G1 Z{(curr_layer * layer_height) + (layer_height if do_raft == 1 else 0)} F{feedrate_z}
	
	
	{% for perim_num in range(number_of_perimeters) %}
	
	{% set perim_offset = perim_num * spacing %}
	{% set perim_radius = corner_radius - (perim_num * spacing) %}
	
	
	G1 X{x_start + corner_radius} Y{y_start + perim_offset} F{feedrate_travel}
	{% if do_retract == 1 %}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	
	
	G1 X{x_end - corner_radius} Y{y_start + perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - perim_offset} Y{y_start + corner_radius} J{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_end - perim_offset} Y{y_end - corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - corner_radius} Y{y_end - perim_offset} I-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + corner_radius} Y{y_end - perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + perim_offset} Y{y_end - corner_radius} J-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + perim_offset} Y{y_start + corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + corner_radius} Y{y_start + perim_offset} I{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	
	{% if do_retract == 1 %}
	G1 E-{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	
	{% if do_retract == 1 %}
	G91
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G91
	G0 Z20 F{feedrate_travel}
	
	RESTORE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION

[gcode_macro COMPUTE_FLOW_MULTIPLIER]
description = Compute a new flow multiplier by using the measured shell thickness on the calibration print
gcode = 
	{% set evalue = params.OLD_EXTRUSION_MULTIPLIER|default(0.0)|float %}
	{% set theorical_thickness = params.THEORICAL_THICKNESS|default(0.0)|float %}
	{% set measured_thickness = params.MEASURED_THICKNESS|default(0.0)|float %}
	
	
	{% if evalue == 0.0 %}
	{% set last_evalue = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_evalue %}
	
	
	{% if last_evalue == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_evalue = last_evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	{% else %}
	{% set final_evalue = evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	
	
	{% if theorical_thickness == 0.0 %}
	{% set last_shell_thickness = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_shell_thickness %}
	
	
	{% if last_shell_thickness == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_theorical_thickness = last_shell_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	{% else %}
	{% set final_theorical_thickness = theorical_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	
	
	{% if measured_thickness == 0.0 %}
	{action_respond_info("You must use a caliper or micrometer to measure the calibration print shell thickness and call this macro with the measured value !!!")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set new_evalue = final_theorical_thickness * final_evalue / measured_thickness %}
	{action_respond_info("NEW COMPUTED FLOW VALUE: %.3f" % new_evalue)}
	{action_respond_info("Use this new value as extrusion multiplier in your slicer of choice")}
	{action_respond_info("")}
	{% endif %}

[gcode_macro PRESSURE_ADVANCE_CALIBRATION]
description = Calibrate the pressure advance by printing a grid pattern
gcode = 
	
	
	
	{% set pa_start     = params.START|default(0.02)|float %}
	{% set pa_increment = params.INCREMENT|default(0.005)|float %}
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	
	{% set print_size      = params.PRINT_SIZE|default(120)|int %}
	{% set num_bands       = params.BANDS_LIMIT|default(999)|int %}
	{% set lines_per_band  = params.LINES_PER_BAND|default(6)|int %}
	{% set e_multiplier    = params.EXTRUSION_MULTIPLIER|default(1.25 if do_raft == 1 else 1.5)|float %},
	{% set retract_length  = params.RETRACT_LENGTH|default(0.6)|float %}
	{% set initial_purge   = params.PURGE_MM|default(8)|int %}
	
	{% set feedrate_control = params.CONTROL_SPEED|default(30)|int * 60 %}
	{% set feedrate_outer   = params.OUTER_SPEED|default(40)|int * 60 %}
	{% set feedrate_inner   = params.INNER_SPEED|default(120)|int * 60 %}
	{% set feedrate_travel  = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft    = params.RAFT_SPEED|default(120)|int * 60 %}
	{% set feedrate_z       = 5 * 60 %}
	{% set feedrate_retract = 50 * 60 %}
	
	{% set spacing_line  = params.LINE_SPACING|default(0.4)|float %}
	{% set spacing_band  = 2 %}
	{% set spacing_raft  = 2 %}
	
	{% set fast_line_ratio_percent = 50 %}
	
	{% set lines_per_band    = [2, lines_per_band]|max %}
	{% set e_multiplier      = [1, e_multiplier]|max %}
	{% set num_lines_control = (lines_per_band / 2)|round(0, 'floor')|int %}
	{% set num_lines_test    = (lines_per_band / 2)|round(0, 'ceil')|int %}
	{% set spacing_line      = spacing_line * (1 + e_multiplier - 1.25) %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set nozzle_diameter = printer.configfile.config['extruder'].nozzle_diameter|float %}
	{% set line_width    = nozzle_diameter * 1.25 %}
	{% set line_height   = nozzle_diameter / 2 %}
	{% set z_hop_height  = 2 * line_height %}
	{% set e_per_mm      = (line_width * line_height) / (3.1415 * (1.75/2)**2) %}
	{% set spacing_purge = line_height * 0.8 %}
	
	{% set spacing_raft   = (spacing_raft / line_width)|round * line_width %}
	{% set num_raft_lines = ([print_size, max_x]|min / spacing_raft)|round(0, 'floor')|int %}
	{% set print_width    = num_raft_lines * spacing_raft %}
	
	{% set band_height      = lines_per_band * line_width + (lines_per_band - 1) * spacing_line + spacing_band %}
	{% set bands_per_height = (([print_size, max_y]|min  - spacing_purge - 2 * line_width + spacing_band) / band_height)|round(0, 'floor')|int %}
	{% set num_bands        = [num_bands, bands_per_height]|min %}
	{% set print_height     = num_bands * band_height - spacing_band + spacing_purge +  2 * line_width %}
	
	{% set slow_line_length = ((print_width * (1 - fast_line_ratio_percent / 100) / 2) / spacing_raft)|round * spacing_raft + spacing_raft / 2 %}
	{% set fast_line_length = print_width - slow_line_length * 2 %}
	{% set thick_raft_num1 = (slow_line_length / spacing_raft)|round|int %}
	{% set thick_raft_num2  = num_raft_lines - thick_raft_num1 + 1 %}
	
	{% set x_start = max_x / 2 - print_width  / 2 %}
	{% set y_start = max_y / 2 - print_height / 2 %}
	
	{action_respond_info("")}
	{action_respond_info("Starting Pressure Advance calibration print.")}
	{action_respond_info("")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button once the print starts exhibiting PA values that are obviously too high.")}
	{action_respond_info("")}
	{action_respond_info("PA of first band: %.4f" % pa_start)}
	{action_respond_info("PA of last band: %.4f" % (pa_start + ((num_bands - 1) * pa_increment)))}
	{action_respond_info("PA increment per band: %.4f" % pa_increment)}
	{action_respond_info("Number of bands: %d" % num_bands)}
	{action_respond_info("")}
	{action_respond_info("Inspect the printed model. "
	"Look at the top and bottom lines in each band, on the right side of the two vertical raft bars (where the print speeds change). "
	"Find the highest band from the bottom where the lines at its top still resemble the lines at its bottom, with no visible extrusion width irregularities. "
	"Your final Pressure Advance value would then be:"
	)}
	{action_respond_info("")}
	{action_respond_info("Assuming that first band_number is 0")}
	{action_respond_info("PA = %.4f + (%.4f * band_number)" % (pa_start, pa_increment))}
	{action_respond_info("")}
	{action_respond_info("Update your [extruder] config section and set \"pressure_advance\" to the value you calculated.")}
	{action_respond_info("")}
	
	
	
	
	
	
	
	
	
	SAVE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION
	{% set pa_saved = printer.configfile.settings['extruder'].pressure_advance %}
	SET_PRESSURE_ADVANCE ADVANCE={pa_start}
	
	
	
	
	M221 S100
	
	
	
	
	M117 Priming
	G90
	G0 X{x_start} Y{y_start} Z{line_height} F{feedrate_travel}
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{print_width}  E{print_width * e_per_mm} F{feedrate_raft / 2}
	G1 Y{line_width}   E{line_width * e_per_mm}  F{feedrate_raft / 2}
	G1 X-{print_width} E{print_width * e_per_mm} F{feedrate_raft / 2}
	
	
	
	
	{% if do_raft == 1 %}
	G0 F{feedrate_raft}
	
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	{% if curr_raft_line == thick_raft_num1 or curr_raft_line == thick_raft_num2 %}
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	G1 Y{loop.cycle(-1.0, 1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	{% endif %}
	
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	
	
	{% if not loop.last %}
	{% set horizontal_move = spacing_raft - (2 * line_width if curr_raft_line == thick_raft_num1 - 1 or curr_raft_line == thick_raft_num2 - 1 else 0) %}
	G1 X{horizontal_move} E{horizontal_move * e_per_mm}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	{% endif %}
	
	
	
	
	M117 Printing bands
	G90
	G0 X{x_start} Y{y_start + 2 * line_width + spacing_purge} F{feedrate_travel}
	G0 Z{line_height + (line_height if do_raft == 1 else 0)} F{feedrate_z}
	G91
	G1 E{retract_length} F{feedrate_retract}
	
	
	{% for curr_band_num in range(0, num_bands ) %}
	{% set outer_loop = loop %}
	
	{% set curr_pa_value = pa_start + curr_band_num * pa_increment %}
	SET_PRESSURE_ADVANCE ADVANCE={curr_pa_value}
	M117 Band {curr_band_num} PA {curr_pa_value|round(4)}
	
	
	{% for _ in range(num_lines_control) %}
	G1 X{print_width} E{print_width * e_per_mm * e_multiplier} F{feedrate_control}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G0 X-{print_width} Y{spacing_line + line_width} F{feedrate_travel}
	
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endfor %}
	
	
	{% for _ in range(num_lines_test) %}
	{% for data in [{'mm': slow_line_length, 'f': feedrate_outer}, {'mm': fast_line_length, 'f': feedrate_inner}, {'mm': slow_line_length, 'f': feedrate_outer}] %}
	G1 X{data.mm} E{data.mm * e_per_mm * e_multiplier} F{data.f}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	{% if not (outer_loop.last and loop.last) %}
	G0 X-{print_width} Y{(spacing_line if not loop.last else spacing_band) + line_width} F{feedrate_travel}
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z20 F{feedrate_z}
	G0 X-{print_width / 2} Y{[50, max_y - (y_start + print_height)]|min} F{feedrate_travel}
	
	M117
	SET_PRESSURE_ADVANCE ADVANCE={pa_saved}
	RESTORE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION

[gcode_macro CHANGE_FILAMENT]
description = Do a PAUSE, park the toolhead over the purge bucket and unload the filament
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	SAVE_GCODE_STATE NAME=CHANGE_FILAMENT_state
	PAUSE
	UNLOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=CHANGE_FILAMENT_state

[gcode_macro UNLOAD_FILAMENT]
description = Basic unload of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to unload filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to unload filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	
	_TIP_SHAPING
	M83
	G1 E-20 F3600
	G4 P3000
	G1 E{DISTANCE|float * -1} F3000
	
	RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament unloaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament unloaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro LOAD_FILAMENT]
description = Basic load of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to load filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to load filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=LOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	M83
	G92 E0
	G1 E{DISTANCE|float} F200
	G1 E50 F150
	
	G92 E0
	RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament loaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament loaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _TIP_SHAPING]
description = Filament tip shaping sequence
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=TIP_SHAPING_state
	_LOW_TEMP_CHECK T={TEMP}
	
	{% set old_pressure_advance = printer.extruder.pressure_advance|default(0) %}
	
	SET_PRESSURE_ADVANCE ADVANCE=0
	
	M82
	G92 E0
	G1 E2 F3600
	G1 E0 F3600
	G1 E3 F3600
	G1 E0 F3600
	G1 E4 F3600
	G1 E0 F3600
	
	
	SET_PRESSURE_ADVANCE ADVANCE={old_pressure_advance}
	RESTORE_GCODE_STATE NAME=TIP_SHAPING_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_CHAMBER]
description = Heatsoak chamber to a specific temperature with a timeout
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set MAXTIME = params.MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% for _ in range(1, MAXTIME) %}
	_WAIT_CHAMBER_TEMP TEMP={SETPOINT_TEMP}
	{% endfor %}
	{% if verbose %}
	RESPOND MSG="Chamber temperature OK !"
	{% endif %}
	{% endif %}

[gcode_macro _WAIT_CHAMBER_TEMP]
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	{% if CURRENT_TEMP <= SETPOINT_TEMP %}
	RESPOND MSG="Heating up the chamber : {CURRENT_TEMP}/{SETPOINT_TEMP}"
	G4 P{60000 * 1}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_BED]
description = Heatsoak bed at specified temperature and wait for a specific amount of time
gcode = 
	{% set SETPOINT_TEMP = params.TEMP|default(0)|int %}
	{% set TIME = params.SOAKTIME|default(8)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set heaterbed_enabled = printer["gcode_macro _USER_VARIABLES"].heaterbed_enabled %}
	
	{% if heaterbed_enabled %}
	{% if verbose %}
	RESPOND MSG="Heating up bed..."
	{% endif %}
	
	M190 S{SETPOINT_TEMP}
	
	{% if TIME > 0 %}
	{% for i in range(0, TIME) %}
	RESPOND MSG="Heatsoak bed, {TIME-i}mn left..."
	G4 P{60000 * 1}
	{% endfor %}
	{% else %}
	RESPOND MSG="No heatsoak needed, continue"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Bed temperature OK"
	{% endif %}
	
	{% else %}
	{% if verbose %}
	RESPOND MSG="No bed heater defined: nothing to do, continuing..."
	{% endif %}
	{% endif %}

[gcode_macro PRIMELINE]
gcode = 
	
	{% set prime_line_length = params.LINE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_length)|float %}
	{% set prime_line_purge_distance = params.PURGE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_purge_distance)|float %}
	{% set prime_line_flowrate = params.FLOWRATE|default(printer["gcode_macro _USER_VARIABLES"].prime_line_flowrate)|float %}
	
	
	{% set prime_line_x, prime_line_y = printer["gcode_macro _USER_VARIABLES"].prime_line_xy|map('float') %}
	{% set prime_line_direction = printer["gcode_macro _USER_VARIABLES"].prime_line_direction|string|upper %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% set max_extrude_cross_section = printer["configfile"].config["extruder"]["max_extrude_cross_section"]|float %}
	{% set filament_diameter = printer["configfile"].config["extruder"]["filament_diameter"]|float %}
	
	{% set line_height = 0.6 %}
	
	
	{% set prime_line_x = params.START_X|default(prime_line_x)|float %}
	{% set prime_line_y = params.START_Y|default(prime_line_y)|float %}
	{% set prime_line_direction = params.LINE_DIRECTION|default(printer["gcode_macro _USER_VARIABLES"].prime_line_direction)|string|upper %}
	
	
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	
	
	
	{% if (line_height * line_width) > max_extrude_cross_section %}
	{% if verbose %}
	{action_respond_info("The prime_line_purge_distance of %.4f mm is too high and will exceed the max_extrude_cross_section!" % prime_line_purge_distance)}
	{% endif %}
	{% set prime_line_purge_distance = 0.98 * (max_extrude_cross_section * prime_line_length) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	{% if verbose %}
	{action_respond_info("Klippain corrected the prime_line_purge_distance to %.4f mm" % prime_line_purge_distance)}
	{% endif %}
	{% endif %}
	
	
	{% if (line_height / line_width) >= 0.5 %}
	{% if verbose %}
	{action_raise_error("The prime line will be too thin and will probably not stick properly to the bed. Increase its purge distance or decrease its length! Aborting...")}
	{% endif %}
	{% endif %}
	
	
	{% set speed = (prime_line_flowrate / (line_height * line_width)) * 60 |float %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% endif %}
	{% endif %}
	{% endif %}
	
	G91
	M83
	G1 Z5 F{Sz}
	
	
	G90
	G0 X{prime_line_x} Y{prime_line_y} F{St}
	G1 Z{line_height} F{Sz|int / 2}
	
	
	G92 E0
	G1 E18 F300
	
	
	G92 E0
	{% if prime_line_direction == "X" %}
	G1 X{prime_line_x + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% elif prime_line_direction == "Y" %}
	G1 Y{prime_line_y + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% else %}
	{ action_respond_error("Prime line direction is not valid. Choose either X or Y in the variables.cfg file!") }
	{% endif %}
	
	
	G92 E0
	G1 E-0.2 F2100
	G92 E0
	G1 Z3 F{Sz}
	M400
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection reactivated after the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro CLEAN_NOZZLE]
description = Wipe the nozzle on the brush
gcode = 
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set brush_clean_accel = printer["gcode_macro _USER_VARIABLES"].brush_clean_accel %}
	{% set brush_over_y_axis = printer["gcode_macro _USER_VARIABLES"].brush_over_y_axis %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set Sc = printer["gcode_macro _USER_VARIABLES"].brush_clean_speed * 60 %}
	
	{% set Bx, By, Bz = printer["gcode_macro _USER_VARIABLES"].brush_xyz|map('float') %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Nozzle cleaning..."
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{brush_clean_accel}
	
	
	G90
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP=1
	
	G1 X{Bx} Y{By} Z{Bz} F{St}
	
	
	G91
	{% if brush_over_y_axis %}
	{% for wipe in range(6) %}
	G1 Y-5 F{Sc}
	G1 Y+5 F{Sc}
	{% endfor %}
	{% endif %}
	
	G1 X+20 F{Sc}
	
	{% for wipe in range(6) %}
	G1 X-40 F{Sc}
	G1 X+40 F{Sc}
	{% endfor %}
	
	G90
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="clean"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro PURGE]
description = Purge a specific amount of filament ontop of the purge bucket
gcode = 
	{% set DISTANCE = params.DISTANCE|default(printer["gcode_macro _USER_VARIABLES"].purge_distance)|int %}
	{% set OOZE_TIME = params.OOZE_TIME|default(printer["gcode_macro _USER_VARIABLES"].purge_ooze_time)|int %}
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Purge filament..."
	{% endif %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% endif %}
	
	G90
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP={Z_DROP}
	
	
	_LOW_TEMP_CHECK T={TEMP}
	G92 E0
	G1 E{DISTANCE|float} F150
	
	
	G92 E0
	G1 E-1.7 F2100
	G1 E-18.3 F150
	G92 E0
	
	
	G4 P{OOZE_TIME * 1000}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _CONDITIONAL_MOVE_TO_PURGE_BUCKET]
description = Move over the purge bucket
gcode = 
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	
	{% if purge_and_brush_enabled %}
	SAVE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	G90
	
	{% if Z_DROP == 1 %}
	{% if purgeclean_servo_enabled %}
	G1 Z{Pz} F{Sz}
	_SERVO_DEPLOY ITEM="purge"
	{% endif %}
	G1 X{Px} Y{Py} Z{Pz} F{St}
	{% else %}
	
	
	
	G1 X{Px} Y{Py} F{St}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	{% endif %}

[gcode_macro _LOW_TEMP_CHECK]
description = Check the nozzle is at temperature and heat it if needed
gcode = 
	{% set T = params.T|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% if printer.extruder.target != 0 %}
	{% if printer.extruder.temperature < printer.extruder.target %}
	M109 S{printer.extruder.target|float}
	{% endif %}
	{% else %}
	{% if printer.extruder.target < T %}
	M109 S{T}
	{% endif %}
	{% endif %}

[gcode_macro M701]
description = Map M701 to LOAD_FILAMENT
gcode = 
	LOAD_FILAMENT

[gcode_macro M702]
description = Map M702 to UNLOAD_FILAMENT
gcode = 
	UNLOAD_FILAMENT

[gcode_macro M600]
description = Map M600 to CHANGE_FILAMENT
gcode = 
	CHANGE_FILAMENT

[gcode_macro M125]
description = Map M125 to PARK
gcode = 
	PARK

[gcode_macro M900]
description = Map M900 to SET_PRESSURE_ADVANCE
gcode = 
	{% if 'K' in params %}
	{% if 'E' in params %}
	SET_PRESSURE_ADVANCE EXTRUDER={params.E} ADVANCE={params.K}
	{% else %}
	SET_PRESSURE_ADVANCE ADVANCE={params.K}
	{% endif %}
	{% endif %}

[gcode_macro M204]
description = Map M204 to SET_VELOCITY_LIMIT for ACCEL and ACCEL_TO_DECEL
rename_existing = M204.1
gcode = 
	{% set F = params.F|default(printer["gcode_macro _USER_VARIABLES"].accel_to_decel_factor)|float %}
	
	{% if 'S' in params %}
	{% set S = params.S|float %}
	SET_VELOCITY_LIMIT ACCEL={S} ACCEL_TO_DECEL={S * F}
	{% endif %}

[gcode_macro M205]
description = Map M205 to SET_VELOCITY_LIMIT for SQUARE_CORNER_VELOCITY
gcode = 
	{% if 'X' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.X}
	{% elif 'Y' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.Y}
	{% endif %}

[gcode_macro G00]
gcode = 
	G0 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G01]
gcode = 
	G1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G02]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G03]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G04]
gcode = 
	G4 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro _SEARCH_VARS]
description = Search for variables in the "printer" object from Klipper
gcode = 
	{% set search = params.S|lower %}
	{% set ns = namespace() %}
	{% for item in printer  %}
	{% if ' ' in item %}
	{% set ns.path = ['printer', "['%s']" % (item), ''] %}
	{% else %}
	{% set ns.path = ['printer.', item, ''] %}
	{% endif %}
	
	{% if search in ns.path|lower %}
	{ action_respond_info(ns.path|join) }
	{% endif %}
	
	{% if printer[item].items() %}
	{% for childkey, child in printer[item].items() recursive %}
	{% set ns.path = ns.path[:loop.depth|int + 1] %}
	
	{% if ' ' in childkey %}
	{% set null = ns.path.append("['%s']" % (childkey)) %}
	{% else %}
	{% set null = ns.path.append(".%s" % (childkey)) %}
	{% endif %}
	
	{% if child is mapping  %}
	{ loop(child.items()) }
	{% else %}
	{% if search in ns.path|lower %}
	{ action_respond_info("%s : %s" % (ns.path|join, child)) }
	{% endif %}
	{% endif %}
	
	{% endfor %}
	{% endif %}
	{% endfor %}

[delayed_gcode KLIPPAIN_STARTUP]
initial_duration = 1
gcode = 
	_KLIPPAIN_STARTUP

[gcode_macro _KLIPPAIN_STARTUP]
gcode = 
	
	RUN_SHELL_COMMAND CMD=system_info
	
	
	_INIT_MCU_VER
	
	
	{% set extruder_enabled = printer["gcode_macro _USER_VARIABLES"].extruder_enabled %}
	{% if not extruder_enabled %}
	{ action_raise_error("Klippain need to have an extruder defined to work properly. Check your printer.cfg includes!") }
	{% endif %}
	
	
	_INIT_CHECKPROBECONF
	
	
	{% set e_driver = printer["gcode_macro _USER_VARIABLES"].e_driver|string %}
	{% if e_driver == "TMC2240" %}
	_INIT_TMC2240
	{% endif %}
	
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% if klippain_ercf_enabled %}
	_INIT_CHECK_ERCF
	{% endif %}
	
	
	_INIT_USERCUSTOM
	
	RESPOND MSG="Klippain started and ready !"

[gcode_macro _INIT_TMC2240]
gcode = 

[gcode_macro _INIT_CHECKPROBECONF]
gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled|string %}
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set qgl_enabled = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set ztilt_enabled = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	
	{% if zcalib_plugin_enabled %}
	{% if probe_type_enabled == "vorontap" %}
	{ action_raise_error("Voron TAP Probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "inductive" %}
	{ action_raise_error("Inductive probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "dockable_virtual" or probe_type_enabled == "inductive_virtual" %}
	{ action_raise_error("Virtual Z endstop probes are not compatible with the Z calibration plugin!") }
	{% elif probe_type_enabled == "none" %}
	{ action_raise_error("You need a probe to use the Z calibration plugin in Klippain!") }
	{% endif %}
	{% endif %}
	
	{% if bed_mesh_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a bed mesh in Klippain!") }
	{% endif %}
	
	{% if qgl_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a quad gantry leveling in Klippain!") }
	{% endif %}
	
	{% if ztilt_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a Z tilt adjust in Klippain!") }
	{% endif %}

[gcode_macro _INIT_MCU_VER]
gcode = 
	{% set parameters = namespace(output = 'Currently configured MCU(s): \n') %}
	{% for name1 in printer %}
	{% for name2 in printer[name1] %}
	{% set show = ['mcu_version'] %}
	{% if name2 is in show %}
	{% set param = "%s: %s" % (name1, printer[name1][name2]) %}
	{% set parameters.output = parameters.output +  param + "\n" %}
	{% endif %}
	{% endfor %}
	{% endfor %}
	{action_respond_info(parameters.output)}

[gcode_macro _INIT_CHECK_ERCF]
gcode = 
	{% if not printer.ercf.enabled %}
	{ action_raise_error("ERCF is enabled in Klippain, but Happy Hare, the supported ERCF backend software is not detected. Please install it now from https://github.com/moggieuk/ERCF-Software-V3 !") }
	{% endif %}

[gcode_macro _INIT_USERCUSTOM]
gcode = 

[gcode_shell_command plot_graph]
command = bash /home/pi/printer_data/config/scripts/plot_graphs.sh
timeout = 500.0
verbose = True

[gcode_shell_command system_info]
command = python3 /home/pi/printer_data/config/scripts/system_info.py
timeout = 5.0
verbose = True

[save_variables]
filename = ~/printer_data/config/save_variables.cfg

[tmc2209 stepper_z]
uart_pin = Z_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z1]
uart_pin = Z1_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z2]
uart_pin = Z2_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z3]
uart_pin = Z3_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 extruder]
uart_pin = toolhead:E_TMCUART
interpolate = false
run_current = 0.45
sense_resistor = 0.110
stealthchop_threshold = 0

[mcu]
canbus_uuid = f981df077b2c

[board_pins mcu_manufacturer]
aliases = 
	MCU_MOTOR0_STEP=PF13   , MCU_MOTOR0_DIR=PF12   , MCU_MOTOR0_ENABLE=PF14   , MCU_MOTOR0_UART=PC4    ,
	MCU_MOTOR1_STEP=PG0    , MCU_MOTOR1_DIR=PG1    , MCU_MOTOR1_ENABLE=PF15   , MCU_MOTOR1_UART=PD11   ,
	MCU_MOTOR2_1_STEP=PF11 , MCU_MOTOR2_1_DIR=PG3  , MCU_MOTOR2_1_ENABLE=PG5  , MCU_MOTOR2_1_UART=PC6  ,
	MCU_MOTOR3_STEP=PG4    , MCU_MOTOR3_DIR=PC1    , MCU_MOTOR3_ENABLE=PA0    , MCU_MOTOR3_UART=PC7    ,
	MCU_MOTOR4_STEP=PF9    , MCU_MOTOR4_DIR=PF10   , MCU_MOTOR4_ENABLE=PG2    , MCU_MOTOR4_UART=PF2    ,
	MCU_MOTOR5_STEP=PC13   , MCU_MOTOR5_DIR=PF0    , MCU_MOTOR5_ENABLE=PF1    , MCU_MOTOR5_UART=PE4    ,
	MCU_MOTOR6_STEP=PE2    , MCU_MOTOR6_DIR=PE3    , MCU_MOTOR6_ENABLE=PD4    , MCU_MOTOR6_UART=PE1    ,
	MCU_MOTOR7_STEP=PE6    , MCU_MOTOR7_DIR=PA14   , MCU_MOTOR7_ENABLE=PE0    , MCU_MOTOR7_UART=PD3    ,
	
	MCU_STOP0=PG6  , MCU_STOP1=PG9  , MCU_STOP2=PG10 , MCU_STOP3=PG11 ,
	MCU_STOP4=PG12 , MCU_STOP5=PG13 , MCU_STOP6=PG14 , MCU_STOP7=PG15 ,
	MCU_PROBE=PB7  ,
	MCU_SERVOS=PB6 ,
	
	MCU_HE0=PA2 , MCU_HE1=PA3 , MCU_HE2=PB10 , MCU_HE3=PB11 ,
	
	MCU_BED0=PA1 ,
	
	MCU_TB=PF3 ,
	MCU_T0=PF4 , MCU_T1=PF5 , MCU_T2=PF6 , MCU_T3=PF7 ,
	
	MCU_FAN0=PA8 , MCU_FAN1=PE5 , MCU_FAN2=PD12 , MCU_FAN3=PD13 , MCU_FAN4=PD14 , MCU_FAN5=PD15 ,
	
	MCU_NEOPIXEL=PB0  ,
	MCU_PS_ON=PE11    ,
	MCU_POWER_DET=PC0 ,
	
	
	EXP1_1=PE8   , EXP1_2=PE7   ,
	EXP1_3=PE9   , EXP1_4=PE10  ,
	EXP1_5=PE12  , EXP1_6=PE13  ,
	EXP1_7=PE14  , EXP1_8=PE15  ,
	EXP1_9=<GND> , EXP1_10=<5V> ,
	
	
	EXP2_1=PA6   , EXP2_2=PA5   ,
	EXP2_3=PB1   , EXP2_4=PA4   ,
	EXP2_5=PB2   , EXP2_6=PA7   ,
	EXP2_7=PC15  , EXP2_8=<RST> ,
	EXP2_9=<GND> , EXP2_10=<5V> ,

[board_pins octopus_mcu]
mcu = mcu
aliases = 
	X_STEP=MCU_MOTOR0_STEP   , X_DIR=MCU_MOTOR0_DIR   , X_ENABLE=MCU_MOTOR0_ENABLE   , X_TMCUART=MCU_MOTOR0_UART   ,
	Y_STEP=MCU_MOTOR1_STEP   , Y_DIR=MCU_MOTOR1_DIR   , Y_ENABLE=MCU_MOTOR1_ENABLE   , Y_TMCUART=MCU_MOTOR1_UART   ,
	
	Z_STEP=MCU_MOTOR2_1_STEP , Z_DIR=MCU_MOTOR2_1_DIR , Z_ENABLE=MCU_MOTOR2_1_ENABLE , Z_TMCUART=MCU_MOTOR2_1_UART ,
	Z1_STEP=MCU_MOTOR3_STEP  , Z1_DIR=MCU_MOTOR3_DIR  , Z1_ENABLE=MCU_MOTOR3_ENABLE  , Z1_TMCUART=MCU_MOTOR3_UART  ,
	Z2_STEP=MCU_MOTOR4_STEP  , Z2_DIR=MCU_MOTOR4_DIR  , Z2_ENABLE=MCU_MOTOR4_ENABLE  , Z2_TMCUART=MCU_MOTOR4_UART  ,
	Z3_STEP=MCU_MOTOR5_STEP  , Z3_DIR=MCU_MOTOR5_DIR  , Z3_ENABLE=MCU_MOTOR5_ENABLE  , Z3_TMCUART=MCU_MOTOR5_UART  ,
	
	E_STEP=MCU_MOTOR6_STEP   , E_DIR=MCU_MOTOR6_DIR   , E_ENABLE=MCU_MOTOR6_ENABLE   , E_TMCUART=MCU_MOTOR6_UART   ,
	
	X_STOP=MCU_STOP0 , Y_STOP=MCU_STOP1 , Z_STOP=MCU_STOP2 ,
	PROBE_INPUT=MCU_STOP7  ,
	RUNOUT_SENSOR=MCU_STOP3 ,
	
	E_HEATER=MCU_HE0   , E_TEMPERATURE=MCU_T0   ,
	BED_HEATER=MCU_HE1 , BED_TEMPERATURE=MCU_TB ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	CONTROLLER_FAN=MCU_FAN2        ,
	EXHAUST_FAN=MCU_FAN3           ,
	FILTER_FAN=MCU_FAN4            ,
	HOST_CONTROLLER_FAN=MCU_FAN5   ,
	
	CHAMBER_TEMPERATURE=MCU_T1 , ELECTRICAL_CABINET_TEMPERATURE=MCU_T2 ,
	
	LIGHT_OUTPUT=MCU_HE2         ,
	LIGHT_NEOPIXEL=MCU_STOP5     ,
	STATUS_NEOPIXEL=MCU_NEOPIXEL ,

[mcu toolhead]
canbus_uuid = 1b44cf5169c3

[board_pins toolhead_manufacturer]
mcu = toolhead
aliases = 
	MCU_EMOT_EN=gpio7 , MCU_EMOT_STEP=gpio9 , MCU_EMOT_DIR=gpio10 , MCU_EMOT_UART=gpio8 ,
	
	MCU_5V_ENDSTOP=gpio28 ,
	MCU_ENDSTOP=gpio29    ,
	MCU_HV_ENDSTOP=gpio25 ,
	
	MCU_FAN0=gpio13 , MCU_FAN1=gpio14 , MCU_FAN2=gpio15 ,
	
	MCU_TEMP=gpio27 , MCU_ONBOARD_NTCK100K=gpio26 ,
	
	MCU_HEAT=gpio6 ,
	
	MCU_RGB=gpio12 ,
	MCU_PWM0=gpio16 , MCU_PWM1=gpio17 ,
	
	MCU_ADXL_CS=gpio1 , MCU_ADXL_SCK=gpio0 , MCU_ADXL_MOSI=gpio3 , MCU_ADXL_MISO=gpio2 ,

[board_pins sb2040_mcu]
mcu = toolhead
aliases = 
	E_STEP=MCU_EMOT_STEP , E_DIR=MCU_EMOT_DIR , E_ENABLE=MCU_EMOT_EN , E_TMCUART=MCU_EMOT_UART ,
	
	X_STOP=MCU_ENDSTOP ,
	PROBE_INPUT=MCU_HV_ENDSTOP ,
	TOOLHEAD_SENSOR=MCU_5V_ENDSTOP ,
	
	E_HEATER=MCU_HEAT , E_TEMPERATURE=MCU_TEMP , CHAMBER_TEMPERATURE=MCU_ONBOARD_NTCK100K ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	
	STATUS_NEOPIXEL=MCU_RGB ,
	
	ADXL_CS=MCU_ADXL_CS , ADXL_SCLK=MCU_ADXL_SCK , ADXL_MOSI=MCU_ADXL_MOSI , ADXL_MISO=MCU_ADXL_MISO ,

[neopixel status_leds]
pin = toolhead:STATUS_NEOPIXEL
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting CAN connect
Created a socket
webhooks client 281473409006992: New connection
webhooks client 281473409006992: Client info {'program': 'Moonraker', 'version': 'v0.8.0-92-g504a3a7'}
Loaded MCU 'mcu' 107 commands (v0.11.0-110-gaca0c71a / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1=PB6,PB7 BUS_PINS_i2c1a=PB8,PB9 BUS_PINS_i2c2=PB10,PB11 BUS_PINS_i2c2a=PH4,PH5 BUS_PINS_i2c3=PA8,PC9 BUS_PINS_i2c3a=PH7,PH8 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3=PB4,PB5,PB3 BUS_PINS_spi3a=PC11,PC12,PC10 BUS_PINS_spi4=PE13,PE14,PE12 CANBUS_BRIDGE=1 CLOCK_FREQ=168000000 MCU=stm32f429xx PWM_MAX=255 RECEIVE_WINDOW=192 RESERVE_PINS_CAN=PD0,PD1 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PH0,PH1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu 'toolhead': Starting CAN connect
Created a socket
Loaded MCU 'toolhead' 107 commands (v0.11.0-201-g37315bf3 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'toolhead' config: ADC_MAX=4095 BUS_PINS_i2c0a=gpio0,gpio1 BUS_PINS_i2c0b=gpio4,gpio5 BUS_PINS_i2c0c=gpio8,gpio9 BUS_PINS_i2c0d=gpio12,gpio13 BUS_PINS_i2c0e=gpio16,gpio17 BUS_PINS_i2c0f=gpio20,gpio21 BUS_PINS_i2c0g=gpio24,gpio25 BUS_PINS_i2c0h=gpio28,gpio29 BUS_PINS_i2c1a=gpio2,gpio3 BUS_PINS_i2c1b=gpio6,gpio7 BUS_PINS_i2c1c=gpio10,gpio11 BUS_PINS_i2c1d=gpio14,gpio15 BUS_PINS_i2c1e=gpio18,gpio19 BUS_PINS_i2c1f=gpio22,gpio23 BUS_PINS_i2c1g=gpio26,gpio27 BUS_PINS_spi0a=gpio0,gpio3,gpio2 BUS_PINS_spi0b=gpio4,gpio7,gpio6 BUS_PINS_spi0c=gpio16,gpio19,gpio18 BUS_PINS_spi0d=gpio20,gpio23,gpio22 BUS_PINS_spi1a=gpio8,gpio11,gpio10 BUS_PINS_spi1b=gpio12,gpio15,gpio14 BUS_PINS_spi1c=gpio24,gpio27,gpio26 CANBUS_FREQUENCY=1000000 CLOCK_FREQ=12000000 INITIAL_PINS=gpio24 MCU=rp2040 PWM_MAX=255 RECEIVE_WINDOW=192 RESERVE_PINS_CAN=gpio4,gpio5 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu_temperature 'mcu' nominal base=-238.014440 slope=1182.671480
mcu_temperature 'toolhead' nominal base=437.226612 slope=-1917.489831
Config error
Traceback (most recent call last):
  File "/home/orangepi/klipper/klippy/klippy.py", line 180, in _connect
    cb()
  File "/home/orangepi/klipper/klippy/mcu.py", line 753, in _connect
    self._send_config(None)
  File "/home/orangepi/klipper/klippy/mcu.py", line 692, in _send_config
    cmdlist[i] = pin_resolver.update_command(cmd)
  File "/home/orangepi/klipper/klippy/pins.py", line 53, in update_command
    return re_pin.sub(pin_fixup, cmd)
  File "/home/orangepi/klipper/klippy/pins.py", line 50, in pin_fixup
    raise error("pin %s is reserved for %s" % (
pins.error: pin EXP2_10 is reserved for <5V>
Attempting MCU 'toolhead' reset command
Attempting MCU 'mcu' reset command
b'Got error -1 in can read: (100)Network is down'
webhooks client 281473409006992: Disconnected
Restarting printer
Start printer at Tue Jul 11 14:42:02 2023 (1689104522.8 156.8)
===== Config file =====
[printer]
kinematics = corexz
max_velocity = 400
max_accel = 1000
max_z_velocity = 200
max_z_accel = 1000
square_corner_velocity = 5.0

[stepper_x]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = X_STEP
dir_pin = X_DIR
enable_pin = !X_ENABLE
endstop_pin = tmc2209_stepper_x:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_y]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = Y_STEP
dir_pin = Y_DIR
enable_pin = !Y_ENABLE
endstop_pin = tmc2209_stepper_y:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_z]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z_STEP
dir_pin = !Z_DIR
enable_pin = !Z_ENABLE
endstop_pin = probe:z_virtual_endstop
homing_speed = 15
second_homing_speed = 8
homing_retract_dist = 3.0
position_max = 310
position_min = -5

[stepper_z1]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z1_STEP
dir_pin = !Z1_DIR
enable_pin = !Z1_ENABLE

[stepper_z2]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z2_STEP
dir_pin = !Z2_DIR
enable_pin = !Z2_ENABLE

[stepper_z3]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z3_STEP
dir_pin = Z3_DIR
enable_pin = !Z3_ENABLE

[gcode_macro _USER_VARIABLES]
variable_extruder_enabled = True
gcode = 
variable_heaterbed_enabled = True
variable_probe_type_enabled = "vorontap"
variable_startprint_actions = "bed_soak", "extruder_preheating", "chamber_soak", "clean", "tilt_calib", "z_offset", "bedmesh", "extruder_heating", "purge", "clean", "primeline"
variable_purgeclean_servo_enabled = True
variable_purgeclean_servo_name = "purgeservo"
variable_status_leds_minidisplay_enabled = True
variable_status_leds_minidisplay_led_name = "btt_mini12864"
variable_bed_mesh_enabled = True
variable_sensorless_homing_enabled = True
variable_qgl_enabled = True
variable_verbose = True
variable_homing_travel_speed = 350
variable_travel_speed = 350
variable_z_drop_speed = 15
variable_brush_clean_speed = 100
variable_probe_dock_speed = 60
variable_homing_travel_accel = 3000
variable_tilting_travel_accel = 3000
variable_brush_clean_accel = 1500
variable_probe_dock_accel = 2000
variable_accel_to_decel_factor = 0.75
variable_zendstop_position = -1, -1
variable_force_homing_in_start_print = False
variable_homing_zhop = 5
variable_homing_first = "X"
variable_homing_backoff_distance_xy = -5, -5
variable_sensorless_current_factor = 75
variable_probe_dock_margin_xy = 0, 0
variable_safe_extruder_temp = 150
variable_prime_line_xy = 5, 2.5
variable_prime_line_direction = "X"
variable_prime_line_length = 40
variable_prime_line_purge_distance = 30
variable_prime_line_flowrate = 10
variable_park_position_xy = -1, -1
variable_park_lift_z = 50
variable_disable_motors_in_end_print = False
variable_turn_off_heaters_in_end_print = True
variable_min_bed_xy = 0, 0
variable_max_bed_xy = 9999, 9999
variable_probe_min_z_travel = 20
variable_probe_dock_location_xy = -1, -1
variable_probe_servo_angle_retracted = 0
variable_probe_servo_angle_deployed = 90
variable_probe_before_attach_position = "front"
variable_probe_after_attach_position = "front"
variable_probe_before_dock_position = "front"
variable_probe_after_dock_position = "left"
variable_probe_move_attach_length = 30
variable_probe_move_dock_length = 30
variable_autodock_on_probe_error = True
variable_tap_max_probing_temp = 150
variable_tap_deactivation_zhop = 5
variable_print_default_bed_temp = 105
variable_print_default_extruder_temp = 240
variable_print_default_chamber_temp = 0
variable_print_default_chamber_max_heating_time = 15
variable_print_default_soak = 8
variable_print_default_material = "XXX"
variable_material_parameters = {
	'PLA': {
	'pressure_advance': 0.0525,
	'retract_length': 0.75,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 0,
	'additional_z_offset': 0
	},
	'PET': {
	'pressure_advance': 0.0650,
	'retract_length': 1.4,
	'unretract_extra_length': 0,
	'retract_speed': 30,
	'unretract_speed': 20,
	'filter_speed': 0,
	'additional_z_offset': 0.020
	},
	'ABS': {
	'pressure_advance': 0.0480,
	'retract_length': 0.5,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 80,
	'additional_z_offset': 0
	}
	}
variable_ercf_unload_on_cancel_print = False
variable_ercf_unload_on_end_print = True
variable_ercf_reset_stats_on_start_print = False
variable_purge_and_brush_enabled = False
variable_force_homing_before_brush = False
variable_brush_over_y_axis = True
variable_brush_xyz = -1, -1, -1
variable_purge_bucket_xyz = -1, -1, -1
variable_purge_distance = 30
variable_purge_ooze_time = 10
variable_purgeclean_servo_angle_retracted = 0
variable_purgeclean_servo_angle_deployed = 90
variable_light_intensity_start_print = 100
variable_light_intensity_printing = 30
variable_light_intensity_end_print = 0
variable_fix_heaters_temperature_settle = False
variable_resonnance_test_point_xy = -1, -1
variable_resonnance_test_z_clearance = 50
variable_status_leds_colors = {
	'logo': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'nozzle': {
	'heating': {'r': 0.8, 'g': 0.35, 'b': 0.0, 'w':0.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'standby': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'caselight': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'minidisplay': {
	'on': {'r': 0.0, 'g': 0.2, 'b': 0.4, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'error': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'thermal': {
	'hot': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cold': {'r': 0.3, 'g': 0.0, 'b': 0.3, 'w': 0.0}
	}
	}
variable_x_driver = "TMC2209"
variable_y_driver = "TMC2209"
variable_z_driver = "TMC2209"
variable_e_driver = "TMC2209"

[extruder]
rotation_distance = 22.79234586
gear_ratio = 50:10
microsteps = 64
full_steps_per_rotation = 200
nozzle_diameter = 0.400
filament_diameter = 1.75
max_extrude_only_distance = 110
max_extrude_cross_section = 5
sensor_type = ATC Semitec 104GT-2
min_temp = 5
max_temp = 310
max_power = 1.0
min_extrude_temp = 170
pressure_advance = 0.045
pressure_advance_smooth_time = 0.040
step_pin = toolhead:E_STEP
dir_pin = toolhead:E_DIR
enable_pin = !toolhead:E_ENABLE
heater_pin = toolhead:E_HEATER
sensor_pin = toolhead:E_TEMPERATURE
control = pid
pid_kp = 34.626
pid_ki = 4.050
pid_kd = 74.014

[gcode_macro M109]
rename_existing = M109.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={S}
	{% else %}
	M109.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[heater_bed]
heater_pin = BED_HEATER
sensor_type = NTC 100K MGB18-104F39050L32
sensor_pin = BED_TEMPERATURE
max_power = 1
min_temp = 0
max_temp = 120
control = pid
pid_kp = 40.783
pid_ki = 1.007
pid_kd = 412.931

[gcode_macro M190]
rename_existing = M190.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={S}
	{% else %}
	M190.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[gcode_macro ACTIVATE_PROBE]
description = Put the machine in a state being able to probe
variable_temperature = 0
gcode = 
	{% set LOCK = params.LOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_max_probing_temp = printer["gcode_macro _USER_VARIABLES"].tap_max_probing_temp|float %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if LOCK %}
	_ATTACH_PROBE_LOCK
	{% else %}
	_ATTACH_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	SAVE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	
	{% set ACTUAL_TEMP = printer.extruder.temperature %}
	{% set TARGET_TEMP = printer.extruder.target %}
	
	SET_GCODE_VARIABLE MACRO=ACTIVATE_PROBE VARIABLE=temperature VALUE={TARGET_TEMP}
	
	{% if TARGET_TEMP > tap_max_probing_temp %}
	{ action_respond_info('Extruder temperature target of %.1fC is too high for TAP probing, lowering to %.1fC' % (TARGET_TEMP, tap_max_probing_temp)) }
	M106 S255
	M109 S{tap_max_probing_temp}
	M106 S0
	{% else %}
	
	{% if ACTUAL_TEMP > tap_max_probing_temp + 3 %}
	M106 S255
	TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={tap_max_probing_temp}
	M106 S0
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro DEACTIVATE_PROBE]
description = Revert the machine to a normal state after probing
gcode = 
	{% set UNLOCK = params.UNLOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_deactivation_zhop = printer["gcode_macro _USER_VARIABLES"].tap_deactivation_zhop %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if UNLOCK %}
	_DOCK_PROBE_UNLOCK
	{% else %}
	_DOCK_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	
	{% set z_safe = printer.toolhead.position.z + tap_deactivation_zhop %}
	{% if z_safe > printer.toolhead.axis_maximum.z %}
	{% set z_safe = printer.toolhead.axis_maximum.z %}
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	
	{% set old_target_temperature = printer["gcode_macro ACTIVATE_PROBE"].temperature %}
	M109 S{old_target_temperature}
	
	RESTORE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	{% endif %}

[probe]
pin = ^toolhead:MCU_ENDSTOP1
x_offset = 0
y_offset = 0
z_offset = -0.45
speed = 3
lift_speed = 10
samples = 3
samples_result = median
sample_retract_dist = 1.0
samples_tolerance = 0.007
samples_tolerance_retries = 3

[heater_fan hotend_fan]
pin = toolhead:E_FAN
max_power = 1.0
kick_start_time = 0.100
heater = extruder
heater_temp = 50.0

[fan]
pin = toolhead:PART_FAN
kick_start_time = 0.100
cycle_time = 0.010

[gcode_macro _SERVO_DEPLOY]
gcode = 
	{% set item = params.ITEM|string|lower %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_servo_enabled = printer["gcode_macro _USER_VARIABLES"].probe_servo_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% if item == "probe" %}
	{% if verbose %}
	RESPOND MSG="Deploying probe dock using the servo"
	{% endif %}
	
	{% if not probe_servo_enabled %}
	{ action_raise_error("No servo available for probe. Please include one in your config!") }
	{% endif %}
	
	{% set probe_servo_name = printer["gcode_macro _USER_VARIABLES"].probe_servo_name %}
	{% set probe_servo_angle_deployed = printer["gcode_macro _USER_VARIABLES"].probe_servo_angle_deployed %}
	SET_SERVO SERVO={probe_servo_name} ANGLE={probe_servo_angle_deployed}
	G4 P500
	
	{% elif item == "purge" or item == "clean" %}
	{% if verbose %}
	RESPOND MSG="Deploying purge bucket and brush using the servo"
	{% endif %}
	
	{% if not purgeclean_servo_enabled %}
	{ action_raise_error("No servo available for purge or clean. Please include one in your config!") }
	{% endif %}
	
	{% set purgeclean_servo_name = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_name %}
	{% set purgeclean_servo_angle_deployed = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_angle_deployed %}
	SET_SERVO SERVO={purgeclean_servo_name} ANGLE={purgeclean_servo_angle_deployed}
	G4 P500
	
	{% else %}
	{ action_raise_error("Servo ITEM must be specified!") }
	{% endif %}

[gcode_macro _SERVO_RETRACT]
gcode = 
	{% set item = params.ITEM|string|lower %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_servo_enabled = printer["gcode_macro _USER_VARIABLES"].probe_servo_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% if item == "probe" %}
	{% if verbose %}
	RESPOND MSG="Rettracting probe dock using the servo"
	{% endif %}
	
	{% if not probe_servo_enabled %}
	{ action_raise_error("No servo available for probe. Please include one in your config!") }
	{% endif %}
	
	{% set probe_servo_name = printer["gcode_macro _USER_VARIABLES"].probe_servo_name %}
	{% set probe_servo_angle_retracted = printer["gcode_macro _USER_VARIABLES"].probe_servo_angle_retracted %}
	SET_SERVO SERVO={probe_servo_name} ANGLE={probe_servo_angle_retracted}
	G4 P500
	
	{% elif item == "purge" or item == "clean" %}
	{% if verbose %}
	RESPOND MSG="Rettracting purge bucket and brush using the servo"
	{% endif %}
	
	{% if not purgeclean_servo_enabled %}
	{ action_raise_error("No servo available for purge or clean. Please include one in your config!") }
	{% endif %}
	
	{% set purgeclean_servo_name = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_name %}
	{% set purgeclean_servo_angle_retracted = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_angle_retracted %}
	SET_SERVO SERVO={purgeclean_servo_name} ANGLE={purgeclean_servo_angle_retracted}
	G4 P500
	
	{% else %}
	{ action_raise_error("Servo ITEM must be specified!") }
	{% endif %}

[servo purgeservo]
pin = SERVO_PIN
maximum_servo_angle = 90
minimum_pulse_width = 0.0011
maximum_pulse_width = 0.0021

[gcode_macro _SET_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = params.LED|string %}
	{% set idx = (params.IDX|string).split(',') %}
	{% set transmit_last = params.TRANSMIT|default(1) %}
	
	{% for led_index in idx %}
	{% set transmit=transmit_last if loop.last else 0 %}
	SET_LED LED={led} RED={red} GREEN={green} BLUE={blue} WHITE={white} INDEX={led_index} TRANSMIT={transmit}
	{% endfor %}

[gcode_macro _SET_LEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_idx"] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_ALLLEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	SET_LED LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w}  TRANSMIT={transmit}

[gcode_macro _SET_LOGO_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_NOZZLE_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro SET_LOGO_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="logo" COLOR="off" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_ON]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="on" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="off" TRANSMIT={transmit}

[gcode_macro STATUS_LEDS]
gcode = 
	{% set color = params.COLOR|default('off')|lower %}
	
	{% set status_color = {
	'ready': {
	'logo': 'standby',
	'nozzle': 'standby',
	'caselight': 'standby',
	'minidisplay': 'on'
	},
	'busy': {
	'logo': 'busy',
	'nozzle': 'on',
	'caselight': 'busy',
	'minidisplay': 'on'
	},
	'heating': {
	'logo': 'heating',
	'nozzle': 'heating',
	'caselight': 'heating',
	'minidisplay': 'on'
	},
	'leveling': {
	'logo': 'leveling',
	'nozzle': 'on',
	'caselight': 'leveling',
	'minidisplay': 'on'
	},
	'homing': {
	'logo': 'homing',
	'nozzle': 'on',
	'caselight': 'homing',
	'minidisplay': 'on'
	},
	'cleaning': {
	'logo': 'cleaning',
	'nozzle': 'on',
	'caselight': 'cleaning',
	'minidisplay': 'on'
	},
	'meshing': {
	'logo': 'meshing',
	'nozzle': 'on',
	'caselight': 'meshing',
	'minidisplay': 'on'
	},
	'calibrating_z': {
	'logo': 'calibrating_z',
	'nozzle': 'on',
	'caselight': 'calibrating_z',
	'minidisplay': 'on'
	},
	'printing': {
	'logo': 'printing',
	'nozzle': 'on',
	'caselight': 'printing',
	'minidisplay': 'on'
	},
	'off': {
	'logo': 'off',
	'nozzle': 'off',
	'caselight': 'off',
	'minidisplay': 'off'
	},
	'on': {
	'logo': 'on',
	'nozzle': 'on',
	'caselight': 'on',
	'minidisplay': 'on'
	},
	'error': {
	'logo': 'error',
	'nozzle': 'error',
	'caselight': 'error',
	'minidisplay': 'error'
	}
	} %}
	
	{% if not (color in status_color) %}
	{ action_raise_error("COLOR is not valid!") }
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	_SET_LEDS_BY_NAME LEDS="logo" COLOR={status_color[color].logo} TRANSMIT=0
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR={status_color[color].nozzle} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_caselight_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="caselight" COLOR={status_color[color].caselight} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_minidisplay_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="minidisplay" COLOR={status_color[color].minidisplay} TRANSMIT=1
	{% endif %}

[display]
lcd_type = uc1701
cs_pin = EXP1_3
a0_pin = EXP1_4
rst_pin = EXP1_5
encoder_pins = ^EXP2_5, ^EXP2_3
click_pin = ^!EXP1_2
contrast = 63
spi_software_miso_pin = EXP2_1
spi_software_mosi_pin = EXP2_6
spi_software_sclk_pin = EXP2_2

[output_pin beeper]
pin = EXP1_1

[neopixel btt_mini12864]
pin = EXP1_6
chain_count = 3
initial_red = 0.1
initial_green = 0.5
initial_blue = 0.0
color_order = RGB

[delayed_gcode setdisplayneopixel]
initial_duration = 1
gcode = 
	SET_LED LED=btt_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3

[temperature_sensor RaspberryPi]
sensor_type = temperature_host

[temperature_sensor mcu]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 90

[temperature_sensor toolhead_mcu]
sensor_type = temperature_mcu
sensor_mcu = toolhead
min_temp = 0
max_temp = 100

[adxl345]
cs_pin = toolhead:ADXL_CS
spi_software_sclk_pin = toolhead:ADXL_SCLK
spi_software_mosi_pin = toolhead:ADXL_MOSI
spi_software_miso_pin = toolhead:ADXL_MISO
axes_map = x,y,z

[resonance_tester]
accel_chip = adxl345
probe_points = 
	-1,-1,-1

[gcode_macro TEST_RESONANCES]
rename_existing = BASE_TEST_RESONANCES
description = Runs input shaper test at the center of the bed
gcode = 
	{% set Tx, Ty = printer["gcode_macro _USER_VARIABLES"].resonnance_test_point_xy|map('float') %}
	{% set Tz = printer["gcode_macro _USER_VARIABLES"].resonnance_test_z_clearance|float %}
	
	{% if Tx == -1 and Ty == -1 %}
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	BASE_TEST_RESONANCES POINT={max_x / 2},{max_y / 2},{Tz} {rawparams}
	{% else %}
	BASE_TEST_RESONANCES POINT={Tx},{Ty},{Tz} {rawparams}
	{% endif %}

[gcode_macro AXES_SHAPER_CALIBRATION]
description = Run standard input shaper test for all axes
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.3)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=X FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=Y FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=SHAPER

[gcode_macro BELTS_SHAPER_CALIBRATION]
description = Run custom demi-axe test to analyze belts on CoreXY printers
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.33)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=1,1 OUTPUT=raw_data NAME=b FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=a FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=BELTS

[gcode_macro EXCITATE_AXIS_AT_FREQ]
description = Maintain a specified input shaper excitating frequency for some time to diagnose vibrations
gcode = 
	{% set FREQUENCY = params.FREQUENCY|default(25)|int %}
	{% set TIME = params.TIME|default(10)|int %}
	{% set AXIS = params.AXIS|default("x")|string|lower %}
	
	TEST_RESONANCES OUTPUT=raw_data AXIS={AXIS} FREQ_START={FREQUENCY-1} FREQ_END={FREQUENCY+1} HZ_PER_SEC={1/(TIME/3)}
	M400

[gcode_macro VIBRATIONS_CALIBRATION]
gcode = 
	
	
	
	{% set size = params.SIZE|default(60)|int %}
	{% set direction = params.DIRECTION|default('XY') %}
	{% set z_height = params.Z_HEIGHT|default(20)|int %}
	{% set verbose = params.VERBOSE|default(true) %}
	
	{% set min_speed = params.MIN_SPEED|default(20)|int * 60 %}
	{% set max_speed = params.MAX_SPEED|default(200)|int * 60 %}
	{% set speed_increment = params.SPEED_INCREMENT|default(2)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	
	{% set accel_chip = params.ACCEL_CHIP|default("adxl345") %}
	
	
	
	
	{% set mid_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set mid_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% set direction_factor = {
	'XY'  : {
	'start' : {'x': -0.5, 'y': -0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': -0.5, 'y': -0.5, 'z': 0.0 }
	}
	},
	'AB' : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': 0.0, 'y': 0.0, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	},
	'ABXY' : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'B'  : {
	'start' : {'x': 0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'A'  : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'X'  : {
	'start' : {'x': -0.5, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': 0.0, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.0, 'z': 0.0 }
	}
	},
	'Y'  : {
	'start' : {'x': 0.0, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.0, 'y': 0.5, 'z': 0.0 }
	}
	},
	'Z'  : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': 0.0, 'z': 1.0 },
	'1' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	}
	}
	%}
	
	
	
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	{% if (size / (max_speed / 60)) < 0.25 %}
	{ action_raise_error("SIZE is too small for this MAX_SPEED. Increase SIZE or decrease MAX_SPEED!") }
	{% endif %}
	
	{% if not (direction in direction_factor) %}
	{ action_raise_error("DIRECTION is not valid. Only XY, AB, ABXY, A, B, X, Y or Z is allowed!") }
	{% endif %}
	
	{action_respond_info("")}
	{action_respond_info("Starting speed and vibration calibration")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION
	
	G90
	
	
	G1 Z{z_height}
	G1 X{mid_x + (size * direction_factor[direction].start.x) } Y{mid_y + (size * direction_factor[direction].start.y)} F{feedrate_travel}
	
	
	{% for curr_speed in range(min_speed, max_speed + speed_increment) %}
	{% if (curr_speed - min_speed) % speed_increment == 0 %}
	{% if verbose %}
	RESPOND MSG="Current speed: {(curr_speed / 60)|int} mm/s"
	{% endif %}
	
	ACCELEROMETER_MEASURE CHIP={accel_chip}
	{% for key, factor in direction_factor[direction].move_factors|dictsort %}
	G1 X{mid_x + (size * factor.x) } Y{mid_y + (size * factor.y)} Z{z_height + (size * factor.z)} F{curr_speed}
	{% endfor %}
	ACCELEROMETER_MEASURE CHIP={accel_chip} NAME=sp{(curr_speed / 60)|int}n1
	
	G4 P300
	M400
	{% endif %}
	{% endfor %}
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS="VIBRATIONS {direction}"
	
	RESTORE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = _BASE_BED_MESH_CALIBRATE
description = Perform Mesh Bed Leveling with klicky automount
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if verbose %}
	{ action_respond_info("Bed Mesh Calibrate") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	_BASE_BED_MESH_CALIBRATE  {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	DEACTIVATE_PROBE

[gcode_macro _ADAPTIVE_MESH_VARIABLES]
variable_ready = False
variable_do_mesh = False
variable_do_nominal = False
variable_mesh_min = 0,0
variable_mesh_max = 0,0
variable_mesh_center = 0,0
variable_probe_count = 0,0
variable_rri = 0
variable_algo = "bicubic"
gcode = 

[gcode_macro COMPUTE_MESH_PARAMETERS]
description = Compute the mesh parameters and store them for later use
gcode = 
	
	{% set xMinConf, yMinConf = printer["configfile"].config["bed_mesh"]["mesh_min"].split(',')|map('trim')|map('int') %}
	{% set xMaxConf, yMaxConf = printer["configfile"].config["bed_mesh"]["mesh_max"].split(',')|map('trim')|map('int') %}
	{% set xProbeCntConf, yProbeCntConf = printer["configfile"].config["bed_mesh"]["probe_count"].split(',')|map('trim')|map('int') %}
	{% set algo = printer["configfile"].config["bed_mesh"]["algorithm"]|lower %}
	{% set xMeshPPS, yMeshPPS = (printer["configfile"].config["bed_mesh"]["mesh_pps"]|default('2,2')).split(',')|map('trim')|map('int') %}
	
	{% set margin = params.MARGIN|default(5)|int %}
	{% set force_mesh = params.FORCE_MESH|default(False) %}
	
	
	
	
	{% if params.SIZE is defined and params.SIZE != "0_0_0_0" %}
	RESPOND MSG="Got a SIZE parameter for the adaptive bed mesh"
	{% set xMinSpec, yMinSpec, xMaxSpec, yMaxSpec = params.SIZE.split('_')|map('trim')|map('int') %}
	
	{% elif printer.exclude_object.objects %}
	
	
	RESPOND MSG="No SIZE parameter, using the [exclude_object] tags for the adaptive bed mesh"
	{% set eo_points = printer.exclude_object.objects|map(attribute='polygon')|sum(start=[]) %}
	{% set xMinSpec = eo_points|map(attribute=0)|min %}
	{% set yMinSpec = eo_points|map(attribute=1)|min %}
	{% set xMaxSpec = eo_points|map(attribute=0)|max %}
	{% set yMaxSpec = eo_points|map(attribute=1)|max %}
	
	{% else %}
	
	
	RESPOND MSG="No info about the first layer coordinates, doing a nominal bed mesh instead of adaptive"
	{% endif %}
	
	
	
	
	{% if xMinSpec and yMinSpec and xMaxSpec and yMaxSpec %}
	
	
	
	
	{% set xMin = [xMinConf, (xMinSpec - margin)]|max %}
	{% set xMax = [xMaxConf, (xMaxSpec + margin)]|min %}
	{% set yMin = [yMinConf, (yMinSpec - margin)]|max %}
	{% set yMax = [yMaxConf, (yMaxSpec + margin)]|min %}
	
	
	
	
	{% set xProbeCnt = ((xMax - xMin) * xProbeCntConf / (xMaxConf - xMinConf))|round(0, 'ceil')|int %}
	{% set yProbeCnt = ((yMax - yMin) * yProbeCntConf / (yMaxConf - yMinConf))|round(0, 'ceil')|int %}
	
	
	
	
	
	
	
	
	{% if xProbeCnt < 3 and yProbeCnt < 3 %}
	{% if force_mesh %}
	RESPOND MSG="Bed mesh forced (small part detected): meshing 3x3..."
	{% set xProbeCnt = 3 %}
	{% set yProbeCnt = 3 %}
	{% set rRefIndex = 4 %}
	{% set algo = "lagrange" %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% else %}
	RESPOND MSG="Computed mesh parameters: none, bed mesh not needed for very small parts"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={False}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	{% else %}
	{% set xProbeCnt = [3, xProbeCnt]|max %}
	{% set yProbeCnt = [3, yProbeCnt]|max %}
	
	
	
	{% if xProbeCnt % 2 == 0 %}
	{% set xProbeCnt = xProbeCnt + 1 %}
	{% endif %}
	{% if yProbeCnt % 2 == 0 %}
	{% set yProbeCnt = yProbeCnt + 1 %}
	{% endif %}
	
	
	{% if xMeshPPS != 0 or yMeshPPS != 0 %}
	{% set probeCntMin = [xProbeCnt, yProbeCnt]|min %}
	{% set probeCntMax = [xProbeCnt, yProbeCnt]|max %}
	{% if algo == "lagrange" and probeCntMax > 6 %}
	
	{% set algo = "bicubic" %}
	{% endif %}
	{% if algo == "bicubic" and probeCntMin < 4 %}
	{% if probeCntMax > 6 %}
	
	{% if xProbeCnt > yProbeCnt %}
	{% set yProbeCnt = 5 %}
	{% else %}
	{% set xProbeCnt = 5 %}
	{% endif %}
	{% else %}
	
	{% set algo = "lagrange" %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	{% set rRefIndex = (((xProbeCnt * yProbeCnt) - 1) / 2)|int %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	
	
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% endif %}
	{% else %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={True}
	
	{% set xCenter = xMinConf + ((xMaxConf - xMinConf) / 2) %}
	{% set yCenter = yMinConf + ((yMaxConf - yMinConf) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={True}

[gcode_macro ADAPTIVE_BED_MESH]
description = Perform a bed mesh, but only where and when it's needed
gcode = 
	{% set ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	
	{% if ready %}
	_DO_ADAPTIVE_MESH
	
	
	
	{% else %}
	RESPOND MSG="Adaptive bed mesh: parameters not already computed, automatically calling the COMPUTE_MESH_PARAMETERS macro prior to the mesh"
	COMPUTE_MESH_PARAMETERS {rawparams}
	M400
	_DO_ADAPTIVE_MESH
	{% endif %}

[gcode_macro _DO_ADAPTIVE_MESH]
gcode = 
	
	{% set do_mesh = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_mesh %}
	{% set do_nominal = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_nominal %}
	{% set mesh_min = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_min %}
	{% set mesh_max = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_max %}
	{% set probe_count = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].probe_count %}
	{% set rRefIndex = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].rri %}
	{% set algo = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].algo %}
	
	
	
	
	{% if do_mesh %}
	
	{% if do_nominal %}
	RESPOND MSG="Adaptive bed mesh: nominal bed mesh"
	BED_MESH_CALIBRATE
	{% else %}
	{% if printer["configfile"].config["bed_mesh"]["relative_reference_index"] is defined %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}
	{% endif %}
	{% endif %}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: no mesh to be done"
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={False}

[bed_mesh]
speed = 350
horizontal_move_z = 12
mesh_min = 25, 25
mesh_max = 325, 325
probe_count = 9, 9
fade_start = 0.6
fade_end = 10.0
algorithm = bicubic
relative_reference_index = 40

[tmc2209 stepper_x]
diag_pin = ^X_STOP
driver_sgthrs = 50
uart_pin = X_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_y]
diag_pin = ^Y_STOP
driver_sgthrs = 60
uart_pin = Y_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[input_shaper]
shaper_freq_x = 56.4
shaper_type_x = zv
shaper_freq_y = 38.4
shaper_type_y = mzv

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing = _BASE_QUAD_GANTRY_LEVEL
description = Conform a moving, twistable gantry to the shape of a stationary bed with klicky automount
gcode = 
	{% set tilting_travel_accel = printer["gcode_macro _USER_VARIABLES"].tilting_travel_accel %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if verbose %}
	{ action_respond_info("Quad gantry leveling") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{tilting_travel_accel}
	
	_BASE_QUAD_GANTRY_LEVEL {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	DEACTIVATE_PROBE

[gcode_macro _TILT_CALIBRATE]
description = Do a QGL, Z_tilt, etc... depending of the machine configuration
gcode = 
	{% set FORCE_OPERATION = params.FORCE|default(true) %}
	{% set conf_QGL = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set conf_ztilt = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="LEVELING"
	{% endif %}
	
	{% if conf_QGL %}
	{% if printer.quad_gantry_level.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="QGL..."
	{% endif %}
	QUAD_GANTRY_LEVEL
	{% endif %}
	{% elif conf_ztilt %}
	{% if printer.z_tilt.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="Z tilt adjust..."
	{% endif %}
	Z_TILT_ADJUST
	{% endif %}
	{% else %}
	{% if verbose %}
	RESPOND MSG="No tilt calibration needed on this machine. Continuing..."
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[quad_gantry_level]
gantry_corners = 
	-60,-10
	410,420
points = 
	50,25
	50,275
	300,275
	300,25
speed = 350
horizontal_move_z = 12
retries = 5
retry_tolerance = 0.0075
max_adjust = 10

[virtual_sdcard]
path = ~/printer_data/gcodes
on_error_gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	STATUS_LEDS COLOR="ERROR"
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	_PROBE_ON_ERROR_ACTION
	{% endif %}

[exclude_object]

[idle_timeout]
timeout = 1800

[pause_resume]

[display_status]

[respond]

[force_move]
enable_force_move = True

[gcode_arcs]
resolution = 0.1

[gcode_macro CANCEL_PRINT]
rename_existing = BASE_CANCEL_PRINT
description = Cancel the print, retract 10mm of filament and park
gcode = 
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload_on_cancel_print = printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_cancel_print %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload_on_cancel_print %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	SDCARD_RESET_FILE
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_OFF
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}
	
	BASE_CANCEL_PRINT

[gcode_macro END_PRINT]
description = Stop the print and filter the atmosphere for 10min before shuting down
gcode = 
	{% set disable_motors_in_end_print = printer["gcode_macro _USER_VARIABLES"].disable_motors_in_end_print %}
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set light_intensity_end_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_end_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload = params.ERCF_UNLOAD_AT_END|default(printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_end_print)|int %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G92 E0
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if disable_motors_in_end_print %}
	M84
	{% endif %}
	
	
	
	
	{% if filter_enabled %}
	{% set FILTER_TIME = params.FILTER_TIME|default(600)|int %}
	START_FILTER SPEED=1
	UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED DURATION={FILTER_TIME}
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_end_print}
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}

[gcode_macro PARK]
description = Park the toolhead at the back and retract some filament if the nozzle is hot
gcode = 
	{% set E = params.E|default(1.7)|float %}
	
	{% set Px, Py = printer["gcode_macro _USER_VARIABLES"].park_position_xy|map('float') %}
	{% set park_lift_z = printer["gcode_macro _USER_VARIABLES"].park_lift_z %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	
	{% set z_safe = act_z + park_lift_z %}
	{% if z_safe > max_z %}
	{% set z_safe = max_z %}
	{% endif %}
	
	
	{% if printer.extruder.temperature > 185 and firmware_retraction_enabled %}
	G10
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	G0 X{Px} Y{Py} F{St}

[gcode_macro PAUSE]
rename_existing = BASE_PAUSE
description = Pause the print and park
gcode = 
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	
	{% if printer.pause_resume.is_paused %}
	RESPOND MSG="Print is already paused"
	{% else %}
	SAVE_GCODE_STATE NAME=PAUSE_state
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	BASE_PAUSE
	PARK
	{% endif %}

[gcode_macro RESUME]
rename_existing = BASE_RESUME
description = Resume the print after an optional unretract
gcode = 
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	
	{% if not printer.pause_resume.is_paused %}
	RESPOND MSG="Print is not paused. Resume ignored"
	{% else %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={St}
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	BASE_RESUME
	{% endif %}

[gcode_macro START_PRINT]
description = Machine heatup procedure before starting a print
variable_bed_temp = 0
variable_extruder_temp = 0
variable_z_adjust = 0
variable_soak = 0
variable_chamber_temp = 0
variable_chamber_maxtime = 0
variable_initial_tool = 0
variable_material = "XXX"
variable_fl_size = "0_0_0_0"
gcode = 
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_ADJUST = params.Z_ADJUST|default(0)|float %}
	{% set SOAK = params.SOAK|default(printer["gcode_macro _USER_VARIABLES"].print_default_soak)|int %}
	{% set CHAMBER_TEMP = params.CHAMBER|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_temp)|int %}
	{% set CHAMBER_MAXTIME = params.CHAMBER_MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	{% set INITIAL_TOOL = params.INITIAL_TOOL|default(0)|int %}
	{% set MATERIAL = params.MATERIAL|default(printer["gcode_macro _USER_VARIABLES"].print_default_material)|string %}
	{% set FL_SIZE = params.SIZE|default("0_0_0_0")|string %}
	
	
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=bed_temp VALUE={BED_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=extruder_temp VALUE={EXTRUDER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=soak VALUE={SOAK}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_temp VALUE={CHAMBER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_maxtime VALUE={CHAMBER_MAXTIME}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=initial_tool VALUE={INITIAL_TOOL}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=material VALUE='"{MATERIAL}"'
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=fl_size VALUE='"{FL_SIZE}"'
	
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_reset_stats_on_start_print = printer["gcode_macro _USER_VARIABLES"].ercf_reset_stats_on_start_print %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% if MATERIAL not in printer["gcode_macro _USER_VARIABLES"].material_parameters %}
	RESPOND MSG="Material '{MATERIAL}' is unknown!"
	{ action_raise_error("Add this new material to your material_parameters variable!") }
	{% else %}
	RESPOND MSG="Material '{MATERIAL}' is used"
	{% set material = printer["gcode_macro _USER_VARIABLES"].material_parameters[MATERIAL] %}
	{% endif %}
	
	
	
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="BUSY"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if ercf_reset_stats_on_start_print %}
	ERCF_RESET_STATS
	{% endif %}
	{% endif %}
	{% endif %}
	
	SET_GCODE_OFFSET Z=0
	M221 S100
	M220 S100
	G90
	M83
	
	
	{% if firmware_retraction_enabled %}
	SET_RETRACTION RETRACT_LENGTH={material.retract_length} RETRACT_SPEED={material.retract_speed} UNRETRACT_EXTRA_LENGTH={material.unretract_extra_length} UNRETRACT_SPEED={material.unretract_speed}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={material.pressure_advance}
	
	
	{% if force_homing_in_start_print %}
	G28
	{% else %}
	_CG28
	{% endif %}
	
	
	
	{% set sp_actions = printer["gcode_macro _USER_VARIABLES"].startprint_actions %}
	{% for action in sp_actions %}
	{% if action == "bed_soak" %}
	_MODULE_HEATSOAK_BED
	{% elif action == "chamber_soak" %}
	_MODULE_HEATSOAK_CHAMBER
	{% elif action == "tilt_calib" %}
	_MODULE_TILTING
	{% elif action == "extruder_heating" %}
	_MODULE_EXTRUDER_HEATING
	{% elif action == "purge" %}
	_MODULE_PURGE
	{% elif action == "clean" %}
	_MODULE_CLEAN
	{% elif action == "z_offset" %}
	_MODULE_Z_CALIB
	{% elif action == "bedmesh" %}
	_MODULE_BED_MESH
	{% elif action == "primeline" %}
	_MODULE_PRIMELINE
	{% elif action == "extruder_preheating" %}
	_MODULE_EXTRUDER_PREHEATING
	{% elif action == "custom1" %}
	_MODULE_CUSTOM1
	{% elif action == "custom2" %}
	_MODULE_CUSTOM2
	{% elif action == "custom3" %}
	_MODULE_CUSTOM3
	{% else %}
	{ action_raise_error("Unknown module called in START_PRINT! Please verify your startprint_actions variable override!") }
	{% endif %}
	{% endfor %}
	
	
	
	SET_GCODE_OFFSET Z_ADJUST={Z_ADJUST} MOVE=1
	
	
	SET_GCODE_OFFSET Z_ADJUST={material.additional_z_offset} MOVE=1
	{% if filter_enabled %}
	START_FILTER SPEED={material.filter_speed / 100}
	{% endif %}
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="PRINTING"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Start printing !"
	{% endif %}
	
	G92 E0.0

[gcode_macro _MODULE_PRIMELINE]
gcode = 
	PRIMELINE

[gcode_macro _MODULE_HEATSOAK_BED]
gcode = 
	
	
	
	
	
	{% set BED_TEMP = printer["gcode_macro START_PRINT"].bed_temp %}
	{% set SOAK = printer["gcode_macro START_PRINT"].soak %}
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if printer.heater_bed.target < (BED_TEMP - 8) %}
	
	
	{% if (CHAMBER_TEMP > 0) and filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	{% if SOAK > 0 %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME={SOAK}
	{% else %}
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME=0
	{% endif %}

[gcode_macro _MODULE_HEATSOAK_CHAMBER]
gcode = 
	
	
	
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	{% set CHAMBER_MAXTIME = printer["gcode_macro START_PRINT"].chamber_maxtime %}
	
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if chamber_sensor_enabled %}
	{% if CHAMBER_TEMP > 0 %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	
	{% if CURRENT_TEMP <= CHAMBER_TEMP %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	
	
	{% if filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	HEATSOAK_CHAMBER TEMP={CHAMBER_TEMP} MAXTIME={CHAMBER_MAXTIME}
	
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_TILTING]
gcode = 
	
	
	
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	_TILT_CALIBRATE FORCE={force_homing_in_start_print}

[gcode_macro _MODULE_EXTRUDER_HEATING]
gcode = 
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	{% set INITIAL_TOOL = printer["gcode_macro START_PRINT"].initial_tool %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder heating to print temperature..."
	{% endif %}
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET
	{% if not purge_and_brush_enabled %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	M109 S{EXTRUDER_TEMP}
	
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	ERCF_CHANGE_TOOL STANDALONE=1 TOOL={INITIAL_TOOL}
	_ERCF_ERROR_CHECK
	{% endif %}
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder temperature OK"
	{% endif %}

[gcode_macro _MODULE_PURGE]
gcode = 
	
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	
	{% if purge_and_brush_enabled %}
	PURGE TEMP={EXTRUDER_TEMP}
	{% endif %}

[gcode_macro _MODULE_CLEAN]
gcode = 
	
	
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set force_homing_before_brush = printer["gcode_macro _USER_VARIABLES"].force_homing_before_brush %}
	
	{% if purge_and_brush_enabled %}
	{% if force_homing_before_brush %}
	G28 Z
	{% endif %}
	CLEAN_NOZZLE
	{% endif %}

[gcode_macro _MODULE_Z_CALIB]
gcode = 
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% if bed_mesh_enabled and printer.bed_mesh.profile_name == "" %}
	COMPUTE_MESH_PARAMETERS SIZE={FL_SIZE}
	{% endif %}
	
	{% if zcalib_plugin_enabled %}
	G28 Z
	CALIBRATE_Z
	{% else %}
	G28 Z
	{% endif %}

[gcode_macro _MODULE_BED_MESH]
gcode = 
	
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if bed_mesh_enabled %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="MESHING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Bed mesh measurement..."
	{% endif %}
	
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	ADAPTIVE_BED_MESH
	{% else %}
	ADAPTIVE_BED_MESH SIZE={FL_SIZE}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_EXTRUDER_PREHEATING]
gcode = 
	
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Pre-heating the nozzle to a safe temperature..."
	{% endif %}
	
	M109 S{safe_extruder_temp}
	
	{% if verbose %}
	RESPOND MSG="Extruder at safe temperature of {safe_extruder_temp} degrees"
	{% endif %}

[gcode_macro _MODULE_CUSTOM1]
gcode = 

[gcode_macro _MODULE_CUSTOM2]
gcode = 

[gcode_macro _MODULE_CUSTOM3]
gcode = 

[gcode_macro _CG28]
description = Homing only if necessary
gcode = 
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	{% if "xyz" not in printer.toolhead.homed_axes %}
	G28
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[homing_override]
axes = xyz
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set homing_zhop = printer["gcode_macro _USER_VARIABLES"].homing_zhop|float %}
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed * 60 %}
	{% set homing_travel_accel = printer["gcode_macro _USER_VARIABLES"].homing_travel_accel %}
	{% set sensorless_homing_enabled = printer["gcode_macro _USER_VARIABLES"].sensorless_homing_enabled %}
	{% set sensorless_current_factor = printer["gcode_macro _USER_VARIABLES"].sensorless_current_factor / 100 %}
	{% set z_drop_speed = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% set homing_first = printer["gcode_macro _USER_VARIABLES"].homing_first|string|upper %}
	{% set x_homing_backoff, y_homing_backoff = printer["gcode_macro _USER_VARIABLES"].homing_backoff_distance_xy|map('float') %}
	
	{% set x_position_endstop = printer["configfile"].config["stepper_x"]["position_endstop"]|float %}
	{% set y_position_endstop = printer["configfile"].config["stepper_y"]["position_endstop"]|float %}
	{% set x_position_center = printer.toolhead.axis_maximum.x|int/2 - printer.toolhead.axis_minimum.x|int/2 %}
	{% set y_position_center = printer.toolhead.axis_maximum.y|int/2 - printer.toolhead.axis_minimum.y|int/2 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	{% set X, Y, Z = False, False, False %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	
	{% if not 'X' in params
	and not 'Y' in params
	and not 'Z' in params %}
	
	{% set X, Y, Z = True, True, True %}
	
	{% else %}
	{% if 'X' in params %}
	{% set X = True %}
	{% endif %}
	
	{% if 'Y' in params %}
	{% set Y = True %}
	{% endif %}
	
	{% if 'Z' in params %}
	{% set Z = True %}
	{% endif %}
	
	{% if 'X' in params
	and 'Y' in params
	and 'Z' in params %}
	
	
	_HOMING_VARIABLES reset=1
	{% endif %}
	
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_ENTRY_POINT FUNCTION=homing_override
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{homing_travel_accel}
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	G90
	
	{% if Z %}
	{% if ('z' in printer.toolhead.homed_axes) %}
	{% if (printer.toolhead.position.z < homing_zhop) %}
	{% if verbose %}
	{ action_respond_info("Z too low, performing ZHOP") }
	{% endif %}
	G0 Z{homing_zhop} F{z_drop_speed}
	{% endif %}
	{% elif ('xy' in printer.toolhead.homed_axes) %}
	{% if verbose %}
	{ action_respond_info("X and Y already homed, no ZHOP needed to home Z") }
	{% endif %}
	{% else %}
	{% if verbose %}
	{ action_respond_info("X and Y not homed, forcing full G28 to home Z properly") }
	{% endif %}
	SET_KINEMATIC_POSITION X=0 Y=0 Z=0
	G0 Z{homing_zhop} F{z_drop_speed}
	{% set X, Y, Z = True, True, True %}
	{% endif %}
	{% endif %}
	
	{% if homing_first == "X" %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% elif homing_first == "Y" %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% else %}
	{ action_respond_error("Axis homing order not valid. Choose either X or Y first in the variables.cfg file!") }
	{% endif %}
	
	
	
	{% if Z %}
	{% if verbose %}
	{ action_respond_info("Homing Z") }
	{% endif %}
	
	
	
	
	
	
	{% if printer["configfile"].config["stepper_z"]["endstop_pin"]|lower == "probe:z_virtual_endstop" %}
	
	{% if probe_type_enabled == "dockable_virtual" %}
	ACTIVATE_PROBE
	{% endif %}
	{% if bed_mesh_enabled %}
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	{% set mesh_center = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_center %}
	{% set x_mesh_center, y_mesh_center = mesh_center.split(',')|map('trim')|map('float') %}
	RESPOND MSG="Z homing: a mesh is computed and ready, probing mesh center: {mesh_center}"
	G0 X{x_mesh_center} Y{y_mesh_center} F{homing_travel_speed}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	
	
	{% else %}
	_GOTO_Z_PROBE
	{% endif %}
	
	
	{% if probe_type_enabled == "vorontap" %}
	ACTIVATE_PROBE
	{% endif %}
	
	G28 Z0
	
	G91
	G0 Z{homing_zhop} F{z_drop_speed}
	G90
	
	
	
	{% if probe_type_enabled == "vorontap" or probe_type_enabled == "dockable_virtual" %}
	DEACTIVATE_PROBE
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_EXIT_POINT FUNCTION=homing_override
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _GOTO_Z_PROBE]
description = Move to z probe avoiding the probe dock
gcode = 
	
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% if zcalib_plugin_enabled %}
	{% set z_endstop_x, z_endstop_y = printer["configfile"].config["z_calibration"]["nozzle_xy_position"].split(',')|map('trim')|map('float') %}
	{% else %}
	{% set z_endstop_x, z_endstop_y = printer["gcode_macro _USER_VARIABLES"].zendstop_position|map('float') %}
	{% endif %}
	
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed|float * 60 %}
	
	{% set probe_dock_location_x, probe_dock_location_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_location_xy|map('float') %}
	{% set probe_dock_margin_x, probe_dock_margin_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_margin_xy|map('float') %}
	
	{% set current_x = printer.toolhead.position.x|float %}
	{% set current_y = printer.toolhead.position.y|float %}
	
	SAVE_GCODE_STATE NAME=goto_ZProbe
	G90
	
	
	{% set avoid_dock = false %}
	{% if probe_dock_location_x < z_endstop_x|float %}
	
	
	{% if current_x < (probe_dock_location_x + probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% else %}
	
	
	{% if current_x > (probe_dock_location_x - probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% endif %}
	
	
	{% if avoid_dock == true  %}
	
	G0 Y{probe_dock_location_y - probe_dock_margin_y} F{homing_travel_speed}
	
	G0 X{z_endstop_x} F{homing_travel_speed}
	{% endif %}
	
	G0 X{z_endstop_x} Y{z_endstop_y} F{homing_travel_speed}
	
	RESTORE_GCODE_STATE NAME=goto_ZProbe

[gcode_macro CALIBRATE]
description = Calibrate the printer flow or pressure advance
gcode = 
	
	{% set TYPE = params.TYPE|default("")|string|lower %}
	
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set MATERIAL = params.MATERIAL|default("ABS")|string %}
	
	{% set center_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set center_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% if TYPE=="flow" %}
	
	{% set computed_size = (center_x - 20)|string + '_' + (center_y - 20)|string + '_' + (center_x + 20)|string + '_' + (center_y + 20)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	FLOW_MULTIPLIER_CALIBRATION EXTRUSION_WIDTH=0.471
	END_PRINT FILTER_TIME=0
	
	{% elif TYPE=="pressure_advance" %}
	
	{% set computed_size = (center_x - 60)|string + '_' + (center_y - 60)|string + '_' + (center_x + 60)|string + '_' + (center_y + 60)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	PRESSURE_ADVANCE_CALIBRATION
	END_PRINT FILTER_TIME=0
	
	{% else %}
	{action_respond_info("Please call this macro using TYPE= \"flow\" or \"pressure_advance\"")}
	{action_raise_error("not enough parameters to start a calibration!")}
	
	{% endif %}

[gcode_macro _FLOW_CALIB_VARIABLES]
variable_last_shell_thickness = 0.0
variable_last_evalue = 0.0
gcode = 

[gcode_macro FLOW_MULTIPLIER_CALIBRATION]
description = Print a small tower to calibrate the extrusion flow multiplier by measuring the shell
gcode = 
	
	
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	{% set do_retract = params.DO_RECTRACT|default(0)|int %}
	{% set print_size = params.PRINT_SIZE|default(40)|int %}
	{% set print_height = params.HEIGHT|default(15)|int %}
	{% set corner_radius = params.CORNER_RADIUS|default(8)|int %}
	{% set number_of_perimeters = params.PERIMETERS|default(2)|int %}
	{% set fan_speed = params.FAN_SPEED|default(20)|int %}
	
	{% set e_multiplier = params.EXTRUSION_MULTIPLIER|default(1.00)|float %}
	{% set filament_diameter = params.FILAMENT_DIAMETER|default(1.75)|float %}
	{% set extrusion_width = params.EXTRUSION_WIDTH|default(0.4)|float %}
	{% set layer_height = params.LAYER_HEIGHT|default(0.2)|float %}
	
	{% set retract_length = params.RETRACT_LENGTH|default(0.5)|float %}
	{% set initial_purge = params.PURGE_MM|default(1)|int %}
	{% set z_hop_height  = 2 * layer_height %}
	
	{% set feedrate_print = params.CONTROL_SPEED|default(100)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft = params.RAFT_SPEED|default(60)|int * 60 %}
	{% set feedrate_z = params.Z_LIFT_SPEED|default(20)|int * 60 %}
	{% set feedrate_retract = params.RETRACT_SPEED|default(50)|int * 60 %}
	
	
	
	
	{% set e_per_mm = ((extrusion_width - layer_height) * layer_height + 3.14159 * (layer_height / 2)**2) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set spacing = extrusion_width - layer_height * (1 - 3.14159 / 4) %}
	{% set shell_thickness = extrusion_width + (number_of_perimeters|float - 1) * spacing %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set x_start = max_x / 2 - print_size / 2 %}
	{% set y_start = max_y / 2 - print_size / 2 %}
	{% set x_end = x_start + print_size %}
	{% set y_end = y_start + print_size %}
	
	{% set num_raft_lines = ([print_size, max_x]|min / spacing)|round(0, 'floor')|int %}
	{% set raft_size = num_raft_lines * spacing %}
	
	
	
	
	{action_respond_info("")}
	{action_respond_info("Starting extrusion flow calibration print")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	{action_respond_info("Exrusion multiplier used: %.4f" % e_multiplier)}
	{action_respond_info("Number of perimeters to print: %d" % number_of_perimeters)}
	{action_respond_info("THEORIC SHELL THICKNESS: %.4f" % shell_thickness)}
	{action_respond_info("")}
	{action_respond_info("Measure the shell thickness using a caliper or micrometer. Then call the computation macro with the measured value:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION
	
	
	
	
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_shell_thickness VALUE={shell_thickness}
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_evalue VALUE={e_multiplier}
	
	
	
	
	G90
	M83
	G92 E0.0
	G0 X{x_start} Y{y_start - 5} Z{layer_height} F{feedrate_travel}
	
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{raft_size} E{raft_size * e_per_mm * 1.5} F{feedrate_raft / 2}
	G1 Y-{extrusion_width} E{extrusion_width * e_per_mm} F{feedrate_raft / 2}
	G1 X-{raft_size} E{raft_size * e_per_mm} F{feedrate_raft / 2}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G90
	G0 X{x_start} Y{y_start} F{feedrate_travel}
	G1 Z{layer_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	
	
	M221 S{e_multiplier * 100}
	
	
	
	
	{% if do_raft == 1 %}
	G91
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	G1 Y{loop.cycle(1.0, -1.0) * raft_size} E{raft_size * e_per_mm} F{feedrate_raft}
	
	
	{% if not loop.last %}
	G1 X{spacing} E{spacing * e_per_mm} F{feedrate_raft}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	
	
	
	
	G90
	M106 S{fan_speed * 255 / 100}
	
	
	{% for curr_layer in range(1, (print_height / layer_height)|round|int) %}
	G0 X{x_start + corner_radius} Y{y_start} F{feedrate_travel}
	G1 Z{(curr_layer * layer_height) + (layer_height if do_raft == 1 else 0)} F{feedrate_z}
	
	
	{% for perim_num in range(number_of_perimeters) %}
	
	{% set perim_offset = perim_num * spacing %}
	{% set perim_radius = corner_radius - (perim_num * spacing) %}
	
	
	G1 X{x_start + corner_radius} Y{y_start + perim_offset} F{feedrate_travel}
	{% if do_retract == 1 %}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	
	
	G1 X{x_end - corner_radius} Y{y_start + perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - perim_offset} Y{y_start + corner_radius} J{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_end - perim_offset} Y{y_end - corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - corner_radius} Y{y_end - perim_offset} I-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + corner_radius} Y{y_end - perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + perim_offset} Y{y_end - corner_radius} J-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + perim_offset} Y{y_start + corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + corner_radius} Y{y_start + perim_offset} I{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	
	{% if do_retract == 1 %}
	G1 E-{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	
	{% if do_retract == 1 %}
	G91
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G91
	G0 Z20 F{feedrate_travel}
	
	RESTORE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION

[gcode_macro COMPUTE_FLOW_MULTIPLIER]
description = Compute a new flow multiplier by using the measured shell thickness on the calibration print
gcode = 
	{% set evalue = params.OLD_EXTRUSION_MULTIPLIER|default(0.0)|float %}
	{% set theorical_thickness = params.THEORICAL_THICKNESS|default(0.0)|float %}
	{% set measured_thickness = params.MEASURED_THICKNESS|default(0.0)|float %}
	
	
	{% if evalue == 0.0 %}
	{% set last_evalue = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_evalue %}
	
	
	{% if last_evalue == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_evalue = last_evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	{% else %}
	{% set final_evalue = evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	
	
	{% if theorical_thickness == 0.0 %}
	{% set last_shell_thickness = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_shell_thickness %}
	
	
	{% if last_shell_thickness == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_theorical_thickness = last_shell_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	{% else %}
	{% set final_theorical_thickness = theorical_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	
	
	{% if measured_thickness == 0.0 %}
	{action_respond_info("You must use a caliper or micrometer to measure the calibration print shell thickness and call this macro with the measured value !!!")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set new_evalue = final_theorical_thickness * final_evalue / measured_thickness %}
	{action_respond_info("NEW COMPUTED FLOW VALUE: %.3f" % new_evalue)}
	{action_respond_info("Use this new value as extrusion multiplier in your slicer of choice")}
	{action_respond_info("")}
	{% endif %}

[gcode_macro PRESSURE_ADVANCE_CALIBRATION]
description = Calibrate the pressure advance by printing a grid pattern
gcode = 
	
	
	
	{% set pa_start     = params.START|default(0.02)|float %}
	{% set pa_increment = params.INCREMENT|default(0.005)|float %}
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	
	{% set print_size      = params.PRINT_SIZE|default(120)|int %}
	{% set num_bands       = params.BANDS_LIMIT|default(999)|int %}
	{% set lines_per_band  = params.LINES_PER_BAND|default(6)|int %}
	{% set e_multiplier    = params.EXTRUSION_MULTIPLIER|default(1.25 if do_raft == 1 else 1.5)|float %},
	{% set retract_length  = params.RETRACT_LENGTH|default(0.6)|float %}
	{% set initial_purge   = params.PURGE_MM|default(8)|int %}
	
	{% set feedrate_control = params.CONTROL_SPEED|default(30)|int * 60 %}
	{% set feedrate_outer   = params.OUTER_SPEED|default(40)|int * 60 %}
	{% set feedrate_inner   = params.INNER_SPEED|default(120)|int * 60 %}
	{% set feedrate_travel  = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft    = params.RAFT_SPEED|default(120)|int * 60 %}
	{% set feedrate_z       = 5 * 60 %}
	{% set feedrate_retract = 50 * 60 %}
	
	{% set spacing_line  = params.LINE_SPACING|default(0.4)|float %}
	{% set spacing_band  = 2 %}
	{% set spacing_raft  = 2 %}
	
	{% set fast_line_ratio_percent = 50 %}
	
	{% set lines_per_band    = [2, lines_per_band]|max %}
	{% set e_multiplier      = [1, e_multiplier]|max %}
	{% set num_lines_control = (lines_per_band / 2)|round(0, 'floor')|int %}
	{% set num_lines_test    = (lines_per_band / 2)|round(0, 'ceil')|int %}
	{% set spacing_line      = spacing_line * (1 + e_multiplier - 1.25) %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set nozzle_diameter = printer.configfile.config['extruder'].nozzle_diameter|float %}
	{% set line_width    = nozzle_diameter * 1.25 %}
	{% set line_height   = nozzle_diameter / 2 %}
	{% set z_hop_height  = 2 * line_height %}
	{% set e_per_mm      = (line_width * line_height) / (3.1415 * (1.75/2)**2) %}
	{% set spacing_purge = line_height * 0.8 %}
	
	{% set spacing_raft   = (spacing_raft / line_width)|round * line_width %}
	{% set num_raft_lines = ([print_size, max_x]|min / spacing_raft)|round(0, 'floor')|int %}
	{% set print_width    = num_raft_lines * spacing_raft %}
	
	{% set band_height      = lines_per_band * line_width + (lines_per_band - 1) * spacing_line + spacing_band %}
	{% set bands_per_height = (([print_size, max_y]|min  - spacing_purge - 2 * line_width + spacing_band) / band_height)|round(0, 'floor')|int %}
	{% set num_bands        = [num_bands, bands_per_height]|min %}
	{% set print_height     = num_bands * band_height - spacing_band + spacing_purge +  2 * line_width %}
	
	{% set slow_line_length = ((print_width * (1 - fast_line_ratio_percent / 100) / 2) / spacing_raft)|round * spacing_raft + spacing_raft / 2 %}
	{% set fast_line_length = print_width - slow_line_length * 2 %}
	{% set thick_raft_num1 = (slow_line_length / spacing_raft)|round|int %}
	{% set thick_raft_num2  = num_raft_lines - thick_raft_num1 + 1 %}
	
	{% set x_start = max_x / 2 - print_width  / 2 %}
	{% set y_start = max_y / 2 - print_height / 2 %}
	
	{action_respond_info("")}
	{action_respond_info("Starting Pressure Advance calibration print.")}
	{action_respond_info("")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button once the print starts exhibiting PA values that are obviously too high.")}
	{action_respond_info("")}
	{action_respond_info("PA of first band: %.4f" % pa_start)}
	{action_respond_info("PA of last band: %.4f" % (pa_start + ((num_bands - 1) * pa_increment)))}
	{action_respond_info("PA increment per band: %.4f" % pa_increment)}
	{action_respond_info("Number of bands: %d" % num_bands)}
	{action_respond_info("")}
	{action_respond_info("Inspect the printed model. "
	"Look at the top and bottom lines in each band, on the right side of the two vertical raft bars (where the print speeds change). "
	"Find the highest band from the bottom where the lines at its top still resemble the lines at its bottom, with no visible extrusion width irregularities. "
	"Your final Pressure Advance value would then be:"
	)}
	{action_respond_info("")}
	{action_respond_info("Assuming that first band_number is 0")}
	{action_respond_info("PA = %.4f + (%.4f * band_number)" % (pa_start, pa_increment))}
	{action_respond_info("")}
	{action_respond_info("Update your [extruder] config section and set \"pressure_advance\" to the value you calculated.")}
	{action_respond_info("")}
	
	
	
	
	
	
	
	
	
	SAVE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION
	{% set pa_saved = printer.configfile.settings['extruder'].pressure_advance %}
	SET_PRESSURE_ADVANCE ADVANCE={pa_start}
	
	
	
	
	M221 S100
	
	
	
	
	M117 Priming
	G90
	G0 X{x_start} Y{y_start} Z{line_height} F{feedrate_travel}
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{print_width}  E{print_width * e_per_mm} F{feedrate_raft / 2}
	G1 Y{line_width}   E{line_width * e_per_mm}  F{feedrate_raft / 2}
	G1 X-{print_width} E{print_width * e_per_mm} F{feedrate_raft / 2}
	
	
	
	
	{% if do_raft == 1 %}
	G0 F{feedrate_raft}
	
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	{% if curr_raft_line == thick_raft_num1 or curr_raft_line == thick_raft_num2 %}
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	G1 Y{loop.cycle(-1.0, 1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	{% endif %}
	
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	
	
	{% if not loop.last %}
	{% set horizontal_move = spacing_raft - (2 * line_width if curr_raft_line == thick_raft_num1 - 1 or curr_raft_line == thick_raft_num2 - 1 else 0) %}
	G1 X{horizontal_move} E{horizontal_move * e_per_mm}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	{% endif %}
	
	
	
	
	M117 Printing bands
	G90
	G0 X{x_start} Y{y_start + 2 * line_width + spacing_purge} F{feedrate_travel}
	G0 Z{line_height + (line_height if do_raft == 1 else 0)} F{feedrate_z}
	G91
	G1 E{retract_length} F{feedrate_retract}
	
	
	{% for curr_band_num in range(0, num_bands ) %}
	{% set outer_loop = loop %}
	
	{% set curr_pa_value = pa_start + curr_band_num * pa_increment %}
	SET_PRESSURE_ADVANCE ADVANCE={curr_pa_value}
	M117 Band {curr_band_num} PA {curr_pa_value|round(4)}
	
	
	{% for _ in range(num_lines_control) %}
	G1 X{print_width} E{print_width * e_per_mm * e_multiplier} F{feedrate_control}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G0 X-{print_width} Y{spacing_line + line_width} F{feedrate_travel}
	
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endfor %}
	
	
	{% for _ in range(num_lines_test) %}
	{% for data in [{'mm': slow_line_length, 'f': feedrate_outer}, {'mm': fast_line_length, 'f': feedrate_inner}, {'mm': slow_line_length, 'f': feedrate_outer}] %}
	G1 X{data.mm} E{data.mm * e_per_mm * e_multiplier} F{data.f}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	{% if not (outer_loop.last and loop.last) %}
	G0 X-{print_width} Y{(spacing_line if not loop.last else spacing_band) + line_width} F{feedrate_travel}
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z20 F{feedrate_z}
	G0 X-{print_width / 2} Y{[50, max_y - (y_start + print_height)]|min} F{feedrate_travel}
	
	M117
	SET_PRESSURE_ADVANCE ADVANCE={pa_saved}
	RESTORE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION

[gcode_macro CHANGE_FILAMENT]
description = Do a PAUSE, park the toolhead over the purge bucket and unload the filament
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	SAVE_GCODE_STATE NAME=CHANGE_FILAMENT_state
	PAUSE
	UNLOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=CHANGE_FILAMENT_state

[gcode_macro UNLOAD_FILAMENT]
description = Basic unload of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to unload filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to unload filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	
	_TIP_SHAPING
	M83
	G1 E-20 F3600
	G4 P3000
	G1 E{DISTANCE|float * -1} F3000
	
	RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament unloaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament unloaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro LOAD_FILAMENT]
description = Basic load of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to load filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to load filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=LOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	M83
	G92 E0
	G1 E{DISTANCE|float} F200
	G1 E50 F150
	
	G92 E0
	RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament loaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament loaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _TIP_SHAPING]
description = Filament tip shaping sequence
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=TIP_SHAPING_state
	_LOW_TEMP_CHECK T={TEMP}
	
	{% set old_pressure_advance = printer.extruder.pressure_advance|default(0) %}
	
	SET_PRESSURE_ADVANCE ADVANCE=0
	
	M82
	G92 E0
	G1 E2 F3600
	G1 E0 F3600
	G1 E3 F3600
	G1 E0 F3600
	G1 E4 F3600
	G1 E0 F3600
	
	
	SET_PRESSURE_ADVANCE ADVANCE={old_pressure_advance}
	RESTORE_GCODE_STATE NAME=TIP_SHAPING_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_CHAMBER]
description = Heatsoak chamber to a specific temperature with a timeout
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set MAXTIME = params.MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% for _ in range(1, MAXTIME) %}
	_WAIT_CHAMBER_TEMP TEMP={SETPOINT_TEMP}
	{% endfor %}
	{% if verbose %}
	RESPOND MSG="Chamber temperature OK !"
	{% endif %}
	{% endif %}

[gcode_macro _WAIT_CHAMBER_TEMP]
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	{% if CURRENT_TEMP <= SETPOINT_TEMP %}
	RESPOND MSG="Heating up the chamber : {CURRENT_TEMP}/{SETPOINT_TEMP}"
	G4 P{60000 * 1}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_BED]
description = Heatsoak bed at specified temperature and wait for a specific amount of time
gcode = 
	{% set SETPOINT_TEMP = params.TEMP|default(0)|int %}
	{% set TIME = params.SOAKTIME|default(8)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set heaterbed_enabled = printer["gcode_macro _USER_VARIABLES"].heaterbed_enabled %}
	
	{% if heaterbed_enabled %}
	{% if verbose %}
	RESPOND MSG="Heating up bed..."
	{% endif %}
	
	M190 S{SETPOINT_TEMP}
	
	{% if TIME > 0 %}
	{% for i in range(0, TIME) %}
	RESPOND MSG="Heatsoak bed, {TIME-i}mn left..."
	G4 P{60000 * 1}
	{% endfor %}
	{% else %}
	RESPOND MSG="No heatsoak needed, continue"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Bed temperature OK"
	{% endif %}
	
	{% else %}
	{% if verbose %}
	RESPOND MSG="No bed heater defined: nothing to do, continuing..."
	{% endif %}
	{% endif %}

[gcode_macro PRIMELINE]
gcode = 
	
	{% set prime_line_length = params.LINE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_length)|float %}
	{% set prime_line_purge_distance = params.PURGE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_purge_distance)|float %}
	{% set prime_line_flowrate = params.FLOWRATE|default(printer["gcode_macro _USER_VARIABLES"].prime_line_flowrate)|float %}
	
	
	{% set prime_line_x, prime_line_y = printer["gcode_macro _USER_VARIABLES"].prime_line_xy|map('float') %}
	{% set prime_line_direction = printer["gcode_macro _USER_VARIABLES"].prime_line_direction|string|upper %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% set max_extrude_cross_section = printer["configfile"].config["extruder"]["max_extrude_cross_section"]|float %}
	{% set filament_diameter = printer["configfile"].config["extruder"]["filament_diameter"]|float %}
	
	{% set line_height = 0.6 %}
	
	
	{% set prime_line_x = params.START_X|default(prime_line_x)|float %}
	{% set prime_line_y = params.START_Y|default(prime_line_y)|float %}
	{% set prime_line_direction = params.LINE_DIRECTION|default(printer["gcode_macro _USER_VARIABLES"].prime_line_direction)|string|upper %}
	
	
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	
	
	
	{% if (line_height * line_width) > max_extrude_cross_section %}
	{% if verbose %}
	{action_respond_info("The prime_line_purge_distance of %.4f mm is too high and will exceed the max_extrude_cross_section!" % prime_line_purge_distance)}
	{% endif %}
	{% set prime_line_purge_distance = 0.98 * (max_extrude_cross_section * prime_line_length) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	{% if verbose %}
	{action_respond_info("Klippain corrected the prime_line_purge_distance to %.4f mm" % prime_line_purge_distance)}
	{% endif %}
	{% endif %}
	
	
	{% if (line_height / line_width) >= 0.5 %}
	{% if verbose %}
	{action_raise_error("The prime line will be too thin and will probably not stick properly to the bed. Increase its purge distance or decrease its length! Aborting...")}
	{% endif %}
	{% endif %}
	
	
	{% set speed = (prime_line_flowrate / (line_height * line_width)) * 60 |float %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% endif %}
	{% endif %}
	{% endif %}
	
	G91
	M83
	G1 Z5 F{Sz}
	
	
	G90
	G0 X{prime_line_x} Y{prime_line_y} F{St}
	G1 Z{line_height} F{Sz|int / 2}
	
	
	G92 E0
	G1 E18 F300
	
	
	G92 E0
	{% if prime_line_direction == "X" %}
	G1 X{prime_line_x + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% elif prime_line_direction == "Y" %}
	G1 Y{prime_line_y + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% else %}
	{ action_respond_error("Prime line direction is not valid. Choose either X or Y in the variables.cfg file!") }
	{% endif %}
	
	
	G92 E0
	G1 E-0.2 F2100
	G92 E0
	G1 Z3 F{Sz}
	M400
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection reactivated after the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro CLEAN_NOZZLE]
description = Wipe the nozzle on the brush
gcode = 
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set brush_clean_accel = printer["gcode_macro _USER_VARIABLES"].brush_clean_accel %}
	{% set brush_over_y_axis = printer["gcode_macro _USER_VARIABLES"].brush_over_y_axis %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set Sc = printer["gcode_macro _USER_VARIABLES"].brush_clean_speed * 60 %}
	
	{% set Bx, By, Bz = printer["gcode_macro _USER_VARIABLES"].brush_xyz|map('float') %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Nozzle cleaning..."
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{brush_clean_accel}
	
	
	G90
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP=1
	
	G1 X{Bx} Y{By} Z{Bz} F{St}
	
	
	G91
	{% if brush_over_y_axis %}
	{% for wipe in range(6) %}
	G1 Y-5 F{Sc}
	G1 Y+5 F{Sc}
	{% endfor %}
	{% endif %}
	
	G1 X+20 F{Sc}
	
	{% for wipe in range(6) %}
	G1 X-40 F{Sc}
	G1 X+40 F{Sc}
	{% endfor %}
	
	G90
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="clean"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro PURGE]
description = Purge a specific amount of filament ontop of the purge bucket
gcode = 
	{% set DISTANCE = params.DISTANCE|default(printer["gcode_macro _USER_VARIABLES"].purge_distance)|int %}
	{% set OOZE_TIME = params.OOZE_TIME|default(printer["gcode_macro _USER_VARIABLES"].purge_ooze_time)|int %}
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Purge filament..."
	{% endif %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% endif %}
	
	G90
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP={Z_DROP}
	
	
	_LOW_TEMP_CHECK T={TEMP}
	G92 E0
	G1 E{DISTANCE|float} F150
	
	
	G92 E0
	G1 E-1.7 F2100
	G1 E-18.3 F150
	G92 E0
	
	
	G4 P{OOZE_TIME * 1000}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _CONDITIONAL_MOVE_TO_PURGE_BUCKET]
description = Move over the purge bucket
gcode = 
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	
	{% if purge_and_brush_enabled %}
	SAVE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	G90
	
	{% if Z_DROP == 1 %}
	{% if purgeclean_servo_enabled %}
	G1 Z{Pz} F{Sz}
	_SERVO_DEPLOY ITEM="purge"
	{% endif %}
	G1 X{Px} Y{Py} Z{Pz} F{St}
	{% else %}
	
	
	
	G1 X{Px} Y{Py} F{St}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	{% endif %}

[gcode_macro _LOW_TEMP_CHECK]
description = Check the nozzle is at temperature and heat it if needed
gcode = 
	{% set T = params.T|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% if printer.extruder.target != 0 %}
	{% if printer.extruder.temperature < printer.extruder.target %}
	M109 S{printer.extruder.target|float}
	{% endif %}
	{% else %}
	{% if printer.extruder.target < T %}
	M109 S{T}
	{% endif %}
	{% endif %}

[gcode_macro M701]
description = Map M701 to LOAD_FILAMENT
gcode = 
	LOAD_FILAMENT

[gcode_macro M702]
description = Map M702 to UNLOAD_FILAMENT
gcode = 
	UNLOAD_FILAMENT

[gcode_macro M600]
description = Map M600 to CHANGE_FILAMENT
gcode = 
	CHANGE_FILAMENT

[gcode_macro M125]
description = Map M125 to PARK
gcode = 
	PARK

[gcode_macro M900]
description = Map M900 to SET_PRESSURE_ADVANCE
gcode = 
	{% if 'K' in params %}
	{% if 'E' in params %}
	SET_PRESSURE_ADVANCE EXTRUDER={params.E} ADVANCE={params.K}
	{% else %}
	SET_PRESSURE_ADVANCE ADVANCE={params.K}
	{% endif %}
	{% endif %}

[gcode_macro M204]
description = Map M204 to SET_VELOCITY_LIMIT for ACCEL and ACCEL_TO_DECEL
rename_existing = M204.1
gcode = 
	{% set F = params.F|default(printer["gcode_macro _USER_VARIABLES"].accel_to_decel_factor)|float %}
	
	{% if 'S' in params %}
	{% set S = params.S|float %}
	SET_VELOCITY_LIMIT ACCEL={S} ACCEL_TO_DECEL={S * F}
	{% endif %}

[gcode_macro M205]
description = Map M205 to SET_VELOCITY_LIMIT for SQUARE_CORNER_VELOCITY
gcode = 
	{% if 'X' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.X}
	{% elif 'Y' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.Y}
	{% endif %}

[gcode_macro G00]
gcode = 
	G0 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G01]
gcode = 
	G1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G02]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G03]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G04]
gcode = 
	G4 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro _SEARCH_VARS]
description = Search for variables in the "printer" object from Klipper
gcode = 
	{% set search = params.S|lower %}
	{% set ns = namespace() %}
	{% for item in printer  %}
	{% if ' ' in item %}
	{% set ns.path = ['printer', "['%s']" % (item), ''] %}
	{% else %}
	{% set ns.path = ['printer.', item, ''] %}
	{% endif %}
	
	{% if search in ns.path|lower %}
	{ action_respond_info(ns.path|join) }
	{% endif %}
	
	{% if printer[item].items() %}
	{% for childkey, child in printer[item].items() recursive %}
	{% set ns.path = ns.path[:loop.depth|int + 1] %}
	
	{% if ' ' in childkey %}
	{% set null = ns.path.append("['%s']" % (childkey)) %}
	{% else %}
	{% set null = ns.path.append(".%s" % (childkey)) %}
	{% endif %}
	
	{% if child is mapping  %}
	{ loop(child.items()) }
	{% else %}
	{% if search in ns.path|lower %}
	{ action_respond_info("%s : %s" % (ns.path|join, child)) }
	{% endif %}
	{% endif %}
	
	{% endfor %}
	{% endif %}
	{% endfor %}

[delayed_gcode KLIPPAIN_STARTUP]
initial_duration = 1
gcode = 
	_KLIPPAIN_STARTUP

[gcode_macro _KLIPPAIN_STARTUP]
gcode = 
	
	RUN_SHELL_COMMAND CMD=system_info
	
	
	_INIT_MCU_VER
	
	
	{% set extruder_enabled = printer["gcode_macro _USER_VARIABLES"].extruder_enabled %}
	{% if not extruder_enabled %}
	{ action_raise_error("Klippain need to have an extruder defined to work properly. Check your printer.cfg includes!") }
	{% endif %}
	
	
	_INIT_CHECKPROBECONF
	
	
	{% set e_driver = printer["gcode_macro _USER_VARIABLES"].e_driver|string %}
	{% if e_driver == "TMC2240" %}
	_INIT_TMC2240
	{% endif %}
	
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% if klippain_ercf_enabled %}
	_INIT_CHECK_ERCF
	{% endif %}
	
	
	_INIT_USERCUSTOM
	
	RESPOND MSG="Klippain started and ready !"

[gcode_macro _INIT_TMC2240]
gcode = 

[gcode_macro _INIT_CHECKPROBECONF]
gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled|string %}
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set qgl_enabled = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set ztilt_enabled = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	
	{% if zcalib_plugin_enabled %}
	{% if probe_type_enabled == "vorontap" %}
	{ action_raise_error("Voron TAP Probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "inductive" %}
	{ action_raise_error("Inductive probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "dockable_virtual" or probe_type_enabled == "inductive_virtual" %}
	{ action_raise_error("Virtual Z endstop probes are not compatible with the Z calibration plugin!") }
	{% elif probe_type_enabled == "none" %}
	{ action_raise_error("You need a probe to use the Z calibration plugin in Klippain!") }
	{% endif %}
	{% endif %}
	
	{% if bed_mesh_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a bed mesh in Klippain!") }
	{% endif %}
	
	{% if qgl_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a quad gantry leveling in Klippain!") }
	{% endif %}
	
	{% if ztilt_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a Z tilt adjust in Klippain!") }
	{% endif %}

[gcode_macro _INIT_MCU_VER]
gcode = 
	{% set parameters = namespace(output = 'Currently configured MCU(s): \n') %}
	{% for name1 in printer %}
	{% for name2 in printer[name1] %}
	{% set show = ['mcu_version'] %}
	{% if name2 is in show %}
	{% set param = "%s: %s" % (name1, printer[name1][name2]) %}
	{% set parameters.output = parameters.output +  param + "\n" %}
	{% endif %}
	{% endfor %}
	{% endfor %}
	{action_respond_info(parameters.output)}

[gcode_macro _INIT_CHECK_ERCF]
gcode = 
	{% if not printer.ercf.enabled %}
	{ action_raise_error("ERCF is enabled in Klippain, but Happy Hare, the supported ERCF backend software is not detected. Please install it now from https://github.com/moggieuk/ERCF-Software-V3 !") }
	{% endif %}

[gcode_macro _INIT_USERCUSTOM]
gcode = 

[gcode_shell_command plot_graph]
command = bash /home/pi/printer_data/config/scripts/plot_graphs.sh
timeout = 500.0
verbose = True

[gcode_shell_command system_info]
command = python3 /home/pi/printer_data/config/scripts/system_info.py
timeout = 5.0
verbose = True

[save_variables]
filename = ~/printer_data/config/save_variables.cfg

[tmc2209 stepper_z]
uart_pin = Z_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z1]
uart_pin = Z1_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z2]
uart_pin = Z2_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z3]
uart_pin = Z3_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 extruder]
uart_pin = toolhead:E_TMCUART
interpolate = false
run_current = 0.45
sense_resistor = 0.110
stealthchop_threshold = 0

[mcu]
canbus_uuid = f981df077b2c

[board_pins mcu_manufacturer]
aliases = 
	MCU_MOTOR0_STEP=PF13   , MCU_MOTOR0_DIR=PF12   , MCU_MOTOR0_ENABLE=PF14   , MCU_MOTOR0_UART=PC4    ,
	MCU_MOTOR1_STEP=PG0    , MCU_MOTOR1_DIR=PG1    , MCU_MOTOR1_ENABLE=PF15   , MCU_MOTOR1_UART=PD11   ,
	MCU_MOTOR2_1_STEP=PF11 , MCU_MOTOR2_1_DIR=PG3  , MCU_MOTOR2_1_ENABLE=PG5  , MCU_MOTOR2_1_UART=PC6  ,
	MCU_MOTOR3_STEP=PG4    , MCU_MOTOR3_DIR=PC1    , MCU_MOTOR3_ENABLE=PA0    , MCU_MOTOR3_UART=PC7    ,
	MCU_MOTOR4_STEP=PF9    , MCU_MOTOR4_DIR=PF10   , MCU_MOTOR4_ENABLE=PG2    , MCU_MOTOR4_UART=PF2    ,
	MCU_MOTOR5_STEP=PC13   , MCU_MOTOR5_DIR=PF0    , MCU_MOTOR5_ENABLE=PF1    , MCU_MOTOR5_UART=PE4    ,
	MCU_MOTOR6_STEP=PE2    , MCU_MOTOR6_DIR=PE3    , MCU_MOTOR6_ENABLE=PD4    , MCU_MOTOR6_UART=PE1    ,
	MCU_MOTOR7_STEP=PE6    , MCU_MOTOR7_DIR=PA14   , MCU_MOTOR7_ENABLE=PE0    , MCU_MOTOR7_UART=PD3    ,
	
	MCU_STOP0=PG6  , MCU_STOP1=PG9  , MCU_STOP2=PG10 , MCU_STOP3=PG11 ,
	MCU_STOP4=PG12 , MCU_STOP5=PG13 , MCU_STOP6=PG14 , MCU_STOP7=PG15 ,
	MCU_PROBE=PB7  ,
	MCU_SERVOS=PB6 ,
	
	MCU_HE0=PA2 , MCU_HE1=PA3 , MCU_HE2=PB10 , MCU_HE3=PB11 ,
	
	MCU_BED0=PA1 ,
	
	MCU_TB=PF3 ,
	MCU_T0=PF4 , MCU_T1=PF5 , MCU_T2=PF6 , MCU_T3=PF7 ,
	
	MCU_FAN0=PA8 , MCU_FAN1=PE5 , MCU_FAN2=PD12 , MCU_FAN3=PD13 , MCU_FAN4=PD14 , MCU_FAN5=PD15 ,
	
	MCU_NEOPIXEL=PB0  ,
	MCU_PS_ON=PE11    ,
	MCU_POWER_DET=PC0 ,
	
	
	EXP1_1=PE8   , EXP1_2=PE7   ,
	EXP1_3=PE9   , EXP1_4=PE10  ,
	EXP1_5=PE12  , EXP1_6=PE13  ,
	EXP1_7=PE14  , EXP1_8=PE15  ,
	EXP1_9=<GND> , EXP1_10=<5V> ,
	
	
	EXP2_1=PA6   , EXP2_2=PA5   ,
	EXP2_3=PB1   , EXP2_4=PA4   ,
	EXP2_5=PB2   , EXP2_6=PA7   ,
	EXP2_7=PC15  , EXP2_8=<RST> ,
	EXP2_9=<GND> , EXP2_10=<5V> ,

[board_pins octopus_mcu]
mcu = mcu
aliases = 
	X_STEP=MCU_MOTOR0_STEP   , X_DIR=MCU_MOTOR0_DIR   , X_ENABLE=MCU_MOTOR0_ENABLE   , X_TMCUART=MCU_MOTOR0_UART   ,
	Y_STEP=MCU_MOTOR1_STEP   , Y_DIR=MCU_MOTOR1_DIR   , Y_ENABLE=MCU_MOTOR1_ENABLE   , Y_TMCUART=MCU_MOTOR1_UART   ,
	
	Z_STEP=MCU_MOTOR2_1_STEP , Z_DIR=MCU_MOTOR2_1_DIR , Z_ENABLE=MCU_MOTOR2_1_ENABLE , Z_TMCUART=MCU_MOTOR2_1_UART ,
	Z1_STEP=MCU_MOTOR3_STEP  , Z1_DIR=MCU_MOTOR3_DIR  , Z1_ENABLE=MCU_MOTOR3_ENABLE  , Z1_TMCUART=MCU_MOTOR3_UART  ,
	Z2_STEP=MCU_MOTOR4_STEP  , Z2_DIR=MCU_MOTOR4_DIR  , Z2_ENABLE=MCU_MOTOR4_ENABLE  , Z2_TMCUART=MCU_MOTOR4_UART  ,
	Z3_STEP=MCU_MOTOR5_STEP  , Z3_DIR=MCU_MOTOR5_DIR  , Z3_ENABLE=MCU_MOTOR5_ENABLE  , Z3_TMCUART=MCU_MOTOR5_UART  ,
	
	E_STEP=MCU_MOTOR6_STEP   , E_DIR=MCU_MOTOR6_DIR   , E_ENABLE=MCU_MOTOR6_ENABLE   , E_TMCUART=MCU_MOTOR6_UART   ,
	
	X_STOP=MCU_STOP0 , Y_STOP=MCU_STOP1 , Z_STOP=MCU_STOP2 ,
	PROBE_INPUT=MCU_STOP7  ,
	RUNOUT_SENSOR=MCU_STOP3 ,
	
	E_HEATER=MCU_HE0   , E_TEMPERATURE=MCU_T0   ,
	BED_HEATER=MCU_HE1 , BED_TEMPERATURE=MCU_TB ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	CONTROLLER_FAN=MCU_FAN2        ,
	EXHAUST_FAN=MCU_FAN3           ,
	FILTER_FAN=MCU_FAN4            ,
	HOST_CONTROLLER_FAN=MCU_FAN5   ,
	
	CHAMBER_TEMPERATURE=MCU_T1 , ELECTRICAL_CABINET_TEMPERATURE=MCU_T2 ,
	
	LIGHT_OUTPUT=MCU_HE2         ,
	LIGHT_NEOPIXEL=MCU_STOP5     ,
	STATUS_NEOPIXEL=MCU_NEOPIXEL ,

[mcu toolhead]
canbus_uuid = 1b44cf5169c3

[board_pins toolhead_manufacturer]
mcu = toolhead
aliases = 
	MCU_EMOT_EN=gpio7 , MCU_EMOT_STEP=gpio9 , MCU_EMOT_DIR=gpio10 , MCU_EMOT_UART=gpio8 ,
	
	MCU_5V_ENDSTOP=gpio28 ,
	MCU_ENDSTOP=gpio29    ,
	MCU_HV_ENDSTOP=gpio25 ,
	
	MCU_FAN0=gpio13 , MCU_FAN1=gpio14 , MCU_FAN2=gpio15 ,
	
	MCU_TEMP=gpio27 , MCU_ONBOARD_NTCK100K=gpio26 ,
	
	MCU_HEAT=gpio6 ,
	
	MCU_RGB=gpio12 ,
	MCU_PWM0=gpio16 , MCU_PWM1=gpio17 ,
	
	MCU_ADXL_CS=gpio1 , MCU_ADXL_SCK=gpio0 , MCU_ADXL_MOSI=gpio3 , MCU_ADXL_MISO=gpio2 ,

[board_pins sb2040_mcu]
mcu = toolhead
aliases = 
	E_STEP=MCU_EMOT_STEP , E_DIR=MCU_EMOT_DIR , E_ENABLE=MCU_EMOT_EN , E_TMCUART=MCU_EMOT_UART ,
	
	X_STOP=MCU_ENDSTOP ,
	PROBE_INPUT=MCU_HV_ENDSTOP ,
	TOOLHEAD_SENSOR=MCU_5V_ENDSTOP ,
	
	E_HEATER=MCU_HEAT , E_TEMPERATURE=MCU_TEMP , CHAMBER_TEMPERATURE=MCU_ONBOARD_NTCK100K ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	
	STATUS_NEOPIXEL=MCU_RGB ,
	
	ADXL_CS=MCU_ADXL_CS , ADXL_SCLK=MCU_ADXL_SCK , ADXL_MOSI=MCU_ADXL_MOSI , ADXL_MISO=MCU_ADXL_MISO ,

[neopixel status_leds]
pin = toolhead:STATUS_NEOPIXEL
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting CAN connect
Created a socket
webhooks client 281473428879056: New connection
webhooks client 281473428879056: Client info {'program': 'Moonraker', 'version': 'v0.8.0-92-g504a3a7'}
Loaded MCU 'mcu' 107 commands (v0.11.0-110-gaca0c71a / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1=PB6,PB7 BUS_PINS_i2c1a=PB8,PB9 BUS_PINS_i2c2=PB10,PB11 BUS_PINS_i2c2a=PH4,PH5 BUS_PINS_i2c3=PA8,PC9 BUS_PINS_i2c3a=PH7,PH8 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3=PB4,PB5,PB3 BUS_PINS_spi3a=PC11,PC12,PC10 BUS_PINS_spi4=PE13,PE14,PE12 CANBUS_BRIDGE=1 CLOCK_FREQ=168000000 MCU=stm32f429xx PWM_MAX=255 RECEIVE_WINDOW=192 RESERVE_PINS_CAN=PD0,PD1 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PH0,PH1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu 'toolhead': Starting CAN connect
Created a socket
Loaded MCU 'toolhead' 107 commands (v0.11.0-201-g37315bf3 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'toolhead' config: ADC_MAX=4095 BUS_PINS_i2c0a=gpio0,gpio1 BUS_PINS_i2c0b=gpio4,gpio5 BUS_PINS_i2c0c=gpio8,gpio9 BUS_PINS_i2c0d=gpio12,gpio13 BUS_PINS_i2c0e=gpio16,gpio17 BUS_PINS_i2c0f=gpio20,gpio21 BUS_PINS_i2c0g=gpio24,gpio25 BUS_PINS_i2c0h=gpio28,gpio29 BUS_PINS_i2c1a=gpio2,gpio3 BUS_PINS_i2c1b=gpio6,gpio7 BUS_PINS_i2c1c=gpio10,gpio11 BUS_PINS_i2c1d=gpio14,gpio15 BUS_PINS_i2c1e=gpio18,gpio19 BUS_PINS_i2c1f=gpio22,gpio23 BUS_PINS_i2c1g=gpio26,gpio27 BUS_PINS_spi0a=gpio0,gpio3,gpio2 BUS_PINS_spi0b=gpio4,gpio7,gpio6 BUS_PINS_spi0c=gpio16,gpio19,gpio18 BUS_PINS_spi0d=gpio20,gpio23,gpio22 BUS_PINS_spi1a=gpio8,gpio11,gpio10 BUS_PINS_spi1b=gpio12,gpio15,gpio14 BUS_PINS_spi1c=gpio24,gpio27,gpio26 CANBUS_FREQUENCY=1000000 CLOCK_FREQ=12000000 INITIAL_PINS=gpio24 MCU=rp2040 PWM_MAX=255 RECEIVE_WINDOW=192 RESERVE_PINS_CAN=gpio4,gpio5 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu_temperature 'mcu' nominal base=-238.014440 slope=1182.671480
mcu_temperature 'toolhead' nominal base=437.226612 slope=-1917.489831
Sending MCU 'mcu' printer configuration...
Config error
Traceback (most recent call last):
  File "/home/orangepi/klipper/klippy/mcu.py", line 707, in _send_config
    self._serial.send(c)
  File "/home/orangepi/klipper/klippy/serialhdl.py", line 256, in send
    cmd = self.msgparser.create_command(msg)
  File "/home/orangepi/klipper/klippy/msgproto.py", line 350, in create_command
    cmd = mp.encode_by_name(**argparts)
  File "/home/orangepi/klipper/klippy/msgproto.py", line 181, in encode_by_name
    t.encode(out, params[name])
  File "/home/orangepi/klipper/klippy/msgproto.py", line 108, in encode
    raise enumeration_error(self.enum_name, v)
msgproto.enumeration_error: Unknown value 'SERVO_PIN' in enumeration 'pin'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/orangepi/klipper/klippy/klippy.py", line 180, in _connect
    cb()
  File "/home/orangepi/klipper/klippy/mcu.py", line 753, in _connect
    self._send_config(None)
  File "/home/orangepi/klipper/klippy/mcu.py", line 718, in _send_config
    raise self._printer.config_error(
configparser.Error: Pin 'SERVO_PIN' is not a valid pin name on mcu 'mcu'
Attempting MCU 'toolhead' reset command
Attempting MCU 'mcu' reset command
b'Got error -1 in can read: (100)Network is down'
webhooks client 281473428879056: Disconnected
Restarting printer
Start printer at Tue Jul 11 14:45:35 2023 (1689104735.6 369.6)
===== Config file =====
[printer]
kinematics = corexz
max_velocity = 400
max_accel = 1000
max_z_velocity = 200
max_z_accel = 1000
square_corner_velocity = 5.0

[stepper_x]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = X_STEP
dir_pin = X_DIR
enable_pin = !X_ENABLE
endstop_pin = tmc2209_stepper_x:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_y]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = Y_STEP
dir_pin = Y_DIR
enable_pin = !Y_ENABLE
endstop_pin = tmc2209_stepper_y:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_z]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z_STEP
dir_pin = !Z_DIR
enable_pin = !Z_ENABLE
endstop_pin = probe:z_virtual_endstop
homing_speed = 15
second_homing_speed = 8
homing_retract_dist = 3.0
position_max = 310
position_min = -5

[stepper_z1]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z1_STEP
dir_pin = !Z1_DIR
enable_pin = !Z1_ENABLE

[stepper_z2]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z2_STEP
dir_pin = !Z2_DIR
enable_pin = !Z2_ENABLE

[stepper_z3]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z3_STEP
dir_pin = Z3_DIR
enable_pin = !Z3_ENABLE

[gcode_macro _USER_VARIABLES]
variable_extruder_enabled = True
gcode = 
variable_heaterbed_enabled = True
variable_probe_type_enabled = "vorontap"
variable_startprint_actions = "bed_soak", "extruder_preheating", "chamber_soak", "clean", "tilt_calib", "z_offset", "bedmesh", "extruder_heating", "purge", "clean", "primeline"
variable_status_leds_minidisplay_enabled = True
variable_status_leds_minidisplay_led_name = "btt_mini12864"
variable_bed_mesh_enabled = True
variable_sensorless_homing_enabled = True
variable_qgl_enabled = True
variable_verbose = True
variable_homing_travel_speed = 350
variable_travel_speed = 350
variable_z_drop_speed = 15
variable_brush_clean_speed = 100
variable_probe_dock_speed = 60
variable_homing_travel_accel = 3000
variable_tilting_travel_accel = 3000
variable_brush_clean_accel = 1500
variable_probe_dock_accel = 2000
variable_accel_to_decel_factor = 0.75
variable_zendstop_position = -1, -1
variable_force_homing_in_start_print = False
variable_homing_zhop = 5
variable_homing_first = "X"
variable_homing_backoff_distance_xy = -5, -5
variable_sensorless_current_factor = 75
variable_probe_dock_margin_xy = 0, 0
variable_safe_extruder_temp = 150
variable_prime_line_xy = 5, 2.5
variable_prime_line_direction = "X"
variable_prime_line_length = 40
variable_prime_line_purge_distance = 30
variable_prime_line_flowrate = 10
variable_park_position_xy = -1, -1
variable_park_lift_z = 50
variable_disable_motors_in_end_print = False
variable_turn_off_heaters_in_end_print = True
variable_min_bed_xy = 0, 0
variable_max_bed_xy = 9999, 9999
variable_probe_min_z_travel = 20
variable_probe_dock_location_xy = -1, -1
variable_probe_servo_angle_retracted = 0
variable_probe_servo_angle_deployed = 90
variable_probe_before_attach_position = "front"
variable_probe_after_attach_position = "front"
variable_probe_before_dock_position = "front"
variable_probe_after_dock_position = "left"
variable_probe_move_attach_length = 30
variable_probe_move_dock_length = 30
variable_autodock_on_probe_error = True
variable_tap_max_probing_temp = 150
variable_tap_deactivation_zhop = 5
variable_print_default_bed_temp = 105
variable_print_default_extruder_temp = 240
variable_print_default_chamber_temp = 0
variable_print_default_chamber_max_heating_time = 15
variable_print_default_soak = 8
variable_print_default_material = "XXX"
variable_material_parameters = {
	'PLA': {
	'pressure_advance': 0.0525,
	'retract_length': 0.75,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 0,
	'additional_z_offset': 0
	},
	'PET': {
	'pressure_advance': 0.0650,
	'retract_length': 1.4,
	'unretract_extra_length': 0,
	'retract_speed': 30,
	'unretract_speed': 20,
	'filter_speed': 0,
	'additional_z_offset': 0.020
	},
	'ABS': {
	'pressure_advance': 0.0480,
	'retract_length': 0.5,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 80,
	'additional_z_offset': 0
	}
	}
variable_ercf_unload_on_cancel_print = False
variable_ercf_unload_on_end_print = True
variable_ercf_reset_stats_on_start_print = False
variable_purge_and_brush_enabled = False
variable_force_homing_before_brush = False
variable_brush_over_y_axis = True
variable_brush_xyz = -1, -1, -1
variable_purge_bucket_xyz = -1, -1, -1
variable_purge_distance = 30
variable_purge_ooze_time = 10
variable_purgeclean_servo_angle_retracted = 0
variable_purgeclean_servo_angle_deployed = 90
variable_light_intensity_start_print = 100
variable_light_intensity_printing = 30
variable_light_intensity_end_print = 0
variable_fix_heaters_temperature_settle = False
variable_resonnance_test_point_xy = -1, -1
variable_resonnance_test_z_clearance = 50
variable_status_leds_colors = {
	'logo': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'nozzle': {
	'heating': {'r': 0.8, 'g': 0.35, 'b': 0.0, 'w':0.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'standby': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'caselight': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'minidisplay': {
	'on': {'r': 0.0, 'g': 0.2, 'b': 0.4, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'error': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'thermal': {
	'hot': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cold': {'r': 0.3, 'g': 0.0, 'b': 0.3, 'w': 0.0}
	}
	}
variable_x_driver = "TMC2209"
variable_y_driver = "TMC2209"
variable_z_driver = "TMC2209"
variable_e_driver = "TMC2209"

[extruder]
rotation_distance = 22.79234586
gear_ratio = 50:10
microsteps = 64
full_steps_per_rotation = 200
nozzle_diameter = 0.400
filament_diameter = 1.75
max_extrude_only_distance = 110
max_extrude_cross_section = 5
sensor_type = ATC Semitec 104GT-2
min_temp = 5
max_temp = 310
max_power = 1.0
min_extrude_temp = 170
pressure_advance = 0.045
pressure_advance_smooth_time = 0.040
step_pin = toolhead:E_STEP
dir_pin = toolhead:E_DIR
enable_pin = !toolhead:E_ENABLE
heater_pin = toolhead:E_HEATER
sensor_pin = toolhead:E_TEMPERATURE
control = pid
pid_kp = 34.626
pid_ki = 4.050
pid_kd = 74.014

[gcode_macro M109]
rename_existing = M109.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={S}
	{% else %}
	M109.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[heater_bed]
heater_pin = BED_HEATER
sensor_type = NTC 100K MGB18-104F39050L32
sensor_pin = BED_TEMPERATURE
max_power = 1
min_temp = 0
max_temp = 120
control = pid
pid_kp = 40.783
pid_ki = 1.007
pid_kd = 412.931

[gcode_macro M190]
rename_existing = M190.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={S}
	{% else %}
	M190.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[gcode_macro ACTIVATE_PROBE]
description = Put the machine in a state being able to probe
variable_temperature = 0
gcode = 
	{% set LOCK = params.LOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_max_probing_temp = printer["gcode_macro _USER_VARIABLES"].tap_max_probing_temp|float %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if LOCK %}
	_ATTACH_PROBE_LOCK
	{% else %}
	_ATTACH_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	SAVE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	
	{% set ACTUAL_TEMP = printer.extruder.temperature %}
	{% set TARGET_TEMP = printer.extruder.target %}
	
	SET_GCODE_VARIABLE MACRO=ACTIVATE_PROBE VARIABLE=temperature VALUE={TARGET_TEMP}
	
	{% if TARGET_TEMP > tap_max_probing_temp %}
	{ action_respond_info('Extruder temperature target of %.1fC is too high for TAP probing, lowering to %.1fC' % (TARGET_TEMP, tap_max_probing_temp)) }
	M106 S255
	M109 S{tap_max_probing_temp}
	M106 S0
	{% else %}
	
	{% if ACTUAL_TEMP > tap_max_probing_temp + 3 %}
	M106 S255
	TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={tap_max_probing_temp}
	M106 S0
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro DEACTIVATE_PROBE]
description = Revert the machine to a normal state after probing
gcode = 
	{% set UNLOCK = params.UNLOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_deactivation_zhop = printer["gcode_macro _USER_VARIABLES"].tap_deactivation_zhop %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if UNLOCK %}
	_DOCK_PROBE_UNLOCK
	{% else %}
	_DOCK_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	
	{% set z_safe = printer.toolhead.position.z + tap_deactivation_zhop %}
	{% if z_safe > printer.toolhead.axis_maximum.z %}
	{% set z_safe = printer.toolhead.axis_maximum.z %}
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	
	{% set old_target_temperature = printer["gcode_macro ACTIVATE_PROBE"].temperature %}
	M109 S{old_target_temperature}
	
	RESTORE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	{% endif %}

[probe]
pin = ^toolhead:MCU_ENDSTOP1
x_offset = 0
y_offset = 0
z_offset = -0.45
speed = 3
lift_speed = 10
samples = 3
samples_result = median
sample_retract_dist = 1.0
samples_tolerance = 0.007
samples_tolerance_retries = 3

[heater_fan hotend_fan]
pin = toolhead:E_FAN
max_power = 1.0
kick_start_time = 0.100
heater = extruder
heater_temp = 50.0

[fan]
pin = toolhead:PART_FAN
kick_start_time = 0.100
cycle_time = 0.010

[gcode_macro _SET_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = params.LED|string %}
	{% set idx = (params.IDX|string).split(',') %}
	{% set transmit_last = params.TRANSMIT|default(1) %}
	
	{% for led_index in idx %}
	{% set transmit=transmit_last if loop.last else 0 %}
	SET_LED LED={led} RED={red} GREEN={green} BLUE={blue} WHITE={white} INDEX={led_index} TRANSMIT={transmit}
	{% endfor %}

[gcode_macro _SET_LEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_idx"] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_ALLLEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	SET_LED LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w}  TRANSMIT={transmit}

[gcode_macro _SET_LOGO_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_NOZZLE_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro SET_LOGO_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="logo" COLOR="off" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_ON]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="on" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="off" TRANSMIT={transmit}

[gcode_macro STATUS_LEDS]
gcode = 
	{% set color = params.COLOR|default('off')|lower %}
	
	{% set status_color = {
	'ready': {
	'logo': 'standby',
	'nozzle': 'standby',
	'caselight': 'standby',
	'minidisplay': 'on'
	},
	'busy': {
	'logo': 'busy',
	'nozzle': 'on',
	'caselight': 'busy',
	'minidisplay': 'on'
	},
	'heating': {
	'logo': 'heating',
	'nozzle': 'heating',
	'caselight': 'heating',
	'minidisplay': 'on'
	},
	'leveling': {
	'logo': 'leveling',
	'nozzle': 'on',
	'caselight': 'leveling',
	'minidisplay': 'on'
	},
	'homing': {
	'logo': 'homing',
	'nozzle': 'on',
	'caselight': 'homing',
	'minidisplay': 'on'
	},
	'cleaning': {
	'logo': 'cleaning',
	'nozzle': 'on',
	'caselight': 'cleaning',
	'minidisplay': 'on'
	},
	'meshing': {
	'logo': 'meshing',
	'nozzle': 'on',
	'caselight': 'meshing',
	'minidisplay': 'on'
	},
	'calibrating_z': {
	'logo': 'calibrating_z',
	'nozzle': 'on',
	'caselight': 'calibrating_z',
	'minidisplay': 'on'
	},
	'printing': {
	'logo': 'printing',
	'nozzle': 'on',
	'caselight': 'printing',
	'minidisplay': 'on'
	},
	'off': {
	'logo': 'off',
	'nozzle': 'off',
	'caselight': 'off',
	'minidisplay': 'off'
	},
	'on': {
	'logo': 'on',
	'nozzle': 'on',
	'caselight': 'on',
	'minidisplay': 'on'
	},
	'error': {
	'logo': 'error',
	'nozzle': 'error',
	'caselight': 'error',
	'minidisplay': 'error'
	}
	} %}
	
	{% if not (color in status_color) %}
	{ action_raise_error("COLOR is not valid!") }
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	_SET_LEDS_BY_NAME LEDS="logo" COLOR={status_color[color].logo} TRANSMIT=0
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR={status_color[color].nozzle} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_caselight_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="caselight" COLOR={status_color[color].caselight} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_minidisplay_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="minidisplay" COLOR={status_color[color].minidisplay} TRANSMIT=1
	{% endif %}

[display]
lcd_type = uc1701
cs_pin = EXP1_3
a0_pin = EXP1_4
rst_pin = EXP1_5
encoder_pins = ^EXP2_5, ^EXP2_3
click_pin = ^!EXP1_2
contrast = 63
spi_software_miso_pin = EXP2_1
spi_software_mosi_pin = EXP2_6
spi_software_sclk_pin = EXP2_2

[output_pin beeper]
pin = EXP1_1

[neopixel btt_mini12864]
pin = EXP1_6
chain_count = 3
initial_red = 0.1
initial_green = 0.5
initial_blue = 0.0
color_order = RGB

[delayed_gcode setdisplayneopixel]
initial_duration = 1
gcode = 
	SET_LED LED=btt_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3

[temperature_sensor RaspberryPi]
sensor_type = temperature_host

[temperature_sensor mcu]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 90

[temperature_sensor toolhead_mcu]
sensor_type = temperature_mcu
sensor_mcu = toolhead
min_temp = 0
max_temp = 100

[adxl345]
cs_pin = toolhead:ADXL_CS
spi_software_sclk_pin = toolhead:ADXL_SCLK
spi_software_mosi_pin = toolhead:ADXL_MOSI
spi_software_miso_pin = toolhead:ADXL_MISO
axes_map = x,y,z

[resonance_tester]
accel_chip = adxl345
probe_points = 
	-1,-1,-1

[gcode_macro TEST_RESONANCES]
rename_existing = BASE_TEST_RESONANCES
description = Runs input shaper test at the center of the bed
gcode = 
	{% set Tx, Ty = printer["gcode_macro _USER_VARIABLES"].resonnance_test_point_xy|map('float') %}
	{% set Tz = printer["gcode_macro _USER_VARIABLES"].resonnance_test_z_clearance|float %}
	
	{% if Tx == -1 and Ty == -1 %}
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	BASE_TEST_RESONANCES POINT={max_x / 2},{max_y / 2},{Tz} {rawparams}
	{% else %}
	BASE_TEST_RESONANCES POINT={Tx},{Ty},{Tz} {rawparams}
	{% endif %}

[gcode_macro AXES_SHAPER_CALIBRATION]
description = Run standard input shaper test for all axes
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.3)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=X FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=Y FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=SHAPER

[gcode_macro BELTS_SHAPER_CALIBRATION]
description = Run custom demi-axe test to analyze belts on CoreXY printers
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.33)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=1,1 OUTPUT=raw_data NAME=b FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=a FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=BELTS

[gcode_macro EXCITATE_AXIS_AT_FREQ]
description = Maintain a specified input shaper excitating frequency for some time to diagnose vibrations
gcode = 
	{% set FREQUENCY = params.FREQUENCY|default(25)|int %}
	{% set TIME = params.TIME|default(10)|int %}
	{% set AXIS = params.AXIS|default("x")|string|lower %}
	
	TEST_RESONANCES OUTPUT=raw_data AXIS={AXIS} FREQ_START={FREQUENCY-1} FREQ_END={FREQUENCY+1} HZ_PER_SEC={1/(TIME/3)}
	M400

[gcode_macro VIBRATIONS_CALIBRATION]
gcode = 
	
	
	
	{% set size = params.SIZE|default(60)|int %}
	{% set direction = params.DIRECTION|default('XY') %}
	{% set z_height = params.Z_HEIGHT|default(20)|int %}
	{% set verbose = params.VERBOSE|default(true) %}
	
	{% set min_speed = params.MIN_SPEED|default(20)|int * 60 %}
	{% set max_speed = params.MAX_SPEED|default(200)|int * 60 %}
	{% set speed_increment = params.SPEED_INCREMENT|default(2)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	
	{% set accel_chip = params.ACCEL_CHIP|default("adxl345") %}
	
	
	
	
	{% set mid_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set mid_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% set direction_factor = {
	'XY'  : {
	'start' : {'x': -0.5, 'y': -0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': -0.5, 'y': -0.5, 'z': 0.0 }
	}
	},
	'AB' : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': 0.0, 'y': 0.0, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	},
	'ABXY' : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'B'  : {
	'start' : {'x': 0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'A'  : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'X'  : {
	'start' : {'x': -0.5, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': 0.0, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.0, 'z': 0.0 }
	}
	},
	'Y'  : {
	'start' : {'x': 0.0, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.0, 'y': 0.5, 'z': 0.0 }
	}
	},
	'Z'  : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': 0.0, 'z': 1.0 },
	'1' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	}
	}
	%}
	
	
	
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	{% if (size / (max_speed / 60)) < 0.25 %}
	{ action_raise_error("SIZE is too small for this MAX_SPEED. Increase SIZE or decrease MAX_SPEED!") }
	{% endif %}
	
	{% if not (direction in direction_factor) %}
	{ action_raise_error("DIRECTION is not valid. Only XY, AB, ABXY, A, B, X, Y or Z is allowed!") }
	{% endif %}
	
	{action_respond_info("")}
	{action_respond_info("Starting speed and vibration calibration")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION
	
	G90
	
	
	G1 Z{z_height}
	G1 X{mid_x + (size * direction_factor[direction].start.x) } Y{mid_y + (size * direction_factor[direction].start.y)} F{feedrate_travel}
	
	
	{% for curr_speed in range(min_speed, max_speed + speed_increment) %}
	{% if (curr_speed - min_speed) % speed_increment == 0 %}
	{% if verbose %}
	RESPOND MSG="Current speed: {(curr_speed / 60)|int} mm/s"
	{% endif %}
	
	ACCELEROMETER_MEASURE CHIP={accel_chip}
	{% for key, factor in direction_factor[direction].move_factors|dictsort %}
	G1 X{mid_x + (size * factor.x) } Y{mid_y + (size * factor.y)} Z{z_height + (size * factor.z)} F{curr_speed}
	{% endfor %}
	ACCELEROMETER_MEASURE CHIP={accel_chip} NAME=sp{(curr_speed / 60)|int}n1
	
	G4 P300
	M400
	{% endif %}
	{% endfor %}
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS="VIBRATIONS {direction}"
	
	RESTORE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = _BASE_BED_MESH_CALIBRATE
description = Perform Mesh Bed Leveling with klicky automount
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if verbose %}
	{ action_respond_info("Bed Mesh Calibrate") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	_BASE_BED_MESH_CALIBRATE  {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	DEACTIVATE_PROBE

[gcode_macro _ADAPTIVE_MESH_VARIABLES]
variable_ready = False
variable_do_mesh = False
variable_do_nominal = False
variable_mesh_min = 0,0
variable_mesh_max = 0,0
variable_mesh_center = 0,0
variable_probe_count = 0,0
variable_rri = 0
variable_algo = "bicubic"
gcode = 

[gcode_macro COMPUTE_MESH_PARAMETERS]
description = Compute the mesh parameters and store them for later use
gcode = 
	
	{% set xMinConf, yMinConf = printer["configfile"].config["bed_mesh"]["mesh_min"].split(',')|map('trim')|map('int') %}
	{% set xMaxConf, yMaxConf = printer["configfile"].config["bed_mesh"]["mesh_max"].split(',')|map('trim')|map('int') %}
	{% set xProbeCntConf, yProbeCntConf = printer["configfile"].config["bed_mesh"]["probe_count"].split(',')|map('trim')|map('int') %}
	{% set algo = printer["configfile"].config["bed_mesh"]["algorithm"]|lower %}
	{% set xMeshPPS, yMeshPPS = (printer["configfile"].config["bed_mesh"]["mesh_pps"]|default('2,2')).split(',')|map('trim')|map('int') %}
	
	{% set margin = params.MARGIN|default(5)|int %}
	{% set force_mesh = params.FORCE_MESH|default(False) %}
	
	
	
	
	{% if params.SIZE is defined and params.SIZE != "0_0_0_0" %}
	RESPOND MSG="Got a SIZE parameter for the adaptive bed mesh"
	{% set xMinSpec, yMinSpec, xMaxSpec, yMaxSpec = params.SIZE.split('_')|map('trim')|map('int') %}
	
	{% elif printer.exclude_object.objects %}
	
	
	RESPOND MSG="No SIZE parameter, using the [exclude_object] tags for the adaptive bed mesh"
	{% set eo_points = printer.exclude_object.objects|map(attribute='polygon')|sum(start=[]) %}
	{% set xMinSpec = eo_points|map(attribute=0)|min %}
	{% set yMinSpec = eo_points|map(attribute=1)|min %}
	{% set xMaxSpec = eo_points|map(attribute=0)|max %}
	{% set yMaxSpec = eo_points|map(attribute=1)|max %}
	
	{% else %}
	
	
	RESPOND MSG="No info about the first layer coordinates, doing a nominal bed mesh instead of adaptive"
	{% endif %}
	
	
	
	
	{% if xMinSpec and yMinSpec and xMaxSpec and yMaxSpec %}
	
	
	
	
	{% set xMin = [xMinConf, (xMinSpec - margin)]|max %}
	{% set xMax = [xMaxConf, (xMaxSpec + margin)]|min %}
	{% set yMin = [yMinConf, (yMinSpec - margin)]|max %}
	{% set yMax = [yMaxConf, (yMaxSpec + margin)]|min %}
	
	
	
	
	{% set xProbeCnt = ((xMax - xMin) * xProbeCntConf / (xMaxConf - xMinConf))|round(0, 'ceil')|int %}
	{% set yProbeCnt = ((yMax - yMin) * yProbeCntConf / (yMaxConf - yMinConf))|round(0, 'ceil')|int %}
	
	
	
	
	
	
	
	
	{% if xProbeCnt < 3 and yProbeCnt < 3 %}
	{% if force_mesh %}
	RESPOND MSG="Bed mesh forced (small part detected): meshing 3x3..."
	{% set xProbeCnt = 3 %}
	{% set yProbeCnt = 3 %}
	{% set rRefIndex = 4 %}
	{% set algo = "lagrange" %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% else %}
	RESPOND MSG="Computed mesh parameters: none, bed mesh not needed for very small parts"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={False}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	{% else %}
	{% set xProbeCnt = [3, xProbeCnt]|max %}
	{% set yProbeCnt = [3, yProbeCnt]|max %}
	
	
	
	{% if xProbeCnt % 2 == 0 %}
	{% set xProbeCnt = xProbeCnt + 1 %}
	{% endif %}
	{% if yProbeCnt % 2 == 0 %}
	{% set yProbeCnt = yProbeCnt + 1 %}
	{% endif %}
	
	
	{% if xMeshPPS != 0 or yMeshPPS != 0 %}
	{% set probeCntMin = [xProbeCnt, yProbeCnt]|min %}
	{% set probeCntMax = [xProbeCnt, yProbeCnt]|max %}
	{% if algo == "lagrange" and probeCntMax > 6 %}
	
	{% set algo = "bicubic" %}
	{% endif %}
	{% if algo == "bicubic" and probeCntMin < 4 %}
	{% if probeCntMax > 6 %}
	
	{% if xProbeCnt > yProbeCnt %}
	{% set yProbeCnt = 5 %}
	{% else %}
	{% set xProbeCnt = 5 %}
	{% endif %}
	{% else %}
	
	{% set algo = "lagrange" %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	{% set rRefIndex = (((xProbeCnt * yProbeCnt) - 1) / 2)|int %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	
	
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% endif %}
	{% else %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={True}
	
	{% set xCenter = xMinConf + ((xMaxConf - xMinConf) / 2) %}
	{% set yCenter = yMinConf + ((yMaxConf - yMinConf) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={True}

[gcode_macro ADAPTIVE_BED_MESH]
description = Perform a bed mesh, but only where and when it's needed
gcode = 
	{% set ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	
	{% if ready %}
	_DO_ADAPTIVE_MESH
	
	
	
	{% else %}
	RESPOND MSG="Adaptive bed mesh: parameters not already computed, automatically calling the COMPUTE_MESH_PARAMETERS macro prior to the mesh"
	COMPUTE_MESH_PARAMETERS {rawparams}
	M400
	_DO_ADAPTIVE_MESH
	{% endif %}

[gcode_macro _DO_ADAPTIVE_MESH]
gcode = 
	
	{% set do_mesh = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_mesh %}
	{% set do_nominal = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_nominal %}
	{% set mesh_min = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_min %}
	{% set mesh_max = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_max %}
	{% set probe_count = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].probe_count %}
	{% set rRefIndex = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].rri %}
	{% set algo = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].algo %}
	
	
	
	
	{% if do_mesh %}
	
	{% if do_nominal %}
	RESPOND MSG="Adaptive bed mesh: nominal bed mesh"
	BED_MESH_CALIBRATE
	{% else %}
	{% if printer["configfile"].config["bed_mesh"]["relative_reference_index"] is defined %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}
	{% endif %}
	{% endif %}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: no mesh to be done"
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={False}

[bed_mesh]
speed = 350
horizontal_move_z = 12
mesh_min = 25, 25
mesh_max = 325, 325
probe_count = 9, 9
fade_start = 0.6
fade_end = 10.0
algorithm = bicubic
relative_reference_index = 40

[tmc2209 stepper_x]
diag_pin = ^X_STOP
driver_sgthrs = 50
uart_pin = X_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_y]
diag_pin = ^Y_STOP
driver_sgthrs = 60
uart_pin = Y_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[input_shaper]
shaper_freq_x = 56.4
shaper_type_x = zv
shaper_freq_y = 38.4
shaper_type_y = mzv

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing = _BASE_QUAD_GANTRY_LEVEL
description = Conform a moving, twistable gantry to the shape of a stationary bed with klicky automount
gcode = 
	{% set tilting_travel_accel = printer["gcode_macro _USER_VARIABLES"].tilting_travel_accel %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if verbose %}
	{ action_respond_info("Quad gantry leveling") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{tilting_travel_accel}
	
	_BASE_QUAD_GANTRY_LEVEL {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	DEACTIVATE_PROBE

[gcode_macro _TILT_CALIBRATE]
description = Do a QGL, Z_tilt, etc... depending of the machine configuration
gcode = 
	{% set FORCE_OPERATION = params.FORCE|default(true) %}
	{% set conf_QGL = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set conf_ztilt = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="LEVELING"
	{% endif %}
	
	{% if conf_QGL %}
	{% if printer.quad_gantry_level.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="QGL..."
	{% endif %}
	QUAD_GANTRY_LEVEL
	{% endif %}
	{% elif conf_ztilt %}
	{% if printer.z_tilt.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="Z tilt adjust..."
	{% endif %}
	Z_TILT_ADJUST
	{% endif %}
	{% else %}
	{% if verbose %}
	RESPOND MSG="No tilt calibration needed on this machine. Continuing..."
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[quad_gantry_level]
gantry_corners = 
	-60,-10
	410,420
points = 
	50,25
	50,275
	300,275
	300,25
speed = 350
horizontal_move_z = 12
retries = 5
retry_tolerance = 0.0075
max_adjust = 10

[virtual_sdcard]
path = ~/printer_data/gcodes
on_error_gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	STATUS_LEDS COLOR="ERROR"
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	_PROBE_ON_ERROR_ACTION
	{% endif %}

[exclude_object]

[idle_timeout]
timeout = 1800

[pause_resume]

[display_status]

[respond]

[force_move]
enable_force_move = True

[gcode_arcs]
resolution = 0.1

[gcode_macro CANCEL_PRINT]
rename_existing = BASE_CANCEL_PRINT
description = Cancel the print, retract 10mm of filament and park
gcode = 
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload_on_cancel_print = printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_cancel_print %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload_on_cancel_print %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	SDCARD_RESET_FILE
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_OFF
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}
	
	BASE_CANCEL_PRINT

[gcode_macro END_PRINT]
description = Stop the print and filter the atmosphere for 10min before shuting down
gcode = 
	{% set disable_motors_in_end_print = printer["gcode_macro _USER_VARIABLES"].disable_motors_in_end_print %}
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set light_intensity_end_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_end_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload = params.ERCF_UNLOAD_AT_END|default(printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_end_print)|int %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G92 E0
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if disable_motors_in_end_print %}
	M84
	{% endif %}
	
	
	
	
	{% if filter_enabled %}
	{% set FILTER_TIME = params.FILTER_TIME|default(600)|int %}
	START_FILTER SPEED=1
	UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED DURATION={FILTER_TIME}
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_end_print}
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}

[gcode_macro PARK]
description = Park the toolhead at the back and retract some filament if the nozzle is hot
gcode = 
	{% set E = params.E|default(1.7)|float %}
	
	{% set Px, Py = printer["gcode_macro _USER_VARIABLES"].park_position_xy|map('float') %}
	{% set park_lift_z = printer["gcode_macro _USER_VARIABLES"].park_lift_z %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	
	{% set z_safe = act_z + park_lift_z %}
	{% if z_safe > max_z %}
	{% set z_safe = max_z %}
	{% endif %}
	
	
	{% if printer.extruder.temperature > 185 and firmware_retraction_enabled %}
	G10
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	G0 X{Px} Y{Py} F{St}

[gcode_macro PAUSE]
rename_existing = BASE_PAUSE
description = Pause the print and park
gcode = 
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	
	{% if printer.pause_resume.is_paused %}
	RESPOND MSG="Print is already paused"
	{% else %}
	SAVE_GCODE_STATE NAME=PAUSE_state
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	BASE_PAUSE
	PARK
	{% endif %}

[gcode_macro RESUME]
rename_existing = BASE_RESUME
description = Resume the print after an optional unretract
gcode = 
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	
	{% if not printer.pause_resume.is_paused %}
	RESPOND MSG="Print is not paused. Resume ignored"
	{% else %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={St}
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	BASE_RESUME
	{% endif %}

[gcode_macro START_PRINT]
description = Machine heatup procedure before starting a print
variable_bed_temp = 0
variable_extruder_temp = 0
variable_z_adjust = 0
variable_soak = 0
variable_chamber_temp = 0
variable_chamber_maxtime = 0
variable_initial_tool = 0
variable_material = "XXX"
variable_fl_size = "0_0_0_0"
gcode = 
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_ADJUST = params.Z_ADJUST|default(0)|float %}
	{% set SOAK = params.SOAK|default(printer["gcode_macro _USER_VARIABLES"].print_default_soak)|int %}
	{% set CHAMBER_TEMP = params.CHAMBER|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_temp)|int %}
	{% set CHAMBER_MAXTIME = params.CHAMBER_MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	{% set INITIAL_TOOL = params.INITIAL_TOOL|default(0)|int %}
	{% set MATERIAL = params.MATERIAL|default(printer["gcode_macro _USER_VARIABLES"].print_default_material)|string %}
	{% set FL_SIZE = params.SIZE|default("0_0_0_0")|string %}
	
	
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=bed_temp VALUE={BED_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=extruder_temp VALUE={EXTRUDER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=soak VALUE={SOAK}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_temp VALUE={CHAMBER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_maxtime VALUE={CHAMBER_MAXTIME}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=initial_tool VALUE={INITIAL_TOOL}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=material VALUE='"{MATERIAL}"'
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=fl_size VALUE='"{FL_SIZE}"'
	
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_reset_stats_on_start_print = printer["gcode_macro _USER_VARIABLES"].ercf_reset_stats_on_start_print %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% if MATERIAL not in printer["gcode_macro _USER_VARIABLES"].material_parameters %}
	RESPOND MSG="Material '{MATERIAL}' is unknown!"
	{ action_raise_error("Add this new material to your material_parameters variable!") }
	{% else %}
	RESPOND MSG="Material '{MATERIAL}' is used"
	{% set material = printer["gcode_macro _USER_VARIABLES"].material_parameters[MATERIAL] %}
	{% endif %}
	
	
	
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="BUSY"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if ercf_reset_stats_on_start_print %}
	ERCF_RESET_STATS
	{% endif %}
	{% endif %}
	{% endif %}
	
	SET_GCODE_OFFSET Z=0
	M221 S100
	M220 S100
	G90
	M83
	
	
	{% if firmware_retraction_enabled %}
	SET_RETRACTION RETRACT_LENGTH={material.retract_length} RETRACT_SPEED={material.retract_speed} UNRETRACT_EXTRA_LENGTH={material.unretract_extra_length} UNRETRACT_SPEED={material.unretract_speed}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={material.pressure_advance}
	
	
	{% if force_homing_in_start_print %}
	G28
	{% else %}
	_CG28
	{% endif %}
	
	
	
	{% set sp_actions = printer["gcode_macro _USER_VARIABLES"].startprint_actions %}
	{% for action in sp_actions %}
	{% if action == "bed_soak" %}
	_MODULE_HEATSOAK_BED
	{% elif action == "chamber_soak" %}
	_MODULE_HEATSOAK_CHAMBER
	{% elif action == "tilt_calib" %}
	_MODULE_TILTING
	{% elif action == "extruder_heating" %}
	_MODULE_EXTRUDER_HEATING
	{% elif action == "purge" %}
	_MODULE_PURGE
	{% elif action == "clean" %}
	_MODULE_CLEAN
	{% elif action == "z_offset" %}
	_MODULE_Z_CALIB
	{% elif action == "bedmesh" %}
	_MODULE_BED_MESH
	{% elif action == "primeline" %}
	_MODULE_PRIMELINE
	{% elif action == "extruder_preheating" %}
	_MODULE_EXTRUDER_PREHEATING
	{% elif action == "custom1" %}
	_MODULE_CUSTOM1
	{% elif action == "custom2" %}
	_MODULE_CUSTOM2
	{% elif action == "custom3" %}
	_MODULE_CUSTOM3
	{% else %}
	{ action_raise_error("Unknown module called in START_PRINT! Please verify your startprint_actions variable override!") }
	{% endif %}
	{% endfor %}
	
	
	
	SET_GCODE_OFFSET Z_ADJUST={Z_ADJUST} MOVE=1
	
	
	SET_GCODE_OFFSET Z_ADJUST={material.additional_z_offset} MOVE=1
	{% if filter_enabled %}
	START_FILTER SPEED={material.filter_speed / 100}
	{% endif %}
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="PRINTING"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Start printing !"
	{% endif %}
	
	G92 E0.0

[gcode_macro _MODULE_PRIMELINE]
gcode = 
	PRIMELINE

[gcode_macro _MODULE_HEATSOAK_BED]
gcode = 
	
	
	
	
	
	{% set BED_TEMP = printer["gcode_macro START_PRINT"].bed_temp %}
	{% set SOAK = printer["gcode_macro START_PRINT"].soak %}
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if printer.heater_bed.target < (BED_TEMP - 8) %}
	
	
	{% if (CHAMBER_TEMP > 0) and filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	{% if SOAK > 0 %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME={SOAK}
	{% else %}
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME=0
	{% endif %}

[gcode_macro _MODULE_HEATSOAK_CHAMBER]
gcode = 
	
	
	
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	{% set CHAMBER_MAXTIME = printer["gcode_macro START_PRINT"].chamber_maxtime %}
	
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if chamber_sensor_enabled %}
	{% if CHAMBER_TEMP > 0 %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	
	{% if CURRENT_TEMP <= CHAMBER_TEMP %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	
	
	{% if filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	HEATSOAK_CHAMBER TEMP={CHAMBER_TEMP} MAXTIME={CHAMBER_MAXTIME}
	
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_TILTING]
gcode = 
	
	
	
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	_TILT_CALIBRATE FORCE={force_homing_in_start_print}

[gcode_macro _MODULE_EXTRUDER_HEATING]
gcode = 
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	{% set INITIAL_TOOL = printer["gcode_macro START_PRINT"].initial_tool %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder heating to print temperature..."
	{% endif %}
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET
	{% if not purge_and_brush_enabled %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	M109 S{EXTRUDER_TEMP}
	
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	ERCF_CHANGE_TOOL STANDALONE=1 TOOL={INITIAL_TOOL}
	_ERCF_ERROR_CHECK
	{% endif %}
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder temperature OK"
	{% endif %}

[gcode_macro _MODULE_PURGE]
gcode = 
	
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	
	{% if purge_and_brush_enabled %}
	PURGE TEMP={EXTRUDER_TEMP}
	{% endif %}

[gcode_macro _MODULE_CLEAN]
gcode = 
	
	
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set force_homing_before_brush = printer["gcode_macro _USER_VARIABLES"].force_homing_before_brush %}
	
	{% if purge_and_brush_enabled %}
	{% if force_homing_before_brush %}
	G28 Z
	{% endif %}
	CLEAN_NOZZLE
	{% endif %}

[gcode_macro _MODULE_Z_CALIB]
gcode = 
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% if bed_mesh_enabled and printer.bed_mesh.profile_name == "" %}
	COMPUTE_MESH_PARAMETERS SIZE={FL_SIZE}
	{% endif %}
	
	{% if zcalib_plugin_enabled %}
	G28 Z
	CALIBRATE_Z
	{% else %}
	G28 Z
	{% endif %}

[gcode_macro _MODULE_BED_MESH]
gcode = 
	
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if bed_mesh_enabled %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="MESHING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Bed mesh measurement..."
	{% endif %}
	
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	ADAPTIVE_BED_MESH
	{% else %}
	ADAPTIVE_BED_MESH SIZE={FL_SIZE}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_EXTRUDER_PREHEATING]
gcode = 
	
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Pre-heating the nozzle to a safe temperature..."
	{% endif %}
	
	M109 S{safe_extruder_temp}
	
	{% if verbose %}
	RESPOND MSG="Extruder at safe temperature of {safe_extruder_temp} degrees"
	{% endif %}

[gcode_macro _MODULE_CUSTOM1]
gcode = 

[gcode_macro _MODULE_CUSTOM2]
gcode = 

[gcode_macro _MODULE_CUSTOM3]
gcode = 

[gcode_macro _CG28]
description = Homing only if necessary
gcode = 
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	{% if "xyz" not in printer.toolhead.homed_axes %}
	G28
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[homing_override]
axes = xyz
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set homing_zhop = printer["gcode_macro _USER_VARIABLES"].homing_zhop|float %}
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed * 60 %}
	{% set homing_travel_accel = printer["gcode_macro _USER_VARIABLES"].homing_travel_accel %}
	{% set sensorless_homing_enabled = printer["gcode_macro _USER_VARIABLES"].sensorless_homing_enabled %}
	{% set sensorless_current_factor = printer["gcode_macro _USER_VARIABLES"].sensorless_current_factor / 100 %}
	{% set z_drop_speed = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% set homing_first = printer["gcode_macro _USER_VARIABLES"].homing_first|string|upper %}
	{% set x_homing_backoff, y_homing_backoff = printer["gcode_macro _USER_VARIABLES"].homing_backoff_distance_xy|map('float') %}
	
	{% set x_position_endstop = printer["configfile"].config["stepper_x"]["position_endstop"]|float %}
	{% set y_position_endstop = printer["configfile"].config["stepper_y"]["position_endstop"]|float %}
	{% set x_position_center = printer.toolhead.axis_maximum.x|int/2 - printer.toolhead.axis_minimum.x|int/2 %}
	{% set y_position_center = printer.toolhead.axis_maximum.y|int/2 - printer.toolhead.axis_minimum.y|int/2 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	{% set X, Y, Z = False, False, False %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	
	{% if not 'X' in params
	and not 'Y' in params
	and not 'Z' in params %}
	
	{% set X, Y, Z = True, True, True %}
	
	{% else %}
	{% if 'X' in params %}
	{% set X = True %}
	{% endif %}
	
	{% if 'Y' in params %}
	{% set Y = True %}
	{% endif %}
	
	{% if 'Z' in params %}
	{% set Z = True %}
	{% endif %}
	
	{% if 'X' in params
	and 'Y' in params
	and 'Z' in params %}
	
	
	_HOMING_VARIABLES reset=1
	{% endif %}
	
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_ENTRY_POINT FUNCTION=homing_override
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{homing_travel_accel}
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	G90
	
	{% if Z %}
	{% if ('z' in printer.toolhead.homed_axes) %}
	{% if (printer.toolhead.position.z < homing_zhop) %}
	{% if verbose %}
	{ action_respond_info("Z too low, performing ZHOP") }
	{% endif %}
	G0 Z{homing_zhop} F{z_drop_speed}
	{% endif %}
	{% elif ('xy' in printer.toolhead.homed_axes) %}
	{% if verbose %}
	{ action_respond_info("X and Y already homed, no ZHOP needed to home Z") }
	{% endif %}
	{% else %}
	{% if verbose %}
	{ action_respond_info("X and Y not homed, forcing full G28 to home Z properly") }
	{% endif %}
	SET_KINEMATIC_POSITION X=0 Y=0 Z=0
	G0 Z{homing_zhop} F{z_drop_speed}
	{% set X, Y, Z = True, True, True %}
	{% endif %}
	{% endif %}
	
	{% if homing_first == "X" %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% elif homing_first == "Y" %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% else %}
	{ action_respond_error("Axis homing order not valid. Choose either X or Y first in the variables.cfg file!") }
	{% endif %}
	
	
	
	{% if Z %}
	{% if verbose %}
	{ action_respond_info("Homing Z") }
	{% endif %}
	
	
	
	
	
	
	{% if printer["configfile"].config["stepper_z"]["endstop_pin"]|lower == "probe:z_virtual_endstop" %}
	
	{% if probe_type_enabled == "dockable_virtual" %}
	ACTIVATE_PROBE
	{% endif %}
	{% if bed_mesh_enabled %}
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	{% set mesh_center = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_center %}
	{% set x_mesh_center, y_mesh_center = mesh_center.split(',')|map('trim')|map('float') %}
	RESPOND MSG="Z homing: a mesh is computed and ready, probing mesh center: {mesh_center}"
	G0 X{x_mesh_center} Y{y_mesh_center} F{homing_travel_speed}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	
	
	{% else %}
	_GOTO_Z_PROBE
	{% endif %}
	
	
	{% if probe_type_enabled == "vorontap" %}
	ACTIVATE_PROBE
	{% endif %}
	
	G28 Z0
	
	G91
	G0 Z{homing_zhop} F{z_drop_speed}
	G90
	
	
	
	{% if probe_type_enabled == "vorontap" or probe_type_enabled == "dockable_virtual" %}
	DEACTIVATE_PROBE
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_EXIT_POINT FUNCTION=homing_override
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _GOTO_Z_PROBE]
description = Move to z probe avoiding the probe dock
gcode = 
	
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% if zcalib_plugin_enabled %}
	{% set z_endstop_x, z_endstop_y = printer["configfile"].config["z_calibration"]["nozzle_xy_position"].split(',')|map('trim')|map('float') %}
	{% else %}
	{% set z_endstop_x, z_endstop_y = printer["gcode_macro _USER_VARIABLES"].zendstop_position|map('float') %}
	{% endif %}
	
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed|float * 60 %}
	
	{% set probe_dock_location_x, probe_dock_location_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_location_xy|map('float') %}
	{% set probe_dock_margin_x, probe_dock_margin_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_margin_xy|map('float') %}
	
	{% set current_x = printer.toolhead.position.x|float %}
	{% set current_y = printer.toolhead.position.y|float %}
	
	SAVE_GCODE_STATE NAME=goto_ZProbe
	G90
	
	
	{% set avoid_dock = false %}
	{% if probe_dock_location_x < z_endstop_x|float %}
	
	
	{% if current_x < (probe_dock_location_x + probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% else %}
	
	
	{% if current_x > (probe_dock_location_x - probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% endif %}
	
	
	{% if avoid_dock == true  %}
	
	G0 Y{probe_dock_location_y - probe_dock_margin_y} F{homing_travel_speed}
	
	G0 X{z_endstop_x} F{homing_travel_speed}
	{% endif %}
	
	G0 X{z_endstop_x} Y{z_endstop_y} F{homing_travel_speed}
	
	RESTORE_GCODE_STATE NAME=goto_ZProbe

[gcode_macro CALIBRATE]
description = Calibrate the printer flow or pressure advance
gcode = 
	
	{% set TYPE = params.TYPE|default("")|string|lower %}
	
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set MATERIAL = params.MATERIAL|default("ABS")|string %}
	
	{% set center_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set center_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% if TYPE=="flow" %}
	
	{% set computed_size = (center_x - 20)|string + '_' + (center_y - 20)|string + '_' + (center_x + 20)|string + '_' + (center_y + 20)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	FLOW_MULTIPLIER_CALIBRATION EXTRUSION_WIDTH=0.471
	END_PRINT FILTER_TIME=0
	
	{% elif TYPE=="pressure_advance" %}
	
	{% set computed_size = (center_x - 60)|string + '_' + (center_y - 60)|string + '_' + (center_x + 60)|string + '_' + (center_y + 60)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	PRESSURE_ADVANCE_CALIBRATION
	END_PRINT FILTER_TIME=0
	
	{% else %}
	{action_respond_info("Please call this macro using TYPE= \"flow\" or \"pressure_advance\"")}
	{action_raise_error("not enough parameters to start a calibration!")}
	
	{% endif %}

[gcode_macro _FLOW_CALIB_VARIABLES]
variable_last_shell_thickness = 0.0
variable_last_evalue = 0.0
gcode = 

[gcode_macro FLOW_MULTIPLIER_CALIBRATION]
description = Print a small tower to calibrate the extrusion flow multiplier by measuring the shell
gcode = 
	
	
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	{% set do_retract = params.DO_RECTRACT|default(0)|int %}
	{% set print_size = params.PRINT_SIZE|default(40)|int %}
	{% set print_height = params.HEIGHT|default(15)|int %}
	{% set corner_radius = params.CORNER_RADIUS|default(8)|int %}
	{% set number_of_perimeters = params.PERIMETERS|default(2)|int %}
	{% set fan_speed = params.FAN_SPEED|default(20)|int %}
	
	{% set e_multiplier = params.EXTRUSION_MULTIPLIER|default(1.00)|float %}
	{% set filament_diameter = params.FILAMENT_DIAMETER|default(1.75)|float %}
	{% set extrusion_width = params.EXTRUSION_WIDTH|default(0.4)|float %}
	{% set layer_height = params.LAYER_HEIGHT|default(0.2)|float %}
	
	{% set retract_length = params.RETRACT_LENGTH|default(0.5)|float %}
	{% set initial_purge = params.PURGE_MM|default(1)|int %}
	{% set z_hop_height  = 2 * layer_height %}
	
	{% set feedrate_print = params.CONTROL_SPEED|default(100)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft = params.RAFT_SPEED|default(60)|int * 60 %}
	{% set feedrate_z = params.Z_LIFT_SPEED|default(20)|int * 60 %}
	{% set feedrate_retract = params.RETRACT_SPEED|default(50)|int * 60 %}
	
	
	
	
	{% set e_per_mm = ((extrusion_width - layer_height) * layer_height + 3.14159 * (layer_height / 2)**2) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set spacing = extrusion_width - layer_height * (1 - 3.14159 / 4) %}
	{% set shell_thickness = extrusion_width + (number_of_perimeters|float - 1) * spacing %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set x_start = max_x / 2 - print_size / 2 %}
	{% set y_start = max_y / 2 - print_size / 2 %}
	{% set x_end = x_start + print_size %}
	{% set y_end = y_start + print_size %}
	
	{% set num_raft_lines = ([print_size, max_x]|min / spacing)|round(0, 'floor')|int %}
	{% set raft_size = num_raft_lines * spacing %}
	
	
	
	
	{action_respond_info("")}
	{action_respond_info("Starting extrusion flow calibration print")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	{action_respond_info("Exrusion multiplier used: %.4f" % e_multiplier)}
	{action_respond_info("Number of perimeters to print: %d" % number_of_perimeters)}
	{action_respond_info("THEORIC SHELL THICKNESS: %.4f" % shell_thickness)}
	{action_respond_info("")}
	{action_respond_info("Measure the shell thickness using a caliper or micrometer. Then call the computation macro with the measured value:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION
	
	
	
	
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_shell_thickness VALUE={shell_thickness}
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_evalue VALUE={e_multiplier}
	
	
	
	
	G90
	M83
	G92 E0.0
	G0 X{x_start} Y{y_start - 5} Z{layer_height} F{feedrate_travel}
	
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{raft_size} E{raft_size * e_per_mm * 1.5} F{feedrate_raft / 2}
	G1 Y-{extrusion_width} E{extrusion_width * e_per_mm} F{feedrate_raft / 2}
	G1 X-{raft_size} E{raft_size * e_per_mm} F{feedrate_raft / 2}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G90
	G0 X{x_start} Y{y_start} F{feedrate_travel}
	G1 Z{layer_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	
	
	M221 S{e_multiplier * 100}
	
	
	
	
	{% if do_raft == 1 %}
	G91
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	G1 Y{loop.cycle(1.0, -1.0) * raft_size} E{raft_size * e_per_mm} F{feedrate_raft}
	
	
	{% if not loop.last %}
	G1 X{spacing} E{spacing * e_per_mm} F{feedrate_raft}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	
	
	
	
	G90
	M106 S{fan_speed * 255 / 100}
	
	
	{% for curr_layer in range(1, (print_height / layer_height)|round|int) %}
	G0 X{x_start + corner_radius} Y{y_start} F{feedrate_travel}
	G1 Z{(curr_layer * layer_height) + (layer_height if do_raft == 1 else 0)} F{feedrate_z}
	
	
	{% for perim_num in range(number_of_perimeters) %}
	
	{% set perim_offset = perim_num * spacing %}
	{% set perim_radius = corner_radius - (perim_num * spacing) %}
	
	
	G1 X{x_start + corner_radius} Y{y_start + perim_offset} F{feedrate_travel}
	{% if do_retract == 1 %}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	
	
	G1 X{x_end - corner_radius} Y{y_start + perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - perim_offset} Y{y_start + corner_radius} J{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_end - perim_offset} Y{y_end - corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - corner_radius} Y{y_end - perim_offset} I-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + corner_radius} Y{y_end - perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + perim_offset} Y{y_end - corner_radius} J-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + perim_offset} Y{y_start + corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + corner_radius} Y{y_start + perim_offset} I{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	
	{% if do_retract == 1 %}
	G1 E-{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	
	{% if do_retract == 1 %}
	G91
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G91
	G0 Z20 F{feedrate_travel}
	
	RESTORE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION

[gcode_macro COMPUTE_FLOW_MULTIPLIER]
description = Compute a new flow multiplier by using the measured shell thickness on the calibration print
gcode = 
	{% set evalue = params.OLD_EXTRUSION_MULTIPLIER|default(0.0)|float %}
	{% set theorical_thickness = params.THEORICAL_THICKNESS|default(0.0)|float %}
	{% set measured_thickness = params.MEASURED_THICKNESS|default(0.0)|float %}
	
	
	{% if evalue == 0.0 %}
	{% set last_evalue = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_evalue %}
	
	
	{% if last_evalue == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_evalue = last_evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	{% else %}
	{% set final_evalue = evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	
	
	{% if theorical_thickness == 0.0 %}
	{% set last_shell_thickness = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_shell_thickness %}
	
	
	{% if last_shell_thickness == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_theorical_thickness = last_shell_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	{% else %}
	{% set final_theorical_thickness = theorical_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	
	
	{% if measured_thickness == 0.0 %}
	{action_respond_info("You must use a caliper or micrometer to measure the calibration print shell thickness and call this macro with the measured value !!!")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set new_evalue = final_theorical_thickness * final_evalue / measured_thickness %}
	{action_respond_info("NEW COMPUTED FLOW VALUE: %.3f" % new_evalue)}
	{action_respond_info("Use this new value as extrusion multiplier in your slicer of choice")}
	{action_respond_info("")}
	{% endif %}

[gcode_macro PRESSURE_ADVANCE_CALIBRATION]
description = Calibrate the pressure advance by printing a grid pattern
gcode = 
	
	
	
	{% set pa_start     = params.START|default(0.02)|float %}
	{% set pa_increment = params.INCREMENT|default(0.005)|float %}
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	
	{% set print_size      = params.PRINT_SIZE|default(120)|int %}
	{% set num_bands       = params.BANDS_LIMIT|default(999)|int %}
	{% set lines_per_band  = params.LINES_PER_BAND|default(6)|int %}
	{% set e_multiplier    = params.EXTRUSION_MULTIPLIER|default(1.25 if do_raft == 1 else 1.5)|float %},
	{% set retract_length  = params.RETRACT_LENGTH|default(0.6)|float %}
	{% set initial_purge   = params.PURGE_MM|default(8)|int %}
	
	{% set feedrate_control = params.CONTROL_SPEED|default(30)|int * 60 %}
	{% set feedrate_outer   = params.OUTER_SPEED|default(40)|int * 60 %}
	{% set feedrate_inner   = params.INNER_SPEED|default(120)|int * 60 %}
	{% set feedrate_travel  = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft    = params.RAFT_SPEED|default(120)|int * 60 %}
	{% set feedrate_z       = 5 * 60 %}
	{% set feedrate_retract = 50 * 60 %}
	
	{% set spacing_line  = params.LINE_SPACING|default(0.4)|float %}
	{% set spacing_band  = 2 %}
	{% set spacing_raft  = 2 %}
	
	{% set fast_line_ratio_percent = 50 %}
	
	{% set lines_per_band    = [2, lines_per_band]|max %}
	{% set e_multiplier      = [1, e_multiplier]|max %}
	{% set num_lines_control = (lines_per_band / 2)|round(0, 'floor')|int %}
	{% set num_lines_test    = (lines_per_band / 2)|round(0, 'ceil')|int %}
	{% set spacing_line      = spacing_line * (1 + e_multiplier - 1.25) %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set nozzle_diameter = printer.configfile.config['extruder'].nozzle_diameter|float %}
	{% set line_width    = nozzle_diameter * 1.25 %}
	{% set line_height   = nozzle_diameter / 2 %}
	{% set z_hop_height  = 2 * line_height %}
	{% set e_per_mm      = (line_width * line_height) / (3.1415 * (1.75/2)**2) %}
	{% set spacing_purge = line_height * 0.8 %}
	
	{% set spacing_raft   = (spacing_raft / line_width)|round * line_width %}
	{% set num_raft_lines = ([print_size, max_x]|min / spacing_raft)|round(0, 'floor')|int %}
	{% set print_width    = num_raft_lines * spacing_raft %}
	
	{% set band_height      = lines_per_band * line_width + (lines_per_band - 1) * spacing_line + spacing_band %}
	{% set bands_per_height = (([print_size, max_y]|min  - spacing_purge - 2 * line_width + spacing_band) / band_height)|round(0, 'floor')|int %}
	{% set num_bands        = [num_bands, bands_per_height]|min %}
	{% set print_height     = num_bands * band_height - spacing_band + spacing_purge +  2 * line_width %}
	
	{% set slow_line_length = ((print_width * (1 - fast_line_ratio_percent / 100) / 2) / spacing_raft)|round * spacing_raft + spacing_raft / 2 %}
	{% set fast_line_length = print_width - slow_line_length * 2 %}
	{% set thick_raft_num1 = (slow_line_length / spacing_raft)|round|int %}
	{% set thick_raft_num2  = num_raft_lines - thick_raft_num1 + 1 %}
	
	{% set x_start = max_x / 2 - print_width  / 2 %}
	{% set y_start = max_y / 2 - print_height / 2 %}
	
	{action_respond_info("")}
	{action_respond_info("Starting Pressure Advance calibration print.")}
	{action_respond_info("")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button once the print starts exhibiting PA values that are obviously too high.")}
	{action_respond_info("")}
	{action_respond_info("PA of first band: %.4f" % pa_start)}
	{action_respond_info("PA of last band: %.4f" % (pa_start + ((num_bands - 1) * pa_increment)))}
	{action_respond_info("PA increment per band: %.4f" % pa_increment)}
	{action_respond_info("Number of bands: %d" % num_bands)}
	{action_respond_info("")}
	{action_respond_info("Inspect the printed model. "
	"Look at the top and bottom lines in each band, on the right side of the two vertical raft bars (where the print speeds change). "
	"Find the highest band from the bottom where the lines at its top still resemble the lines at its bottom, with no visible extrusion width irregularities. "
	"Your final Pressure Advance value would then be:"
	)}
	{action_respond_info("")}
	{action_respond_info("Assuming that first band_number is 0")}
	{action_respond_info("PA = %.4f + (%.4f * band_number)" % (pa_start, pa_increment))}
	{action_respond_info("")}
	{action_respond_info("Update your [extruder] config section and set \"pressure_advance\" to the value you calculated.")}
	{action_respond_info("")}
	
	
	
	
	
	
	
	
	
	SAVE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION
	{% set pa_saved = printer.configfile.settings['extruder'].pressure_advance %}
	SET_PRESSURE_ADVANCE ADVANCE={pa_start}
	
	
	
	
	M221 S100
	
	
	
	
	M117 Priming
	G90
	G0 X{x_start} Y{y_start} Z{line_height} F{feedrate_travel}
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{print_width}  E{print_width * e_per_mm} F{feedrate_raft / 2}
	G1 Y{line_width}   E{line_width * e_per_mm}  F{feedrate_raft / 2}
	G1 X-{print_width} E{print_width * e_per_mm} F{feedrate_raft / 2}
	
	
	
	
	{% if do_raft == 1 %}
	G0 F{feedrate_raft}
	
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	{% if curr_raft_line == thick_raft_num1 or curr_raft_line == thick_raft_num2 %}
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	G1 Y{loop.cycle(-1.0, 1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	{% endif %}
	
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	
	
	{% if not loop.last %}
	{% set horizontal_move = spacing_raft - (2 * line_width if curr_raft_line == thick_raft_num1 - 1 or curr_raft_line == thick_raft_num2 - 1 else 0) %}
	G1 X{horizontal_move} E{horizontal_move * e_per_mm}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	{% endif %}
	
	
	
	
	M117 Printing bands
	G90
	G0 X{x_start} Y{y_start + 2 * line_width + spacing_purge} F{feedrate_travel}
	G0 Z{line_height + (line_height if do_raft == 1 else 0)} F{feedrate_z}
	G91
	G1 E{retract_length} F{feedrate_retract}
	
	
	{% for curr_band_num in range(0, num_bands ) %}
	{% set outer_loop = loop %}
	
	{% set curr_pa_value = pa_start + curr_band_num * pa_increment %}
	SET_PRESSURE_ADVANCE ADVANCE={curr_pa_value}
	M117 Band {curr_band_num} PA {curr_pa_value|round(4)}
	
	
	{% for _ in range(num_lines_control) %}
	G1 X{print_width} E{print_width * e_per_mm * e_multiplier} F{feedrate_control}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G0 X-{print_width} Y{spacing_line + line_width} F{feedrate_travel}
	
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endfor %}
	
	
	{% for _ in range(num_lines_test) %}
	{% for data in [{'mm': slow_line_length, 'f': feedrate_outer}, {'mm': fast_line_length, 'f': feedrate_inner}, {'mm': slow_line_length, 'f': feedrate_outer}] %}
	G1 X{data.mm} E{data.mm * e_per_mm * e_multiplier} F{data.f}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	{% if not (outer_loop.last and loop.last) %}
	G0 X-{print_width} Y{(spacing_line if not loop.last else spacing_band) + line_width} F{feedrate_travel}
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z20 F{feedrate_z}
	G0 X-{print_width / 2} Y{[50, max_y - (y_start + print_height)]|min} F{feedrate_travel}
	
	M117
	SET_PRESSURE_ADVANCE ADVANCE={pa_saved}
	RESTORE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION

[gcode_macro CHANGE_FILAMENT]
description = Do a PAUSE, park the toolhead over the purge bucket and unload the filament
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	SAVE_GCODE_STATE NAME=CHANGE_FILAMENT_state
	PAUSE
	UNLOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=CHANGE_FILAMENT_state

[gcode_macro UNLOAD_FILAMENT]
description = Basic unload of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to unload filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to unload filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	
	_TIP_SHAPING
	M83
	G1 E-20 F3600
	G4 P3000
	G1 E{DISTANCE|float * -1} F3000
	
	RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament unloaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament unloaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro LOAD_FILAMENT]
description = Basic load of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to load filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to load filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=LOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	M83
	G92 E0
	G1 E{DISTANCE|float} F200
	G1 E50 F150
	
	G92 E0
	RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament loaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament loaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _TIP_SHAPING]
description = Filament tip shaping sequence
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=TIP_SHAPING_state
	_LOW_TEMP_CHECK T={TEMP}
	
	{% set old_pressure_advance = printer.extruder.pressure_advance|default(0) %}
	
	SET_PRESSURE_ADVANCE ADVANCE=0
	
	M82
	G92 E0
	G1 E2 F3600
	G1 E0 F3600
	G1 E3 F3600
	G1 E0 F3600
	G1 E4 F3600
	G1 E0 F3600
	
	
	SET_PRESSURE_ADVANCE ADVANCE={old_pressure_advance}
	RESTORE_GCODE_STATE NAME=TIP_SHAPING_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_CHAMBER]
description = Heatsoak chamber to a specific temperature with a timeout
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set MAXTIME = params.MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% for _ in range(1, MAXTIME) %}
	_WAIT_CHAMBER_TEMP TEMP={SETPOINT_TEMP}
	{% endfor %}
	{% if verbose %}
	RESPOND MSG="Chamber temperature OK !"
	{% endif %}
	{% endif %}

[gcode_macro _WAIT_CHAMBER_TEMP]
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	{% if CURRENT_TEMP <= SETPOINT_TEMP %}
	RESPOND MSG="Heating up the chamber : {CURRENT_TEMP}/{SETPOINT_TEMP}"
	G4 P{60000 * 1}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_BED]
description = Heatsoak bed at specified temperature and wait for a specific amount of time
gcode = 
	{% set SETPOINT_TEMP = params.TEMP|default(0)|int %}
	{% set TIME = params.SOAKTIME|default(8)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set heaterbed_enabled = printer["gcode_macro _USER_VARIABLES"].heaterbed_enabled %}
	
	{% if heaterbed_enabled %}
	{% if verbose %}
	RESPOND MSG="Heating up bed..."
	{% endif %}
	
	M190 S{SETPOINT_TEMP}
	
	{% if TIME > 0 %}
	{% for i in range(0, TIME) %}
	RESPOND MSG="Heatsoak bed, {TIME-i}mn left..."
	G4 P{60000 * 1}
	{% endfor %}
	{% else %}
	RESPOND MSG="No heatsoak needed, continue"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Bed temperature OK"
	{% endif %}
	
	{% else %}
	{% if verbose %}
	RESPOND MSG="No bed heater defined: nothing to do, continuing..."
	{% endif %}
	{% endif %}

[gcode_macro PRIMELINE]
gcode = 
	
	{% set prime_line_length = params.LINE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_length)|float %}
	{% set prime_line_purge_distance = params.PURGE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_purge_distance)|float %}
	{% set prime_line_flowrate = params.FLOWRATE|default(printer["gcode_macro _USER_VARIABLES"].prime_line_flowrate)|float %}
	
	
	{% set prime_line_x, prime_line_y = printer["gcode_macro _USER_VARIABLES"].prime_line_xy|map('float') %}
	{% set prime_line_direction = printer["gcode_macro _USER_VARIABLES"].prime_line_direction|string|upper %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% set max_extrude_cross_section = printer["configfile"].config["extruder"]["max_extrude_cross_section"]|float %}
	{% set filament_diameter = printer["configfile"].config["extruder"]["filament_diameter"]|float %}
	
	{% set line_height = 0.6 %}
	
	
	{% set prime_line_x = params.START_X|default(prime_line_x)|float %}
	{% set prime_line_y = params.START_Y|default(prime_line_y)|float %}
	{% set prime_line_direction = params.LINE_DIRECTION|default(printer["gcode_macro _USER_VARIABLES"].prime_line_direction)|string|upper %}
	
	
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	
	
	
	{% if (line_height * line_width) > max_extrude_cross_section %}
	{% if verbose %}
	{action_respond_info("The prime_line_purge_distance of %.4f mm is too high and will exceed the max_extrude_cross_section!" % prime_line_purge_distance)}
	{% endif %}
	{% set prime_line_purge_distance = 0.98 * (max_extrude_cross_section * prime_line_length) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	{% if verbose %}
	{action_respond_info("Klippain corrected the prime_line_purge_distance to %.4f mm" % prime_line_purge_distance)}
	{% endif %}
	{% endif %}
	
	
	{% if (line_height / line_width) >= 0.5 %}
	{% if verbose %}
	{action_raise_error("The prime line will be too thin and will probably not stick properly to the bed. Increase its purge distance or decrease its length! Aborting...")}
	{% endif %}
	{% endif %}
	
	
	{% set speed = (prime_line_flowrate / (line_height * line_width)) * 60 |float %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% endif %}
	{% endif %}
	{% endif %}
	
	G91
	M83
	G1 Z5 F{Sz}
	
	
	G90
	G0 X{prime_line_x} Y{prime_line_y} F{St}
	G1 Z{line_height} F{Sz|int / 2}
	
	
	G92 E0
	G1 E18 F300
	
	
	G92 E0
	{% if prime_line_direction == "X" %}
	G1 X{prime_line_x + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% elif prime_line_direction == "Y" %}
	G1 Y{prime_line_y + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% else %}
	{ action_respond_error("Prime line direction is not valid. Choose either X or Y in the variables.cfg file!") }
	{% endif %}
	
	
	G92 E0
	G1 E-0.2 F2100
	G92 E0
	G1 Z3 F{Sz}
	M400
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection reactivated after the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro CLEAN_NOZZLE]
description = Wipe the nozzle on the brush
gcode = 
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set brush_clean_accel = printer["gcode_macro _USER_VARIABLES"].brush_clean_accel %}
	{% set brush_over_y_axis = printer["gcode_macro _USER_VARIABLES"].brush_over_y_axis %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set Sc = printer["gcode_macro _USER_VARIABLES"].brush_clean_speed * 60 %}
	
	{% set Bx, By, Bz = printer["gcode_macro _USER_VARIABLES"].brush_xyz|map('float') %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Nozzle cleaning..."
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{brush_clean_accel}
	
	
	G90
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP=1
	
	G1 X{Bx} Y{By} Z{Bz} F{St}
	
	
	G91
	{% if brush_over_y_axis %}
	{% for wipe in range(6) %}
	G1 Y-5 F{Sc}
	G1 Y+5 F{Sc}
	{% endfor %}
	{% endif %}
	
	G1 X+20 F{Sc}
	
	{% for wipe in range(6) %}
	G1 X-40 F{Sc}
	G1 X+40 F{Sc}
	{% endfor %}
	
	G90
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="clean"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro PURGE]
description = Purge a specific amount of filament ontop of the purge bucket
gcode = 
	{% set DISTANCE = params.DISTANCE|default(printer["gcode_macro _USER_VARIABLES"].purge_distance)|int %}
	{% set OOZE_TIME = params.OOZE_TIME|default(printer["gcode_macro _USER_VARIABLES"].purge_ooze_time)|int %}
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Purge filament..."
	{% endif %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% endif %}
	
	G90
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP={Z_DROP}
	
	
	_LOW_TEMP_CHECK T={TEMP}
	G92 E0
	G1 E{DISTANCE|float} F150
	
	
	G92 E0
	G1 E-1.7 F2100
	G1 E-18.3 F150
	G92 E0
	
	
	G4 P{OOZE_TIME * 1000}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _CONDITIONAL_MOVE_TO_PURGE_BUCKET]
description = Move over the purge bucket
gcode = 
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	
	{% if purge_and_brush_enabled %}
	SAVE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	G90
	
	{% if Z_DROP == 1 %}
	{% if purgeclean_servo_enabled %}
	G1 Z{Pz} F{Sz}
	_SERVO_DEPLOY ITEM="purge"
	{% endif %}
	G1 X{Px} Y{Py} Z{Pz} F{St}
	{% else %}
	
	
	
	G1 X{Px} Y{Py} F{St}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	{% endif %}

[gcode_macro _LOW_TEMP_CHECK]
description = Check the nozzle is at temperature and heat it if needed
gcode = 
	{% set T = params.T|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% if printer.extruder.target != 0 %}
	{% if printer.extruder.temperature < printer.extruder.target %}
	M109 S{printer.extruder.target|float}
	{% endif %}
	{% else %}
	{% if printer.extruder.target < T %}
	M109 S{T}
	{% endif %}
	{% endif %}

[gcode_macro M701]
description = Map M701 to LOAD_FILAMENT
gcode = 
	LOAD_FILAMENT

[gcode_macro M702]
description = Map M702 to UNLOAD_FILAMENT
gcode = 
	UNLOAD_FILAMENT

[gcode_macro M600]
description = Map M600 to CHANGE_FILAMENT
gcode = 
	CHANGE_FILAMENT

[gcode_macro M125]
description = Map M125 to PARK
gcode = 
	PARK

[gcode_macro M900]
description = Map M900 to SET_PRESSURE_ADVANCE
gcode = 
	{% if 'K' in params %}
	{% if 'E' in params %}
	SET_PRESSURE_ADVANCE EXTRUDER={params.E} ADVANCE={params.K}
	{% else %}
	SET_PRESSURE_ADVANCE ADVANCE={params.K}
	{% endif %}
	{% endif %}

[gcode_macro M204]
description = Map M204 to SET_VELOCITY_LIMIT for ACCEL and ACCEL_TO_DECEL
rename_existing = M204.1
gcode = 
	{% set F = params.F|default(printer["gcode_macro _USER_VARIABLES"].accel_to_decel_factor)|float %}
	
	{% if 'S' in params %}
	{% set S = params.S|float %}
	SET_VELOCITY_LIMIT ACCEL={S} ACCEL_TO_DECEL={S * F}
	{% endif %}

[gcode_macro M205]
description = Map M205 to SET_VELOCITY_LIMIT for SQUARE_CORNER_VELOCITY
gcode = 
	{% if 'X' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.X}
	{% elif 'Y' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.Y}
	{% endif %}

[gcode_macro G00]
gcode = 
	G0 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G01]
gcode = 
	G1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G02]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G03]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G04]
gcode = 
	G4 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro _SEARCH_VARS]
description = Search for variables in the "printer" object from Klipper
gcode = 
	{% set search = params.S|lower %}
	{% set ns = namespace() %}
	{% for item in printer  %}
	{% if ' ' in item %}
	{% set ns.path = ['printer', "['%s']" % (item), ''] %}
	{% else %}
	{% set ns.path = ['printer.', item, ''] %}
	{% endif %}
	
	{% if search in ns.path|lower %}
	{ action_respond_info(ns.path|join) }
	{% endif %}
	
	{% if printer[item].items() %}
	{% for childkey, child in printer[item].items() recursive %}
	{% set ns.path = ns.path[:loop.depth|int + 1] %}
	
	{% if ' ' in childkey %}
	{% set null = ns.path.append("['%s']" % (childkey)) %}
	{% else %}
	{% set null = ns.path.append(".%s" % (childkey)) %}
	{% endif %}
	
	{% if child is mapping  %}
	{ loop(child.items()) }
	{% else %}
	{% if search in ns.path|lower %}
	{ action_respond_info("%s : %s" % (ns.path|join, child)) }
	{% endif %}
	{% endif %}
	
	{% endfor %}
	{% endif %}
	{% endfor %}

[delayed_gcode KLIPPAIN_STARTUP]
initial_duration = 1
gcode = 
	_KLIPPAIN_STARTUP

[gcode_macro _KLIPPAIN_STARTUP]
gcode = 
	
	RUN_SHELL_COMMAND CMD=system_info
	
	
	_INIT_MCU_VER
	
	
	{% set extruder_enabled = printer["gcode_macro _USER_VARIABLES"].extruder_enabled %}
	{% if not extruder_enabled %}
	{ action_raise_error("Klippain need to have an extruder defined to work properly. Check your printer.cfg includes!") }
	{% endif %}
	
	
	_INIT_CHECKPROBECONF
	
	
	{% set e_driver = printer["gcode_macro _USER_VARIABLES"].e_driver|string %}
	{% if e_driver == "TMC2240" %}
	_INIT_TMC2240
	{% endif %}
	
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% if klippain_ercf_enabled %}
	_INIT_CHECK_ERCF
	{% endif %}
	
	
	_INIT_USERCUSTOM
	
	RESPOND MSG="Klippain started and ready !"

[gcode_macro _INIT_TMC2240]
gcode = 

[gcode_macro _INIT_CHECKPROBECONF]
gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled|string %}
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set qgl_enabled = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set ztilt_enabled = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	
	{% if zcalib_plugin_enabled %}
	{% if probe_type_enabled == "vorontap" %}
	{ action_raise_error("Voron TAP Probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "inductive" %}
	{ action_raise_error("Inductive probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "dockable_virtual" or probe_type_enabled == "inductive_virtual" %}
	{ action_raise_error("Virtual Z endstop probes are not compatible with the Z calibration plugin!") }
	{% elif probe_type_enabled == "none" %}
	{ action_raise_error("You need a probe to use the Z calibration plugin in Klippain!") }
	{% endif %}
	{% endif %}
	
	{% if bed_mesh_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a bed mesh in Klippain!") }
	{% endif %}
	
	{% if qgl_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a quad gantry leveling in Klippain!") }
	{% endif %}
	
	{% if ztilt_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a Z tilt adjust in Klippain!") }
	{% endif %}

[gcode_macro _INIT_MCU_VER]
gcode = 
	{% set parameters = namespace(output = 'Currently configured MCU(s): \n') %}
	{% for name1 in printer %}
	{% for name2 in printer[name1] %}
	{% set show = ['mcu_version'] %}
	{% if name2 is in show %}
	{% set param = "%s: %s" % (name1, printer[name1][name2]) %}
	{% set parameters.output = parameters.output +  param + "\n" %}
	{% endif %}
	{% endfor %}
	{% endfor %}
	{action_respond_info(parameters.output)}

[gcode_macro _INIT_CHECK_ERCF]
gcode = 
	{% if not printer.ercf.enabled %}
	{ action_raise_error("ERCF is enabled in Klippain, but Happy Hare, the supported ERCF backend software is not detected. Please install it now from https://github.com/moggieuk/ERCF-Software-V3 !") }
	{% endif %}

[gcode_macro _INIT_USERCUSTOM]
gcode = 

[gcode_shell_command plot_graph]
command = bash /home/pi/printer_data/config/scripts/plot_graphs.sh
timeout = 500.0
verbose = True

[gcode_shell_command system_info]
command = python3 /home/pi/printer_data/config/scripts/system_info.py
timeout = 5.0
verbose = True

[save_variables]
filename = ~/printer_data/config/save_variables.cfg

[tmc2209 stepper_z]
uart_pin = Z_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z1]
uart_pin = Z1_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z2]
uart_pin = Z2_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z3]
uart_pin = Z3_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 extruder]
uart_pin = toolhead:E_TMCUART
interpolate = false
run_current = 0.45
sense_resistor = 0.110
stealthchop_threshold = 0

[mcu]
canbus_uuid = f981df077b2c

[board_pins mcu_manufacturer]
aliases = 
	MCU_MOTOR0_STEP=PF13   , MCU_MOTOR0_DIR=PF12   , MCU_MOTOR0_ENABLE=PF14   , MCU_MOTOR0_UART=PC4    ,
	MCU_MOTOR1_STEP=PG0    , MCU_MOTOR1_DIR=PG1    , MCU_MOTOR1_ENABLE=PF15   , MCU_MOTOR1_UART=PD11   ,
	MCU_MOTOR2_1_STEP=PF11 , MCU_MOTOR2_1_DIR=PG3  , MCU_MOTOR2_1_ENABLE=PG5  , MCU_MOTOR2_1_UART=PC6  ,
	MCU_MOTOR3_STEP=PG4    , MCU_MOTOR3_DIR=PC1    , MCU_MOTOR3_ENABLE=PA0    , MCU_MOTOR3_UART=PC7    ,
	MCU_MOTOR4_STEP=PF9    , MCU_MOTOR4_DIR=PF10   , MCU_MOTOR4_ENABLE=PG2    , MCU_MOTOR4_UART=PF2    ,
	MCU_MOTOR5_STEP=PC13   , MCU_MOTOR5_DIR=PF0    , MCU_MOTOR5_ENABLE=PF1    , MCU_MOTOR5_UART=PE4    ,
	MCU_MOTOR6_STEP=PE2    , MCU_MOTOR6_DIR=PE3    , MCU_MOTOR6_ENABLE=PD4    , MCU_MOTOR6_UART=PE1    ,
	MCU_MOTOR7_STEP=PE6    , MCU_MOTOR7_DIR=PA14   , MCU_MOTOR7_ENABLE=PE0    , MCU_MOTOR7_UART=PD3    ,
	
	MCU_STOP0=PG6  , MCU_STOP1=PG9  , MCU_STOP2=PG10 , MCU_STOP3=PG11 ,
	MCU_STOP4=PG12 , MCU_STOP5=PG13 , MCU_STOP6=PG14 , MCU_STOP7=PG15 ,
	MCU_PROBE=PB7  ,
	MCU_SERVOS=PB6 ,
	
	MCU_HE0=PA2 , MCU_HE1=PA3 , MCU_HE2=PB10 , MCU_HE3=PB11 ,
	
	MCU_BED0=PA1 ,
	
	MCU_TB=PF3 ,
	MCU_T0=PF4 , MCU_T1=PF5 , MCU_T2=PF6 , MCU_T3=PF7 ,
	
	MCU_FAN0=PA8 , MCU_FAN1=PE5 , MCU_FAN2=PD12 , MCU_FAN3=PD13 , MCU_FAN4=PD14 , MCU_FAN5=PD15 ,
	
	MCU_NEOPIXEL=PB0  ,
	MCU_PS_ON=PE11    ,
	MCU_POWER_DET=PC0 ,
	
	
	EXP1_1=PE8   , EXP1_2=PE7   ,
	EXP1_3=PE9   , EXP1_4=PE10  ,
	EXP1_5=PE12  , EXP1_6=PE13  ,
	EXP1_7=PE14  , EXP1_8=PE15  ,
	EXP1_9=<GND> , EXP1_10=<5V> ,
	
	
	EXP2_1=PA6   , EXP2_2=PA5   ,
	EXP2_3=PB1   , EXP2_4=PA4   ,
	EXP2_5=PB2   , EXP2_6=PA7   ,
	EXP2_7=PC15  , EXP2_8=<RST> ,
	EXP2_9=<GND> , EXP2_10=<5V> ,

[board_pins octopus_mcu]
mcu = mcu
aliases = 
	X_STEP=MCU_MOTOR0_STEP   , X_DIR=MCU_MOTOR0_DIR   , X_ENABLE=MCU_MOTOR0_ENABLE   , X_TMCUART=MCU_MOTOR0_UART   ,
	Y_STEP=MCU_MOTOR1_STEP   , Y_DIR=MCU_MOTOR1_DIR   , Y_ENABLE=MCU_MOTOR1_ENABLE   , Y_TMCUART=MCU_MOTOR1_UART   ,
	
	Z_STEP=MCU_MOTOR2_1_STEP , Z_DIR=MCU_MOTOR2_1_DIR , Z_ENABLE=MCU_MOTOR2_1_ENABLE , Z_TMCUART=MCU_MOTOR2_1_UART ,
	Z1_STEP=MCU_MOTOR3_STEP  , Z1_DIR=MCU_MOTOR3_DIR  , Z1_ENABLE=MCU_MOTOR3_ENABLE  , Z1_TMCUART=MCU_MOTOR3_UART  ,
	Z2_STEP=MCU_MOTOR4_STEP  , Z2_DIR=MCU_MOTOR4_DIR  , Z2_ENABLE=MCU_MOTOR4_ENABLE  , Z2_TMCUART=MCU_MOTOR4_UART  ,
	Z3_STEP=MCU_MOTOR5_STEP  , Z3_DIR=MCU_MOTOR5_DIR  , Z3_ENABLE=MCU_MOTOR5_ENABLE  , Z3_TMCUART=MCU_MOTOR5_UART  ,
	
	E_STEP=MCU_MOTOR6_STEP   , E_DIR=MCU_MOTOR6_DIR   , E_ENABLE=MCU_MOTOR6_ENABLE   , E_TMCUART=MCU_MOTOR6_UART   ,
	
	X_STOP=MCU_STOP0 , Y_STOP=MCU_STOP1 , Z_STOP=MCU_STOP2 ,
	PROBE_INPUT=MCU_STOP7  ,
	RUNOUT_SENSOR=MCU_STOP3 ,
	
	E_HEATER=MCU_HE0   , E_TEMPERATURE=MCU_T0   ,
	BED_HEATER=MCU_HE1 , BED_TEMPERATURE=MCU_TB ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	CONTROLLER_FAN=MCU_FAN2        ,
	EXHAUST_FAN=MCU_FAN3           ,
	FILTER_FAN=MCU_FAN4            ,
	HOST_CONTROLLER_FAN=MCU_FAN5   ,
	
	CHAMBER_TEMPERATURE=MCU_T1 , ELECTRICAL_CABINET_TEMPERATURE=MCU_T2 ,
	
	LIGHT_OUTPUT=MCU_HE2         ,
	LIGHT_NEOPIXEL=MCU_STOP5     ,
	STATUS_NEOPIXEL=MCU_NEOPIXEL ,

[mcu toolhead]
canbus_uuid = 1b44cf5169c3

[board_pins toolhead_manufacturer]
mcu = toolhead
aliases = 
	MCU_EMOT_EN=gpio7 , MCU_EMOT_STEP=gpio9 , MCU_EMOT_DIR=gpio10 , MCU_EMOT_UART=gpio8 ,
	
	MCU_5V_ENDSTOP=gpio28 ,
	MCU_ENDSTOP=gpio29    ,
	MCU_HV_ENDSTOP=gpio25 ,
	
	MCU_FAN0=gpio13 , MCU_FAN1=gpio14 , MCU_FAN2=gpio15 ,
	
	MCU_TEMP=gpio27 , MCU_ONBOARD_NTCK100K=gpio26 ,
	
	MCU_HEAT=gpio6 ,
	
	MCU_RGB=gpio12 ,
	MCU_PWM0=gpio16 , MCU_PWM1=gpio17 ,
	
	MCU_ADXL_CS=gpio1 , MCU_ADXL_SCK=gpio0 , MCU_ADXL_MOSI=gpio3 , MCU_ADXL_MISO=gpio2 ,

[board_pins sb2040_mcu]
mcu = toolhead
aliases = 
	E_STEP=MCU_EMOT_STEP , E_DIR=MCU_EMOT_DIR , E_ENABLE=MCU_EMOT_EN , E_TMCUART=MCU_EMOT_UART ,
	
	X_STOP=MCU_ENDSTOP ,
	PROBE_INPUT=MCU_HV_ENDSTOP ,
	TOOLHEAD_SENSOR=MCU_5V_ENDSTOP ,
	
	E_HEATER=MCU_HEAT , E_TEMPERATURE=MCU_TEMP , CHAMBER_TEMPERATURE=MCU_ONBOARD_NTCK100K ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	
	STATUS_NEOPIXEL=MCU_RGB ,
	
	ADXL_CS=MCU_ADXL_CS , ADXL_SCLK=MCU_ADXL_SCK , ADXL_MOSI=MCU_ADXL_MOSI , ADXL_MISO=MCU_ADXL_MISO ,

[neopixel status_leds]
pin = toolhead:STATUS_NEOPIXEL
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting CAN connect
Created a socket
webhooks client 281473419311856: New connection
webhooks client 281473419311856: Client info {'program': 'Moonraker', 'version': 'v0.8.0-92-g504a3a7'}
Loaded MCU 'mcu' 107 commands (v0.11.0-110-gaca0c71a / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1=PB6,PB7 BUS_PINS_i2c1a=PB8,PB9 BUS_PINS_i2c2=PB10,PB11 BUS_PINS_i2c2a=PH4,PH5 BUS_PINS_i2c3=PA8,PC9 BUS_PINS_i2c3a=PH7,PH8 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3=PB4,PB5,PB3 BUS_PINS_spi3a=PC11,PC12,PC10 BUS_PINS_spi4=PE13,PE14,PE12 CANBUS_BRIDGE=1 CLOCK_FREQ=168000000 MCU=stm32f429xx PWM_MAX=255 RECEIVE_WINDOW=192 RESERVE_PINS_CAN=PD0,PD1 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PH0,PH1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu 'toolhead': Starting CAN connect
Created a socket
Loaded MCU 'toolhead' 107 commands (v0.11.0-201-g37315bf3 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'toolhead' config: ADC_MAX=4095 BUS_PINS_i2c0a=gpio0,gpio1 BUS_PINS_i2c0b=gpio4,gpio5 BUS_PINS_i2c0c=gpio8,gpio9 BUS_PINS_i2c0d=gpio12,gpio13 BUS_PINS_i2c0e=gpio16,gpio17 BUS_PINS_i2c0f=gpio20,gpio21 BUS_PINS_i2c0g=gpio24,gpio25 BUS_PINS_i2c0h=gpio28,gpio29 BUS_PINS_i2c1a=gpio2,gpio3 BUS_PINS_i2c1b=gpio6,gpio7 BUS_PINS_i2c1c=gpio10,gpio11 BUS_PINS_i2c1d=gpio14,gpio15 BUS_PINS_i2c1e=gpio18,gpio19 BUS_PINS_i2c1f=gpio22,gpio23 BUS_PINS_i2c1g=gpio26,gpio27 BUS_PINS_spi0a=gpio0,gpio3,gpio2 BUS_PINS_spi0b=gpio4,gpio7,gpio6 BUS_PINS_spi0c=gpio16,gpio19,gpio18 BUS_PINS_spi0d=gpio20,gpio23,gpio22 BUS_PINS_spi1a=gpio8,gpio11,gpio10 BUS_PINS_spi1b=gpio12,gpio15,gpio14 BUS_PINS_spi1c=gpio24,gpio27,gpio26 CANBUS_FREQUENCY=1000000 CLOCK_FREQ=12000000 INITIAL_PINS=gpio24 MCU=rp2040 PWM_MAX=255 RECEIVE_WINDOW=192 RESERVE_PINS_CAN=gpio4,gpio5 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu_temperature 'mcu' nominal base=-238.014440 slope=1182.671480
mcu_temperature 'toolhead' nominal base=437.226612 slope=-1917.489831
Sending MCU 'mcu' printer configuration...
Configured MCU 'mcu' (1024 moves)
Sending MCU 'toolhead' printer configuration...
Config error
Traceback (most recent call last):
  File "/home/orangepi/klipper/klippy/mcu.py", line 707, in _send_config
    self._serial.send(c)
  File "/home/orangepi/klipper/klippy/serialhdl.py", line 256, in send
    cmd = self.msgparser.create_command(msg)
  File "/home/orangepi/klipper/klippy/msgproto.py", line 350, in create_command
    cmd = mp.encode_by_name(**argparts)
  File "/home/orangepi/klipper/klippy/msgproto.py", line 181, in encode_by_name
    t.encode(out, params[name])
  File "/home/orangepi/klipper/klippy/msgproto.py", line 108, in encode
    raise enumeration_error(self.enum_name, v)
msgproto.enumeration_error: Unknown value 'MCU_ENDSTOP1' in enumeration 'pin'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/orangepi/klipper/klippy/klippy.py", line 180, in _connect
    cb()
  File "/home/orangepi/klipper/klippy/mcu.py", line 753, in _connect
    self._send_config(None)
  File "/home/orangepi/klipper/klippy/mcu.py", line 718, in _send_config
    raise self._printer.config_error(
configparser.Error: Pin 'MCU_ENDSTOP1' is not a valid pin name on mcu 'toolhead'
Attempting MCU 'toolhead' reset command
Attempting MCU 'mcu' reset command
b'Got error -1 in can read: (100)Network is down'
webhooks client 281473419311856: Disconnected
Restarting printer
Start printer at Tue Jul 11 14:52:25 2023 (1689105145.4 779.4)
===== Config file =====
[printer]
kinematics = corexz
max_velocity = 400
max_accel = 1000
max_z_velocity = 200
max_z_accel = 1000
square_corner_velocity = 5.0

[stepper_x]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = X_STEP
dir_pin = X_DIR
enable_pin = !X_ENABLE
endstop_pin = tmc2209_stepper_x:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_y]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = Y_STEP
dir_pin = Y_DIR
enable_pin = !Y_ENABLE
endstop_pin = tmc2209_stepper_y:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_z]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z_STEP
dir_pin = !Z_DIR
enable_pin = !Z_ENABLE
endstop_pin = probe:z_virtual_endstop
homing_speed = 15
second_homing_speed = 8
homing_retract_dist = 3.0
position_max = 310
position_min = -5

[stepper_z1]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z1_STEP
dir_pin = !Z1_DIR
enable_pin = !Z1_ENABLE

[stepper_z2]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z2_STEP
dir_pin = !Z2_DIR
enable_pin = !Z2_ENABLE

[stepper_z3]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z3_STEP
dir_pin = Z3_DIR
enable_pin = !Z3_ENABLE

[gcode_macro _USER_VARIABLES]
variable_extruder_enabled = True
gcode = 
variable_heaterbed_enabled = True
variable_probe_type_enabled = "vorontap"
variable_startprint_actions = "bed_soak", "extruder_preheating", "chamber_soak", "clean", "tilt_calib", "z_offset", "bedmesh", "extruder_heating", "purge", "clean", "primeline"
variable_status_leds_minidisplay_enabled = True
variable_status_leds_minidisplay_led_name = "btt_mini12864"
variable_bed_mesh_enabled = True
variable_sensorless_homing_enabled = True
variable_qgl_enabled = True
variable_verbose = True
variable_homing_travel_speed = 350
variable_travel_speed = 350
variable_z_drop_speed = 15
variable_brush_clean_speed = 100
variable_probe_dock_speed = 60
variable_homing_travel_accel = 3000
variable_tilting_travel_accel = 3000
variable_brush_clean_accel = 1500
variable_probe_dock_accel = 2000
variable_accel_to_decel_factor = 0.75
variable_zendstop_position = -1, -1
variable_force_homing_in_start_print = False
variable_homing_zhop = 5
variable_homing_first = "X"
variable_homing_backoff_distance_xy = -5, -5
variable_sensorless_current_factor = 75
variable_probe_dock_margin_xy = 0, 0
variable_safe_extruder_temp = 150
variable_prime_line_xy = 5, 2.5
variable_prime_line_direction = "X"
variable_prime_line_length = 40
variable_prime_line_purge_distance = 30
variable_prime_line_flowrate = 10
variable_park_position_xy = -1, -1
variable_park_lift_z = 50
variable_disable_motors_in_end_print = False
variable_turn_off_heaters_in_end_print = True
variable_min_bed_xy = 0, 0
variable_max_bed_xy = 9999, 9999
variable_probe_min_z_travel = 20
variable_probe_dock_location_xy = -1, -1
variable_probe_servo_angle_retracted = 0
variable_probe_servo_angle_deployed = 90
variable_probe_before_attach_position = "front"
variable_probe_after_attach_position = "front"
variable_probe_before_dock_position = "front"
variable_probe_after_dock_position = "left"
variable_probe_move_attach_length = 30
variable_probe_move_dock_length = 30
variable_autodock_on_probe_error = True
variable_tap_max_probing_temp = 150
variable_tap_deactivation_zhop = 5
variable_print_default_bed_temp = 105
variable_print_default_extruder_temp = 240
variable_print_default_chamber_temp = 0
variable_print_default_chamber_max_heating_time = 15
variable_print_default_soak = 8
variable_print_default_material = "XXX"
variable_material_parameters = {
	'PLA': {
	'pressure_advance': 0.0525,
	'retract_length': 0.75,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 0,
	'additional_z_offset': 0
	},
	'PET': {
	'pressure_advance': 0.0650,
	'retract_length': 1.4,
	'unretract_extra_length': 0,
	'retract_speed': 30,
	'unretract_speed': 20,
	'filter_speed': 0,
	'additional_z_offset': 0.020
	},
	'ABS': {
	'pressure_advance': 0.0480,
	'retract_length': 0.5,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 80,
	'additional_z_offset': 0
	}
	}
variable_ercf_unload_on_cancel_print = False
variable_ercf_unload_on_end_print = True
variable_ercf_reset_stats_on_start_print = False
variable_purge_and_brush_enabled = False
variable_force_homing_before_brush = False
variable_brush_over_y_axis = True
variable_brush_xyz = -1, -1, -1
variable_purge_bucket_xyz = -1, -1, -1
variable_purge_distance = 30
variable_purge_ooze_time = 10
variable_purgeclean_servo_angle_retracted = 0
variable_purgeclean_servo_angle_deployed = 90
variable_light_intensity_start_print = 100
variable_light_intensity_printing = 30
variable_light_intensity_end_print = 0
variable_fix_heaters_temperature_settle = False
variable_resonnance_test_point_xy = -1, -1
variable_resonnance_test_z_clearance = 50
variable_status_leds_colors = {
	'logo': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'nozzle': {
	'heating': {'r': 0.8, 'g': 0.35, 'b': 0.0, 'w':0.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'standby': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'caselight': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'minidisplay': {
	'on': {'r': 0.0, 'g': 0.2, 'b': 0.4, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'error': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'thermal': {
	'hot': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cold': {'r': 0.3, 'g': 0.0, 'b': 0.3, 'w': 0.0}
	}
	}
variable_x_driver = "TMC2209"
variable_y_driver = "TMC2209"
variable_z_driver = "TMC2209"
variable_e_driver = "TMC2209"

[extruder]
rotation_distance = 22.79234586
gear_ratio = 50:10
microsteps = 64
full_steps_per_rotation = 200
nozzle_diameter = 0.400
filament_diameter = 1.75
max_extrude_only_distance = 110
max_extrude_cross_section = 5
sensor_type = ATC Semitec 104GT-2
min_temp = 5
max_temp = 310
max_power = 1.0
min_extrude_temp = 170
pressure_advance = 0.045
pressure_advance_smooth_time = 0.040
step_pin = toolhead:E_STEP
dir_pin = toolhead:E_DIR
enable_pin = !toolhead:E_ENABLE
heater_pin = toolhead:E_HEATER
sensor_pin = toolhead:E_TEMPERATURE
control = pid
pid_kp = 34.626
pid_ki = 4.050
pid_kd = 74.014

[gcode_macro M109]
rename_existing = M109.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={S}
	{% else %}
	M109.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[heater_bed]
heater_pin = BED_HEATER
sensor_type = NTC 100K MGB18-104F39050L32
sensor_pin = BED_TEMPERATURE
max_power = 1
min_temp = 0
max_temp = 120
control = pid
pid_kp = 40.783
pid_ki = 1.007
pid_kd = 412.931

[gcode_macro M190]
rename_existing = M190.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={S}
	{% else %}
	M190.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[gcode_macro ACTIVATE_PROBE]
description = Put the machine in a state being able to probe
variable_temperature = 0
gcode = 
	{% set LOCK = params.LOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_max_probing_temp = printer["gcode_macro _USER_VARIABLES"].tap_max_probing_temp|float %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if LOCK %}
	_ATTACH_PROBE_LOCK
	{% else %}
	_ATTACH_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	SAVE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	
	{% set ACTUAL_TEMP = printer.extruder.temperature %}
	{% set TARGET_TEMP = printer.extruder.target %}
	
	SET_GCODE_VARIABLE MACRO=ACTIVATE_PROBE VARIABLE=temperature VALUE={TARGET_TEMP}
	
	{% if TARGET_TEMP > tap_max_probing_temp %}
	{ action_respond_info('Extruder temperature target of %.1fC is too high for TAP probing, lowering to %.1fC' % (TARGET_TEMP, tap_max_probing_temp)) }
	M106 S255
	M109 S{tap_max_probing_temp}
	M106 S0
	{% else %}
	
	{% if ACTUAL_TEMP > tap_max_probing_temp + 3 %}
	M106 S255
	TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={tap_max_probing_temp}
	M106 S0
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro DEACTIVATE_PROBE]
description = Revert the machine to a normal state after probing
gcode = 
	{% set UNLOCK = params.UNLOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_deactivation_zhop = printer["gcode_macro _USER_VARIABLES"].tap_deactivation_zhop %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if UNLOCK %}
	_DOCK_PROBE_UNLOCK
	{% else %}
	_DOCK_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	
	{% set z_safe = printer.toolhead.position.z + tap_deactivation_zhop %}
	{% if z_safe > printer.toolhead.axis_maximum.z %}
	{% set z_safe = printer.toolhead.axis_maximum.z %}
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	
	{% set old_target_temperature = printer["gcode_macro ACTIVATE_PROBE"].temperature %}
	M109 S{old_target_temperature}
	
	RESTORE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	{% endif %}

[probe]
pin = ^MCU_5V_ENDSTOP
x_offset = 0
y_offset = 0
z_offset = -0.45
speed = 3
lift_speed = 10
samples = 3
samples_result = median
sample_retract_dist = 1.0
samples_tolerance = 0.007
samples_tolerance_retries = 3

[heater_fan hotend_fan]
pin = toolhead:E_FAN
max_power = 1.0
kick_start_time = 0.100
heater = extruder
heater_temp = 50.0

[fan]
pin = toolhead:PART_FAN
kick_start_time = 0.100
cycle_time = 0.010

[gcode_macro _SET_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = params.LED|string %}
	{% set idx = (params.IDX|string).split(',') %}
	{% set transmit_last = params.TRANSMIT|default(1) %}
	
	{% for led_index in idx %}
	{% set transmit=transmit_last if loop.last else 0 %}
	SET_LED LED={led} RED={red} GREEN={green} BLUE={blue} WHITE={white} INDEX={led_index} TRANSMIT={transmit}
	{% endfor %}

[gcode_macro _SET_LEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_idx"] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_ALLLEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	SET_LED LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w}  TRANSMIT={transmit}

[gcode_macro _SET_LOGO_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_NOZZLE_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro SET_LOGO_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="logo" COLOR="off" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_ON]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="on" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="off" TRANSMIT={transmit}

[gcode_macro STATUS_LEDS]
gcode = 
	{% set color = params.COLOR|default('off')|lower %}
	
	{% set status_color = {
	'ready': {
	'logo': 'standby',
	'nozzle': 'standby',
	'caselight': 'standby',
	'minidisplay': 'on'
	},
	'busy': {
	'logo': 'busy',
	'nozzle': 'on',
	'caselight': 'busy',
	'minidisplay': 'on'
	},
	'heating': {
	'logo': 'heating',
	'nozzle': 'heating',
	'caselight': 'heating',
	'minidisplay': 'on'
	},
	'leveling': {
	'logo': 'leveling',
	'nozzle': 'on',
	'caselight': 'leveling',
	'minidisplay': 'on'
	},
	'homing': {
	'logo': 'homing',
	'nozzle': 'on',
	'caselight': 'homing',
	'minidisplay': 'on'
	},
	'cleaning': {
	'logo': 'cleaning',
	'nozzle': 'on',
	'caselight': 'cleaning',
	'minidisplay': 'on'
	},
	'meshing': {
	'logo': 'meshing',
	'nozzle': 'on',
	'caselight': 'meshing',
	'minidisplay': 'on'
	},
	'calibrating_z': {
	'logo': 'calibrating_z',
	'nozzle': 'on',
	'caselight': 'calibrating_z',
	'minidisplay': 'on'
	},
	'printing': {
	'logo': 'printing',
	'nozzle': 'on',
	'caselight': 'printing',
	'minidisplay': 'on'
	},
	'off': {
	'logo': 'off',
	'nozzle': 'off',
	'caselight': 'off',
	'minidisplay': 'off'
	},
	'on': {
	'logo': 'on',
	'nozzle': 'on',
	'caselight': 'on',
	'minidisplay': 'on'
	},
	'error': {
	'logo': 'error',
	'nozzle': 'error',
	'caselight': 'error',
	'minidisplay': 'error'
	}
	} %}
	
	{% if not (color in status_color) %}
	{ action_raise_error("COLOR is not valid!") }
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	_SET_LEDS_BY_NAME LEDS="logo" COLOR={status_color[color].logo} TRANSMIT=0
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR={status_color[color].nozzle} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_caselight_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="caselight" COLOR={status_color[color].caselight} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_minidisplay_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="minidisplay" COLOR={status_color[color].minidisplay} TRANSMIT=1
	{% endif %}

[display]
lcd_type = uc1701
cs_pin = EXP1_3
a0_pin = EXP1_4
rst_pin = EXP1_5
encoder_pins = ^EXP2_5, ^EXP2_3
click_pin = ^!EXP1_2
contrast = 63
spi_software_miso_pin = EXP2_1
spi_software_mosi_pin = EXP2_6
spi_software_sclk_pin = EXP2_2

[output_pin beeper]
pin = EXP1_1

[neopixel btt_mini12864]
pin = EXP1_6
chain_count = 3
initial_red = 0.1
initial_green = 0.5
initial_blue = 0.0
color_order = RGB

[delayed_gcode setdisplayneopixel]
initial_duration = 1
gcode = 
	SET_LED LED=btt_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3

[temperature_sensor RaspberryPi]
sensor_type = temperature_host

[temperature_sensor mcu]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 90

[temperature_sensor toolhead_mcu]
sensor_type = temperature_mcu
sensor_mcu = toolhead
min_temp = 0
max_temp = 100

[adxl345]
cs_pin = toolhead:ADXL_CS
spi_software_sclk_pin = toolhead:ADXL_SCLK
spi_software_mosi_pin = toolhead:ADXL_MOSI
spi_software_miso_pin = toolhead:ADXL_MISO
axes_map = x,y,z

[resonance_tester]
accel_chip = adxl345
probe_points = 
	-1,-1,-1

[gcode_macro TEST_RESONANCES]
rename_existing = BASE_TEST_RESONANCES
description = Runs input shaper test at the center of the bed
gcode = 
	{% set Tx, Ty = printer["gcode_macro _USER_VARIABLES"].resonnance_test_point_xy|map('float') %}
	{% set Tz = printer["gcode_macro _USER_VARIABLES"].resonnance_test_z_clearance|float %}
	
	{% if Tx == -1 and Ty == -1 %}
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	BASE_TEST_RESONANCES POINT={max_x / 2},{max_y / 2},{Tz} {rawparams}
	{% else %}
	BASE_TEST_RESONANCES POINT={Tx},{Ty},{Tz} {rawparams}
	{% endif %}

[gcode_macro AXES_SHAPER_CALIBRATION]
description = Run standard input shaper test for all axes
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.3)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=X FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=Y FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=SHAPER

[gcode_macro BELTS_SHAPER_CALIBRATION]
description = Run custom demi-axe test to analyze belts on CoreXY printers
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.33)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=1,1 OUTPUT=raw_data NAME=b FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=a FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=BELTS

[gcode_macro EXCITATE_AXIS_AT_FREQ]
description = Maintain a specified input shaper excitating frequency for some time to diagnose vibrations
gcode = 
	{% set FREQUENCY = params.FREQUENCY|default(25)|int %}
	{% set TIME = params.TIME|default(10)|int %}
	{% set AXIS = params.AXIS|default("x")|string|lower %}
	
	TEST_RESONANCES OUTPUT=raw_data AXIS={AXIS} FREQ_START={FREQUENCY-1} FREQ_END={FREQUENCY+1} HZ_PER_SEC={1/(TIME/3)}
	M400

[gcode_macro VIBRATIONS_CALIBRATION]
gcode = 
	
	
	
	{% set size = params.SIZE|default(60)|int %}
	{% set direction = params.DIRECTION|default('XY') %}
	{% set z_height = params.Z_HEIGHT|default(20)|int %}
	{% set verbose = params.VERBOSE|default(true) %}
	
	{% set min_speed = params.MIN_SPEED|default(20)|int * 60 %}
	{% set max_speed = params.MAX_SPEED|default(200)|int * 60 %}
	{% set speed_increment = params.SPEED_INCREMENT|default(2)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	
	{% set accel_chip = params.ACCEL_CHIP|default("adxl345") %}
	
	
	
	
	{% set mid_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set mid_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% set direction_factor = {
	'XY'  : {
	'start' : {'x': -0.5, 'y': -0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': -0.5, 'y': -0.5, 'z': 0.0 }
	}
	},
	'AB' : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': 0.0, 'y': 0.0, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	},
	'ABXY' : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'B'  : {
	'start' : {'x': 0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'A'  : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'X'  : {
	'start' : {'x': -0.5, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': 0.0, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.0, 'z': 0.0 }
	}
	},
	'Y'  : {
	'start' : {'x': 0.0, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.0, 'y': 0.5, 'z': 0.0 }
	}
	},
	'Z'  : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': 0.0, 'z': 1.0 },
	'1' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	}
	}
	%}
	
	
	
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	{% if (size / (max_speed / 60)) < 0.25 %}
	{ action_raise_error("SIZE is too small for this MAX_SPEED. Increase SIZE or decrease MAX_SPEED!") }
	{% endif %}
	
	{% if not (direction in direction_factor) %}
	{ action_raise_error("DIRECTION is not valid. Only XY, AB, ABXY, A, B, X, Y or Z is allowed!") }
	{% endif %}
	
	{action_respond_info("")}
	{action_respond_info("Starting speed and vibration calibration")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION
	
	G90
	
	
	G1 Z{z_height}
	G1 X{mid_x + (size * direction_factor[direction].start.x) } Y{mid_y + (size * direction_factor[direction].start.y)} F{feedrate_travel}
	
	
	{% for curr_speed in range(min_speed, max_speed + speed_increment) %}
	{% if (curr_speed - min_speed) % speed_increment == 0 %}
	{% if verbose %}
	RESPOND MSG="Current speed: {(curr_speed / 60)|int} mm/s"
	{% endif %}
	
	ACCELEROMETER_MEASURE CHIP={accel_chip}
	{% for key, factor in direction_factor[direction].move_factors|dictsort %}
	G1 X{mid_x + (size * factor.x) } Y{mid_y + (size * factor.y)} Z{z_height + (size * factor.z)} F{curr_speed}
	{% endfor %}
	ACCELEROMETER_MEASURE CHIP={accel_chip} NAME=sp{(curr_speed / 60)|int}n1
	
	G4 P300
	M400
	{% endif %}
	{% endfor %}
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS="VIBRATIONS {direction}"
	
	RESTORE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = _BASE_BED_MESH_CALIBRATE
description = Perform Mesh Bed Leveling with klicky automount
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if verbose %}
	{ action_respond_info("Bed Mesh Calibrate") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	_BASE_BED_MESH_CALIBRATE  {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	DEACTIVATE_PROBE

[gcode_macro _ADAPTIVE_MESH_VARIABLES]
variable_ready = False
variable_do_mesh = False
variable_do_nominal = False
variable_mesh_min = 0,0
variable_mesh_max = 0,0
variable_mesh_center = 0,0
variable_probe_count = 0,0
variable_rri = 0
variable_algo = "bicubic"
gcode = 

[gcode_macro COMPUTE_MESH_PARAMETERS]
description = Compute the mesh parameters and store them for later use
gcode = 
	
	{% set xMinConf, yMinConf = printer["configfile"].config["bed_mesh"]["mesh_min"].split(',')|map('trim')|map('int') %}
	{% set xMaxConf, yMaxConf = printer["configfile"].config["bed_mesh"]["mesh_max"].split(',')|map('trim')|map('int') %}
	{% set xProbeCntConf, yProbeCntConf = printer["configfile"].config["bed_mesh"]["probe_count"].split(',')|map('trim')|map('int') %}
	{% set algo = printer["configfile"].config["bed_mesh"]["algorithm"]|lower %}
	{% set xMeshPPS, yMeshPPS = (printer["configfile"].config["bed_mesh"]["mesh_pps"]|default('2,2')).split(',')|map('trim')|map('int') %}
	
	{% set margin = params.MARGIN|default(5)|int %}
	{% set force_mesh = params.FORCE_MESH|default(False) %}
	
	
	
	
	{% if params.SIZE is defined and params.SIZE != "0_0_0_0" %}
	RESPOND MSG="Got a SIZE parameter for the adaptive bed mesh"
	{% set xMinSpec, yMinSpec, xMaxSpec, yMaxSpec = params.SIZE.split('_')|map('trim')|map('int') %}
	
	{% elif printer.exclude_object.objects %}
	
	
	RESPOND MSG="No SIZE parameter, using the [exclude_object] tags for the adaptive bed mesh"
	{% set eo_points = printer.exclude_object.objects|map(attribute='polygon')|sum(start=[]) %}
	{% set xMinSpec = eo_points|map(attribute=0)|min %}
	{% set yMinSpec = eo_points|map(attribute=1)|min %}
	{% set xMaxSpec = eo_points|map(attribute=0)|max %}
	{% set yMaxSpec = eo_points|map(attribute=1)|max %}
	
	{% else %}
	
	
	RESPOND MSG="No info about the first layer coordinates, doing a nominal bed mesh instead of adaptive"
	{% endif %}
	
	
	
	
	{% if xMinSpec and yMinSpec and xMaxSpec and yMaxSpec %}
	
	
	
	
	{% set xMin = [xMinConf, (xMinSpec - margin)]|max %}
	{% set xMax = [xMaxConf, (xMaxSpec + margin)]|min %}
	{% set yMin = [yMinConf, (yMinSpec - margin)]|max %}
	{% set yMax = [yMaxConf, (yMaxSpec + margin)]|min %}
	
	
	
	
	{% set xProbeCnt = ((xMax - xMin) * xProbeCntConf / (xMaxConf - xMinConf))|round(0, 'ceil')|int %}
	{% set yProbeCnt = ((yMax - yMin) * yProbeCntConf / (yMaxConf - yMinConf))|round(0, 'ceil')|int %}
	
	
	
	
	
	
	
	
	{% if xProbeCnt < 3 and yProbeCnt < 3 %}
	{% if force_mesh %}
	RESPOND MSG="Bed mesh forced (small part detected): meshing 3x3..."
	{% set xProbeCnt = 3 %}
	{% set yProbeCnt = 3 %}
	{% set rRefIndex = 4 %}
	{% set algo = "lagrange" %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% else %}
	RESPOND MSG="Computed mesh parameters: none, bed mesh not needed for very small parts"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={False}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	{% else %}
	{% set xProbeCnt = [3, xProbeCnt]|max %}
	{% set yProbeCnt = [3, yProbeCnt]|max %}
	
	
	
	{% if xProbeCnt % 2 == 0 %}
	{% set xProbeCnt = xProbeCnt + 1 %}
	{% endif %}
	{% if yProbeCnt % 2 == 0 %}
	{% set yProbeCnt = yProbeCnt + 1 %}
	{% endif %}
	
	
	{% if xMeshPPS != 0 or yMeshPPS != 0 %}
	{% set probeCntMin = [xProbeCnt, yProbeCnt]|min %}
	{% set probeCntMax = [xProbeCnt, yProbeCnt]|max %}
	{% if algo == "lagrange" and probeCntMax > 6 %}
	
	{% set algo = "bicubic" %}
	{% endif %}
	{% if algo == "bicubic" and probeCntMin < 4 %}
	{% if probeCntMax > 6 %}
	
	{% if xProbeCnt > yProbeCnt %}
	{% set yProbeCnt = 5 %}
	{% else %}
	{% set xProbeCnt = 5 %}
	{% endif %}
	{% else %}
	
	{% set algo = "lagrange" %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	{% set rRefIndex = (((xProbeCnt * yProbeCnt) - 1) / 2)|int %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	
	
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% endif %}
	{% else %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={True}
	
	{% set xCenter = xMinConf + ((xMaxConf - xMinConf) / 2) %}
	{% set yCenter = yMinConf + ((yMaxConf - yMinConf) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={True}

[gcode_macro ADAPTIVE_BED_MESH]
description = Perform a bed mesh, but only where and when it's needed
gcode = 
	{% set ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	
	{% if ready %}
	_DO_ADAPTIVE_MESH
	
	
	
	{% else %}
	RESPOND MSG="Adaptive bed mesh: parameters not already computed, automatically calling the COMPUTE_MESH_PARAMETERS macro prior to the mesh"
	COMPUTE_MESH_PARAMETERS {rawparams}
	M400
	_DO_ADAPTIVE_MESH
	{% endif %}

[gcode_macro _DO_ADAPTIVE_MESH]
gcode = 
	
	{% set do_mesh = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_mesh %}
	{% set do_nominal = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_nominal %}
	{% set mesh_min = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_min %}
	{% set mesh_max = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_max %}
	{% set probe_count = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].probe_count %}
	{% set rRefIndex = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].rri %}
	{% set algo = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].algo %}
	
	
	
	
	{% if do_mesh %}
	
	{% if do_nominal %}
	RESPOND MSG="Adaptive bed mesh: nominal bed mesh"
	BED_MESH_CALIBRATE
	{% else %}
	{% if printer["configfile"].config["bed_mesh"]["relative_reference_index"] is defined %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}
	{% endif %}
	{% endif %}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: no mesh to be done"
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={False}

[bed_mesh]
speed = 350
horizontal_move_z = 12
mesh_min = 25, 25
mesh_max = 325, 325
probe_count = 9, 9
fade_start = 0.6
fade_end = 10.0
algorithm = bicubic
relative_reference_index = 40

[tmc2209 stepper_x]
diag_pin = ^X_STOP
driver_sgthrs = 50
uart_pin = X_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_y]
diag_pin = ^Y_STOP
driver_sgthrs = 60
uart_pin = Y_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[input_shaper]
shaper_freq_x = 56.4
shaper_type_x = zv
shaper_freq_y = 38.4
shaper_type_y = mzv

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing = _BASE_QUAD_GANTRY_LEVEL
description = Conform a moving, twistable gantry to the shape of a stationary bed with klicky automount
gcode = 
	{% set tilting_travel_accel = printer["gcode_macro _USER_VARIABLES"].tilting_travel_accel %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if verbose %}
	{ action_respond_info("Quad gantry leveling") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{tilting_travel_accel}
	
	_BASE_QUAD_GANTRY_LEVEL {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	DEACTIVATE_PROBE

[gcode_macro _TILT_CALIBRATE]
description = Do a QGL, Z_tilt, etc... depending of the machine configuration
gcode = 
	{% set FORCE_OPERATION = params.FORCE|default(true) %}
	{% set conf_QGL = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set conf_ztilt = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="LEVELING"
	{% endif %}
	
	{% if conf_QGL %}
	{% if printer.quad_gantry_level.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="QGL..."
	{% endif %}
	QUAD_GANTRY_LEVEL
	{% endif %}
	{% elif conf_ztilt %}
	{% if printer.z_tilt.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="Z tilt adjust..."
	{% endif %}
	Z_TILT_ADJUST
	{% endif %}
	{% else %}
	{% if verbose %}
	RESPOND MSG="No tilt calibration needed on this machine. Continuing..."
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[quad_gantry_level]
gantry_corners = 
	-60,-10
	410,420
points = 
	50,25
	50,275
	300,275
	300,25
speed = 350
horizontal_move_z = 12
retries = 5
retry_tolerance = 0.0075
max_adjust = 10

[virtual_sdcard]
path = ~/printer_data/gcodes
on_error_gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	STATUS_LEDS COLOR="ERROR"
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	_PROBE_ON_ERROR_ACTION
	{% endif %}

[exclude_object]

[idle_timeout]
timeout = 1800

[pause_resume]

[display_status]

[respond]

[force_move]
enable_force_move = True

[gcode_arcs]
resolution = 0.1

[gcode_macro CANCEL_PRINT]
rename_existing = BASE_CANCEL_PRINT
description = Cancel the print, retract 10mm of filament and park
gcode = 
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload_on_cancel_print = printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_cancel_print %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload_on_cancel_print %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	SDCARD_RESET_FILE
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_OFF
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}
	
	BASE_CANCEL_PRINT

[gcode_macro END_PRINT]
description = Stop the print and filter the atmosphere for 10min before shuting down
gcode = 
	{% set disable_motors_in_end_print = printer["gcode_macro _USER_VARIABLES"].disable_motors_in_end_print %}
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set light_intensity_end_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_end_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload = params.ERCF_UNLOAD_AT_END|default(printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_end_print)|int %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G92 E0
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if disable_motors_in_end_print %}
	M84
	{% endif %}
	
	
	
	
	{% if filter_enabled %}
	{% set FILTER_TIME = params.FILTER_TIME|default(600)|int %}
	START_FILTER SPEED=1
	UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED DURATION={FILTER_TIME}
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_end_print}
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}

[gcode_macro PARK]
description = Park the toolhead at the back and retract some filament if the nozzle is hot
gcode = 
	{% set E = params.E|default(1.7)|float %}
	
	{% set Px, Py = printer["gcode_macro _USER_VARIABLES"].park_position_xy|map('float') %}
	{% set park_lift_z = printer["gcode_macro _USER_VARIABLES"].park_lift_z %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	
	{% set z_safe = act_z + park_lift_z %}
	{% if z_safe > max_z %}
	{% set z_safe = max_z %}
	{% endif %}
	
	
	{% if printer.extruder.temperature > 185 and firmware_retraction_enabled %}
	G10
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	G0 X{Px} Y{Py} F{St}

[gcode_macro PAUSE]
rename_existing = BASE_PAUSE
description = Pause the print and park
gcode = 
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	
	{% if printer.pause_resume.is_paused %}
	RESPOND MSG="Print is already paused"
	{% else %}
	SAVE_GCODE_STATE NAME=PAUSE_state
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	BASE_PAUSE
	PARK
	{% endif %}

[gcode_macro RESUME]
rename_existing = BASE_RESUME
description = Resume the print after an optional unretract
gcode = 
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	
	{% if not printer.pause_resume.is_paused %}
	RESPOND MSG="Print is not paused. Resume ignored"
	{% else %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={St}
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	BASE_RESUME
	{% endif %}

[gcode_macro START_PRINT]
description = Machine heatup procedure before starting a print
variable_bed_temp = 0
variable_extruder_temp = 0
variable_z_adjust = 0
variable_soak = 0
variable_chamber_temp = 0
variable_chamber_maxtime = 0
variable_initial_tool = 0
variable_material = "XXX"
variable_fl_size = "0_0_0_0"
gcode = 
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_ADJUST = params.Z_ADJUST|default(0)|float %}
	{% set SOAK = params.SOAK|default(printer["gcode_macro _USER_VARIABLES"].print_default_soak)|int %}
	{% set CHAMBER_TEMP = params.CHAMBER|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_temp)|int %}
	{% set CHAMBER_MAXTIME = params.CHAMBER_MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	{% set INITIAL_TOOL = params.INITIAL_TOOL|default(0)|int %}
	{% set MATERIAL = params.MATERIAL|default(printer["gcode_macro _USER_VARIABLES"].print_default_material)|string %}
	{% set FL_SIZE = params.SIZE|default("0_0_0_0")|string %}
	
	
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=bed_temp VALUE={BED_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=extruder_temp VALUE={EXTRUDER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=soak VALUE={SOAK}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_temp VALUE={CHAMBER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_maxtime VALUE={CHAMBER_MAXTIME}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=initial_tool VALUE={INITIAL_TOOL}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=material VALUE='"{MATERIAL}"'
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=fl_size VALUE='"{FL_SIZE}"'
	
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_reset_stats_on_start_print = printer["gcode_macro _USER_VARIABLES"].ercf_reset_stats_on_start_print %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% if MATERIAL not in printer["gcode_macro _USER_VARIABLES"].material_parameters %}
	RESPOND MSG="Material '{MATERIAL}' is unknown!"
	{ action_raise_error("Add this new material to your material_parameters variable!") }
	{% else %}
	RESPOND MSG="Material '{MATERIAL}' is used"
	{% set material = printer["gcode_macro _USER_VARIABLES"].material_parameters[MATERIAL] %}
	{% endif %}
	
	
	
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="BUSY"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if ercf_reset_stats_on_start_print %}
	ERCF_RESET_STATS
	{% endif %}
	{% endif %}
	{% endif %}
	
	SET_GCODE_OFFSET Z=0
	M221 S100
	M220 S100
	G90
	M83
	
	
	{% if firmware_retraction_enabled %}
	SET_RETRACTION RETRACT_LENGTH={material.retract_length} RETRACT_SPEED={material.retract_speed} UNRETRACT_EXTRA_LENGTH={material.unretract_extra_length} UNRETRACT_SPEED={material.unretract_speed}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={material.pressure_advance}
	
	
	{% if force_homing_in_start_print %}
	G28
	{% else %}
	_CG28
	{% endif %}
	
	
	
	{% set sp_actions = printer["gcode_macro _USER_VARIABLES"].startprint_actions %}
	{% for action in sp_actions %}
	{% if action == "bed_soak" %}
	_MODULE_HEATSOAK_BED
	{% elif action == "chamber_soak" %}
	_MODULE_HEATSOAK_CHAMBER
	{% elif action == "tilt_calib" %}
	_MODULE_TILTING
	{% elif action == "extruder_heating" %}
	_MODULE_EXTRUDER_HEATING
	{% elif action == "purge" %}
	_MODULE_PURGE
	{% elif action == "clean" %}
	_MODULE_CLEAN
	{% elif action == "z_offset" %}
	_MODULE_Z_CALIB
	{% elif action == "bedmesh" %}
	_MODULE_BED_MESH
	{% elif action == "primeline" %}
	_MODULE_PRIMELINE
	{% elif action == "extruder_preheating" %}
	_MODULE_EXTRUDER_PREHEATING
	{% elif action == "custom1" %}
	_MODULE_CUSTOM1
	{% elif action == "custom2" %}
	_MODULE_CUSTOM2
	{% elif action == "custom3" %}
	_MODULE_CUSTOM3
	{% else %}
	{ action_raise_error("Unknown module called in START_PRINT! Please verify your startprint_actions variable override!") }
	{% endif %}
	{% endfor %}
	
	
	
	SET_GCODE_OFFSET Z_ADJUST={Z_ADJUST} MOVE=1
	
	
	SET_GCODE_OFFSET Z_ADJUST={material.additional_z_offset} MOVE=1
	{% if filter_enabled %}
	START_FILTER SPEED={material.filter_speed / 100}
	{% endif %}
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="PRINTING"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Start printing !"
	{% endif %}
	
	G92 E0.0

[gcode_macro _MODULE_PRIMELINE]
gcode = 
	PRIMELINE

[gcode_macro _MODULE_HEATSOAK_BED]
gcode = 
	
	
	
	
	
	{% set BED_TEMP = printer["gcode_macro START_PRINT"].bed_temp %}
	{% set SOAK = printer["gcode_macro START_PRINT"].soak %}
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if printer.heater_bed.target < (BED_TEMP - 8) %}
	
	
	{% if (CHAMBER_TEMP > 0) and filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	{% if SOAK > 0 %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME={SOAK}
	{% else %}
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME=0
	{% endif %}

[gcode_macro _MODULE_HEATSOAK_CHAMBER]
gcode = 
	
	
	
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	{% set CHAMBER_MAXTIME = printer["gcode_macro START_PRINT"].chamber_maxtime %}
	
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if chamber_sensor_enabled %}
	{% if CHAMBER_TEMP > 0 %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	
	{% if CURRENT_TEMP <= CHAMBER_TEMP %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	
	
	{% if filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	HEATSOAK_CHAMBER TEMP={CHAMBER_TEMP} MAXTIME={CHAMBER_MAXTIME}
	
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_TILTING]
gcode = 
	
	
	
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	_TILT_CALIBRATE FORCE={force_homing_in_start_print}

[gcode_macro _MODULE_EXTRUDER_HEATING]
gcode = 
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	{% set INITIAL_TOOL = printer["gcode_macro START_PRINT"].initial_tool %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder heating to print temperature..."
	{% endif %}
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET
	{% if not purge_and_brush_enabled %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	M109 S{EXTRUDER_TEMP}
	
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	ERCF_CHANGE_TOOL STANDALONE=1 TOOL={INITIAL_TOOL}
	_ERCF_ERROR_CHECK
	{% endif %}
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder temperature OK"
	{% endif %}

[gcode_macro _MODULE_PURGE]
gcode = 
	
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	
	{% if purge_and_brush_enabled %}
	PURGE TEMP={EXTRUDER_TEMP}
	{% endif %}

[gcode_macro _MODULE_CLEAN]
gcode = 
	
	
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set force_homing_before_brush = printer["gcode_macro _USER_VARIABLES"].force_homing_before_brush %}
	
	{% if purge_and_brush_enabled %}
	{% if force_homing_before_brush %}
	G28 Z
	{% endif %}
	CLEAN_NOZZLE
	{% endif %}

[gcode_macro _MODULE_Z_CALIB]
gcode = 
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% if bed_mesh_enabled and printer.bed_mesh.profile_name == "" %}
	COMPUTE_MESH_PARAMETERS SIZE={FL_SIZE}
	{% endif %}
	
	{% if zcalib_plugin_enabled %}
	G28 Z
	CALIBRATE_Z
	{% else %}
	G28 Z
	{% endif %}

[gcode_macro _MODULE_BED_MESH]
gcode = 
	
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if bed_mesh_enabled %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="MESHING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Bed mesh measurement..."
	{% endif %}
	
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	ADAPTIVE_BED_MESH
	{% else %}
	ADAPTIVE_BED_MESH SIZE={FL_SIZE}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_EXTRUDER_PREHEATING]
gcode = 
	
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Pre-heating the nozzle to a safe temperature..."
	{% endif %}
	
	M109 S{safe_extruder_temp}
	
	{% if verbose %}
	RESPOND MSG="Extruder at safe temperature of {safe_extruder_temp} degrees"
	{% endif %}

[gcode_macro _MODULE_CUSTOM1]
gcode = 

[gcode_macro _MODULE_CUSTOM2]
gcode = 

[gcode_macro _MODULE_CUSTOM3]
gcode = 

[gcode_macro _CG28]
description = Homing only if necessary
gcode = 
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	{% if "xyz" not in printer.toolhead.homed_axes %}
	G28
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[homing_override]
axes = xyz
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set homing_zhop = printer["gcode_macro _USER_VARIABLES"].homing_zhop|float %}
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed * 60 %}
	{% set homing_travel_accel = printer["gcode_macro _USER_VARIABLES"].homing_travel_accel %}
	{% set sensorless_homing_enabled = printer["gcode_macro _USER_VARIABLES"].sensorless_homing_enabled %}
	{% set sensorless_current_factor = printer["gcode_macro _USER_VARIABLES"].sensorless_current_factor / 100 %}
	{% set z_drop_speed = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% set homing_first = printer["gcode_macro _USER_VARIABLES"].homing_first|string|upper %}
	{% set x_homing_backoff, y_homing_backoff = printer["gcode_macro _USER_VARIABLES"].homing_backoff_distance_xy|map('float') %}
	
	{% set x_position_endstop = printer["configfile"].config["stepper_x"]["position_endstop"]|float %}
	{% set y_position_endstop = printer["configfile"].config["stepper_y"]["position_endstop"]|float %}
	{% set x_position_center = printer.toolhead.axis_maximum.x|int/2 - printer.toolhead.axis_minimum.x|int/2 %}
	{% set y_position_center = printer.toolhead.axis_maximum.y|int/2 - printer.toolhead.axis_minimum.y|int/2 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	{% set X, Y, Z = False, False, False %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	
	{% if not 'X' in params
	and not 'Y' in params
	and not 'Z' in params %}
	
	{% set X, Y, Z = True, True, True %}
	
	{% else %}
	{% if 'X' in params %}
	{% set X = True %}
	{% endif %}
	
	{% if 'Y' in params %}
	{% set Y = True %}
	{% endif %}
	
	{% if 'Z' in params %}
	{% set Z = True %}
	{% endif %}
	
	{% if 'X' in params
	and 'Y' in params
	and 'Z' in params %}
	
	
	_HOMING_VARIABLES reset=1
	{% endif %}
	
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_ENTRY_POINT FUNCTION=homing_override
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{homing_travel_accel}
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	G90
	
	{% if Z %}
	{% if ('z' in printer.toolhead.homed_axes) %}
	{% if (printer.toolhead.position.z < homing_zhop) %}
	{% if verbose %}
	{ action_respond_info("Z too low, performing ZHOP") }
	{% endif %}
	G0 Z{homing_zhop} F{z_drop_speed}
	{% endif %}
	{% elif ('xy' in printer.toolhead.homed_axes) %}
	{% if verbose %}
	{ action_respond_info("X and Y already homed, no ZHOP needed to home Z") }
	{% endif %}
	{% else %}
	{% if verbose %}
	{ action_respond_info("X and Y not homed, forcing full G28 to home Z properly") }
	{% endif %}
	SET_KINEMATIC_POSITION X=0 Y=0 Z=0
	G0 Z{homing_zhop} F{z_drop_speed}
	{% set X, Y, Z = True, True, True %}
	{% endif %}
	{% endif %}
	
	{% if homing_first == "X" %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% elif homing_first == "Y" %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% else %}
	{ action_respond_error("Axis homing order not valid. Choose either X or Y first in the variables.cfg file!") }
	{% endif %}
	
	
	
	{% if Z %}
	{% if verbose %}
	{ action_respond_info("Homing Z") }
	{% endif %}
	
	
	
	
	
	
	{% if printer["configfile"].config["stepper_z"]["endstop_pin"]|lower == "probe:z_virtual_endstop" %}
	
	{% if probe_type_enabled == "dockable_virtual" %}
	ACTIVATE_PROBE
	{% endif %}
	{% if bed_mesh_enabled %}
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	{% set mesh_center = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_center %}
	{% set x_mesh_center, y_mesh_center = mesh_center.split(',')|map('trim')|map('float') %}
	RESPOND MSG="Z homing: a mesh is computed and ready, probing mesh center: {mesh_center}"
	G0 X{x_mesh_center} Y{y_mesh_center} F{homing_travel_speed}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	
	
	{% else %}
	_GOTO_Z_PROBE
	{% endif %}
	
	
	{% if probe_type_enabled == "vorontap" %}
	ACTIVATE_PROBE
	{% endif %}
	
	G28 Z0
	
	G91
	G0 Z{homing_zhop} F{z_drop_speed}
	G90
	
	
	
	{% if probe_type_enabled == "vorontap" or probe_type_enabled == "dockable_virtual" %}
	DEACTIVATE_PROBE
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_EXIT_POINT FUNCTION=homing_override
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _GOTO_Z_PROBE]
description = Move to z probe avoiding the probe dock
gcode = 
	
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% if zcalib_plugin_enabled %}
	{% set z_endstop_x, z_endstop_y = printer["configfile"].config["z_calibration"]["nozzle_xy_position"].split(',')|map('trim')|map('float') %}
	{% else %}
	{% set z_endstop_x, z_endstop_y = printer["gcode_macro _USER_VARIABLES"].zendstop_position|map('float') %}
	{% endif %}
	
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed|float * 60 %}
	
	{% set probe_dock_location_x, probe_dock_location_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_location_xy|map('float') %}
	{% set probe_dock_margin_x, probe_dock_margin_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_margin_xy|map('float') %}
	
	{% set current_x = printer.toolhead.position.x|float %}
	{% set current_y = printer.toolhead.position.y|float %}
	
	SAVE_GCODE_STATE NAME=goto_ZProbe
	G90
	
	
	{% set avoid_dock = false %}
	{% if probe_dock_location_x < z_endstop_x|float %}
	
	
	{% if current_x < (probe_dock_location_x + probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% else %}
	
	
	{% if current_x > (probe_dock_location_x - probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% endif %}
	
	
	{% if avoid_dock == true  %}
	
	G0 Y{probe_dock_location_y - probe_dock_margin_y} F{homing_travel_speed}
	
	G0 X{z_endstop_x} F{homing_travel_speed}
	{% endif %}
	
	G0 X{z_endstop_x} Y{z_endstop_y} F{homing_travel_speed}
	
	RESTORE_GCODE_STATE NAME=goto_ZProbe

[gcode_macro CALIBRATE]
description = Calibrate the printer flow or pressure advance
gcode = 
	
	{% set TYPE = params.TYPE|default("")|string|lower %}
	
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set MATERIAL = params.MATERIAL|default("ABS")|string %}
	
	{% set center_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set center_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% if TYPE=="flow" %}
	
	{% set computed_size = (center_x - 20)|string + '_' + (center_y - 20)|string + '_' + (center_x + 20)|string + '_' + (center_y + 20)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	FLOW_MULTIPLIER_CALIBRATION EXTRUSION_WIDTH=0.471
	END_PRINT FILTER_TIME=0
	
	{% elif TYPE=="pressure_advance" %}
	
	{% set computed_size = (center_x - 60)|string + '_' + (center_y - 60)|string + '_' + (center_x + 60)|string + '_' + (center_y + 60)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	PRESSURE_ADVANCE_CALIBRATION
	END_PRINT FILTER_TIME=0
	
	{% else %}
	{action_respond_info("Please call this macro using TYPE= \"flow\" or \"pressure_advance\"")}
	{action_raise_error("not enough parameters to start a calibration!")}
	
	{% endif %}

[gcode_macro _FLOW_CALIB_VARIABLES]
variable_last_shell_thickness = 0.0
variable_last_evalue = 0.0
gcode = 

[gcode_macro FLOW_MULTIPLIER_CALIBRATION]
description = Print a small tower to calibrate the extrusion flow multiplier by measuring the shell
gcode = 
	
	
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	{% set do_retract = params.DO_RECTRACT|default(0)|int %}
	{% set print_size = params.PRINT_SIZE|default(40)|int %}
	{% set print_height = params.HEIGHT|default(15)|int %}
	{% set corner_radius = params.CORNER_RADIUS|default(8)|int %}
	{% set number_of_perimeters = params.PERIMETERS|default(2)|int %}
	{% set fan_speed = params.FAN_SPEED|default(20)|int %}
	
	{% set e_multiplier = params.EXTRUSION_MULTIPLIER|default(1.00)|float %}
	{% set filament_diameter = params.FILAMENT_DIAMETER|default(1.75)|float %}
	{% set extrusion_width = params.EXTRUSION_WIDTH|default(0.4)|float %}
	{% set layer_height = params.LAYER_HEIGHT|default(0.2)|float %}
	
	{% set retract_length = params.RETRACT_LENGTH|default(0.5)|float %}
	{% set initial_purge = params.PURGE_MM|default(1)|int %}
	{% set z_hop_height  = 2 * layer_height %}
	
	{% set feedrate_print = params.CONTROL_SPEED|default(100)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft = params.RAFT_SPEED|default(60)|int * 60 %}
	{% set feedrate_z = params.Z_LIFT_SPEED|default(20)|int * 60 %}
	{% set feedrate_retract = params.RETRACT_SPEED|default(50)|int * 60 %}
	
	
	
	
	{% set e_per_mm = ((extrusion_width - layer_height) * layer_height + 3.14159 * (layer_height / 2)**2) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set spacing = extrusion_width - layer_height * (1 - 3.14159 / 4) %}
	{% set shell_thickness = extrusion_width + (number_of_perimeters|float - 1) * spacing %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set x_start = max_x / 2 - print_size / 2 %}
	{% set y_start = max_y / 2 - print_size / 2 %}
	{% set x_end = x_start + print_size %}
	{% set y_end = y_start + print_size %}
	
	{% set num_raft_lines = ([print_size, max_x]|min / spacing)|round(0, 'floor')|int %}
	{% set raft_size = num_raft_lines * spacing %}
	
	
	
	
	{action_respond_info("")}
	{action_respond_info("Starting extrusion flow calibration print")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	{action_respond_info("Exrusion multiplier used: %.4f" % e_multiplier)}
	{action_respond_info("Number of perimeters to print: %d" % number_of_perimeters)}
	{action_respond_info("THEORIC SHELL THICKNESS: %.4f" % shell_thickness)}
	{action_respond_info("")}
	{action_respond_info("Measure the shell thickness using a caliper or micrometer. Then call the computation macro with the measured value:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION
	
	
	
	
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_shell_thickness VALUE={shell_thickness}
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_evalue VALUE={e_multiplier}
	
	
	
	
	G90
	M83
	G92 E0.0
	G0 X{x_start} Y{y_start - 5} Z{layer_height} F{feedrate_travel}
	
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{raft_size} E{raft_size * e_per_mm * 1.5} F{feedrate_raft / 2}
	G1 Y-{extrusion_width} E{extrusion_width * e_per_mm} F{feedrate_raft / 2}
	G1 X-{raft_size} E{raft_size * e_per_mm} F{feedrate_raft / 2}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G90
	G0 X{x_start} Y{y_start} F{feedrate_travel}
	G1 Z{layer_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	
	
	M221 S{e_multiplier * 100}
	
	
	
	
	{% if do_raft == 1 %}
	G91
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	G1 Y{loop.cycle(1.0, -1.0) * raft_size} E{raft_size * e_per_mm} F{feedrate_raft}
	
	
	{% if not loop.last %}
	G1 X{spacing} E{spacing * e_per_mm} F{feedrate_raft}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	
	
	
	
	G90
	M106 S{fan_speed * 255 / 100}
	
	
	{% for curr_layer in range(1, (print_height / layer_height)|round|int) %}
	G0 X{x_start + corner_radius} Y{y_start} F{feedrate_travel}
	G1 Z{(curr_layer * layer_height) + (layer_height if do_raft == 1 else 0)} F{feedrate_z}
	
	
	{% for perim_num in range(number_of_perimeters) %}
	
	{% set perim_offset = perim_num * spacing %}
	{% set perim_radius = corner_radius - (perim_num * spacing) %}
	
	
	G1 X{x_start + corner_radius} Y{y_start + perim_offset} F{feedrate_travel}
	{% if do_retract == 1 %}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	
	
	G1 X{x_end - corner_radius} Y{y_start + perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - perim_offset} Y{y_start + corner_radius} J{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_end - perim_offset} Y{y_end - corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - corner_radius} Y{y_end - perim_offset} I-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + corner_radius} Y{y_end - perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + perim_offset} Y{y_end - corner_radius} J-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + perim_offset} Y{y_start + corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + corner_radius} Y{y_start + perim_offset} I{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	
	{% if do_retract == 1 %}
	G1 E-{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	
	{% if do_retract == 1 %}
	G91
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G91
	G0 Z20 F{feedrate_travel}
	
	RESTORE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION

[gcode_macro COMPUTE_FLOW_MULTIPLIER]
description = Compute a new flow multiplier by using the measured shell thickness on the calibration print
gcode = 
	{% set evalue = params.OLD_EXTRUSION_MULTIPLIER|default(0.0)|float %}
	{% set theorical_thickness = params.THEORICAL_THICKNESS|default(0.0)|float %}
	{% set measured_thickness = params.MEASURED_THICKNESS|default(0.0)|float %}
	
	
	{% if evalue == 0.0 %}
	{% set last_evalue = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_evalue %}
	
	
	{% if last_evalue == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_evalue = last_evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	{% else %}
	{% set final_evalue = evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	
	
	{% if theorical_thickness == 0.0 %}
	{% set last_shell_thickness = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_shell_thickness %}
	
	
	{% if last_shell_thickness == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_theorical_thickness = last_shell_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	{% else %}
	{% set final_theorical_thickness = theorical_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	
	
	{% if measured_thickness == 0.0 %}
	{action_respond_info("You must use a caliper or micrometer to measure the calibration print shell thickness and call this macro with the measured value !!!")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set new_evalue = final_theorical_thickness * final_evalue / measured_thickness %}
	{action_respond_info("NEW COMPUTED FLOW VALUE: %.3f" % new_evalue)}
	{action_respond_info("Use this new value as extrusion multiplier in your slicer of choice")}
	{action_respond_info("")}
	{% endif %}

[gcode_macro PRESSURE_ADVANCE_CALIBRATION]
description = Calibrate the pressure advance by printing a grid pattern
gcode = 
	
	
	
	{% set pa_start     = params.START|default(0.02)|float %}
	{% set pa_increment = params.INCREMENT|default(0.005)|float %}
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	
	{% set print_size      = params.PRINT_SIZE|default(120)|int %}
	{% set num_bands       = params.BANDS_LIMIT|default(999)|int %}
	{% set lines_per_band  = params.LINES_PER_BAND|default(6)|int %}
	{% set e_multiplier    = params.EXTRUSION_MULTIPLIER|default(1.25 if do_raft == 1 else 1.5)|float %},
	{% set retract_length  = params.RETRACT_LENGTH|default(0.6)|float %}
	{% set initial_purge   = params.PURGE_MM|default(8)|int %}
	
	{% set feedrate_control = params.CONTROL_SPEED|default(30)|int * 60 %}
	{% set feedrate_outer   = params.OUTER_SPEED|default(40)|int * 60 %}
	{% set feedrate_inner   = params.INNER_SPEED|default(120)|int * 60 %}
	{% set feedrate_travel  = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft    = params.RAFT_SPEED|default(120)|int * 60 %}
	{% set feedrate_z       = 5 * 60 %}
	{% set feedrate_retract = 50 * 60 %}
	
	{% set spacing_line  = params.LINE_SPACING|default(0.4)|float %}
	{% set spacing_band  = 2 %}
	{% set spacing_raft  = 2 %}
	
	{% set fast_line_ratio_percent = 50 %}
	
	{% set lines_per_band    = [2, lines_per_band]|max %}
	{% set e_multiplier      = [1, e_multiplier]|max %}
	{% set num_lines_control = (lines_per_band / 2)|round(0, 'floor')|int %}
	{% set num_lines_test    = (lines_per_band / 2)|round(0, 'ceil')|int %}
	{% set spacing_line      = spacing_line * (1 + e_multiplier - 1.25) %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set nozzle_diameter = printer.configfile.config['extruder'].nozzle_diameter|float %}
	{% set line_width    = nozzle_diameter * 1.25 %}
	{% set line_height   = nozzle_diameter / 2 %}
	{% set z_hop_height  = 2 * line_height %}
	{% set e_per_mm      = (line_width * line_height) / (3.1415 * (1.75/2)**2) %}
	{% set spacing_purge = line_height * 0.8 %}
	
	{% set spacing_raft   = (spacing_raft / line_width)|round * line_width %}
	{% set num_raft_lines = ([print_size, max_x]|min / spacing_raft)|round(0, 'floor')|int %}
	{% set print_width    = num_raft_lines * spacing_raft %}
	
	{% set band_height      = lines_per_band * line_width + (lines_per_band - 1) * spacing_line + spacing_band %}
	{% set bands_per_height = (([print_size, max_y]|min  - spacing_purge - 2 * line_width + spacing_band) / band_height)|round(0, 'floor')|int %}
	{% set num_bands        = [num_bands, bands_per_height]|min %}
	{% set print_height     = num_bands * band_height - spacing_band + spacing_purge +  2 * line_width %}
	
	{% set slow_line_length = ((print_width * (1 - fast_line_ratio_percent / 100) / 2) / spacing_raft)|round * spacing_raft + spacing_raft / 2 %}
	{% set fast_line_length = print_width - slow_line_length * 2 %}
	{% set thick_raft_num1 = (slow_line_length / spacing_raft)|round|int %}
	{% set thick_raft_num2  = num_raft_lines - thick_raft_num1 + 1 %}
	
	{% set x_start = max_x / 2 - print_width  / 2 %}
	{% set y_start = max_y / 2 - print_height / 2 %}
	
	{action_respond_info("")}
	{action_respond_info("Starting Pressure Advance calibration print.")}
	{action_respond_info("")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button once the print starts exhibiting PA values that are obviously too high.")}
	{action_respond_info("")}
	{action_respond_info("PA of first band: %.4f" % pa_start)}
	{action_respond_info("PA of last band: %.4f" % (pa_start + ((num_bands - 1) * pa_increment)))}
	{action_respond_info("PA increment per band: %.4f" % pa_increment)}
	{action_respond_info("Number of bands: %d" % num_bands)}
	{action_respond_info("")}
	{action_respond_info("Inspect the printed model. "
	"Look at the top and bottom lines in each band, on the right side of the two vertical raft bars (where the print speeds change). "
	"Find the highest band from the bottom where the lines at its top still resemble the lines at its bottom, with no visible extrusion width irregularities. "
	"Your final Pressure Advance value would then be:"
	)}
	{action_respond_info("")}
	{action_respond_info("Assuming that first band_number is 0")}
	{action_respond_info("PA = %.4f + (%.4f * band_number)" % (pa_start, pa_increment))}
	{action_respond_info("")}
	{action_respond_info("Update your [extruder] config section and set \"pressure_advance\" to the value you calculated.")}
	{action_respond_info("")}
	
	
	
	
	
	
	
	
	
	SAVE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION
	{% set pa_saved = printer.configfile.settings['extruder'].pressure_advance %}
	SET_PRESSURE_ADVANCE ADVANCE={pa_start}
	
	
	
	
	M221 S100
	
	
	
	
	M117 Priming
	G90
	G0 X{x_start} Y{y_start} Z{line_height} F{feedrate_travel}
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{print_width}  E{print_width * e_per_mm} F{feedrate_raft / 2}
	G1 Y{line_width}   E{line_width * e_per_mm}  F{feedrate_raft / 2}
	G1 X-{print_width} E{print_width * e_per_mm} F{feedrate_raft / 2}
	
	
	
	
	{% if do_raft == 1 %}
	G0 F{feedrate_raft}
	
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	{% if curr_raft_line == thick_raft_num1 or curr_raft_line == thick_raft_num2 %}
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	G1 Y{loop.cycle(-1.0, 1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	{% endif %}
	
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	
	
	{% if not loop.last %}
	{% set horizontal_move = spacing_raft - (2 * line_width if curr_raft_line == thick_raft_num1 - 1 or curr_raft_line == thick_raft_num2 - 1 else 0) %}
	G1 X{horizontal_move} E{horizontal_move * e_per_mm}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	{% endif %}
	
	
	
	
	M117 Printing bands
	G90
	G0 X{x_start} Y{y_start + 2 * line_width + spacing_purge} F{feedrate_travel}
	G0 Z{line_height + (line_height if do_raft == 1 else 0)} F{feedrate_z}
	G91
	G1 E{retract_length} F{feedrate_retract}
	
	
	{% for curr_band_num in range(0, num_bands ) %}
	{% set outer_loop = loop %}
	
	{% set curr_pa_value = pa_start + curr_band_num * pa_increment %}
	SET_PRESSURE_ADVANCE ADVANCE={curr_pa_value}
	M117 Band {curr_band_num} PA {curr_pa_value|round(4)}
	
	
	{% for _ in range(num_lines_control) %}
	G1 X{print_width} E{print_width * e_per_mm * e_multiplier} F{feedrate_control}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G0 X-{print_width} Y{spacing_line + line_width} F{feedrate_travel}
	
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endfor %}
	
	
	{% for _ in range(num_lines_test) %}
	{% for data in [{'mm': slow_line_length, 'f': feedrate_outer}, {'mm': fast_line_length, 'f': feedrate_inner}, {'mm': slow_line_length, 'f': feedrate_outer}] %}
	G1 X{data.mm} E{data.mm * e_per_mm * e_multiplier} F{data.f}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	{% if not (outer_loop.last and loop.last) %}
	G0 X-{print_width} Y{(spacing_line if not loop.last else spacing_band) + line_width} F{feedrate_travel}
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z20 F{feedrate_z}
	G0 X-{print_width / 2} Y{[50, max_y - (y_start + print_height)]|min} F{feedrate_travel}
	
	M117
	SET_PRESSURE_ADVANCE ADVANCE={pa_saved}
	RESTORE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION

[gcode_macro CHANGE_FILAMENT]
description = Do a PAUSE, park the toolhead over the purge bucket and unload the filament
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	SAVE_GCODE_STATE NAME=CHANGE_FILAMENT_state
	PAUSE
	UNLOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=CHANGE_FILAMENT_state

[gcode_macro UNLOAD_FILAMENT]
description = Basic unload of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to unload filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to unload filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	
	_TIP_SHAPING
	M83
	G1 E-20 F3600
	G4 P3000
	G1 E{DISTANCE|float * -1} F3000
	
	RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament unloaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament unloaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro LOAD_FILAMENT]
description = Basic load of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to load filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to load filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=LOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	M83
	G92 E0
	G1 E{DISTANCE|float} F200
	G1 E50 F150
	
	G92 E0
	RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament loaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament loaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _TIP_SHAPING]
description = Filament tip shaping sequence
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=TIP_SHAPING_state
	_LOW_TEMP_CHECK T={TEMP}
	
	{% set old_pressure_advance = printer.extruder.pressure_advance|default(0) %}
	
	SET_PRESSURE_ADVANCE ADVANCE=0
	
	M82
	G92 E0
	G1 E2 F3600
	G1 E0 F3600
	G1 E3 F3600
	G1 E0 F3600
	G1 E4 F3600
	G1 E0 F3600
	
	
	SET_PRESSURE_ADVANCE ADVANCE={old_pressure_advance}
	RESTORE_GCODE_STATE NAME=TIP_SHAPING_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_CHAMBER]
description = Heatsoak chamber to a specific temperature with a timeout
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set MAXTIME = params.MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% for _ in range(1, MAXTIME) %}
	_WAIT_CHAMBER_TEMP TEMP={SETPOINT_TEMP}
	{% endfor %}
	{% if verbose %}
	RESPOND MSG="Chamber temperature OK !"
	{% endif %}
	{% endif %}

[gcode_macro _WAIT_CHAMBER_TEMP]
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	{% if CURRENT_TEMP <= SETPOINT_TEMP %}
	RESPOND MSG="Heating up the chamber : {CURRENT_TEMP}/{SETPOINT_TEMP}"
	G4 P{60000 * 1}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_BED]
description = Heatsoak bed at specified temperature and wait for a specific amount of time
gcode = 
	{% set SETPOINT_TEMP = params.TEMP|default(0)|int %}
	{% set TIME = params.SOAKTIME|default(8)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set heaterbed_enabled = printer["gcode_macro _USER_VARIABLES"].heaterbed_enabled %}
	
	{% if heaterbed_enabled %}
	{% if verbose %}
	RESPOND MSG="Heating up bed..."
	{% endif %}
	
	M190 S{SETPOINT_TEMP}
	
	{% if TIME > 0 %}
	{% for i in range(0, TIME) %}
	RESPOND MSG="Heatsoak bed, {TIME-i}mn left..."
	G4 P{60000 * 1}
	{% endfor %}
	{% else %}
	RESPOND MSG="No heatsoak needed, continue"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Bed temperature OK"
	{% endif %}
	
	{% else %}
	{% if verbose %}
	RESPOND MSG="No bed heater defined: nothing to do, continuing..."
	{% endif %}
	{% endif %}

[gcode_macro PRIMELINE]
gcode = 
	
	{% set prime_line_length = params.LINE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_length)|float %}
	{% set prime_line_purge_distance = params.PURGE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_purge_distance)|float %}
	{% set prime_line_flowrate = params.FLOWRATE|default(printer["gcode_macro _USER_VARIABLES"].prime_line_flowrate)|float %}
	
	
	{% set prime_line_x, prime_line_y = printer["gcode_macro _USER_VARIABLES"].prime_line_xy|map('float') %}
	{% set prime_line_direction = printer["gcode_macro _USER_VARIABLES"].prime_line_direction|string|upper %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% set max_extrude_cross_section = printer["configfile"].config["extruder"]["max_extrude_cross_section"]|float %}
	{% set filament_diameter = printer["configfile"].config["extruder"]["filament_diameter"]|float %}
	
	{% set line_height = 0.6 %}
	
	
	{% set prime_line_x = params.START_X|default(prime_line_x)|float %}
	{% set prime_line_y = params.START_Y|default(prime_line_y)|float %}
	{% set prime_line_direction = params.LINE_DIRECTION|default(printer["gcode_macro _USER_VARIABLES"].prime_line_direction)|string|upper %}
	
	
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	
	
	
	{% if (line_height * line_width) > max_extrude_cross_section %}
	{% if verbose %}
	{action_respond_info("The prime_line_purge_distance of %.4f mm is too high and will exceed the max_extrude_cross_section!" % prime_line_purge_distance)}
	{% endif %}
	{% set prime_line_purge_distance = 0.98 * (max_extrude_cross_section * prime_line_length) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	{% if verbose %}
	{action_respond_info("Klippain corrected the prime_line_purge_distance to %.4f mm" % prime_line_purge_distance)}
	{% endif %}
	{% endif %}
	
	
	{% if (line_height / line_width) >= 0.5 %}
	{% if verbose %}
	{action_raise_error("The prime line will be too thin and will probably not stick properly to the bed. Increase its purge distance or decrease its length! Aborting...")}
	{% endif %}
	{% endif %}
	
	
	{% set speed = (prime_line_flowrate / (line_height * line_width)) * 60 |float %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% endif %}
	{% endif %}
	{% endif %}
	
	G91
	M83
	G1 Z5 F{Sz}
	
	
	G90
	G0 X{prime_line_x} Y{prime_line_y} F{St}
	G1 Z{line_height} F{Sz|int / 2}
	
	
	G92 E0
	G1 E18 F300
	
	
	G92 E0
	{% if prime_line_direction == "X" %}
	G1 X{prime_line_x + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% elif prime_line_direction == "Y" %}
	G1 Y{prime_line_y + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% else %}
	{ action_respond_error("Prime line direction is not valid. Choose either X or Y in the variables.cfg file!") }
	{% endif %}
	
	
	G92 E0
	G1 E-0.2 F2100
	G92 E0
	G1 Z3 F{Sz}
	M400
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection reactivated after the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro CLEAN_NOZZLE]
description = Wipe the nozzle on the brush
gcode = 
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set brush_clean_accel = printer["gcode_macro _USER_VARIABLES"].brush_clean_accel %}
	{% set brush_over_y_axis = printer["gcode_macro _USER_VARIABLES"].brush_over_y_axis %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set Sc = printer["gcode_macro _USER_VARIABLES"].brush_clean_speed * 60 %}
	
	{% set Bx, By, Bz = printer["gcode_macro _USER_VARIABLES"].brush_xyz|map('float') %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Nozzle cleaning..."
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{brush_clean_accel}
	
	
	G90
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP=1
	
	G1 X{Bx} Y{By} Z{Bz} F{St}
	
	
	G91
	{% if brush_over_y_axis %}
	{% for wipe in range(6) %}
	G1 Y-5 F{Sc}
	G1 Y+5 F{Sc}
	{% endfor %}
	{% endif %}
	
	G1 X+20 F{Sc}
	
	{% for wipe in range(6) %}
	G1 X-40 F{Sc}
	G1 X+40 F{Sc}
	{% endfor %}
	
	G90
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="clean"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro PURGE]
description = Purge a specific amount of filament ontop of the purge bucket
gcode = 
	{% set DISTANCE = params.DISTANCE|default(printer["gcode_macro _USER_VARIABLES"].purge_distance)|int %}
	{% set OOZE_TIME = params.OOZE_TIME|default(printer["gcode_macro _USER_VARIABLES"].purge_ooze_time)|int %}
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Purge filament..."
	{% endif %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% endif %}
	
	G90
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP={Z_DROP}
	
	
	_LOW_TEMP_CHECK T={TEMP}
	G92 E0
	G1 E{DISTANCE|float} F150
	
	
	G92 E0
	G1 E-1.7 F2100
	G1 E-18.3 F150
	G92 E0
	
	
	G4 P{OOZE_TIME * 1000}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _CONDITIONAL_MOVE_TO_PURGE_BUCKET]
description = Move over the purge bucket
gcode = 
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	
	{% if purge_and_brush_enabled %}
	SAVE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	G90
	
	{% if Z_DROP == 1 %}
	{% if purgeclean_servo_enabled %}
	G1 Z{Pz} F{Sz}
	_SERVO_DEPLOY ITEM="purge"
	{% endif %}
	G1 X{Px} Y{Py} Z{Pz} F{St}
	{% else %}
	
	
	
	G1 X{Px} Y{Py} F{St}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	{% endif %}

[gcode_macro _LOW_TEMP_CHECK]
description = Check the nozzle is at temperature and heat it if needed
gcode = 
	{% set T = params.T|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% if printer.extruder.target != 0 %}
	{% if printer.extruder.temperature < printer.extruder.target %}
	M109 S{printer.extruder.target|float}
	{% endif %}
	{% else %}
	{% if printer.extruder.target < T %}
	M109 S{T}
	{% endif %}
	{% endif %}

[gcode_macro M701]
description = Map M701 to LOAD_FILAMENT
gcode = 
	LOAD_FILAMENT

[gcode_macro M702]
description = Map M702 to UNLOAD_FILAMENT
gcode = 
	UNLOAD_FILAMENT

[gcode_macro M600]
description = Map M600 to CHANGE_FILAMENT
gcode = 
	CHANGE_FILAMENT

[gcode_macro M125]
description = Map M125 to PARK
gcode = 
	PARK

[gcode_macro M900]
description = Map M900 to SET_PRESSURE_ADVANCE
gcode = 
	{% if 'K' in params %}
	{% if 'E' in params %}
	SET_PRESSURE_ADVANCE EXTRUDER={params.E} ADVANCE={params.K}
	{% else %}
	SET_PRESSURE_ADVANCE ADVANCE={params.K}
	{% endif %}
	{% endif %}

[gcode_macro M204]
description = Map M204 to SET_VELOCITY_LIMIT for ACCEL and ACCEL_TO_DECEL
rename_existing = M204.1
gcode = 
	{% set F = params.F|default(printer["gcode_macro _USER_VARIABLES"].accel_to_decel_factor)|float %}
	
	{% if 'S' in params %}
	{% set S = params.S|float %}
	SET_VELOCITY_LIMIT ACCEL={S} ACCEL_TO_DECEL={S * F}
	{% endif %}

[gcode_macro M205]
description = Map M205 to SET_VELOCITY_LIMIT for SQUARE_CORNER_VELOCITY
gcode = 
	{% if 'X' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.X}
	{% elif 'Y' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.Y}
	{% endif %}

[gcode_macro G00]
gcode = 
	G0 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G01]
gcode = 
	G1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G02]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G03]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G04]
gcode = 
	G4 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro _SEARCH_VARS]
description = Search for variables in the "printer" object from Klipper
gcode = 
	{% set search = params.S|lower %}
	{% set ns = namespace() %}
	{% for item in printer  %}
	{% if ' ' in item %}
	{% set ns.path = ['printer', "['%s']" % (item), ''] %}
	{% else %}
	{% set ns.path = ['printer.', item, ''] %}
	{% endif %}
	
	{% if search in ns.path|lower %}
	{ action_respond_info(ns.path|join) }
	{% endif %}
	
	{% if printer[item].items() %}
	{% for childkey, child in printer[item].items() recursive %}
	{% set ns.path = ns.path[:loop.depth|int + 1] %}
	
	{% if ' ' in childkey %}
	{% set null = ns.path.append("['%s']" % (childkey)) %}
	{% else %}
	{% set null = ns.path.append(".%s" % (childkey)) %}
	{% endif %}
	
	{% if child is mapping  %}
	{ loop(child.items()) }
	{% else %}
	{% if search in ns.path|lower %}
	{ action_respond_info("%s : %s" % (ns.path|join, child)) }
	{% endif %}
	{% endif %}
	
	{% endfor %}
	{% endif %}
	{% endfor %}

[delayed_gcode KLIPPAIN_STARTUP]
initial_duration = 1
gcode = 
	_KLIPPAIN_STARTUP

[gcode_macro _KLIPPAIN_STARTUP]
gcode = 
	
	RUN_SHELL_COMMAND CMD=system_info
	
	
	_INIT_MCU_VER
	
	
	{% set extruder_enabled = printer["gcode_macro _USER_VARIABLES"].extruder_enabled %}
	{% if not extruder_enabled %}
	{ action_raise_error("Klippain need to have an extruder defined to work properly. Check your printer.cfg includes!") }
	{% endif %}
	
	
	_INIT_CHECKPROBECONF
	
	
	{% set e_driver = printer["gcode_macro _USER_VARIABLES"].e_driver|string %}
	{% if e_driver == "TMC2240" %}
	_INIT_TMC2240
	{% endif %}
	
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% if klippain_ercf_enabled %}
	_INIT_CHECK_ERCF
	{% endif %}
	
	
	_INIT_USERCUSTOM
	
	RESPOND MSG="Klippain started and ready !"

[gcode_macro _INIT_TMC2240]
gcode = 

[gcode_macro _INIT_CHECKPROBECONF]
gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled|string %}
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set qgl_enabled = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set ztilt_enabled = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	
	{% if zcalib_plugin_enabled %}
	{% if probe_type_enabled == "vorontap" %}
	{ action_raise_error("Voron TAP Probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "inductive" %}
	{ action_raise_error("Inductive probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "dockable_virtual" or probe_type_enabled == "inductive_virtual" %}
	{ action_raise_error("Virtual Z endstop probes are not compatible with the Z calibration plugin!") }
	{% elif probe_type_enabled == "none" %}
	{ action_raise_error("You need a probe to use the Z calibration plugin in Klippain!") }
	{% endif %}
	{% endif %}
	
	{% if bed_mesh_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a bed mesh in Klippain!") }
	{% endif %}
	
	{% if qgl_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a quad gantry leveling in Klippain!") }
	{% endif %}
	
	{% if ztilt_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a Z tilt adjust in Klippain!") }
	{% endif %}

[gcode_macro _INIT_MCU_VER]
gcode = 
	{% set parameters = namespace(output = 'Currently configured MCU(s): \n') %}
	{% for name1 in printer %}
	{% for name2 in printer[name1] %}
	{% set show = ['mcu_version'] %}
	{% if name2 is in show %}
	{% set param = "%s: %s" % (name1, printer[name1][name2]) %}
	{% set parameters.output = parameters.output +  param + "\n" %}
	{% endif %}
	{% endfor %}
	{% endfor %}
	{action_respond_info(parameters.output)}

[gcode_macro _INIT_CHECK_ERCF]
gcode = 
	{% if not printer.ercf.enabled %}
	{ action_raise_error("ERCF is enabled in Klippain, but Happy Hare, the supported ERCF backend software is not detected. Please install it now from https://github.com/moggieuk/ERCF-Software-V3 !") }
	{% endif %}

[gcode_macro _INIT_USERCUSTOM]
gcode = 

[gcode_shell_command plot_graph]
command = bash /home/pi/printer_data/config/scripts/plot_graphs.sh
timeout = 500.0
verbose = True

[gcode_shell_command system_info]
command = python3 /home/pi/printer_data/config/scripts/system_info.py
timeout = 5.0
verbose = True

[save_variables]
filename = ~/printer_data/config/save_variables.cfg

[tmc2209 stepper_z]
uart_pin = Z_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z1]
uart_pin = Z1_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z2]
uart_pin = Z2_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z3]
uart_pin = Z3_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 extruder]
uart_pin = toolhead:E_TMCUART
interpolate = false
run_current = 0.45
sense_resistor = 0.110
stealthchop_threshold = 0

[mcu]
canbus_uuid = f981df077b2c

[board_pins mcu_manufacturer]
aliases = 
	MCU_MOTOR0_STEP=PF13   , MCU_MOTOR0_DIR=PF12   , MCU_MOTOR0_ENABLE=PF14   , MCU_MOTOR0_UART=PC4    ,
	MCU_MOTOR1_STEP=PG0    , MCU_MOTOR1_DIR=PG1    , MCU_MOTOR1_ENABLE=PF15   , MCU_MOTOR1_UART=PD11   ,
	MCU_MOTOR2_1_STEP=PF11 , MCU_MOTOR2_1_DIR=PG3  , MCU_MOTOR2_1_ENABLE=PG5  , MCU_MOTOR2_1_UART=PC6  ,
	MCU_MOTOR3_STEP=PG4    , MCU_MOTOR3_DIR=PC1    , MCU_MOTOR3_ENABLE=PA0    , MCU_MOTOR3_UART=PC7    ,
	MCU_MOTOR4_STEP=PF9    , MCU_MOTOR4_DIR=PF10   , MCU_MOTOR4_ENABLE=PG2    , MCU_MOTOR4_UART=PF2    ,
	MCU_MOTOR5_STEP=PC13   , MCU_MOTOR5_DIR=PF0    , MCU_MOTOR5_ENABLE=PF1    , MCU_MOTOR5_UART=PE4    ,
	MCU_MOTOR6_STEP=PE2    , MCU_MOTOR6_DIR=PE3    , MCU_MOTOR6_ENABLE=PD4    , MCU_MOTOR6_UART=PE1    ,
	MCU_MOTOR7_STEP=PE6    , MCU_MOTOR7_DIR=PA14   , MCU_MOTOR7_ENABLE=PE0    , MCU_MOTOR7_UART=PD3    ,
	
	MCU_STOP0=PG6  , MCU_STOP1=PG9  , MCU_STOP2=PG10 , MCU_STOP3=PG11 ,
	MCU_STOP4=PG12 , MCU_STOP5=PG13 , MCU_STOP6=PG14 , MCU_STOP7=PG15 ,
	MCU_PROBE=PB7  ,
	MCU_SERVOS=PB6 ,
	
	MCU_HE0=PA2 , MCU_HE1=PA3 , MCU_HE2=PB10 , MCU_HE3=PB11 ,
	
	MCU_BED0=PA1 ,
	
	MCU_TB=PF3 ,
	MCU_T0=PF4 , MCU_T1=PF5 , MCU_T2=PF6 , MCU_T3=PF7 ,
	
	MCU_FAN0=PA8 , MCU_FAN1=PE5 , MCU_FAN2=PD12 , MCU_FAN3=PD13 , MCU_FAN4=PD14 , MCU_FAN5=PD15 ,
	
	MCU_NEOPIXEL=PB0  ,
	MCU_PS_ON=PE11    ,
	MCU_POWER_DET=PC0 ,
	
	
	EXP1_1=PE8   , EXP1_2=PE7   ,
	EXP1_3=PE9   , EXP1_4=PE10  ,
	EXP1_5=PE12  , EXP1_6=PE13  ,
	EXP1_7=PE14  , EXP1_8=PE15  ,
	EXP1_9=<GND> , EXP1_10=<5V> ,
	
	
	EXP2_1=PA6   , EXP2_2=PA5   ,
	EXP2_3=PB1   , EXP2_4=PA4   ,
	EXP2_5=PB2   , EXP2_6=PA7   ,
	EXP2_7=PC15  , EXP2_8=<RST> ,
	EXP2_9=<GND> , EXP2_10=<5V> ,

[board_pins octopus_mcu]
mcu = mcu
aliases = 
	X_STEP=MCU_MOTOR0_STEP   , X_DIR=MCU_MOTOR0_DIR   , X_ENABLE=MCU_MOTOR0_ENABLE   , X_TMCUART=MCU_MOTOR0_UART   ,
	Y_STEP=MCU_MOTOR1_STEP   , Y_DIR=MCU_MOTOR1_DIR   , Y_ENABLE=MCU_MOTOR1_ENABLE   , Y_TMCUART=MCU_MOTOR1_UART   ,
	
	Z_STEP=MCU_MOTOR2_1_STEP , Z_DIR=MCU_MOTOR2_1_DIR , Z_ENABLE=MCU_MOTOR2_1_ENABLE , Z_TMCUART=MCU_MOTOR2_1_UART ,
	Z1_STEP=MCU_MOTOR3_STEP  , Z1_DIR=MCU_MOTOR3_DIR  , Z1_ENABLE=MCU_MOTOR3_ENABLE  , Z1_TMCUART=MCU_MOTOR3_UART  ,
	Z2_STEP=MCU_MOTOR4_STEP  , Z2_DIR=MCU_MOTOR4_DIR  , Z2_ENABLE=MCU_MOTOR4_ENABLE  , Z2_TMCUART=MCU_MOTOR4_UART  ,
	Z3_STEP=MCU_MOTOR5_STEP  , Z3_DIR=MCU_MOTOR5_DIR  , Z3_ENABLE=MCU_MOTOR5_ENABLE  , Z3_TMCUART=MCU_MOTOR5_UART  ,
	
	E_STEP=MCU_MOTOR6_STEP   , E_DIR=MCU_MOTOR6_DIR   , E_ENABLE=MCU_MOTOR6_ENABLE   , E_TMCUART=MCU_MOTOR6_UART   ,
	
	X_STOP=MCU_STOP0 , Y_STOP=MCU_STOP1 , Z_STOP=MCU_STOP2 ,
	PROBE_INPUT=MCU_STOP7  ,
	RUNOUT_SENSOR=MCU_STOP3 ,
	
	E_HEATER=MCU_HE0   , E_TEMPERATURE=MCU_T0   ,
	BED_HEATER=MCU_HE1 , BED_TEMPERATURE=MCU_TB ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	CONTROLLER_FAN=MCU_FAN2        ,
	EXHAUST_FAN=MCU_FAN3           ,
	FILTER_FAN=MCU_FAN4            ,
	HOST_CONTROLLER_FAN=MCU_FAN5   ,
	
	CHAMBER_TEMPERATURE=MCU_T1 , ELECTRICAL_CABINET_TEMPERATURE=MCU_T2 ,
	
	LIGHT_OUTPUT=MCU_HE2         ,
	LIGHT_NEOPIXEL=MCU_STOP5     ,
	STATUS_NEOPIXEL=MCU_NEOPIXEL ,

[mcu toolhead]
canbus_uuid = 1b44cf5169c3

[board_pins toolhead_manufacturer]
mcu = toolhead
aliases = 
	MCU_EMOT_EN=gpio7 , MCU_EMOT_STEP=gpio9 , MCU_EMOT_DIR=gpio10 , MCU_EMOT_UART=gpio8 ,
	
	MCU_5V_ENDSTOP=gpio28 ,
	MCU_ENDSTOP=gpio29    ,
	MCU_HV_ENDSTOP=gpio25 ,
	
	MCU_FAN0=gpio13 , MCU_FAN1=gpio14 , MCU_FAN2=gpio15 ,
	
	MCU_TEMP=gpio27 , MCU_ONBOARD_NTCK100K=gpio26 ,
	
	MCU_HEAT=gpio6 ,
	
	MCU_RGB=gpio12 ,
	MCU_PWM0=gpio16 , MCU_PWM1=gpio17 ,
	
	MCU_ADXL_CS=gpio1 , MCU_ADXL_SCK=gpio0 , MCU_ADXL_MOSI=gpio3 , MCU_ADXL_MISO=gpio2 ,

[board_pins sb2040_mcu]
mcu = toolhead
aliases = 
	E_STEP=MCU_EMOT_STEP , E_DIR=MCU_EMOT_DIR , E_ENABLE=MCU_EMOT_EN , E_TMCUART=MCU_EMOT_UART ,
	
	X_STOP=MCU_ENDSTOP ,
	PROBE_INPUT=MCU_HV_ENDSTOP ,
	TOOLHEAD_SENSOR=MCU_5V_ENDSTOP ,
	
	E_HEATER=MCU_HEAT , E_TEMPERATURE=MCU_TEMP , CHAMBER_TEMPERATURE=MCU_ONBOARD_NTCK100K ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	
	STATUS_NEOPIXEL=MCU_RGB ,
	
	ADXL_CS=MCU_ADXL_CS , ADXL_SCLK=MCU_ADXL_SCK , ADXL_MOSI=MCU_ADXL_MOSI , ADXL_MISO=MCU_ADXL_MISO ,

[neopixel status_leds]
pin = toolhead:STATUS_NEOPIXEL
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting CAN connect
Created a socket
webhooks client 281473428219552: New connection
webhooks client 281473428219552: Client info {'program': 'Moonraker', 'version': 'v0.8.0-92-g504a3a7'}
Loaded MCU 'mcu' 107 commands (v0.11.0-110-gaca0c71a / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1=PB6,PB7 BUS_PINS_i2c1a=PB8,PB9 BUS_PINS_i2c2=PB10,PB11 BUS_PINS_i2c2a=PH4,PH5 BUS_PINS_i2c3=PA8,PC9 BUS_PINS_i2c3a=PH7,PH8 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3=PB4,PB5,PB3 BUS_PINS_spi3a=PC11,PC12,PC10 BUS_PINS_spi4=PE13,PE14,PE12 CANBUS_BRIDGE=1 CLOCK_FREQ=168000000 MCU=stm32f429xx PWM_MAX=255 RECEIVE_WINDOW=192 RESERVE_PINS_CAN=PD0,PD1 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PH0,PH1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu 'toolhead': Starting CAN connect
Created a socket
Loaded MCU 'toolhead' 107 commands (v0.11.0-201-g37315bf3 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'toolhead' config: ADC_MAX=4095 BUS_PINS_i2c0a=gpio0,gpio1 BUS_PINS_i2c0b=gpio4,gpio5 BUS_PINS_i2c0c=gpio8,gpio9 BUS_PINS_i2c0d=gpio12,gpio13 BUS_PINS_i2c0e=gpio16,gpio17 BUS_PINS_i2c0f=gpio20,gpio21 BUS_PINS_i2c0g=gpio24,gpio25 BUS_PINS_i2c0h=gpio28,gpio29 BUS_PINS_i2c1a=gpio2,gpio3 BUS_PINS_i2c1b=gpio6,gpio7 BUS_PINS_i2c1c=gpio10,gpio11 BUS_PINS_i2c1d=gpio14,gpio15 BUS_PINS_i2c1e=gpio18,gpio19 BUS_PINS_i2c1f=gpio22,gpio23 BUS_PINS_i2c1g=gpio26,gpio27 BUS_PINS_spi0a=gpio0,gpio3,gpio2 BUS_PINS_spi0b=gpio4,gpio7,gpio6 BUS_PINS_spi0c=gpio16,gpio19,gpio18 BUS_PINS_spi0d=gpio20,gpio23,gpio22 BUS_PINS_spi1a=gpio8,gpio11,gpio10 BUS_PINS_spi1b=gpio12,gpio15,gpio14 BUS_PINS_spi1c=gpio24,gpio27,gpio26 CANBUS_FREQUENCY=1000000 CLOCK_FREQ=12000000 INITIAL_PINS=gpio24 MCU=rp2040 PWM_MAX=255 RECEIVE_WINDOW=192 RESERVE_PINS_CAN=gpio4,gpio5 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu_temperature 'mcu' nominal base=-238.014440 slope=1182.671480
mcu_temperature 'toolhead' nominal base=437.226612 slope=-1917.489831
Sending MCU 'mcu' printer configuration...
Config error
Traceback (most recent call last):
  File "/home/orangepi/klipper/klippy/mcu.py", line 707, in _send_config
    self._serial.send(c)
  File "/home/orangepi/klipper/klippy/serialhdl.py", line 256, in send
    cmd = self.msgparser.create_command(msg)
  File "/home/orangepi/klipper/klippy/msgproto.py", line 350, in create_command
    cmd = mp.encode_by_name(**argparts)
  File "/home/orangepi/klipper/klippy/msgproto.py", line 181, in encode_by_name
    t.encode(out, params[name])
  File "/home/orangepi/klipper/klippy/msgproto.py", line 108, in encode
    raise enumeration_error(self.enum_name, v)
msgproto.enumeration_error: Unknown value 'MCU_5V_ENDSTOP' in enumeration 'pin'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/orangepi/klipper/klippy/klippy.py", line 180, in _connect
    cb()
  File "/home/orangepi/klipper/klippy/mcu.py", line 753, in _connect
    self._send_config(None)
  File "/home/orangepi/klipper/klippy/mcu.py", line 718, in _send_config
    raise self._printer.config_error(
configparser.Error: Pin 'MCU_5V_ENDSTOP' is not a valid pin name on mcu 'mcu'
Attempting MCU 'toolhead' reset command
Attempting MCU 'mcu' reset command
b'Got error -1 in can read: (100)Network is down'
webhooks client 281473428219552: Disconnected
Restarting printer
Start printer at Tue Jul 11 14:53:55 2023 (1689105235.9 869.9)
===== Config file =====
[printer]
kinematics = corexz
max_velocity = 400
max_accel = 1000
max_z_velocity = 200
max_z_accel = 1000
square_corner_velocity = 5.0

[stepper_x]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = X_STEP
dir_pin = X_DIR
enable_pin = !X_ENABLE
endstop_pin = tmc2209_stepper_x:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_y]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = Y_STEP
dir_pin = Y_DIR
enable_pin = !Y_ENABLE
endstop_pin = tmc2209_stepper_y:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_z]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z_STEP
dir_pin = !Z_DIR
enable_pin = !Z_ENABLE
endstop_pin = probe:z_virtual_endstop
homing_speed = 15
second_homing_speed = 8
homing_retract_dist = 3.0
position_max = 310
position_min = -5

[stepper_z1]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z1_STEP
dir_pin = !Z1_DIR
enable_pin = !Z1_ENABLE

[stepper_z2]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z2_STEP
dir_pin = !Z2_DIR
enable_pin = !Z2_ENABLE

[stepper_z3]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z3_STEP
dir_pin = Z3_DIR
enable_pin = !Z3_ENABLE

[gcode_macro _USER_VARIABLES]
variable_extruder_enabled = True
gcode = 
variable_heaterbed_enabled = True
variable_probe_type_enabled = "vorontap"
variable_startprint_actions = "bed_soak", "extruder_preheating", "chamber_soak", "clean", "tilt_calib", "z_offset", "bedmesh", "extruder_heating", "purge", "clean", "primeline"
variable_status_leds_minidisplay_enabled = True
variable_status_leds_minidisplay_led_name = "btt_mini12864"
variable_bed_mesh_enabled = True
variable_sensorless_homing_enabled = True
variable_qgl_enabled = True
variable_verbose = True
variable_homing_travel_speed = 350
variable_travel_speed = 350
variable_z_drop_speed = 15
variable_brush_clean_speed = 100
variable_probe_dock_speed = 60
variable_homing_travel_accel = 3000
variable_tilting_travel_accel = 3000
variable_brush_clean_accel = 1500
variable_probe_dock_accel = 2000
variable_accel_to_decel_factor = 0.75
variable_zendstop_position = -1, -1
variable_force_homing_in_start_print = False
variable_homing_zhop = 5
variable_homing_first = "X"
variable_homing_backoff_distance_xy = -5, -5
variable_sensorless_current_factor = 75
variable_probe_dock_margin_xy = 0, 0
variable_safe_extruder_temp = 150
variable_prime_line_xy = 5, 2.5
variable_prime_line_direction = "X"
variable_prime_line_length = 40
variable_prime_line_purge_distance = 30
variable_prime_line_flowrate = 10
variable_park_position_xy = -1, -1
variable_park_lift_z = 50
variable_disable_motors_in_end_print = False
variable_turn_off_heaters_in_end_print = True
variable_min_bed_xy = 0, 0
variable_max_bed_xy = 9999, 9999
variable_probe_min_z_travel = 20
variable_probe_dock_location_xy = -1, -1
variable_probe_servo_angle_retracted = 0
variable_probe_servo_angle_deployed = 90
variable_probe_before_attach_position = "front"
variable_probe_after_attach_position = "front"
variable_probe_before_dock_position = "front"
variable_probe_after_dock_position = "left"
variable_probe_move_attach_length = 30
variable_probe_move_dock_length = 30
variable_autodock_on_probe_error = True
variable_tap_max_probing_temp = 150
variable_tap_deactivation_zhop = 5
variable_print_default_bed_temp = 105
variable_print_default_extruder_temp = 240
variable_print_default_chamber_temp = 0
variable_print_default_chamber_max_heating_time = 15
variable_print_default_soak = 8
variable_print_default_material = "XXX"
variable_material_parameters = {
	'PLA': {
	'pressure_advance': 0.0525,
	'retract_length': 0.75,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 0,
	'additional_z_offset': 0
	},
	'PET': {
	'pressure_advance': 0.0650,
	'retract_length': 1.4,
	'unretract_extra_length': 0,
	'retract_speed': 30,
	'unretract_speed': 20,
	'filter_speed': 0,
	'additional_z_offset': 0.020
	},
	'ABS': {
	'pressure_advance': 0.0480,
	'retract_length': 0.5,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 80,
	'additional_z_offset': 0
	}
	}
variable_ercf_unload_on_cancel_print = False
variable_ercf_unload_on_end_print = True
variable_ercf_reset_stats_on_start_print = False
variable_purge_and_brush_enabled = False
variable_force_homing_before_brush = False
variable_brush_over_y_axis = True
variable_brush_xyz = -1, -1, -1
variable_purge_bucket_xyz = -1, -1, -1
variable_purge_distance = 30
variable_purge_ooze_time = 10
variable_purgeclean_servo_angle_retracted = 0
variable_purgeclean_servo_angle_deployed = 90
variable_light_intensity_start_print = 100
variable_light_intensity_printing = 30
variable_light_intensity_end_print = 0
variable_fix_heaters_temperature_settle = False
variable_resonnance_test_point_xy = -1, -1
variable_resonnance_test_z_clearance = 50
variable_status_leds_colors = {
	'logo': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'nozzle': {
	'heating': {'r': 0.8, 'g': 0.35, 'b': 0.0, 'w':0.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'standby': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'caselight': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'minidisplay': {
	'on': {'r': 0.0, 'g': 0.2, 'b': 0.4, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'error': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'thermal': {
	'hot': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cold': {'r': 0.3, 'g': 0.0, 'b': 0.3, 'w': 0.0}
	}
	}
variable_x_driver = "TMC2209"
variable_y_driver = "TMC2209"
variable_z_driver = "TMC2209"
variable_e_driver = "TMC2209"

[extruder]
rotation_distance = 22.79234586
gear_ratio = 50:10
microsteps = 64
full_steps_per_rotation = 200
nozzle_diameter = 0.400
filament_diameter = 1.75
max_extrude_only_distance = 110
max_extrude_cross_section = 5
sensor_type = ATC Semitec 104GT-2
min_temp = 5
max_temp = 310
max_power = 1.0
min_extrude_temp = 170
pressure_advance = 0.045
pressure_advance_smooth_time = 0.040
step_pin = toolhead:E_STEP
dir_pin = toolhead:E_DIR
enable_pin = !toolhead:E_ENABLE
heater_pin = toolhead:E_HEATER
sensor_pin = toolhead:E_TEMPERATURE
control = pid
pid_kp = 34.626
pid_ki = 4.050
pid_kd = 74.014

[gcode_macro M109]
rename_existing = M109.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={S}
	{% else %}
	M109.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[heater_bed]
heater_pin = BED_HEATER
sensor_type = NTC 100K MGB18-104F39050L32
sensor_pin = BED_TEMPERATURE
max_power = 1
min_temp = 0
max_temp = 120
control = pid
pid_kp = 40.783
pid_ki = 1.007
pid_kd = 412.931

[gcode_macro M190]
rename_existing = M190.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={S}
	{% else %}
	M190.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[gcode_macro ACTIVATE_PROBE]
description = Put the machine in a state being able to probe
variable_temperature = 0
gcode = 
	{% set LOCK = params.LOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_max_probing_temp = printer["gcode_macro _USER_VARIABLES"].tap_max_probing_temp|float %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if LOCK %}
	_ATTACH_PROBE_LOCK
	{% else %}
	_ATTACH_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	SAVE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	
	{% set ACTUAL_TEMP = printer.extruder.temperature %}
	{% set TARGET_TEMP = printer.extruder.target %}
	
	SET_GCODE_VARIABLE MACRO=ACTIVATE_PROBE VARIABLE=temperature VALUE={TARGET_TEMP}
	
	{% if TARGET_TEMP > tap_max_probing_temp %}
	{ action_respond_info('Extruder temperature target of %.1fC is too high for TAP probing, lowering to %.1fC' % (TARGET_TEMP, tap_max_probing_temp)) }
	M106 S255
	M109 S{tap_max_probing_temp}
	M106 S0
	{% else %}
	
	{% if ACTUAL_TEMP > tap_max_probing_temp + 3 %}
	M106 S255
	TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={tap_max_probing_temp}
	M106 S0
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro DEACTIVATE_PROBE]
description = Revert the machine to a normal state after probing
gcode = 
	{% set UNLOCK = params.UNLOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_deactivation_zhop = printer["gcode_macro _USER_VARIABLES"].tap_deactivation_zhop %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if UNLOCK %}
	_DOCK_PROBE_UNLOCK
	{% else %}
	_DOCK_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	
	{% set z_safe = printer.toolhead.position.z + tap_deactivation_zhop %}
	{% if z_safe > printer.toolhead.axis_maximum.z %}
	{% set z_safe = printer.toolhead.axis_maximum.z %}
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	
	{% set old_target_temperature = printer["gcode_macro ACTIVATE_PROBE"].temperature %}
	M109 S{old_target_temperature}
	
	RESTORE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	{% endif %}

[probe]
pin = ^toolhead:MCU_5V_ENDSTOP
x_offset = 0
y_offset = 0
z_offset = -0.45
speed = 3
lift_speed = 10
samples = 3
samples_result = median
sample_retract_dist = 1.0
samples_tolerance = 0.007
samples_tolerance_retries = 3

[heater_fan hotend_fan]
pin = toolhead:E_FAN
max_power = 1.0
kick_start_time = 0.100
heater = extruder
heater_temp = 50.0

[fan]
pin = toolhead:PART_FAN
kick_start_time = 0.100
cycle_time = 0.010

[gcode_macro _SET_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = params.LED|string %}
	{% set idx = (params.IDX|string).split(',') %}
	{% set transmit_last = params.TRANSMIT|default(1) %}
	
	{% for led_index in idx %}
	{% set transmit=transmit_last if loop.last else 0 %}
	SET_LED LED={led} RED={red} GREEN={green} BLUE={blue} WHITE={white} INDEX={led_index} TRANSMIT={transmit}
	{% endfor %}

[gcode_macro _SET_LEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_idx"] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_ALLLEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	SET_LED LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w}  TRANSMIT={transmit}

[gcode_macro _SET_LOGO_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_NOZZLE_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro SET_LOGO_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="logo" COLOR="off" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_ON]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="on" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="off" TRANSMIT={transmit}

[gcode_macro STATUS_LEDS]
gcode = 
	{% set color = params.COLOR|default('off')|lower %}
	
	{% set status_color = {
	'ready': {
	'logo': 'standby',
	'nozzle': 'standby',
	'caselight': 'standby',
	'minidisplay': 'on'
	},
	'busy': {
	'logo': 'busy',
	'nozzle': 'on',
	'caselight': 'busy',
	'minidisplay': 'on'
	},
	'heating': {
	'logo': 'heating',
	'nozzle': 'heating',
	'caselight': 'heating',
	'minidisplay': 'on'
	},
	'leveling': {
	'logo': 'leveling',
	'nozzle': 'on',
	'caselight': 'leveling',
	'minidisplay': 'on'
	},
	'homing': {
	'logo': 'homing',
	'nozzle': 'on',
	'caselight': 'homing',
	'minidisplay': 'on'
	},
	'cleaning': {
	'logo': 'cleaning',
	'nozzle': 'on',
	'caselight': 'cleaning',
	'minidisplay': 'on'
	},
	'meshing': {
	'logo': 'meshing',
	'nozzle': 'on',
	'caselight': 'meshing',
	'minidisplay': 'on'
	},
	'calibrating_z': {
	'logo': 'calibrating_z',
	'nozzle': 'on',
	'caselight': 'calibrating_z',
	'minidisplay': 'on'
	},
	'printing': {
	'logo': 'printing',
	'nozzle': 'on',
	'caselight': 'printing',
	'minidisplay': 'on'
	},
	'off': {
	'logo': 'off',
	'nozzle': 'off',
	'caselight': 'off',
	'minidisplay': 'off'
	},
	'on': {
	'logo': 'on',
	'nozzle': 'on',
	'caselight': 'on',
	'minidisplay': 'on'
	},
	'error': {
	'logo': 'error',
	'nozzle': 'error',
	'caselight': 'error',
	'minidisplay': 'error'
	}
	} %}
	
	{% if not (color in status_color) %}
	{ action_raise_error("COLOR is not valid!") }
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	_SET_LEDS_BY_NAME LEDS="logo" COLOR={status_color[color].logo} TRANSMIT=0
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR={status_color[color].nozzle} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_caselight_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="caselight" COLOR={status_color[color].caselight} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_minidisplay_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="minidisplay" COLOR={status_color[color].minidisplay} TRANSMIT=1
	{% endif %}

[display]
lcd_type = uc1701
cs_pin = EXP1_3
a0_pin = EXP1_4
rst_pin = EXP1_5
encoder_pins = ^EXP2_5, ^EXP2_3
click_pin = ^!EXP1_2
contrast = 63
spi_software_miso_pin = EXP2_1
spi_software_mosi_pin = EXP2_6
spi_software_sclk_pin = EXP2_2

[output_pin beeper]
pin = EXP1_1

[neopixel btt_mini12864]
pin = EXP1_6
chain_count = 3
initial_red = 0.1
initial_green = 0.5
initial_blue = 0.0
color_order = RGB

[delayed_gcode setdisplayneopixel]
initial_duration = 1
gcode = 
	SET_LED LED=btt_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3

[temperature_sensor RaspberryPi]
sensor_type = temperature_host

[temperature_sensor mcu]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 90

[temperature_sensor toolhead_mcu]
sensor_type = temperature_mcu
sensor_mcu = toolhead
min_temp = 0
max_temp = 100

[adxl345]
cs_pin = toolhead:ADXL_CS
spi_software_sclk_pin = toolhead:ADXL_SCLK
spi_software_mosi_pin = toolhead:ADXL_MOSI
spi_software_miso_pin = toolhead:ADXL_MISO
axes_map = x,y,z

[resonance_tester]
accel_chip = adxl345
probe_points = 
	-1,-1,-1

[gcode_macro TEST_RESONANCES]
rename_existing = BASE_TEST_RESONANCES
description = Runs input shaper test at the center of the bed
gcode = 
	{% set Tx, Ty = printer["gcode_macro _USER_VARIABLES"].resonnance_test_point_xy|map('float') %}
	{% set Tz = printer["gcode_macro _USER_VARIABLES"].resonnance_test_z_clearance|float %}
	
	{% if Tx == -1 and Ty == -1 %}
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	BASE_TEST_RESONANCES POINT={max_x / 2},{max_y / 2},{Tz} {rawparams}
	{% else %}
	BASE_TEST_RESONANCES POINT={Tx},{Ty},{Tz} {rawparams}
	{% endif %}

[gcode_macro AXES_SHAPER_CALIBRATION]
description = Run standard input shaper test for all axes
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.3)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=X FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=Y FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=SHAPER

[gcode_macro BELTS_SHAPER_CALIBRATION]
description = Run custom demi-axe test to analyze belts on CoreXY printers
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.33)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=1,1 OUTPUT=raw_data NAME=b FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=a FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=BELTS

[gcode_macro EXCITATE_AXIS_AT_FREQ]
description = Maintain a specified input shaper excitating frequency for some time to diagnose vibrations
gcode = 
	{% set FREQUENCY = params.FREQUENCY|default(25)|int %}
	{% set TIME = params.TIME|default(10)|int %}
	{% set AXIS = params.AXIS|default("x")|string|lower %}
	
	TEST_RESONANCES OUTPUT=raw_data AXIS={AXIS} FREQ_START={FREQUENCY-1} FREQ_END={FREQUENCY+1} HZ_PER_SEC={1/(TIME/3)}
	M400

[gcode_macro VIBRATIONS_CALIBRATION]
gcode = 
	
	
	
	{% set size = params.SIZE|default(60)|int %}
	{% set direction = params.DIRECTION|default('XY') %}
	{% set z_height = params.Z_HEIGHT|default(20)|int %}
	{% set verbose = params.VERBOSE|default(true) %}
	
	{% set min_speed = params.MIN_SPEED|default(20)|int * 60 %}
	{% set max_speed = params.MAX_SPEED|default(200)|int * 60 %}
	{% set speed_increment = params.SPEED_INCREMENT|default(2)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	
	{% set accel_chip = params.ACCEL_CHIP|default("adxl345") %}
	
	
	
	
	{% set mid_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set mid_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% set direction_factor = {
	'XY'  : {
	'start' : {'x': -0.5, 'y': -0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': -0.5, 'y': -0.5, 'z': 0.0 }
	}
	},
	'AB' : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': 0.0, 'y': 0.0, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	},
	'ABXY' : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'B'  : {
	'start' : {'x': 0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'A'  : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'X'  : {
	'start' : {'x': -0.5, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': 0.0, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.0, 'z': 0.0 }
	}
	},
	'Y'  : {
	'start' : {'x': 0.0, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.0, 'y': 0.5, 'z': 0.0 }
	}
	},
	'Z'  : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': 0.0, 'z': 1.0 },
	'1' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	}
	}
	%}
	
	
	
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	{% if (size / (max_speed / 60)) < 0.25 %}
	{ action_raise_error("SIZE is too small for this MAX_SPEED. Increase SIZE or decrease MAX_SPEED!") }
	{% endif %}
	
	{% if not (direction in direction_factor) %}
	{ action_raise_error("DIRECTION is not valid. Only XY, AB, ABXY, A, B, X, Y or Z is allowed!") }
	{% endif %}
	
	{action_respond_info("")}
	{action_respond_info("Starting speed and vibration calibration")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION
	
	G90
	
	
	G1 Z{z_height}
	G1 X{mid_x + (size * direction_factor[direction].start.x) } Y{mid_y + (size * direction_factor[direction].start.y)} F{feedrate_travel}
	
	
	{% for curr_speed in range(min_speed, max_speed + speed_increment) %}
	{% if (curr_speed - min_speed) % speed_increment == 0 %}
	{% if verbose %}
	RESPOND MSG="Current speed: {(curr_speed / 60)|int} mm/s"
	{% endif %}
	
	ACCELEROMETER_MEASURE CHIP={accel_chip}
	{% for key, factor in direction_factor[direction].move_factors|dictsort %}
	G1 X{mid_x + (size * factor.x) } Y{mid_y + (size * factor.y)} Z{z_height + (size * factor.z)} F{curr_speed}
	{% endfor %}
	ACCELEROMETER_MEASURE CHIP={accel_chip} NAME=sp{(curr_speed / 60)|int}n1
	
	G4 P300
	M400
	{% endif %}
	{% endfor %}
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS="VIBRATIONS {direction}"
	
	RESTORE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = _BASE_BED_MESH_CALIBRATE
description = Perform Mesh Bed Leveling with klicky automount
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if verbose %}
	{ action_respond_info("Bed Mesh Calibrate") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	_BASE_BED_MESH_CALIBRATE  {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	DEACTIVATE_PROBE

[gcode_macro _ADAPTIVE_MESH_VARIABLES]
variable_ready = False
variable_do_mesh = False
variable_do_nominal = False
variable_mesh_min = 0,0
variable_mesh_max = 0,0
variable_mesh_center = 0,0
variable_probe_count = 0,0
variable_rri = 0
variable_algo = "bicubic"
gcode = 

[gcode_macro COMPUTE_MESH_PARAMETERS]
description = Compute the mesh parameters and store them for later use
gcode = 
	
	{% set xMinConf, yMinConf = printer["configfile"].config["bed_mesh"]["mesh_min"].split(',')|map('trim')|map('int') %}
	{% set xMaxConf, yMaxConf = printer["configfile"].config["bed_mesh"]["mesh_max"].split(',')|map('trim')|map('int') %}
	{% set xProbeCntConf, yProbeCntConf = printer["configfile"].config["bed_mesh"]["probe_count"].split(',')|map('trim')|map('int') %}
	{% set algo = printer["configfile"].config["bed_mesh"]["algorithm"]|lower %}
	{% set xMeshPPS, yMeshPPS = (printer["configfile"].config["bed_mesh"]["mesh_pps"]|default('2,2')).split(',')|map('trim')|map('int') %}
	
	{% set margin = params.MARGIN|default(5)|int %}
	{% set force_mesh = params.FORCE_MESH|default(False) %}
	
	
	
	
	{% if params.SIZE is defined and params.SIZE != "0_0_0_0" %}
	RESPOND MSG="Got a SIZE parameter for the adaptive bed mesh"
	{% set xMinSpec, yMinSpec, xMaxSpec, yMaxSpec = params.SIZE.split('_')|map('trim')|map('int') %}
	
	{% elif printer.exclude_object.objects %}
	
	
	RESPOND MSG="No SIZE parameter, using the [exclude_object] tags for the adaptive bed mesh"
	{% set eo_points = printer.exclude_object.objects|map(attribute='polygon')|sum(start=[]) %}
	{% set xMinSpec = eo_points|map(attribute=0)|min %}
	{% set yMinSpec = eo_points|map(attribute=1)|min %}
	{% set xMaxSpec = eo_points|map(attribute=0)|max %}
	{% set yMaxSpec = eo_points|map(attribute=1)|max %}
	
	{% else %}
	
	
	RESPOND MSG="No info about the first layer coordinates, doing a nominal bed mesh instead of adaptive"
	{% endif %}
	
	
	
	
	{% if xMinSpec and yMinSpec and xMaxSpec and yMaxSpec %}
	
	
	
	
	{% set xMin = [xMinConf, (xMinSpec - margin)]|max %}
	{% set xMax = [xMaxConf, (xMaxSpec + margin)]|min %}
	{% set yMin = [yMinConf, (yMinSpec - margin)]|max %}
	{% set yMax = [yMaxConf, (yMaxSpec + margin)]|min %}
	
	
	
	
	{% set xProbeCnt = ((xMax - xMin) * xProbeCntConf / (xMaxConf - xMinConf))|round(0, 'ceil')|int %}
	{% set yProbeCnt = ((yMax - yMin) * yProbeCntConf / (yMaxConf - yMinConf))|round(0, 'ceil')|int %}
	
	
	
	
	
	
	
	
	{% if xProbeCnt < 3 and yProbeCnt < 3 %}
	{% if force_mesh %}
	RESPOND MSG="Bed mesh forced (small part detected): meshing 3x3..."
	{% set xProbeCnt = 3 %}
	{% set yProbeCnt = 3 %}
	{% set rRefIndex = 4 %}
	{% set algo = "lagrange" %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% else %}
	RESPOND MSG="Computed mesh parameters: none, bed mesh not needed for very small parts"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={False}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	{% else %}
	{% set xProbeCnt = [3, xProbeCnt]|max %}
	{% set yProbeCnt = [3, yProbeCnt]|max %}
	
	
	
	{% if xProbeCnt % 2 == 0 %}
	{% set xProbeCnt = xProbeCnt + 1 %}
	{% endif %}
	{% if yProbeCnt % 2 == 0 %}
	{% set yProbeCnt = yProbeCnt + 1 %}
	{% endif %}
	
	
	{% if xMeshPPS != 0 or yMeshPPS != 0 %}
	{% set probeCntMin = [xProbeCnt, yProbeCnt]|min %}
	{% set probeCntMax = [xProbeCnt, yProbeCnt]|max %}
	{% if algo == "lagrange" and probeCntMax > 6 %}
	
	{% set algo = "bicubic" %}
	{% endif %}
	{% if algo == "bicubic" and probeCntMin < 4 %}
	{% if probeCntMax > 6 %}
	
	{% if xProbeCnt > yProbeCnt %}
	{% set yProbeCnt = 5 %}
	{% else %}
	{% set xProbeCnt = 5 %}
	{% endif %}
	{% else %}
	
	{% set algo = "lagrange" %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	{% set rRefIndex = (((xProbeCnt * yProbeCnt) - 1) / 2)|int %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	
	
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% endif %}
	{% else %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={True}
	
	{% set xCenter = xMinConf + ((xMaxConf - xMinConf) / 2) %}
	{% set yCenter = yMinConf + ((yMaxConf - yMinConf) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={True}

[gcode_macro ADAPTIVE_BED_MESH]
description = Perform a bed mesh, but only where and when it's needed
gcode = 
	{% set ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	
	{% if ready %}
	_DO_ADAPTIVE_MESH
	
	
	
	{% else %}
	RESPOND MSG="Adaptive bed mesh: parameters not already computed, automatically calling the COMPUTE_MESH_PARAMETERS macro prior to the mesh"
	COMPUTE_MESH_PARAMETERS {rawparams}
	M400
	_DO_ADAPTIVE_MESH
	{% endif %}

[gcode_macro _DO_ADAPTIVE_MESH]
gcode = 
	
	{% set do_mesh = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_mesh %}
	{% set do_nominal = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_nominal %}
	{% set mesh_min = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_min %}
	{% set mesh_max = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_max %}
	{% set probe_count = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].probe_count %}
	{% set rRefIndex = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].rri %}
	{% set algo = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].algo %}
	
	
	
	
	{% if do_mesh %}
	
	{% if do_nominal %}
	RESPOND MSG="Adaptive bed mesh: nominal bed mesh"
	BED_MESH_CALIBRATE
	{% else %}
	{% if printer["configfile"].config["bed_mesh"]["relative_reference_index"] is defined %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}
	{% endif %}
	{% endif %}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: no mesh to be done"
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={False}

[bed_mesh]
speed = 350
horizontal_move_z = 12
mesh_min = 25, 25
mesh_max = 325, 325
probe_count = 9, 9
fade_start = 0.6
fade_end = 10.0
algorithm = bicubic
relative_reference_index = 40

[tmc2209 stepper_x]
diag_pin = ^X_STOP
driver_sgthrs = 50
uart_pin = X_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_y]
diag_pin = ^Y_STOP
driver_sgthrs = 60
uart_pin = Y_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[input_shaper]
shaper_freq_x = 56.4
shaper_type_x = zv
shaper_freq_y = 38.4
shaper_type_y = mzv

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing = _BASE_QUAD_GANTRY_LEVEL
description = Conform a moving, twistable gantry to the shape of a stationary bed with klicky automount
gcode = 
	{% set tilting_travel_accel = printer["gcode_macro _USER_VARIABLES"].tilting_travel_accel %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if verbose %}
	{ action_respond_info("Quad gantry leveling") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{tilting_travel_accel}
	
	_BASE_QUAD_GANTRY_LEVEL {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	DEACTIVATE_PROBE

[gcode_macro _TILT_CALIBRATE]
description = Do a QGL, Z_tilt, etc... depending of the machine configuration
gcode = 
	{% set FORCE_OPERATION = params.FORCE|default(true) %}
	{% set conf_QGL = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set conf_ztilt = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="LEVELING"
	{% endif %}
	
	{% if conf_QGL %}
	{% if printer.quad_gantry_level.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="QGL..."
	{% endif %}
	QUAD_GANTRY_LEVEL
	{% endif %}
	{% elif conf_ztilt %}
	{% if printer.z_tilt.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="Z tilt adjust..."
	{% endif %}
	Z_TILT_ADJUST
	{% endif %}
	{% else %}
	{% if verbose %}
	RESPOND MSG="No tilt calibration needed on this machine. Continuing..."
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[quad_gantry_level]
gantry_corners = 
	-60,-10
	410,420
points = 
	50,25
	50,275
	300,275
	300,25
speed = 350
horizontal_move_z = 12
retries = 5
retry_tolerance = 0.0075
max_adjust = 10

[virtual_sdcard]
path = ~/printer_data/gcodes
on_error_gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	STATUS_LEDS COLOR="ERROR"
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	_PROBE_ON_ERROR_ACTION
	{% endif %}

[exclude_object]

[idle_timeout]
timeout = 1800

[pause_resume]

[display_status]

[respond]

[force_move]
enable_force_move = True

[gcode_arcs]
resolution = 0.1

[gcode_macro CANCEL_PRINT]
rename_existing = BASE_CANCEL_PRINT
description = Cancel the print, retract 10mm of filament and park
gcode = 
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload_on_cancel_print = printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_cancel_print %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload_on_cancel_print %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	SDCARD_RESET_FILE
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_OFF
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}
	
	BASE_CANCEL_PRINT

[gcode_macro END_PRINT]
description = Stop the print and filter the atmosphere for 10min before shuting down
gcode = 
	{% set disable_motors_in_end_print = printer["gcode_macro _USER_VARIABLES"].disable_motors_in_end_print %}
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set light_intensity_end_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_end_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload = params.ERCF_UNLOAD_AT_END|default(printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_end_print)|int %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G92 E0
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if disable_motors_in_end_print %}
	M84
	{% endif %}
	
	
	
	
	{% if filter_enabled %}
	{% set FILTER_TIME = params.FILTER_TIME|default(600)|int %}
	START_FILTER SPEED=1
	UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED DURATION={FILTER_TIME}
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_end_print}
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}

[gcode_macro PARK]
description = Park the toolhead at the back and retract some filament if the nozzle is hot
gcode = 
	{% set E = params.E|default(1.7)|float %}
	
	{% set Px, Py = printer["gcode_macro _USER_VARIABLES"].park_position_xy|map('float') %}
	{% set park_lift_z = printer["gcode_macro _USER_VARIABLES"].park_lift_z %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	
	{% set z_safe = act_z + park_lift_z %}
	{% if z_safe > max_z %}
	{% set z_safe = max_z %}
	{% endif %}
	
	
	{% if printer.extruder.temperature > 185 and firmware_retraction_enabled %}
	G10
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	G0 X{Px} Y{Py} F{St}

[gcode_macro PAUSE]
rename_existing = BASE_PAUSE
description = Pause the print and park
gcode = 
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	
	{% if printer.pause_resume.is_paused %}
	RESPOND MSG="Print is already paused"
	{% else %}
	SAVE_GCODE_STATE NAME=PAUSE_state
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	BASE_PAUSE
	PARK
	{% endif %}

[gcode_macro RESUME]
rename_existing = BASE_RESUME
description = Resume the print after an optional unretract
gcode = 
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	
	{% if not printer.pause_resume.is_paused %}
	RESPOND MSG="Print is not paused. Resume ignored"
	{% else %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={St}
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	BASE_RESUME
	{% endif %}

[gcode_macro START_PRINT]
description = Machine heatup procedure before starting a print
variable_bed_temp = 0
variable_extruder_temp = 0
variable_z_adjust = 0
variable_soak = 0
variable_chamber_temp = 0
variable_chamber_maxtime = 0
variable_initial_tool = 0
variable_material = "XXX"
variable_fl_size = "0_0_0_0"
gcode = 
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_ADJUST = params.Z_ADJUST|default(0)|float %}
	{% set SOAK = params.SOAK|default(printer["gcode_macro _USER_VARIABLES"].print_default_soak)|int %}
	{% set CHAMBER_TEMP = params.CHAMBER|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_temp)|int %}
	{% set CHAMBER_MAXTIME = params.CHAMBER_MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	{% set INITIAL_TOOL = params.INITIAL_TOOL|default(0)|int %}
	{% set MATERIAL = params.MATERIAL|default(printer["gcode_macro _USER_VARIABLES"].print_default_material)|string %}
	{% set FL_SIZE = params.SIZE|default("0_0_0_0")|string %}
	
	
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=bed_temp VALUE={BED_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=extruder_temp VALUE={EXTRUDER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=soak VALUE={SOAK}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_temp VALUE={CHAMBER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_maxtime VALUE={CHAMBER_MAXTIME}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=initial_tool VALUE={INITIAL_TOOL}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=material VALUE='"{MATERIAL}"'
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=fl_size VALUE='"{FL_SIZE}"'
	
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_reset_stats_on_start_print = printer["gcode_macro _USER_VARIABLES"].ercf_reset_stats_on_start_print %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% if MATERIAL not in printer["gcode_macro _USER_VARIABLES"].material_parameters %}
	RESPOND MSG="Material '{MATERIAL}' is unknown!"
	{ action_raise_error("Add this new material to your material_parameters variable!") }
	{% else %}
	RESPOND MSG="Material '{MATERIAL}' is used"
	{% set material = printer["gcode_macro _USER_VARIABLES"].material_parameters[MATERIAL] %}
	{% endif %}
	
	
	
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="BUSY"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if ercf_reset_stats_on_start_print %}
	ERCF_RESET_STATS
	{% endif %}
	{% endif %}
	{% endif %}
	
	SET_GCODE_OFFSET Z=0
	M221 S100
	M220 S100
	G90
	M83
	
	
	{% if firmware_retraction_enabled %}
	SET_RETRACTION RETRACT_LENGTH={material.retract_length} RETRACT_SPEED={material.retract_speed} UNRETRACT_EXTRA_LENGTH={material.unretract_extra_length} UNRETRACT_SPEED={material.unretract_speed}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={material.pressure_advance}
	
	
	{% if force_homing_in_start_print %}
	G28
	{% else %}
	_CG28
	{% endif %}
	
	
	
	{% set sp_actions = printer["gcode_macro _USER_VARIABLES"].startprint_actions %}
	{% for action in sp_actions %}
	{% if action == "bed_soak" %}
	_MODULE_HEATSOAK_BED
	{% elif action == "chamber_soak" %}
	_MODULE_HEATSOAK_CHAMBER
	{% elif action == "tilt_calib" %}
	_MODULE_TILTING
	{% elif action == "extruder_heating" %}
	_MODULE_EXTRUDER_HEATING
	{% elif action == "purge" %}
	_MODULE_PURGE
	{% elif action == "clean" %}
	_MODULE_CLEAN
	{% elif action == "z_offset" %}
	_MODULE_Z_CALIB
	{% elif action == "bedmesh" %}
	_MODULE_BED_MESH
	{% elif action == "primeline" %}
	_MODULE_PRIMELINE
	{% elif action == "extruder_preheating" %}
	_MODULE_EXTRUDER_PREHEATING
	{% elif action == "custom1" %}
	_MODULE_CUSTOM1
	{% elif action == "custom2" %}
	_MODULE_CUSTOM2
	{% elif action == "custom3" %}
	_MODULE_CUSTOM3
	{% else %}
	{ action_raise_error("Unknown module called in START_PRINT! Please verify your startprint_actions variable override!") }
	{% endif %}
	{% endfor %}
	
	
	
	SET_GCODE_OFFSET Z_ADJUST={Z_ADJUST} MOVE=1
	
	
	SET_GCODE_OFFSET Z_ADJUST={material.additional_z_offset} MOVE=1
	{% if filter_enabled %}
	START_FILTER SPEED={material.filter_speed / 100}
	{% endif %}
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="PRINTING"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Start printing !"
	{% endif %}
	
	G92 E0.0

[gcode_macro _MODULE_PRIMELINE]
gcode = 
	PRIMELINE

[gcode_macro _MODULE_HEATSOAK_BED]
gcode = 
	
	
	
	
	
	{% set BED_TEMP = printer["gcode_macro START_PRINT"].bed_temp %}
	{% set SOAK = printer["gcode_macro START_PRINT"].soak %}
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if printer.heater_bed.target < (BED_TEMP - 8) %}
	
	
	{% if (CHAMBER_TEMP > 0) and filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	{% if SOAK > 0 %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME={SOAK}
	{% else %}
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME=0
	{% endif %}

[gcode_macro _MODULE_HEATSOAK_CHAMBER]
gcode = 
	
	
	
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	{% set CHAMBER_MAXTIME = printer["gcode_macro START_PRINT"].chamber_maxtime %}
	
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if chamber_sensor_enabled %}
	{% if CHAMBER_TEMP > 0 %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	
	{% if CURRENT_TEMP <= CHAMBER_TEMP %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	
	
	{% if filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	HEATSOAK_CHAMBER TEMP={CHAMBER_TEMP} MAXTIME={CHAMBER_MAXTIME}
	
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_TILTING]
gcode = 
	
	
	
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	_TILT_CALIBRATE FORCE={force_homing_in_start_print}

[gcode_macro _MODULE_EXTRUDER_HEATING]
gcode = 
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	{% set INITIAL_TOOL = printer["gcode_macro START_PRINT"].initial_tool %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder heating to print temperature..."
	{% endif %}
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET
	{% if not purge_and_brush_enabled %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	M109 S{EXTRUDER_TEMP}
	
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	ERCF_CHANGE_TOOL STANDALONE=1 TOOL={INITIAL_TOOL}
	_ERCF_ERROR_CHECK
	{% endif %}
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder temperature OK"
	{% endif %}

[gcode_macro _MODULE_PURGE]
gcode = 
	
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	
	{% if purge_and_brush_enabled %}
	PURGE TEMP={EXTRUDER_TEMP}
	{% endif %}

[gcode_macro _MODULE_CLEAN]
gcode = 
	
	
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set force_homing_before_brush = printer["gcode_macro _USER_VARIABLES"].force_homing_before_brush %}
	
	{% if purge_and_brush_enabled %}
	{% if force_homing_before_brush %}
	G28 Z
	{% endif %}
	CLEAN_NOZZLE
	{% endif %}

[gcode_macro _MODULE_Z_CALIB]
gcode = 
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% if bed_mesh_enabled and printer.bed_mesh.profile_name == "" %}
	COMPUTE_MESH_PARAMETERS SIZE={FL_SIZE}
	{% endif %}
	
	{% if zcalib_plugin_enabled %}
	G28 Z
	CALIBRATE_Z
	{% else %}
	G28 Z
	{% endif %}

[gcode_macro _MODULE_BED_MESH]
gcode = 
	
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if bed_mesh_enabled %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="MESHING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Bed mesh measurement..."
	{% endif %}
	
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	ADAPTIVE_BED_MESH
	{% else %}
	ADAPTIVE_BED_MESH SIZE={FL_SIZE}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_EXTRUDER_PREHEATING]
gcode = 
	
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Pre-heating the nozzle to a safe temperature..."
	{% endif %}
	
	M109 S{safe_extruder_temp}
	
	{% if verbose %}
	RESPOND MSG="Extruder at safe temperature of {safe_extruder_temp} degrees"
	{% endif %}

[gcode_macro _MODULE_CUSTOM1]
gcode = 

[gcode_macro _MODULE_CUSTOM2]
gcode = 

[gcode_macro _MODULE_CUSTOM3]
gcode = 

[gcode_macro _CG28]
description = Homing only if necessary
gcode = 
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	{% if "xyz" not in printer.toolhead.homed_axes %}
	G28
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[homing_override]
axes = xyz
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set homing_zhop = printer["gcode_macro _USER_VARIABLES"].homing_zhop|float %}
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed * 60 %}
	{% set homing_travel_accel = printer["gcode_macro _USER_VARIABLES"].homing_travel_accel %}
	{% set sensorless_homing_enabled = printer["gcode_macro _USER_VARIABLES"].sensorless_homing_enabled %}
	{% set sensorless_current_factor = printer["gcode_macro _USER_VARIABLES"].sensorless_current_factor / 100 %}
	{% set z_drop_speed = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% set homing_first = printer["gcode_macro _USER_VARIABLES"].homing_first|string|upper %}
	{% set x_homing_backoff, y_homing_backoff = printer["gcode_macro _USER_VARIABLES"].homing_backoff_distance_xy|map('float') %}
	
	{% set x_position_endstop = printer["configfile"].config["stepper_x"]["position_endstop"]|float %}
	{% set y_position_endstop = printer["configfile"].config["stepper_y"]["position_endstop"]|float %}
	{% set x_position_center = printer.toolhead.axis_maximum.x|int/2 - printer.toolhead.axis_minimum.x|int/2 %}
	{% set y_position_center = printer.toolhead.axis_maximum.y|int/2 - printer.toolhead.axis_minimum.y|int/2 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	{% set X, Y, Z = False, False, False %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	
	{% if not 'X' in params
	and not 'Y' in params
	and not 'Z' in params %}
	
	{% set X, Y, Z = True, True, True %}
	
	{% else %}
	{% if 'X' in params %}
	{% set X = True %}
	{% endif %}
	
	{% if 'Y' in params %}
	{% set Y = True %}
	{% endif %}
	
	{% if 'Z' in params %}
	{% set Z = True %}
	{% endif %}
	
	{% if 'X' in params
	and 'Y' in params
	and 'Z' in params %}
	
	
	_HOMING_VARIABLES reset=1
	{% endif %}
	
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_ENTRY_POINT FUNCTION=homing_override
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{homing_travel_accel}
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	G90
	
	{% if Z %}
	{% if ('z' in printer.toolhead.homed_axes) %}
	{% if (printer.toolhead.position.z < homing_zhop) %}
	{% if verbose %}
	{ action_respond_info("Z too low, performing ZHOP") }
	{% endif %}
	G0 Z{homing_zhop} F{z_drop_speed}
	{% endif %}
	{% elif ('xy' in printer.toolhead.homed_axes) %}
	{% if verbose %}
	{ action_respond_info("X and Y already homed, no ZHOP needed to home Z") }
	{% endif %}
	{% else %}
	{% if verbose %}
	{ action_respond_info("X and Y not homed, forcing full G28 to home Z properly") }
	{% endif %}
	SET_KINEMATIC_POSITION X=0 Y=0 Z=0
	G0 Z{homing_zhop} F{z_drop_speed}
	{% set X, Y, Z = True, True, True %}
	{% endif %}
	{% endif %}
	
	{% if homing_first == "X" %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% elif homing_first == "Y" %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% else %}
	{ action_respond_error("Axis homing order not valid. Choose either X or Y first in the variables.cfg file!") }
	{% endif %}
	
	
	
	{% if Z %}
	{% if verbose %}
	{ action_respond_info("Homing Z") }
	{% endif %}
	
	
	
	
	
	
	{% if printer["configfile"].config["stepper_z"]["endstop_pin"]|lower == "probe:z_virtual_endstop" %}
	
	{% if probe_type_enabled == "dockable_virtual" %}
	ACTIVATE_PROBE
	{% endif %}
	{% if bed_mesh_enabled %}
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	{% set mesh_center = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_center %}
	{% set x_mesh_center, y_mesh_center = mesh_center.split(',')|map('trim')|map('float') %}
	RESPOND MSG="Z homing: a mesh is computed and ready, probing mesh center: {mesh_center}"
	G0 X{x_mesh_center} Y{y_mesh_center} F{homing_travel_speed}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	
	
	{% else %}
	_GOTO_Z_PROBE
	{% endif %}
	
	
	{% if probe_type_enabled == "vorontap" %}
	ACTIVATE_PROBE
	{% endif %}
	
	G28 Z0
	
	G91
	G0 Z{homing_zhop} F{z_drop_speed}
	G90
	
	
	
	{% if probe_type_enabled == "vorontap" or probe_type_enabled == "dockable_virtual" %}
	DEACTIVATE_PROBE
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_EXIT_POINT FUNCTION=homing_override
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _GOTO_Z_PROBE]
description = Move to z probe avoiding the probe dock
gcode = 
	
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% if zcalib_plugin_enabled %}
	{% set z_endstop_x, z_endstop_y = printer["configfile"].config["z_calibration"]["nozzle_xy_position"].split(',')|map('trim')|map('float') %}
	{% else %}
	{% set z_endstop_x, z_endstop_y = printer["gcode_macro _USER_VARIABLES"].zendstop_position|map('float') %}
	{% endif %}
	
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed|float * 60 %}
	
	{% set probe_dock_location_x, probe_dock_location_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_location_xy|map('float') %}
	{% set probe_dock_margin_x, probe_dock_margin_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_margin_xy|map('float') %}
	
	{% set current_x = printer.toolhead.position.x|float %}
	{% set current_y = printer.toolhead.position.y|float %}
	
	SAVE_GCODE_STATE NAME=goto_ZProbe
	G90
	
	
	{% set avoid_dock = false %}
	{% if probe_dock_location_x < z_endstop_x|float %}
	
	
	{% if current_x < (probe_dock_location_x + probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% else %}
	
	
	{% if current_x > (probe_dock_location_x - probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% endif %}
	
	
	{% if avoid_dock == true  %}
	
	G0 Y{probe_dock_location_y - probe_dock_margin_y} F{homing_travel_speed}
	
	G0 X{z_endstop_x} F{homing_travel_speed}
	{% endif %}
	
	G0 X{z_endstop_x} Y{z_endstop_y} F{homing_travel_speed}
	
	RESTORE_GCODE_STATE NAME=goto_ZProbe

[gcode_macro CALIBRATE]
description = Calibrate the printer flow or pressure advance
gcode = 
	
	{% set TYPE = params.TYPE|default("")|string|lower %}
	
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set MATERIAL = params.MATERIAL|default("ABS")|string %}
	
	{% set center_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set center_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% if TYPE=="flow" %}
	
	{% set computed_size = (center_x - 20)|string + '_' + (center_y - 20)|string + '_' + (center_x + 20)|string + '_' + (center_y + 20)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	FLOW_MULTIPLIER_CALIBRATION EXTRUSION_WIDTH=0.471
	END_PRINT FILTER_TIME=0
	
	{% elif TYPE=="pressure_advance" %}
	
	{% set computed_size = (center_x - 60)|string + '_' + (center_y - 60)|string + '_' + (center_x + 60)|string + '_' + (center_y + 60)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	PRESSURE_ADVANCE_CALIBRATION
	END_PRINT FILTER_TIME=0
	
	{% else %}
	{action_respond_info("Please call this macro using TYPE= \"flow\" or \"pressure_advance\"")}
	{action_raise_error("not enough parameters to start a calibration!")}
	
	{% endif %}

[gcode_macro _FLOW_CALIB_VARIABLES]
variable_last_shell_thickness = 0.0
variable_last_evalue = 0.0
gcode = 

[gcode_macro FLOW_MULTIPLIER_CALIBRATION]
description = Print a small tower to calibrate the extrusion flow multiplier by measuring the shell
gcode = 
	
	
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	{% set do_retract = params.DO_RECTRACT|default(0)|int %}
	{% set print_size = params.PRINT_SIZE|default(40)|int %}
	{% set print_height = params.HEIGHT|default(15)|int %}
	{% set corner_radius = params.CORNER_RADIUS|default(8)|int %}
	{% set number_of_perimeters = params.PERIMETERS|default(2)|int %}
	{% set fan_speed = params.FAN_SPEED|default(20)|int %}
	
	{% set e_multiplier = params.EXTRUSION_MULTIPLIER|default(1.00)|float %}
	{% set filament_diameter = params.FILAMENT_DIAMETER|default(1.75)|float %}
	{% set extrusion_width = params.EXTRUSION_WIDTH|default(0.4)|float %}
	{% set layer_height = params.LAYER_HEIGHT|default(0.2)|float %}
	
	{% set retract_length = params.RETRACT_LENGTH|default(0.5)|float %}
	{% set initial_purge = params.PURGE_MM|default(1)|int %}
	{% set z_hop_height  = 2 * layer_height %}
	
	{% set feedrate_print = params.CONTROL_SPEED|default(100)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft = params.RAFT_SPEED|default(60)|int * 60 %}
	{% set feedrate_z = params.Z_LIFT_SPEED|default(20)|int * 60 %}
	{% set feedrate_retract = params.RETRACT_SPEED|default(50)|int * 60 %}
	
	
	
	
	{% set e_per_mm = ((extrusion_width - layer_height) * layer_height + 3.14159 * (layer_height / 2)**2) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set spacing = extrusion_width - layer_height * (1 - 3.14159 / 4) %}
	{% set shell_thickness = extrusion_width + (number_of_perimeters|float - 1) * spacing %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set x_start = max_x / 2 - print_size / 2 %}
	{% set y_start = max_y / 2 - print_size / 2 %}
	{% set x_end = x_start + print_size %}
	{% set y_end = y_start + print_size %}
	
	{% set num_raft_lines = ([print_size, max_x]|min / spacing)|round(0, 'floor')|int %}
	{% set raft_size = num_raft_lines * spacing %}
	
	
	
	
	{action_respond_info("")}
	{action_respond_info("Starting extrusion flow calibration print")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	{action_respond_info("Exrusion multiplier used: %.4f" % e_multiplier)}
	{action_respond_info("Number of perimeters to print: %d" % number_of_perimeters)}
	{action_respond_info("THEORIC SHELL THICKNESS: %.4f" % shell_thickness)}
	{action_respond_info("")}
	{action_respond_info("Measure the shell thickness using a caliper or micrometer. Then call the computation macro with the measured value:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION
	
	
	
	
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_shell_thickness VALUE={shell_thickness}
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_evalue VALUE={e_multiplier}
	
	
	
	
	G90
	M83
	G92 E0.0
	G0 X{x_start} Y{y_start - 5} Z{layer_height} F{feedrate_travel}
	
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{raft_size} E{raft_size * e_per_mm * 1.5} F{feedrate_raft / 2}
	G1 Y-{extrusion_width} E{extrusion_width * e_per_mm} F{feedrate_raft / 2}
	G1 X-{raft_size} E{raft_size * e_per_mm} F{feedrate_raft / 2}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G90
	G0 X{x_start} Y{y_start} F{feedrate_travel}
	G1 Z{layer_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	
	
	M221 S{e_multiplier * 100}
	
	
	
	
	{% if do_raft == 1 %}
	G91
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	G1 Y{loop.cycle(1.0, -1.0) * raft_size} E{raft_size * e_per_mm} F{feedrate_raft}
	
	
	{% if not loop.last %}
	G1 X{spacing} E{spacing * e_per_mm} F{feedrate_raft}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	
	
	
	
	G90
	M106 S{fan_speed * 255 / 100}
	
	
	{% for curr_layer in range(1, (print_height / layer_height)|round|int) %}
	G0 X{x_start + corner_radius} Y{y_start} F{feedrate_travel}
	G1 Z{(curr_layer * layer_height) + (layer_height if do_raft == 1 else 0)} F{feedrate_z}
	
	
	{% for perim_num in range(number_of_perimeters) %}
	
	{% set perim_offset = perim_num * spacing %}
	{% set perim_radius = corner_radius - (perim_num * spacing) %}
	
	
	G1 X{x_start + corner_radius} Y{y_start + perim_offset} F{feedrate_travel}
	{% if do_retract == 1 %}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	
	
	G1 X{x_end - corner_radius} Y{y_start + perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - perim_offset} Y{y_start + corner_radius} J{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_end - perim_offset} Y{y_end - corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - corner_radius} Y{y_end - perim_offset} I-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + corner_radius} Y{y_end - perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + perim_offset} Y{y_end - corner_radius} J-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + perim_offset} Y{y_start + corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + corner_radius} Y{y_start + perim_offset} I{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	
	{% if do_retract == 1 %}
	G1 E-{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	
	{% if do_retract == 1 %}
	G91
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G91
	G0 Z20 F{feedrate_travel}
	
	RESTORE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION

[gcode_macro COMPUTE_FLOW_MULTIPLIER]
description = Compute a new flow multiplier by using the measured shell thickness on the calibration print
gcode = 
	{% set evalue = params.OLD_EXTRUSION_MULTIPLIER|default(0.0)|float %}
	{% set theorical_thickness = params.THEORICAL_THICKNESS|default(0.0)|float %}
	{% set measured_thickness = params.MEASURED_THICKNESS|default(0.0)|float %}
	
	
	{% if evalue == 0.0 %}
	{% set last_evalue = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_evalue %}
	
	
	{% if last_evalue == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_evalue = last_evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	{% else %}
	{% set final_evalue = evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	
	
	{% if theorical_thickness == 0.0 %}
	{% set last_shell_thickness = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_shell_thickness %}
	
	
	{% if last_shell_thickness == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_theorical_thickness = last_shell_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	{% else %}
	{% set final_theorical_thickness = theorical_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	
	
	{% if measured_thickness == 0.0 %}
	{action_respond_info("You must use a caliper or micrometer to measure the calibration print shell thickness and call this macro with the measured value !!!")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set new_evalue = final_theorical_thickness * final_evalue / measured_thickness %}
	{action_respond_info("NEW COMPUTED FLOW VALUE: %.3f" % new_evalue)}
	{action_respond_info("Use this new value as extrusion multiplier in your slicer of choice")}
	{action_respond_info("")}
	{% endif %}

[gcode_macro PRESSURE_ADVANCE_CALIBRATION]
description = Calibrate the pressure advance by printing a grid pattern
gcode = 
	
	
	
	{% set pa_start     = params.START|default(0.02)|float %}
	{% set pa_increment = params.INCREMENT|default(0.005)|float %}
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	
	{% set print_size      = params.PRINT_SIZE|default(120)|int %}
	{% set num_bands       = params.BANDS_LIMIT|default(999)|int %}
	{% set lines_per_band  = params.LINES_PER_BAND|default(6)|int %}
	{% set e_multiplier    = params.EXTRUSION_MULTIPLIER|default(1.25 if do_raft == 1 else 1.5)|float %},
	{% set retract_length  = params.RETRACT_LENGTH|default(0.6)|float %}
	{% set initial_purge   = params.PURGE_MM|default(8)|int %}
	
	{% set feedrate_control = params.CONTROL_SPEED|default(30)|int * 60 %}
	{% set feedrate_outer   = params.OUTER_SPEED|default(40)|int * 60 %}
	{% set feedrate_inner   = params.INNER_SPEED|default(120)|int * 60 %}
	{% set feedrate_travel  = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft    = params.RAFT_SPEED|default(120)|int * 60 %}
	{% set feedrate_z       = 5 * 60 %}
	{% set feedrate_retract = 50 * 60 %}
	
	{% set spacing_line  = params.LINE_SPACING|default(0.4)|float %}
	{% set spacing_band  = 2 %}
	{% set spacing_raft  = 2 %}
	
	{% set fast_line_ratio_percent = 50 %}
	
	{% set lines_per_band    = [2, lines_per_band]|max %}
	{% set e_multiplier      = [1, e_multiplier]|max %}
	{% set num_lines_control = (lines_per_band / 2)|round(0, 'floor')|int %}
	{% set num_lines_test    = (lines_per_band / 2)|round(0, 'ceil')|int %}
	{% set spacing_line      = spacing_line * (1 + e_multiplier - 1.25) %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set nozzle_diameter = printer.configfile.config['extruder'].nozzle_diameter|float %}
	{% set line_width    = nozzle_diameter * 1.25 %}
	{% set line_height   = nozzle_diameter / 2 %}
	{% set z_hop_height  = 2 * line_height %}
	{% set e_per_mm      = (line_width * line_height) / (3.1415 * (1.75/2)**2) %}
	{% set spacing_purge = line_height * 0.8 %}
	
	{% set spacing_raft   = (spacing_raft / line_width)|round * line_width %}
	{% set num_raft_lines = ([print_size, max_x]|min / spacing_raft)|round(0, 'floor')|int %}
	{% set print_width    = num_raft_lines * spacing_raft %}
	
	{% set band_height      = lines_per_band * line_width + (lines_per_band - 1) * spacing_line + spacing_band %}
	{% set bands_per_height = (([print_size, max_y]|min  - spacing_purge - 2 * line_width + spacing_band) / band_height)|round(0, 'floor')|int %}
	{% set num_bands        = [num_bands, bands_per_height]|min %}
	{% set print_height     = num_bands * band_height - spacing_band + spacing_purge +  2 * line_width %}
	
	{% set slow_line_length = ((print_width * (1 - fast_line_ratio_percent / 100) / 2) / spacing_raft)|round * spacing_raft + spacing_raft / 2 %}
	{% set fast_line_length = print_width - slow_line_length * 2 %}
	{% set thick_raft_num1 = (slow_line_length / spacing_raft)|round|int %}
	{% set thick_raft_num2  = num_raft_lines - thick_raft_num1 + 1 %}
	
	{% set x_start = max_x / 2 - print_width  / 2 %}
	{% set y_start = max_y / 2 - print_height / 2 %}
	
	{action_respond_info("")}
	{action_respond_info("Starting Pressure Advance calibration print.")}
	{action_respond_info("")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button once the print starts exhibiting PA values that are obviously too high.")}
	{action_respond_info("")}
	{action_respond_info("PA of first band: %.4f" % pa_start)}
	{action_respond_info("PA of last band: %.4f" % (pa_start + ((num_bands - 1) * pa_increment)))}
	{action_respond_info("PA increment per band: %.4f" % pa_increment)}
	{action_respond_info("Number of bands: %d" % num_bands)}
	{action_respond_info("")}
	{action_respond_info("Inspect the printed model. "
	"Look at the top and bottom lines in each band, on the right side of the two vertical raft bars (where the print speeds change). "
	"Find the highest band from the bottom where the lines at its top still resemble the lines at its bottom, with no visible extrusion width irregularities. "
	"Your final Pressure Advance value would then be:"
	)}
	{action_respond_info("")}
	{action_respond_info("Assuming that first band_number is 0")}
	{action_respond_info("PA = %.4f + (%.4f * band_number)" % (pa_start, pa_increment))}
	{action_respond_info("")}
	{action_respond_info("Update your [extruder] config section and set \"pressure_advance\" to the value you calculated.")}
	{action_respond_info("")}
	
	
	
	
	
	
	
	
	
	SAVE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION
	{% set pa_saved = printer.configfile.settings['extruder'].pressure_advance %}
	SET_PRESSURE_ADVANCE ADVANCE={pa_start}
	
	
	
	
	M221 S100
	
	
	
	
	M117 Priming
	G90
	G0 X{x_start} Y{y_start} Z{line_height} F{feedrate_travel}
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{print_width}  E{print_width * e_per_mm} F{feedrate_raft / 2}
	G1 Y{line_width}   E{line_width * e_per_mm}  F{feedrate_raft / 2}
	G1 X-{print_width} E{print_width * e_per_mm} F{feedrate_raft / 2}
	
	
	
	
	{% if do_raft == 1 %}
	G0 F{feedrate_raft}
	
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	{% if curr_raft_line == thick_raft_num1 or curr_raft_line == thick_raft_num2 %}
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	G1 Y{loop.cycle(-1.0, 1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	{% endif %}
	
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	
	
	{% if not loop.last %}
	{% set horizontal_move = spacing_raft - (2 * line_width if curr_raft_line == thick_raft_num1 - 1 or curr_raft_line == thick_raft_num2 - 1 else 0) %}
	G1 X{horizontal_move} E{horizontal_move * e_per_mm}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	{% endif %}
	
	
	
	
	M117 Printing bands
	G90
	G0 X{x_start} Y{y_start + 2 * line_width + spacing_purge} F{feedrate_travel}
	G0 Z{line_height + (line_height if do_raft == 1 else 0)} F{feedrate_z}
	G91
	G1 E{retract_length} F{feedrate_retract}
	
	
	{% for curr_band_num in range(0, num_bands ) %}
	{% set outer_loop = loop %}
	
	{% set curr_pa_value = pa_start + curr_band_num * pa_increment %}
	SET_PRESSURE_ADVANCE ADVANCE={curr_pa_value}
	M117 Band {curr_band_num} PA {curr_pa_value|round(4)}
	
	
	{% for _ in range(num_lines_control) %}
	G1 X{print_width} E{print_width * e_per_mm * e_multiplier} F{feedrate_control}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G0 X-{print_width} Y{spacing_line + line_width} F{feedrate_travel}
	
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endfor %}
	
	
	{% for _ in range(num_lines_test) %}
	{% for data in [{'mm': slow_line_length, 'f': feedrate_outer}, {'mm': fast_line_length, 'f': feedrate_inner}, {'mm': slow_line_length, 'f': feedrate_outer}] %}
	G1 X{data.mm} E{data.mm * e_per_mm * e_multiplier} F{data.f}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	{% if not (outer_loop.last and loop.last) %}
	G0 X-{print_width} Y{(spacing_line if not loop.last else spacing_band) + line_width} F{feedrate_travel}
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z20 F{feedrate_z}
	G0 X-{print_width / 2} Y{[50, max_y - (y_start + print_height)]|min} F{feedrate_travel}
	
	M117
	SET_PRESSURE_ADVANCE ADVANCE={pa_saved}
	RESTORE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION

[gcode_macro CHANGE_FILAMENT]
description = Do a PAUSE, park the toolhead over the purge bucket and unload the filament
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	SAVE_GCODE_STATE NAME=CHANGE_FILAMENT_state
	PAUSE
	UNLOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=CHANGE_FILAMENT_state

[gcode_macro UNLOAD_FILAMENT]
description = Basic unload of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to unload filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to unload filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	
	_TIP_SHAPING
	M83
	G1 E-20 F3600
	G4 P3000
	G1 E{DISTANCE|float * -1} F3000
	
	RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament unloaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament unloaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro LOAD_FILAMENT]
description = Basic load of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to load filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to load filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=LOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	M83
	G92 E0
	G1 E{DISTANCE|float} F200
	G1 E50 F150
	
	G92 E0
	RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament loaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament loaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _TIP_SHAPING]
description = Filament tip shaping sequence
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=TIP_SHAPING_state
	_LOW_TEMP_CHECK T={TEMP}
	
	{% set old_pressure_advance = printer.extruder.pressure_advance|default(0) %}
	
	SET_PRESSURE_ADVANCE ADVANCE=0
	
	M82
	G92 E0
	G1 E2 F3600
	G1 E0 F3600
	G1 E3 F3600
	G1 E0 F3600
	G1 E4 F3600
	G1 E0 F3600
	
	
	SET_PRESSURE_ADVANCE ADVANCE={old_pressure_advance}
	RESTORE_GCODE_STATE NAME=TIP_SHAPING_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_CHAMBER]
description = Heatsoak chamber to a specific temperature with a timeout
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set MAXTIME = params.MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% for _ in range(1, MAXTIME) %}
	_WAIT_CHAMBER_TEMP TEMP={SETPOINT_TEMP}
	{% endfor %}
	{% if verbose %}
	RESPOND MSG="Chamber temperature OK !"
	{% endif %}
	{% endif %}

[gcode_macro _WAIT_CHAMBER_TEMP]
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	{% if CURRENT_TEMP <= SETPOINT_TEMP %}
	RESPOND MSG="Heating up the chamber : {CURRENT_TEMP}/{SETPOINT_TEMP}"
	G4 P{60000 * 1}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_BED]
description = Heatsoak bed at specified temperature and wait for a specific amount of time
gcode = 
	{% set SETPOINT_TEMP = params.TEMP|default(0)|int %}
	{% set TIME = params.SOAKTIME|default(8)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set heaterbed_enabled = printer["gcode_macro _USER_VARIABLES"].heaterbed_enabled %}
	
	{% if heaterbed_enabled %}
	{% if verbose %}
	RESPOND MSG="Heating up bed..."
	{% endif %}
	
	M190 S{SETPOINT_TEMP}
	
	{% if TIME > 0 %}
	{% for i in range(0, TIME) %}
	RESPOND MSG="Heatsoak bed, {TIME-i}mn left..."
	G4 P{60000 * 1}
	{% endfor %}
	{% else %}
	RESPOND MSG="No heatsoak needed, continue"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Bed temperature OK"
	{% endif %}
	
	{% else %}
	{% if verbose %}
	RESPOND MSG="No bed heater defined: nothing to do, continuing..."
	{% endif %}
	{% endif %}

[gcode_macro PRIMELINE]
gcode = 
	
	{% set prime_line_length = params.LINE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_length)|float %}
	{% set prime_line_purge_distance = params.PURGE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_purge_distance)|float %}
	{% set prime_line_flowrate = params.FLOWRATE|default(printer["gcode_macro _USER_VARIABLES"].prime_line_flowrate)|float %}
	
	
	{% set prime_line_x, prime_line_y = printer["gcode_macro _USER_VARIABLES"].prime_line_xy|map('float') %}
	{% set prime_line_direction = printer["gcode_macro _USER_VARIABLES"].prime_line_direction|string|upper %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% set max_extrude_cross_section = printer["configfile"].config["extruder"]["max_extrude_cross_section"]|float %}
	{% set filament_diameter = printer["configfile"].config["extruder"]["filament_diameter"]|float %}
	
	{% set line_height = 0.6 %}
	
	
	{% set prime_line_x = params.START_X|default(prime_line_x)|float %}
	{% set prime_line_y = params.START_Y|default(prime_line_y)|float %}
	{% set prime_line_direction = params.LINE_DIRECTION|default(printer["gcode_macro _USER_VARIABLES"].prime_line_direction)|string|upper %}
	
	
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	
	
	
	{% if (line_height * line_width) > max_extrude_cross_section %}
	{% if verbose %}
	{action_respond_info("The prime_line_purge_distance of %.4f mm is too high and will exceed the max_extrude_cross_section!" % prime_line_purge_distance)}
	{% endif %}
	{% set prime_line_purge_distance = 0.98 * (max_extrude_cross_section * prime_line_length) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	{% if verbose %}
	{action_respond_info("Klippain corrected the prime_line_purge_distance to %.4f mm" % prime_line_purge_distance)}
	{% endif %}
	{% endif %}
	
	
	{% if (line_height / line_width) >= 0.5 %}
	{% if verbose %}
	{action_raise_error("The prime line will be too thin and will probably not stick properly to the bed. Increase its purge distance or decrease its length! Aborting...")}
	{% endif %}
	{% endif %}
	
	
	{% set speed = (prime_line_flowrate / (line_height * line_width)) * 60 |float %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% endif %}
	{% endif %}
	{% endif %}
	
	G91
	M83
	G1 Z5 F{Sz}
	
	
	G90
	G0 X{prime_line_x} Y{prime_line_y} F{St}
	G1 Z{line_height} F{Sz|int / 2}
	
	
	G92 E0
	G1 E18 F300
	
	
	G92 E0
	{% if prime_line_direction == "X" %}
	G1 X{prime_line_x + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% elif prime_line_direction == "Y" %}
	G1 Y{prime_line_y + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% else %}
	{ action_respond_error("Prime line direction is not valid. Choose either X or Y in the variables.cfg file!") }
	{% endif %}
	
	
	G92 E0
	G1 E-0.2 F2100
	G92 E0
	G1 Z3 F{Sz}
	M400
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection reactivated after the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro CLEAN_NOZZLE]
description = Wipe the nozzle on the brush
gcode = 
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set brush_clean_accel = printer["gcode_macro _USER_VARIABLES"].brush_clean_accel %}
	{% set brush_over_y_axis = printer["gcode_macro _USER_VARIABLES"].brush_over_y_axis %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set Sc = printer["gcode_macro _USER_VARIABLES"].brush_clean_speed * 60 %}
	
	{% set Bx, By, Bz = printer["gcode_macro _USER_VARIABLES"].brush_xyz|map('float') %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Nozzle cleaning..."
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{brush_clean_accel}
	
	
	G90
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP=1
	
	G1 X{Bx} Y{By} Z{Bz} F{St}
	
	
	G91
	{% if brush_over_y_axis %}
	{% for wipe in range(6) %}
	G1 Y-5 F{Sc}
	G1 Y+5 F{Sc}
	{% endfor %}
	{% endif %}
	
	G1 X+20 F{Sc}
	
	{% for wipe in range(6) %}
	G1 X-40 F{Sc}
	G1 X+40 F{Sc}
	{% endfor %}
	
	G90
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="clean"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro PURGE]
description = Purge a specific amount of filament ontop of the purge bucket
gcode = 
	{% set DISTANCE = params.DISTANCE|default(printer["gcode_macro _USER_VARIABLES"].purge_distance)|int %}
	{% set OOZE_TIME = params.OOZE_TIME|default(printer["gcode_macro _USER_VARIABLES"].purge_ooze_time)|int %}
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Purge filament..."
	{% endif %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% endif %}
	
	G90
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP={Z_DROP}
	
	
	_LOW_TEMP_CHECK T={TEMP}
	G92 E0
	G1 E{DISTANCE|float} F150
	
	
	G92 E0
	G1 E-1.7 F2100
	G1 E-18.3 F150
	G92 E0
	
	
	G4 P{OOZE_TIME * 1000}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _CONDITIONAL_MOVE_TO_PURGE_BUCKET]
description = Move over the purge bucket
gcode = 
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	
	{% if purge_and_brush_enabled %}
	SAVE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	G90
	
	{% if Z_DROP == 1 %}
	{% if purgeclean_servo_enabled %}
	G1 Z{Pz} F{Sz}
	_SERVO_DEPLOY ITEM="purge"
	{% endif %}
	G1 X{Px} Y{Py} Z{Pz} F{St}
	{% else %}
	
	
	
	G1 X{Px} Y{Py} F{St}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	{% endif %}

[gcode_macro _LOW_TEMP_CHECK]
description = Check the nozzle is at temperature and heat it if needed
gcode = 
	{% set T = params.T|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% if printer.extruder.target != 0 %}
	{% if printer.extruder.temperature < printer.extruder.target %}
	M109 S{printer.extruder.target|float}
	{% endif %}
	{% else %}
	{% if printer.extruder.target < T %}
	M109 S{T}
	{% endif %}
	{% endif %}

[gcode_macro M701]
description = Map M701 to LOAD_FILAMENT
gcode = 
	LOAD_FILAMENT

[gcode_macro M702]
description = Map M702 to UNLOAD_FILAMENT
gcode = 
	UNLOAD_FILAMENT

[gcode_macro M600]
description = Map M600 to CHANGE_FILAMENT
gcode = 
	CHANGE_FILAMENT

[gcode_macro M125]
description = Map M125 to PARK
gcode = 
	PARK

[gcode_macro M900]
description = Map M900 to SET_PRESSURE_ADVANCE
gcode = 
	{% if 'K' in params %}
	{% if 'E' in params %}
	SET_PRESSURE_ADVANCE EXTRUDER={params.E} ADVANCE={params.K}
	{% else %}
	SET_PRESSURE_ADVANCE ADVANCE={params.K}
	{% endif %}
	{% endif %}

[gcode_macro M204]
description = Map M204 to SET_VELOCITY_LIMIT for ACCEL and ACCEL_TO_DECEL
rename_existing = M204.1
gcode = 
	{% set F = params.F|default(printer["gcode_macro _USER_VARIABLES"].accel_to_decel_factor)|float %}
	
	{% if 'S' in params %}
	{% set S = params.S|float %}
	SET_VELOCITY_LIMIT ACCEL={S} ACCEL_TO_DECEL={S * F}
	{% endif %}

[gcode_macro M205]
description = Map M205 to SET_VELOCITY_LIMIT for SQUARE_CORNER_VELOCITY
gcode = 
	{% if 'X' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.X}
	{% elif 'Y' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.Y}
	{% endif %}

[gcode_macro G00]
gcode = 
	G0 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G01]
gcode = 
	G1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G02]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G03]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G04]
gcode = 
	G4 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro _SEARCH_VARS]
description = Search for variables in the "printer" object from Klipper
gcode = 
	{% set search = params.S|lower %}
	{% set ns = namespace() %}
	{% for item in printer  %}
	{% if ' ' in item %}
	{% set ns.path = ['printer', "['%s']" % (item), ''] %}
	{% else %}
	{% set ns.path = ['printer.', item, ''] %}
	{% endif %}
	
	{% if search in ns.path|lower %}
	{ action_respond_info(ns.path|join) }
	{% endif %}
	
	{% if printer[item].items() %}
	{% for childkey, child in printer[item].items() recursive %}
	{% set ns.path = ns.path[:loop.depth|int + 1] %}
	
	{% if ' ' in childkey %}
	{% set null = ns.path.append("['%s']" % (childkey)) %}
	{% else %}
	{% set null = ns.path.append(".%s" % (childkey)) %}
	{% endif %}
	
	{% if child is mapping  %}
	{ loop(child.items()) }
	{% else %}
	{% if search in ns.path|lower %}
	{ action_respond_info("%s : %s" % (ns.path|join, child)) }
	{% endif %}
	{% endif %}
	
	{% endfor %}
	{% endif %}
	{% endfor %}

[delayed_gcode KLIPPAIN_STARTUP]
initial_duration = 1
gcode = 
	_KLIPPAIN_STARTUP

[gcode_macro _KLIPPAIN_STARTUP]
gcode = 
	
	RUN_SHELL_COMMAND CMD=system_info
	
	
	_INIT_MCU_VER
	
	
	{% set extruder_enabled = printer["gcode_macro _USER_VARIABLES"].extruder_enabled %}
	{% if not extruder_enabled %}
	{ action_raise_error("Klippain need to have an extruder defined to work properly. Check your printer.cfg includes!") }
	{% endif %}
	
	
	_INIT_CHECKPROBECONF
	
	
	{% set e_driver = printer["gcode_macro _USER_VARIABLES"].e_driver|string %}
	{% if e_driver == "TMC2240" %}
	_INIT_TMC2240
	{% endif %}
	
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% if klippain_ercf_enabled %}
	_INIT_CHECK_ERCF
	{% endif %}
	
	
	_INIT_USERCUSTOM
	
	RESPOND MSG="Klippain started and ready !"

[gcode_macro _INIT_TMC2240]
gcode = 

[gcode_macro _INIT_CHECKPROBECONF]
gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled|string %}
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set qgl_enabled = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set ztilt_enabled = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	
	{% if zcalib_plugin_enabled %}
	{% if probe_type_enabled == "vorontap" %}
	{ action_raise_error("Voron TAP Probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "inductive" %}
	{ action_raise_error("Inductive probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "dockable_virtual" or probe_type_enabled == "inductive_virtual" %}
	{ action_raise_error("Virtual Z endstop probes are not compatible with the Z calibration plugin!") }
	{% elif probe_type_enabled == "none" %}
	{ action_raise_error("You need a probe to use the Z calibration plugin in Klippain!") }
	{% endif %}
	{% endif %}
	
	{% if bed_mesh_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a bed mesh in Klippain!") }
	{% endif %}
	
	{% if qgl_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a quad gantry leveling in Klippain!") }
	{% endif %}
	
	{% if ztilt_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a Z tilt adjust in Klippain!") }
	{% endif %}

[gcode_macro _INIT_MCU_VER]
gcode = 
	{% set parameters = namespace(output = 'Currently configured MCU(s): \n') %}
	{% for name1 in printer %}
	{% for name2 in printer[name1] %}
	{% set show = ['mcu_version'] %}
	{% if name2 is in show %}
	{% set param = "%s: %s" % (name1, printer[name1][name2]) %}
	{% set parameters.output = parameters.output +  param + "\n" %}
	{% endif %}
	{% endfor %}
	{% endfor %}
	{action_respond_info(parameters.output)}

[gcode_macro _INIT_CHECK_ERCF]
gcode = 
	{% if not printer.ercf.enabled %}
	{ action_raise_error("ERCF is enabled in Klippain, but Happy Hare, the supported ERCF backend software is not detected. Please install it now from https://github.com/moggieuk/ERCF-Software-V3 !") }
	{% endif %}

[gcode_macro _INIT_USERCUSTOM]
gcode = 

[gcode_shell_command plot_graph]
command = bash /home/pi/printer_data/config/scripts/plot_graphs.sh
timeout = 500.0
verbose = True

[gcode_shell_command system_info]
command = python3 /home/pi/printer_data/config/scripts/system_info.py
timeout = 5.0
verbose = True

[save_variables]
filename = ~/printer_data/config/save_variables.cfg

[tmc2209 stepper_z]
uart_pin = Z_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z1]
uart_pin = Z1_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z2]
uart_pin = Z2_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z3]
uart_pin = Z3_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 extruder]
uart_pin = toolhead:E_TMCUART
interpolate = false
run_current = 0.45
sense_resistor = 0.110
stealthchop_threshold = 0

[mcu]
canbus_uuid = f981df077b2c

[board_pins mcu_manufacturer]
aliases = 
	MCU_MOTOR0_STEP=PF13   , MCU_MOTOR0_DIR=PF12   , MCU_MOTOR0_ENABLE=PF14   , MCU_MOTOR0_UART=PC4    ,
	MCU_MOTOR1_STEP=PG0    , MCU_MOTOR1_DIR=PG1    , MCU_MOTOR1_ENABLE=PF15   , MCU_MOTOR1_UART=PD11   ,
	MCU_MOTOR2_1_STEP=PF11 , MCU_MOTOR2_1_DIR=PG3  , MCU_MOTOR2_1_ENABLE=PG5  , MCU_MOTOR2_1_UART=PC6  ,
	MCU_MOTOR3_STEP=PG4    , MCU_MOTOR3_DIR=PC1    , MCU_MOTOR3_ENABLE=PA0    , MCU_MOTOR3_UART=PC7    ,
	MCU_MOTOR4_STEP=PF9    , MCU_MOTOR4_DIR=PF10   , MCU_MOTOR4_ENABLE=PG2    , MCU_MOTOR4_UART=PF2    ,
	MCU_MOTOR5_STEP=PC13   , MCU_MOTOR5_DIR=PF0    , MCU_MOTOR5_ENABLE=PF1    , MCU_MOTOR5_UART=PE4    ,
	MCU_MOTOR6_STEP=PE2    , MCU_MOTOR6_DIR=PE3    , MCU_MOTOR6_ENABLE=PD4    , MCU_MOTOR6_UART=PE1    ,
	MCU_MOTOR7_STEP=PE6    , MCU_MOTOR7_DIR=PA14   , MCU_MOTOR7_ENABLE=PE0    , MCU_MOTOR7_UART=PD3    ,
	
	MCU_STOP0=PG6  , MCU_STOP1=PG9  , MCU_STOP2=PG10 , MCU_STOP3=PG11 ,
	MCU_STOP4=PG12 , MCU_STOP5=PG13 , MCU_STOP6=PG14 , MCU_STOP7=PG15 ,
	MCU_PROBE=PB7  ,
	MCU_SERVOS=PB6 ,
	
	MCU_HE0=PA2 , MCU_HE1=PA3 , MCU_HE2=PB10 , MCU_HE3=PB11 ,
	
	MCU_BED0=PA1 ,
	
	MCU_TB=PF3 ,
	MCU_T0=PF4 , MCU_T1=PF5 , MCU_T2=PF6 , MCU_T3=PF7 ,
	
	MCU_FAN0=PA8 , MCU_FAN1=PE5 , MCU_FAN2=PD12 , MCU_FAN3=PD13 , MCU_FAN4=PD14 , MCU_FAN5=PD15 ,
	
	MCU_NEOPIXEL=PB0  ,
	MCU_PS_ON=PE11    ,
	MCU_POWER_DET=PC0 ,
	
	
	EXP1_1=PE8   , EXP1_2=PE7   ,
	EXP1_3=PE9   , EXP1_4=PE10  ,
	EXP1_5=PE12  , EXP1_6=PE13  ,
	EXP1_7=PE14  , EXP1_8=PE15  ,
	EXP1_9=<GND> , EXP1_10=<5V> ,
	
	
	EXP2_1=PA6   , EXP2_2=PA5   ,
	EXP2_3=PB1   , EXP2_4=PA4   ,
	EXP2_5=PB2   , EXP2_6=PA7   ,
	EXP2_7=PC15  , EXP2_8=<RST> ,
	EXP2_9=<GND> , EXP2_10=<5V> ,

[board_pins octopus_mcu]
mcu = mcu
aliases = 
	X_STEP=MCU_MOTOR0_STEP   , X_DIR=MCU_MOTOR0_DIR   , X_ENABLE=MCU_MOTOR0_ENABLE   , X_TMCUART=MCU_MOTOR0_UART   ,
	Y_STEP=MCU_MOTOR1_STEP   , Y_DIR=MCU_MOTOR1_DIR   , Y_ENABLE=MCU_MOTOR1_ENABLE   , Y_TMCUART=MCU_MOTOR1_UART   ,
	
	Z_STEP=MCU_MOTOR2_1_STEP , Z_DIR=MCU_MOTOR2_1_DIR , Z_ENABLE=MCU_MOTOR2_1_ENABLE , Z_TMCUART=MCU_MOTOR2_1_UART ,
	Z1_STEP=MCU_MOTOR3_STEP  , Z1_DIR=MCU_MOTOR3_DIR  , Z1_ENABLE=MCU_MOTOR3_ENABLE  , Z1_TMCUART=MCU_MOTOR3_UART  ,
	Z2_STEP=MCU_MOTOR4_STEP  , Z2_DIR=MCU_MOTOR4_DIR  , Z2_ENABLE=MCU_MOTOR4_ENABLE  , Z2_TMCUART=MCU_MOTOR4_UART  ,
	Z3_STEP=MCU_MOTOR5_STEP  , Z3_DIR=MCU_MOTOR5_DIR  , Z3_ENABLE=MCU_MOTOR5_ENABLE  , Z3_TMCUART=MCU_MOTOR5_UART  ,
	
	E_STEP=MCU_MOTOR6_STEP   , E_DIR=MCU_MOTOR6_DIR   , E_ENABLE=MCU_MOTOR6_ENABLE   , E_TMCUART=MCU_MOTOR6_UART   ,
	
	X_STOP=MCU_STOP0 , Y_STOP=MCU_STOP1 , Z_STOP=MCU_STOP2 ,
	PROBE_INPUT=MCU_STOP7  ,
	RUNOUT_SENSOR=MCU_STOP3 ,
	
	E_HEATER=MCU_HE0   , E_TEMPERATURE=MCU_T0   ,
	BED_HEATER=MCU_HE1 , BED_TEMPERATURE=MCU_TB ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	CONTROLLER_FAN=MCU_FAN2        ,
	EXHAUST_FAN=MCU_FAN3           ,
	FILTER_FAN=MCU_FAN4            ,
	HOST_CONTROLLER_FAN=MCU_FAN5   ,
	
	CHAMBER_TEMPERATURE=MCU_T1 , ELECTRICAL_CABINET_TEMPERATURE=MCU_T2 ,
	
	LIGHT_OUTPUT=MCU_HE2         ,
	LIGHT_NEOPIXEL=MCU_STOP5     ,
	STATUS_NEOPIXEL=MCU_NEOPIXEL ,

[mcu toolhead]
canbus_uuid = 1b44cf5169c3

[board_pins toolhead_manufacturer]
mcu = toolhead
aliases = 
	MCU_EMOT_EN=gpio7 , MCU_EMOT_STEP=gpio9 , MCU_EMOT_DIR=gpio10 , MCU_EMOT_UART=gpio8 ,
	
	MCU_5V_ENDSTOP=gpio28 ,
	MCU_ENDSTOP=gpio29    ,
	MCU_HV_ENDSTOP=gpio25 ,
	
	MCU_FAN0=gpio13 , MCU_FAN1=gpio14 , MCU_FAN2=gpio15 ,
	
	MCU_TEMP=gpio27 , MCU_ONBOARD_NTCK100K=gpio26 ,
	
	MCU_HEAT=gpio6 ,
	
	MCU_RGB=gpio12 ,
	MCU_PWM0=gpio16 , MCU_PWM1=gpio17 ,
	
	MCU_ADXL_CS=gpio1 , MCU_ADXL_SCK=gpio0 , MCU_ADXL_MOSI=gpio3 , MCU_ADXL_MISO=gpio2 ,

[board_pins sb2040_mcu]
mcu = toolhead
aliases = 
	E_STEP=MCU_EMOT_STEP , E_DIR=MCU_EMOT_DIR , E_ENABLE=MCU_EMOT_EN , E_TMCUART=MCU_EMOT_UART ,
	
	X_STOP=MCU_ENDSTOP ,
	PROBE_INPUT=MCU_HV_ENDSTOP ,
	TOOLHEAD_SENSOR=MCU_5V_ENDSTOP ,
	
	E_HEATER=MCU_HEAT , E_TEMPERATURE=MCU_TEMP , CHAMBER_TEMPERATURE=MCU_ONBOARD_NTCK100K ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	
	STATUS_NEOPIXEL=MCU_RGB ,
	
	ADXL_CS=MCU_ADXL_CS , ADXL_SCLK=MCU_ADXL_SCK , ADXL_MOSI=MCU_ADXL_MOSI , ADXL_MISO=MCU_ADXL_MISO ,

[neopixel status_leds]
pin = toolhead:STATUS_NEOPIXEL
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting CAN connect
Created a socket
webhooks client 281473420703968: New connection
webhooks client 281473420703968: Client info {'program': 'Moonraker', 'version': 'v0.8.0-92-g504a3a7'}
Loaded MCU 'mcu' 107 commands (v0.11.0-110-gaca0c71a / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1=PB6,PB7 BUS_PINS_i2c1a=PB8,PB9 BUS_PINS_i2c2=PB10,PB11 BUS_PINS_i2c2a=PH4,PH5 BUS_PINS_i2c3=PA8,PC9 BUS_PINS_i2c3a=PH7,PH8 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3=PB4,PB5,PB3 BUS_PINS_spi3a=PC11,PC12,PC10 BUS_PINS_spi4=PE13,PE14,PE12 CANBUS_BRIDGE=1 CLOCK_FREQ=168000000 MCU=stm32f429xx PWM_MAX=255 RECEIVE_WINDOW=192 RESERVE_PINS_CAN=PD0,PD1 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PH0,PH1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu 'toolhead': Starting CAN connect
Created a socket
Loaded MCU 'toolhead' 107 commands (v0.11.0-201-g37315bf3 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'toolhead' config: ADC_MAX=4095 BUS_PINS_i2c0a=gpio0,gpio1 BUS_PINS_i2c0b=gpio4,gpio5 BUS_PINS_i2c0c=gpio8,gpio9 BUS_PINS_i2c0d=gpio12,gpio13 BUS_PINS_i2c0e=gpio16,gpio17 BUS_PINS_i2c0f=gpio20,gpio21 BUS_PINS_i2c0g=gpio24,gpio25 BUS_PINS_i2c0h=gpio28,gpio29 BUS_PINS_i2c1a=gpio2,gpio3 BUS_PINS_i2c1b=gpio6,gpio7 BUS_PINS_i2c1c=gpio10,gpio11 BUS_PINS_i2c1d=gpio14,gpio15 BUS_PINS_i2c1e=gpio18,gpio19 BUS_PINS_i2c1f=gpio22,gpio23 BUS_PINS_i2c1g=gpio26,gpio27 BUS_PINS_spi0a=gpio0,gpio3,gpio2 BUS_PINS_spi0b=gpio4,gpio7,gpio6 BUS_PINS_spi0c=gpio16,gpio19,gpio18 BUS_PINS_spi0d=gpio20,gpio23,gpio22 BUS_PINS_spi1a=gpio8,gpio11,gpio10 BUS_PINS_spi1b=gpio12,gpio15,gpio14 BUS_PINS_spi1c=gpio24,gpio27,gpio26 CANBUS_FREQUENCY=1000000 CLOCK_FREQ=12000000 INITIAL_PINS=gpio24 MCU=rp2040 PWM_MAX=255 RECEIVE_WINDOW=192 RESERVE_PINS_CAN=gpio4,gpio5 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu_temperature 'mcu' nominal base=-238.014440 slope=1182.671480
mcu_temperature 'toolhead' nominal base=437.226612 slope=-1917.489831
Sending MCU 'mcu' printer configuration...
Configured MCU 'mcu' (1024 moves)
Sending MCU 'toolhead' printer configuration...
Configured MCU 'toolhead' (1024 moves)
Starting heater checks for heater_bed
bed_mesh: generated points
Index |  Tool Adjusted  |   Probe
  0   | (25.0, 25.0)    | (25.0, 25.0)
  1   | (62.5, 25.0)    | (62.5, 25.0)
  2   | (100.0, 25.0)   | (100.0, 25.0)
  3   | (137.5, 25.0)   | (137.5, 25.0)
  4   | (175.0, 25.0)   | (175.0, 25.0)
  5   | (212.5, 25.0)   | (212.5, 25.0)
  6   | (250.0, 25.0)   | (250.0, 25.0)
  7   | (287.5, 25.0)   | (287.5, 25.0)
  8   | (325.0, 25.0)   | (325.0, 25.0)
  9   | (325.0, 62.5)   | (325.0, 62.5)
  10  | (287.5, 62.5)   | (287.5, 62.5)
  11  | (250.0, 62.5)   | (250.0, 62.5)
  12  | (212.5, 62.5)   | (212.5, 62.5)
  13  | (175.0, 62.5)   | (175.0, 62.5)
  14  | (137.5, 62.5)   | (137.5, 62.5)
  15  | (100.0, 62.5)   | (100.0, 62.5)
  16  | (62.5, 62.5)    | (62.5, 62.5)
  17  | (25.0, 62.5)    | (25.0, 62.5)
  18  | (25.0, 100.0)   | (25.0, 100.0)
  19  | (62.5, 100.0)   | (62.5, 100.0)
  20  | (100.0, 100.0)  | (100.0, 100.0)
  21  | (137.5, 100.0)  | (137.5, 100.0)
  22  | (175.0, 100.0)  | (175.0, 100.0)
  23  | (212.5, 100.0)  | (212.5, 100.0)
  24  | (250.0, 100.0)  | (250.0, 100.0)
  25  | (287.5, 100.0)  | (287.5, 100.0)
  26  | (325.0, 100.0)  | (325.0, 100.0)
  27  | (325.0, 137.5)  | (325.0, 137.5)
  28  | (287.5, 137.5)  | (287.5, 137.5)
  29  | (250.0, 137.5)  | (250.0, 137.5)
  30  | (212.5, 137.5)  | (212.5, 137.5)
  31  | (175.0, 137.5)  | (175.0, 137.5)
  32  | (137.5, 137.5)  | (137.5, 137.5)
  33  | (100.0, 137.5)  | (100.0, 137.5)
  34  | (62.5, 137.5)   | (62.5, 137.5)
  35  | (25.0, 137.5)   | (25.0, 137.5)
  36  | (25.0, 175.0)   | (25.0, 175.0)
  37  | (62.5, 175.0)   | (62.5, 175.0)
  38  | (100.0, 175.0)  | (100.0, 175.0)
  39  | (137.5, 175.0)  | (137.5, 175.0)
  40  | (175.0, 175.0)  | (175.0, 175.0)
  41  | (212.5, 175.0)  | (212.5, 175.0)
  42  | (250.0, 175.0)  | (250.0, 175.0)
  43  | (287.5, 175.0)  | (287.5, 175.0)
  44  | (325.0, 175.0)  | (325.0, 175.0)
  45  | (325.0, 212.5)  | (325.0, 212.5)
  46  | (287.5, 212.5)  | (287.5, 212.5)
  47  | (250.0, 212.5)  | (250.0, 212.5)
  48  | (212.5, 212.5)  | (212.5, 212.5)
  49  | (175.0, 212.5)  | (175.0, 212.5)
  50  | (137.5, 212.5)  | (137.5, 212.5)
  51  | (100.0, 212.5)  | (100.0, 212.5)
  52  | (62.5, 212.5)   | (62.5, 212.5)
  53  | (25.0, 212.5)   | (25.0, 212.5)
  54  | (25.0, 250.0)   | (25.0, 250.0)
  55  | (62.5, 250.0)   | (62.5, 250.0)
  56  | (100.0, 250.0)  | (100.0, 250.0)
  57  | (137.5, 250.0)  | (137.5, 250.0)
  58  | (175.0, 250.0)  | (175.0, 250.0)
  59  | (212.5, 250.0)  | (212.5, 250.0)
  60  | (250.0, 250.0)  | (250.0, 250.0)
  61  | (287.5, 250.0)  | (287.5, 250.0)
  62  | (325.0, 250.0)  | (325.0, 250.0)
  63  | (325.0, 287.5)  | (325.0, 287.5)
  64  | (287.5, 287.5)  | (287.5, 287.5)
  65  | (250.0, 287.5)  | (250.0, 287.5)
  66  | (212.5, 287.5)  | (212.5, 287.5)
  67  | (175.0, 287.5)  | (175.0, 287.5)
  68  | (137.5, 287.5)  | (137.5, 287.5)
  69  | (100.0, 287.5)  | (100.0, 287.5)
  70  | (62.5, 287.5)   | (62.5, 287.5)
  71  | (25.0, 287.5)   | (25.0, 287.5)
  72  | (25.0, 325.0)   | (25.0, 325.0)
  73  | (62.5, 325.0)   | (62.5, 325.0)
  74  | (100.0, 325.0)  | (100.0, 325.0)
  75  | (137.5, 325.0)  | (137.5, 325.0)
  76  | (175.0, 325.0)  | (175.0, 325.0)
  77  | (212.5, 325.0)  | (212.5, 325.0)
  78  | (250.0, 325.0)  | (250.0, 325.0)
  79  | (287.5, 325.0)  | (287.5, 325.0)
  80  | (325.0, 325.0)  | (325.0, 325.0)
bed_mesh: relative_reference_index 40 is (175.00, 175.00)
Config error
Traceback (most recent call last):
  File "/home/orangepi/klipper/klippy/klippy.py", line 180, in _connect
    cb()
  File "/home/orangepi/klipper/klippy/extras/z_tilt.py", line 22, in handle_connect
    raise self.printer.config_error(
configparser.Error: quad_gantry_level z_positions needs exactly 5 items
Starting Klippy...
Args: ['/home/orangepi/klipper/klippy/klippy.py', '/home/orangepi/printer_data/config/printer.cfg', '-I', '/home/orangepi/printer_data/comms/klippy.serial', '-l', '/home/orangepi/printer_data/logs/klippy.log', '-a', '/home/orangepi/printer_data/comms/klippy.sock']
Git version: 'v0.11.0-241-gffb5105b-dirty'
Untracked files: klippy/extras/gcode_shell_command.py
Branch: master
Remote: origin
Tracked URL: https://github.com/Klipper3d/klipper
CPU: 4 core ?
Python: '3.9.2 (default, Feb 28 2021, 17:03:44) \n[GCC 10.2.1 20210110]'
Start printer at Tue Jul 11 15:37:43 2023 (1689107863.3 25.9)
===== Config file =====
[printer]
kinematics = corexz
max_velocity = 400
max_accel = 1000
max_z_velocity = 200
max_z_accel = 1000
square_corner_velocity = 5.0

[stepper_x]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = X_STEP
dir_pin = X_DIR
enable_pin = !X_ENABLE
endstop_pin = tmc2209_stepper_x:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_y]
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
step_pin = Y_STEP
dir_pin = Y_DIR
enable_pin = !Y_ENABLE
endstop_pin = tmc2209_stepper_y:virtual_endstop
homing_speed = 40
homing_retract_dist = 0
homing_positive_dir = true
position_min = 0
position_max = 350
position_endstop = 350

[stepper_z]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z_STEP
dir_pin = !Z_DIR
enable_pin = !Z_ENABLE
endstop_pin = probe:z_virtual_endstop
homing_speed = 15
second_homing_speed = 8
homing_retract_dist = 3.0
position_max = 310
position_min = -5

[stepper_z1]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z1_STEP
dir_pin = !Z1_DIR
enable_pin = !Z1_ENABLE

[stepper_z2]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z2_STEP
dir_pin = !Z2_DIR
enable_pin = !Z2_ENABLE

[stepper_z3]
rotation_distance = 40
gear_ratio = 80:16
microsteps = 32
full_steps_per_rotation = 200
step_pin = Z3_STEP
dir_pin = Z3_DIR
enable_pin = !Z3_ENABLE

[gcode_macro _USER_VARIABLES]
variable_extruder_enabled = True
gcode = 
variable_heaterbed_enabled = True
variable_probe_type_enabled = "vorontap"
variable_startprint_actions = "bed_soak", "extruder_preheating", "chamber_soak", "clean", "tilt_calib", "z_offset", "bedmesh", "extruder_heating", "purge", "clean", "primeline"
variable_status_leds_minidisplay_enabled = True
variable_status_leds_minidisplay_led_name = "btt_mini12864"
variable_bed_mesh_enabled = True
variable_sensorless_homing_enabled = True
variable_qgl_enabled = True
variable_verbose = True
variable_homing_travel_speed = 350
variable_travel_speed = 350
variable_z_drop_speed = 15
variable_brush_clean_speed = 100
variable_probe_dock_speed = 60
variable_homing_travel_accel = 3000
variable_tilting_travel_accel = 3000
variable_brush_clean_accel = 1500
variable_probe_dock_accel = 2000
variable_accel_to_decel_factor = 0.75
variable_zendstop_position = -1, -1
variable_force_homing_in_start_print = False
variable_homing_zhop = 5
variable_homing_first = "X"
variable_homing_backoff_distance_xy = -5, -5
variable_sensorless_current_factor = 75
variable_probe_dock_margin_xy = 0, 0
variable_safe_extruder_temp = 150
variable_prime_line_xy = 5, 2.5
variable_prime_line_direction = "X"
variable_prime_line_length = 40
variable_prime_line_purge_distance = 30
variable_prime_line_flowrate = 10
variable_park_position_xy = -1, -1
variable_park_lift_z = 50
variable_disable_motors_in_end_print = False
variable_turn_off_heaters_in_end_print = True
variable_min_bed_xy = 0, 0
variable_max_bed_xy = 9999, 9999
variable_probe_min_z_travel = 20
variable_probe_dock_location_xy = -1, -1
variable_probe_servo_angle_retracted = 0
variable_probe_servo_angle_deployed = 90
variable_probe_before_attach_position = "front"
variable_probe_after_attach_position = "front"
variable_probe_before_dock_position = "front"
variable_probe_after_dock_position = "left"
variable_probe_move_attach_length = 30
variable_probe_move_dock_length = 30
variable_autodock_on_probe_error = True
variable_tap_max_probing_temp = 150
variable_tap_deactivation_zhop = 5
variable_print_default_bed_temp = 105
variable_print_default_extruder_temp = 240
variable_print_default_chamber_temp = 0
variable_print_default_chamber_max_heating_time = 15
variable_print_default_soak = 8
variable_print_default_material = "XXX"
variable_material_parameters = {
	'PLA': {
	'pressure_advance': 0.0525,
	'retract_length': 0.75,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 0,
	'additional_z_offset': 0
	},
	'PET': {
	'pressure_advance': 0.0650,
	'retract_length': 1.4,
	'unretract_extra_length': 0,
	'retract_speed': 30,
	'unretract_speed': 20,
	'filter_speed': 0,
	'additional_z_offset': 0.020
	},
	'ABS': {
	'pressure_advance': 0.0480,
	'retract_length': 0.5,
	'unretract_extra_length': 0,
	'retract_speed': 40,
	'unretract_speed': 30,
	'filter_speed': 80,
	'additional_z_offset': 0
	}
	}
variable_ercf_unload_on_cancel_print = False
variable_ercf_unload_on_end_print = True
variable_ercf_reset_stats_on_start_print = False
variable_purge_and_brush_enabled = False
variable_force_homing_before_brush = False
variable_brush_over_y_axis = True
variable_brush_xyz = -1, -1, -1
variable_purge_bucket_xyz = -1, -1, -1
variable_purge_distance = 30
variable_purge_ooze_time = 10
variable_purgeclean_servo_angle_retracted = 0
variable_purgeclean_servo_angle_deployed = 90
variable_light_intensity_start_print = 100
variable_light_intensity_printing = 30
variable_light_intensity_end_print = 0
variable_fix_heaters_temperature_settle = False
variable_resonnance_test_point_xy = -1, -1
variable_resonnance_test_z_clearance = 50
variable_status_leds_colors = {
	'logo': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'nozzle': {
	'heating': {'r': 0.8, 'g': 0.35, 'b': 0.0, 'w':0.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'standby': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'caselight': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
	'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
	'error': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'minidisplay': {
	'on': {'r': 0.0, 'g': 0.2, 'b': 0.4, 'w':1.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'error': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w':0.0},
	},
	'thermal': {
	'hot': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cold': {'r': 0.3, 'g': 0.0, 'b': 0.3, 'w': 0.0}
	}
	}
variable_x_driver = "TMC2209"
variable_y_driver = "TMC2209"
variable_z_driver = "TMC2209"
variable_e_driver = "TMC2209"

[extruder]
rotation_distance = 22.79234586
gear_ratio = 50:10
microsteps = 64
full_steps_per_rotation = 200
nozzle_diameter = 0.400
filament_diameter = 1.75
max_extrude_only_distance = 110
max_extrude_cross_section = 5
sensor_type = ATC Semitec 104GT-2
min_temp = 5
max_temp = 310
max_power = 1.0
min_extrude_temp = 170
pressure_advance = 0.045
pressure_advance_smooth_time = 0.040
step_pin = toolhead:E_STEP
dir_pin = toolhead:E_DIR
enable_pin = !toolhead:E_ENABLE
heater_pin = toolhead:E_HEATER
sensor_pin = toolhead:E_TEMPERATURE
control = pid
pid_kp = 34.626
pid_ki = 4.050
pid_kd = 74.014

[gcode_macro M109]
rename_existing = M109.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={S}
	{% else %}
	M109.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[heater_bed]
heater_pin = BED_HEATER
sensor_type = NTC 100K MGB18-104F39050L32
sensor_pin = BED_TEMPERATURE
max_power = 1
min_temp = 0
max_temp = 120
control = pid
pid_kp = 40.783
pid_ki = 1.007
pid_kd = 412.931

[gcode_macro M190]
rename_existing = M190.1
gcode = 
	{% set S = params.S|float %}
	
	{% set fix_heaters_temperature_settle = printer["gcode_macro _USER_VARIABLES"].fix_heaters_temperature_settle %}
	
	{% if fix_heaters_temperature_settle %}
	M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={S}
	{% else %}
	M190.1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% endif %}

[gcode_macro ACTIVATE_PROBE]
description = Put the machine in a state being able to probe
variable_temperature = 0
gcode = 
	{% set LOCK = params.LOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_max_probing_temp = printer["gcode_macro _USER_VARIABLES"].tap_max_probing_temp|float %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if LOCK %}
	_ATTACH_PROBE_LOCK
	{% else %}
	_ATTACH_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	SAVE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	
	{% set ACTUAL_TEMP = printer.extruder.temperature %}
	{% set TARGET_TEMP = printer.extruder.target %}
	
	SET_GCODE_VARIABLE MACRO=ACTIVATE_PROBE VARIABLE=temperature VALUE={TARGET_TEMP}
	
	{% if TARGET_TEMP > tap_max_probing_temp %}
	{ action_respond_info('Extruder temperature target of %.1fC is too high for TAP probing, lowering to %.1fC' % (TARGET_TEMP, tap_max_probing_temp)) }
	M106 S255
	M109 S{tap_max_probing_temp}
	M106 S0
	{% else %}
	
	{% if ACTUAL_TEMP > tap_max_probing_temp + 3 %}
	M106 S255
	TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={tap_max_probing_temp}
	M106 S0
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro DEACTIVATE_PROBE]
description = Revert the machine to a normal state after probing
gcode = 
	{% set UNLOCK = params.UNLOCK|default(False, boolean=true) %}
	
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set tap_deactivation_zhop = printer["gcode_macro _USER_VARIABLES"].tap_deactivation_zhop %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% if UNLOCK %}
	_DOCK_PROBE_UNLOCK
	{% else %}
	_DOCK_PROBE
	{% endif %}
	
	
	{% elif probe_type_enabled == "vorontap" %}
	
	{% set z_safe = printer.toolhead.position.z + tap_deactivation_zhop %}
	{% if z_safe > printer.toolhead.axis_maximum.z %}
	{% set z_safe = printer.toolhead.axis_maximum.z %}
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	
	{% set old_target_temperature = printer["gcode_macro ACTIVATE_PROBE"].temperature %}
	M109 S{old_target_temperature}
	
	RESTORE_GCODE_STATE NAME=BEFORE_TAP_ACTION
	{% endif %}

[probe]
pin = ^toolhead:MCU_5V_ENDSTOP
x_offset = 0
y_offset = 0
z_offset = -0.45
speed = 3
lift_speed = 10
samples = 3
samples_result = median
sample_retract_dist = 1.0
samples_tolerance = 0.007
samples_tolerance_retries = 3

[heater_fan hotend_fan]
pin = toolhead:E_FAN
max_power = 1.0
kick_start_time = 0.100
heater = extruder
heater_temp = 50.0

[fan]
pin = toolhead:PART_FAN
kick_start_time = 0.100
cycle_time = 0.010

[gcode_macro _SET_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = params.LED|string %}
	{% set idx = (params.IDX|string).split(',') %}
	{% set transmit_last = params.TRANSMIT|default(1) %}
	
	{% for led_index in idx %}
	{% set transmit=transmit_last if loop.last else 0 %}
	SET_LED LED={led} RED={red} GREEN={green} BLUE={blue} WHITE={white} INDEX={led_index} TRANSMIT={transmit}
	{% endfor %}

[gcode_macro _SET_LEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_idx"] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_ALLLEDS_BY_NAME]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set led = printer["gcode_macro _USER_VARIABLES"]["status_leds_" + leds_name + "_led_name"] %}
	{% set color = printer["gcode_macro _USER_VARIABLES"].status_leds_colors[leds_name][color_name] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	SET_LED LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w}  TRANSMIT={transmit}

[gcode_macro _SET_LOGO_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_logo_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro _SET_NOZZLE_LEDS]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_led_name %}
	{% set idx = printer["gcode_macro _USER_VARIABLES"].status_leds_nozzle_idx %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS LED={led} RED={red} green={green} BLUE={blue} WHITE={white} IDX="{idx}" TRANSMIT={transmit}

[gcode_macro SET_LOGO_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="logo" COLOR="off" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_ON]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="on" TRANSMIT={transmit}

[gcode_macro SET_NOZZLE_LEDS_OFF]
gcode = 
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR="off" TRANSMIT={transmit}

[gcode_macro STATUS_LEDS]
gcode = 
	{% set color = params.COLOR|default('off')|lower %}
	
	{% set status_color = {
	'ready': {
	'logo': 'standby',
	'nozzle': 'standby',
	'caselight': 'standby',
	'minidisplay': 'on'
	},
	'busy': {
	'logo': 'busy',
	'nozzle': 'on',
	'caselight': 'busy',
	'minidisplay': 'on'
	},
	'heating': {
	'logo': 'heating',
	'nozzle': 'heating',
	'caselight': 'heating',
	'minidisplay': 'on'
	},
	'leveling': {
	'logo': 'leveling',
	'nozzle': 'on',
	'caselight': 'leveling',
	'minidisplay': 'on'
	},
	'homing': {
	'logo': 'homing',
	'nozzle': 'on',
	'caselight': 'homing',
	'minidisplay': 'on'
	},
	'cleaning': {
	'logo': 'cleaning',
	'nozzle': 'on',
	'caselight': 'cleaning',
	'minidisplay': 'on'
	},
	'meshing': {
	'logo': 'meshing',
	'nozzle': 'on',
	'caselight': 'meshing',
	'minidisplay': 'on'
	},
	'calibrating_z': {
	'logo': 'calibrating_z',
	'nozzle': 'on',
	'caselight': 'calibrating_z',
	'minidisplay': 'on'
	},
	'printing': {
	'logo': 'printing',
	'nozzle': 'on',
	'caselight': 'printing',
	'minidisplay': 'on'
	},
	'off': {
	'logo': 'off',
	'nozzle': 'off',
	'caselight': 'off',
	'minidisplay': 'off'
	},
	'on': {
	'logo': 'on',
	'nozzle': 'on',
	'caselight': 'on',
	'minidisplay': 'on'
	},
	'error': {
	'logo': 'error',
	'nozzle': 'error',
	'caselight': 'error',
	'minidisplay': 'error'
	}
	} %}
	
	{% if not (color in status_color) %}
	{ action_raise_error("COLOR is not valid!") }
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	_SET_LEDS_BY_NAME LEDS="logo" COLOR={status_color[color].logo} TRANSMIT=0
	_SET_LEDS_BY_NAME LEDS="nozzle" COLOR={status_color[color].nozzle} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_caselight_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="caselight" COLOR={status_color[color].caselight} TRANSMIT=1
	{% endif %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_minidisplay_enabled %}
	_SET_ALLLEDS_BY_NAME LEDS="minidisplay" COLOR={status_color[color].minidisplay} TRANSMIT=1
	{% endif %}

[display]
lcd_type = uc1701
cs_pin = EXP1_3
a0_pin = EXP1_4
rst_pin = EXP1_5
encoder_pins = ^EXP2_5, ^EXP2_3
click_pin = ^!EXP1_2
contrast = 63
spi_software_miso_pin = EXP2_1
spi_software_mosi_pin = EXP2_6
spi_software_sclk_pin = EXP2_2

[output_pin beeper]
pin = EXP1_1

[neopixel btt_mini12864]
pin = EXP1_6
chain_count = 3
initial_red = 0.1
initial_green = 0.5
initial_blue = 0.0
color_order = RGB

[delayed_gcode setdisplayneopixel]
initial_duration = 1
gcode = 
	SET_LED LED=btt_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
	SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3

[temperature_sensor RaspberryPi]
sensor_type = temperature_host

[temperature_sensor mcu]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 90

[temperature_sensor toolhead_mcu]
sensor_type = temperature_mcu
sensor_mcu = toolhead
min_temp = 0
max_temp = 100

[adxl345]
cs_pin = toolhead:ADXL_CS
spi_software_sclk_pin = toolhead:ADXL_SCLK
spi_software_mosi_pin = toolhead:ADXL_MOSI
spi_software_miso_pin = toolhead:ADXL_MISO
axes_map = x,y,z

[resonance_tester]
accel_chip = adxl345
probe_points = 
	-1,-1,-1

[gcode_macro TEST_RESONANCES]
rename_existing = BASE_TEST_RESONANCES
description = Runs input shaper test at the center of the bed
gcode = 
	{% set Tx, Ty = printer["gcode_macro _USER_VARIABLES"].resonnance_test_point_xy|map('float') %}
	{% set Tz = printer["gcode_macro _USER_VARIABLES"].resonnance_test_z_clearance|float %}
	
	{% if Tx == -1 and Ty == -1 %}
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	BASE_TEST_RESONANCES POINT={max_x / 2},{max_y / 2},{Tz} {rawparams}
	{% else %}
	BASE_TEST_RESONANCES POINT={Tx},{Ty},{Tz} {rawparams}
	{% endif %}

[gcode_macro AXES_SHAPER_CALIBRATION]
description = Run standard input shaper test for all axes
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.3)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=X FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=Y FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=SHAPER

[gcode_macro BELTS_SHAPER_CALIBRATION]
description = Run custom demi-axe test to analyze belts on CoreXY printers
gcode = 
	{% set verbose = params.VERBOSE|default(true) %}
	{% set min_freq = params.FREQ_START|default(5)|float %}
	{% set max_freq = params.FREQ_END|default(133.33)|float %}
	{% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
	
	TEST_RESONANCES AXIS=1,1 OUTPUT=raw_data NAME=b FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=a FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
	M400
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS=BELTS

[gcode_macro EXCITATE_AXIS_AT_FREQ]
description = Maintain a specified input shaper excitating frequency for some time to diagnose vibrations
gcode = 
	{% set FREQUENCY = params.FREQUENCY|default(25)|int %}
	{% set TIME = params.TIME|default(10)|int %}
	{% set AXIS = params.AXIS|default("x")|string|lower %}
	
	TEST_RESONANCES OUTPUT=raw_data AXIS={AXIS} FREQ_START={FREQUENCY-1} FREQ_END={FREQUENCY+1} HZ_PER_SEC={1/(TIME/3)}
	M400

[gcode_macro VIBRATIONS_CALIBRATION]
gcode = 
	
	
	
	{% set size = params.SIZE|default(60)|int %}
	{% set direction = params.DIRECTION|default('XY') %}
	{% set z_height = params.Z_HEIGHT|default(20)|int %}
	{% set verbose = params.VERBOSE|default(true) %}
	
	{% set min_speed = params.MIN_SPEED|default(20)|int * 60 %}
	{% set max_speed = params.MAX_SPEED|default(200)|int * 60 %}
	{% set speed_increment = params.SPEED_INCREMENT|default(2)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	
	{% set accel_chip = params.ACCEL_CHIP|default("adxl345") %}
	
	
	
	
	{% set mid_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set mid_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% set direction_factor = {
	'XY'  : {
	'start' : {'x': -0.5, 'y': -0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': -0.5, 'y': -0.5, 'z': 0.0 }
	}
	},
	'AB' : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'2' : {'x': 0.0, 'y': 0.0, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	},
	'ABXY' : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'2' : {'x': -0.5, 'y': 0.5, 'z': 0.0 },
	'3' : {'x': 0.5, 'y': 0.5, 'z': 0.0 },
	'4' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'5' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'B'  : {
	'start' : {'x': 0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': -0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'A'  : {
	'start' : {'x': -0.5, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.5, 'z': 0.0 }
	}
	},
	'X'  : {
	'start' : {'x': -0.5, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.5, 'y': 0.0, 'z': 0.0 },
	'1' : {'x': -0.5, 'y': 0.0, 'z': 0.0 }
	}
	},
	'Y'  : {
	'start' : {'x': 0.0, 'y': 0.5 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': -0.5, 'z': 0.0 },
	'1' : {'x': 0.0, 'y': 0.5, 'z': 0.0 }
	}
	},
	'Z'  : {
	'start' : {'x': 0.0, 'y': 0.0 },
	'move_factors' : {
	'0' : {'x': 0.0, 'y': 0.0, 'z': 1.0 },
	'1' : {'x': 0.0, 'y': 0.0, 'z': 0.0 }
	}
	}
	}
	%}
	
	
	
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	{% if (size / (max_speed / 60)) < 0.25 %}
	{ action_raise_error("SIZE is too small for this MAX_SPEED. Increase SIZE or decrease MAX_SPEED!") }
	{% endif %}
	
	{% if not (direction in direction_factor) %}
	{ action_raise_error("DIRECTION is not valid. Only XY, AB, ABXY, A, B, X, Y or Z is allowed!") }
	{% endif %}
	
	{action_respond_info("")}
	{action_respond_info("Starting speed and vibration calibration")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION
	
	G90
	
	
	G1 Z{z_height}
	G1 X{mid_x + (size * direction_factor[direction].start.x) } Y{mid_y + (size * direction_factor[direction].start.y)} F{feedrate_travel}
	
	
	{% for curr_speed in range(min_speed, max_speed + speed_increment) %}
	{% if (curr_speed - min_speed) % speed_increment == 0 %}
	{% if verbose %}
	RESPOND MSG="Current speed: {(curr_speed / 60)|int} mm/s"
	{% endif %}
	
	ACCELEROMETER_MEASURE CHIP={accel_chip}
	{% for key, factor in direction_factor[direction].move_factors|dictsort %}
	G1 X{mid_x + (size * factor.x) } Y{mid_y + (size * factor.y)} Z{z_height + (size * factor.z)} F{curr_speed}
	{% endfor %}
	ACCELEROMETER_MEASURE CHIP={accel_chip} NAME=sp{(curr_speed / 60)|int}n1
	
	G4 P300
	M400
	{% endif %}
	{% endfor %}
	
	{% if verbose %}
	RESPOND MSG="Graphs generation... Please wait a minute or two and look in the configured folder."
	{% endif %}
	RUN_SHELL_COMMAND CMD=plot_graph PARAMS="VIBRATIONS {direction}"
	
	RESTORE_GCODE_STATE NAME=STATE_VIBRATIONS_CALIBRATION

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = _BASE_BED_MESH_CALIBRATE
description = Perform Mesh Bed Leveling with klicky automount
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if verbose %}
	{ action_respond_info("Bed Mesh Calibrate") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	_BASE_BED_MESH_CALIBRATE  {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	DEACTIVATE_PROBE

[gcode_macro _ADAPTIVE_MESH_VARIABLES]
variable_ready = False
variable_do_mesh = False
variable_do_nominal = False
variable_mesh_min = 0,0
variable_mesh_max = 0,0
variable_mesh_center = 0,0
variable_probe_count = 0,0
variable_rri = 0
variable_algo = "bicubic"
gcode = 

[gcode_macro COMPUTE_MESH_PARAMETERS]
description = Compute the mesh parameters and store them for later use
gcode = 
	
	{% set xMinConf, yMinConf = printer["configfile"].config["bed_mesh"]["mesh_min"].split(',')|map('trim')|map('int') %}
	{% set xMaxConf, yMaxConf = printer["configfile"].config["bed_mesh"]["mesh_max"].split(',')|map('trim')|map('int') %}
	{% set xProbeCntConf, yProbeCntConf = printer["configfile"].config["bed_mesh"]["probe_count"].split(',')|map('trim')|map('int') %}
	{% set algo = printer["configfile"].config["bed_mesh"]["algorithm"]|lower %}
	{% set xMeshPPS, yMeshPPS = (printer["configfile"].config["bed_mesh"]["mesh_pps"]|default('2,2')).split(',')|map('trim')|map('int') %}
	
	{% set margin = params.MARGIN|default(5)|int %}
	{% set force_mesh = params.FORCE_MESH|default(False) %}
	
	
	
	
	{% if params.SIZE is defined and params.SIZE != "0_0_0_0" %}
	RESPOND MSG="Got a SIZE parameter for the adaptive bed mesh"
	{% set xMinSpec, yMinSpec, xMaxSpec, yMaxSpec = params.SIZE.split('_')|map('trim')|map('int') %}
	
	{% elif printer.exclude_object.objects %}
	
	
	RESPOND MSG="No SIZE parameter, using the [exclude_object] tags for the adaptive bed mesh"
	{% set eo_points = printer.exclude_object.objects|map(attribute='polygon')|sum(start=[]) %}
	{% set xMinSpec = eo_points|map(attribute=0)|min %}
	{% set yMinSpec = eo_points|map(attribute=1)|min %}
	{% set xMaxSpec = eo_points|map(attribute=0)|max %}
	{% set yMaxSpec = eo_points|map(attribute=1)|max %}
	
	{% else %}
	
	
	RESPOND MSG="No info about the first layer coordinates, doing a nominal bed mesh instead of adaptive"
	{% endif %}
	
	
	
	
	{% if xMinSpec and yMinSpec and xMaxSpec and yMaxSpec %}
	
	
	
	
	{% set xMin = [xMinConf, (xMinSpec - margin)]|max %}
	{% set xMax = [xMaxConf, (xMaxSpec + margin)]|min %}
	{% set yMin = [yMinConf, (yMinSpec - margin)]|max %}
	{% set yMax = [yMaxConf, (yMaxSpec + margin)]|min %}
	
	
	
	
	{% set xProbeCnt = ((xMax - xMin) * xProbeCntConf / (xMaxConf - xMinConf))|round(0, 'ceil')|int %}
	{% set yProbeCnt = ((yMax - yMin) * yProbeCntConf / (yMaxConf - yMinConf))|round(0, 'ceil')|int %}
	
	
	
	
	
	
	
	
	{% if xProbeCnt < 3 and yProbeCnt < 3 %}
	{% if force_mesh %}
	RESPOND MSG="Bed mesh forced (small part detected): meshing 3x3..."
	{% set xProbeCnt = 3 %}
	{% set yProbeCnt = 3 %}
	{% set rRefIndex = 4 %}
	{% set algo = "lagrange" %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% else %}
	RESPOND MSG="Computed mesh parameters: none, bed mesh not needed for very small parts"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={False}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	{% else %}
	{% set xProbeCnt = [3, xProbeCnt]|max %}
	{% set yProbeCnt = [3, yProbeCnt]|max %}
	
	
	
	{% if xProbeCnt % 2 == 0 %}
	{% set xProbeCnt = xProbeCnt + 1 %}
	{% endif %}
	{% if yProbeCnt % 2 == 0 %}
	{% set yProbeCnt = yProbeCnt + 1 %}
	{% endif %}
	
	
	{% if xMeshPPS != 0 or yMeshPPS != 0 %}
	{% set probeCntMin = [xProbeCnt, yProbeCnt]|min %}
	{% set probeCntMax = [xProbeCnt, yProbeCnt]|max %}
	{% if algo == "lagrange" and probeCntMax > 6 %}
	
	{% set algo = "bicubic" %}
	{% endif %}
	{% if algo == "bicubic" and probeCntMin < 4 %}
	{% if probeCntMax > 6 %}
	
	{% if xProbeCnt > yProbeCnt %}
	{% set yProbeCnt = 5 %}
	{% else %}
	{% set xProbeCnt = 5 %}
	{% endif %}
	{% else %}
	
	{% set algo = "lagrange" %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	{% set rRefIndex = (((xProbeCnt * yProbeCnt) - 1) / 2)|int %}
	{% set xCenter = xMin + ((xMax - xMin) / 2) %}
	{% set yCenter = yMin + ((yMax - yMin) / 2) %}
	
	
	{% set mesh_min = "%d,%d"|format(xMin, yMin) %}
	{% set mesh_max = "%d,%d"|format(xMax, yMax) %}
	{% set probe_count = "%d,%d"|format(xProbeCnt, yProbeCnt) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	RESPOND MSG="Computed mesh parameters: MESH_MIN={mesh_min} MESH_MAX={mesh_max} MESH_CENTER={mesh_center} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={False}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_min VALUE='"{mesh_min}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_max VALUE='"{mesh_max}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=probe_count VALUE='"{probe_count}"'
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=rri VALUE={rRefIndex}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=algo VALUE='"{algo}"'
	{% endif %}
	{% else %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_mesh VALUE={True}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=do_nominal VALUE={True}
	
	{% set xCenter = xMinConf + ((xMaxConf - xMinConf) / 2) %}
	{% set yCenter = yMinConf + ((yMaxConf - yMinConf) / 2) %}
	{% set mesh_center = "%d,%d"|format(xCenter, yCenter) %}
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=mesh_center VALUE='"{mesh_center}"'
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={True}

[gcode_macro ADAPTIVE_BED_MESH]
description = Perform a bed mesh, but only where and when it's needed
gcode = 
	{% set ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	
	{% if not 'xyz' in printer.toolhead.homed_axes %}
	{ action_raise_error("Must Home printer first!") }
	{% endif %}
	
	
	{% if ready %}
	_DO_ADAPTIVE_MESH
	
	
	
	{% else %}
	RESPOND MSG="Adaptive bed mesh: parameters not already computed, automatically calling the COMPUTE_MESH_PARAMETERS macro prior to the mesh"
	COMPUTE_MESH_PARAMETERS {rawparams}
	M400
	_DO_ADAPTIVE_MESH
	{% endif %}

[gcode_macro _DO_ADAPTIVE_MESH]
gcode = 
	
	{% set do_mesh = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_mesh %}
	{% set do_nominal = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].do_nominal %}
	{% set mesh_min = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_min %}
	{% set mesh_max = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_max %}
	{% set probe_count = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].probe_count %}
	{% set rRefIndex = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].rri %}
	{% set algo = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].algo %}
	
	
	
	
	{% if do_mesh %}
	
	{% if do_nominal %}
	RESPOND MSG="Adaptive bed mesh: nominal bed mesh"
	BED_MESH_CALIBRATE
	{% else %}
	{% if printer["configfile"].config["bed_mesh"]["relative_reference_index"] is defined %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} RELATIVE_REFERENCE_INDEX={rRefIndex} ALGORITHM={algo}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}"
	BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count} ALGORITHM={algo}
	{% endif %}
	{% endif %}
	{% else %}
	RESPOND MSG="Adaptive bed mesh: no mesh to be done"
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=_ADAPTIVE_MESH_VARIABLES VARIABLE=ready VALUE={False}

[bed_mesh]
speed = 350
horizontal_move_z = 12
mesh_min = 25, 25
mesh_max = 325, 325
probe_count = 9, 9
fade_start = 0.6
fade_end = 10.0
algorithm = bicubic
relative_reference_index = 40

[tmc2209 stepper_x]
diag_pin = ^X_STOP
driver_sgthrs = 50
uart_pin = X_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_y]
diag_pin = ^Y_STOP
driver_sgthrs = 60
uart_pin = Y_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[input_shaper]
shaper_freq_x = 56.4
shaper_type_x = zv
shaper_freq_y = 38.4
shaper_type_y = mzv

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing = _BASE_QUAD_GANTRY_LEVEL
description = Conform a moving, twistable gantry to the shape of a stationary bed with klicky automount
gcode = 
	{% set tilting_travel_accel = printer["gcode_macro _USER_VARIABLES"].tilting_travel_accel %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if verbose %}
	{ action_respond_info("Quad gantry leveling") }
	{% endif %}
	_CG28
	
	ACTIVATE_PROBE
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{tilting_travel_accel}
	
	_BASE_QUAD_GANTRY_LEVEL {% for p in params %}{'%s=%s ' % (p, params[p])}{% endfor %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	DEACTIVATE_PROBE

[gcode_macro _TILT_CALIBRATE]
description = Do a QGL, Z_tilt, etc... depending of the machine configuration
gcode = 
	{% set FORCE_OPERATION = params.FORCE|default(true) %}
	{% set conf_QGL = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set conf_ztilt = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=True
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="LEVELING"
	{% endif %}
	
	{% if conf_QGL %}
	{% if printer.quad_gantry_level.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="QGL..."
	{% endif %}
	QUAD_GANTRY_LEVEL
	{% endif %}
	{% elif conf_ztilt %}
	{% if printer.z_tilt.applied|lower == 'false' or FORCE_OPERATION %}
	{% if verbose %}
	RESPOND MSG="Z tilt adjust..."
	{% endif %}
	Z_TILT_ADJUST
	{% endif %}
	{% else %}
	{% if verbose %}
	RESPOND MSG="No tilt calibration needed on this machine. Continuing..."
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	SET_GCODE_VARIABLE MACRO=_PROBE_ON_ERROR_ACTION VARIABLE=probing VALUE=False
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[quad_gantry_level]
gantry_corners = 
	-60,-10
	410,420
points = 
	50,25
	50,275
	300,275
	300,25
speed = 350
horizontal_move_z = 12
retries = 5
retry_tolerance = 0.0075
max_adjust = 10

[virtual_sdcard]
path = ~/printer_data/gcodes
on_error_gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	
	{% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	STATUS_LEDS COLOR="ERROR"
	{% endif %}
	
	{% if probe_type_enabled == "dockable" %}
	_PROBE_ON_ERROR_ACTION
	{% endif %}

[exclude_object]

[idle_timeout]
timeout = 1800

[pause_resume]

[display_status]

[respond]

[force_move]
enable_force_move = True

[gcode_arcs]
resolution = 0.1

[gcode_macro CANCEL_PRINT]
rename_existing = BASE_CANCEL_PRINT
description = Cancel the print, retract 10mm of filament and park
gcode = 
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload_on_cancel_print = printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_cancel_print %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload_on_cancel_print %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	SDCARD_RESET_FILE
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_OFF
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}
	
	BASE_CANCEL_PRINT

[gcode_macro END_PRINT]
description = Stop the print and filter the atmosphere for 10min before shuting down
gcode = 
	{% set disable_motors_in_end_print = printer["gcode_macro _USER_VARIABLES"].disable_motors_in_end_print %}
	{% set turn_off_heaters_in_end_print = printer["gcode_macro _USER_VARIABLES"].turn_off_heaters_in_end_print %}
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set light_intensity_end_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_end_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_unload = params.ERCF_UNLOAD_AT_END|default(printer["gcode_macro _USER_VARIABLES"].ercf_unload_on_end_print)|int %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	PARK
	
	{% if klippain_ercf_enabled and ercf_unload %}
	{% if printer.ercf.enabled %}
	
	ERCF_EJECT
	{% endif %}
	{% else %}
	
	_TIP_SHAPING
	G92 E0
	G1 E-10 F2100
	{% endif %}
	
	{% if turn_off_heaters_in_end_print %}
	TURN_OFF_HEATERS
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={safe_extruder_temp}
	{% endif %}
	
	M107
	M400
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if disable_motors_in_end_print %}
	M84
	{% endif %}
	
	
	
	
	{% if filter_enabled %}
	{% set FILTER_TIME = params.FILTER_TIME|default(600)|int %}
	START_FILTER SPEED=1
	UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED DURATION={FILTER_TIME}
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_end_print}
	{% endif %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="OFF"
	{% endif %}

[gcode_macro PARK]
description = Park the toolhead at the back and retract some filament if the nozzle is hot
gcode = 
	{% set E = params.E|default(1.7)|float %}
	
	{% set Px, Py = printer["gcode_macro _USER_VARIABLES"].park_position_xy|map('float') %}
	{% set park_lift_z = printer["gcode_macro _USER_VARIABLES"].park_lift_z %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	
	{% set z_safe = act_z + park_lift_z %}
	{% if z_safe > max_z %}
	{% set z_safe = max_z %}
	{% endif %}
	
	
	{% if printer.extruder.temperature > 185 and firmware_retraction_enabled %}
	G10
	{% endif %}
	G90
	G1 Z{z_safe} F{Sz}
	
	G0 X{Px} Y{Py} F{St}

[gcode_macro PAUSE]
rename_existing = BASE_PAUSE
description = Pause the print and park
gcode = 
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	
	{% if printer.pause_resume.is_paused %}
	RESPOND MSG="Print is already paused"
	{% else %}
	SAVE_GCODE_STATE NAME=PAUSE_state
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	BASE_PAUSE
	PARK
	{% endif %}

[gcode_macro RESUME]
rename_existing = BASE_RESUME
description = Resume the print after an optional unretract
gcode = 
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	
	{% if not printer.pause_resume.is_paused %}
	RESPOND MSG="Print is not paused. Resume ignored"
	{% else %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={St}
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	BASE_RESUME
	{% endif %}

[gcode_macro START_PRINT]
description = Machine heatup procedure before starting a print
variable_bed_temp = 0
variable_extruder_temp = 0
variable_z_adjust = 0
variable_soak = 0
variable_chamber_temp = 0
variable_chamber_maxtime = 0
variable_initial_tool = 0
variable_material = "XXX"
variable_fl_size = "0_0_0_0"
gcode = 
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_ADJUST = params.Z_ADJUST|default(0)|float %}
	{% set SOAK = params.SOAK|default(printer["gcode_macro _USER_VARIABLES"].print_default_soak)|int %}
	{% set CHAMBER_TEMP = params.CHAMBER|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_temp)|int %}
	{% set CHAMBER_MAXTIME = params.CHAMBER_MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	{% set INITIAL_TOOL = params.INITIAL_TOOL|default(0)|int %}
	{% set MATERIAL = params.MATERIAL|default(printer["gcode_macro _USER_VARIABLES"].print_default_material)|string %}
	{% set FL_SIZE = params.SIZE|default("0_0_0_0")|string %}
	
	
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=bed_temp VALUE={BED_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=extruder_temp VALUE={EXTRUDER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=soak VALUE={SOAK}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_temp VALUE={CHAMBER_TEMP}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_maxtime VALUE={CHAMBER_MAXTIME}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=initial_tool VALUE={INITIAL_TOOL}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=material VALUE='"{MATERIAL}"'
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=fl_size VALUE='"{FL_SIZE}"'
	
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set light_enabled = printer["gcode_macro _USER_VARIABLES"].light_enabled %}
	{% set light_intensity_start_print = printer["gcode_macro _USER_VARIABLES"].light_intensity_start_print %}
	{% set light_intensity_printing = printer["gcode_macro _USER_VARIABLES"].light_intensity_printing %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set ercf_reset_stats_on_start_print = printer["gcode_macro _USER_VARIABLES"].ercf_reset_stats_on_start_print %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set firmware_retraction_enabled = printer["gcode_macro _USER_VARIABLES"].firmware_retraction_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% if MATERIAL not in printer["gcode_macro _USER_VARIABLES"].material_parameters %}
	RESPOND MSG="Material '{MATERIAL}' is unknown!"
	{ action_raise_error("Add this new material to your material_parameters variable!") }
	{% else %}
	RESPOND MSG="Material '{MATERIAL}' is used"
	{% set material = printer["gcode_macro _USER_VARIABLES"].material_parameters[MATERIAL] %}
	{% endif %}
	
	
	
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="BUSY"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_start_print}
	{% endif %}
	
	CLEAR_PAUSE
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if ercf_reset_stats_on_start_print %}
	ERCF_RESET_STATS
	{% endif %}
	{% endif %}
	{% endif %}
	
	SET_GCODE_OFFSET Z=0
	M221 S100
	M220 S100
	G90
	M83
	
	
	{% if firmware_retraction_enabled %}
	SET_RETRACTION RETRACT_LENGTH={material.retract_length} RETRACT_SPEED={material.retract_speed} UNRETRACT_EXTRA_LENGTH={material.unretract_extra_length} UNRETRACT_SPEED={material.unretract_speed}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={material.pressure_advance}
	
	
	{% if force_homing_in_start_print %}
	G28
	{% else %}
	_CG28
	{% endif %}
	
	
	
	{% set sp_actions = printer["gcode_macro _USER_VARIABLES"].startprint_actions %}
	{% for action in sp_actions %}
	{% if action == "bed_soak" %}
	_MODULE_HEATSOAK_BED
	{% elif action == "chamber_soak" %}
	_MODULE_HEATSOAK_CHAMBER
	{% elif action == "tilt_calib" %}
	_MODULE_TILTING
	{% elif action == "extruder_heating" %}
	_MODULE_EXTRUDER_HEATING
	{% elif action == "purge" %}
	_MODULE_PURGE
	{% elif action == "clean" %}
	_MODULE_CLEAN
	{% elif action == "z_offset" %}
	_MODULE_Z_CALIB
	{% elif action == "bedmesh" %}
	_MODULE_BED_MESH
	{% elif action == "primeline" %}
	_MODULE_PRIMELINE
	{% elif action == "extruder_preheating" %}
	_MODULE_EXTRUDER_PREHEATING
	{% elif action == "custom1" %}
	_MODULE_CUSTOM1
	{% elif action == "custom2" %}
	_MODULE_CUSTOM2
	{% elif action == "custom3" %}
	_MODULE_CUSTOM3
	{% else %}
	{ action_raise_error("Unknown module called in START_PRINT! Please verify your startprint_actions variable override!") }
	{% endif %}
	{% endfor %}
	
	
	
	SET_GCODE_OFFSET Z_ADJUST={Z_ADJUST} MOVE=1
	
	
	SET_GCODE_OFFSET Z_ADJUST={material.additional_z_offset} MOVE=1
	{% if filter_enabled %}
	START_FILTER SPEED={material.filter_speed / 100}
	{% endif %}
	
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="PRINTING"
	{% endif %}
	
	{% if light_enabled %}
	LIGHT_ON S={light_intensity_printing}
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Start printing !"
	{% endif %}
	
	G92 E0.0

[gcode_macro _MODULE_PRIMELINE]
gcode = 
	PRIMELINE

[gcode_macro _MODULE_HEATSOAK_BED]
gcode = 
	
	
	
	
	
	{% set BED_TEMP = printer["gcode_macro START_PRINT"].bed_temp %}
	{% set SOAK = printer["gcode_macro START_PRINT"].soak %}
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if printer.heater_bed.target < (BED_TEMP - 8) %}
	
	
	{% if (CHAMBER_TEMP > 0) and filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	{% if SOAK > 0 %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME={SOAK}
	{% else %}
	HEATSOAK_BED TEMP={BED_TEMP} SOAKTIME=0
	{% endif %}

[gcode_macro _MODULE_HEATSOAK_CHAMBER]
gcode = 
	
	
	
	{% set CHAMBER_TEMP = printer["gcode_macro START_PRINT"].chamber_temp %}
	{% set CHAMBER_MAXTIME = printer["gcode_macro START_PRINT"].chamber_maxtime %}
	
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	{% set filter_enabled = printer["gcode_macro _USER_VARIABLES"].filter_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if chamber_sensor_enabled %}
	{% if CHAMBER_TEMP > 0 %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	
	{% if CURRENT_TEMP <= CHAMBER_TEMP %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	
	
	{% if filter_enabled %}
	START_FILTER SPEED=1
	{% endif %}
	
	
	HEATSOAK_CHAMBER TEMP={CHAMBER_TEMP} MAXTIME={CHAMBER_MAXTIME}
	
	
	{% if filter_enabled %}
	STOP_FILTER
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_TILTING]
gcode = 
	
	
	
	{% set force_homing_in_start_print = printer["gcode_macro _USER_VARIABLES"].force_homing_in_start_print %}
	_TILT_CALIBRATE FORCE={force_homing_in_start_print}

[gcode_macro _MODULE_EXTRUDER_HEATING]
gcode = 
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	{% set INITIAL_TOOL = printer["gcode_macro START_PRINT"].initial_tool %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder heating to print temperature..."
	{% endif %}
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET
	{% if not purge_and_brush_enabled %}
	G0 X{max_x|int / 2} Y{max_y|int / 3} Z50 F{St}
	{% endif %}
	
	M109 S{EXTRUDER_TEMP}
	
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	ERCF_CHANGE_TOOL STANDALONE=1 TOOL={INITIAL_TOOL}
	_ERCF_ERROR_CHECK
	{% endif %}
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Extruder temperature OK"
	{% endif %}

[gcode_macro _MODULE_PURGE]
gcode = 
	
	
	
	{% set EXTRUDER_TEMP = printer["gcode_macro START_PRINT"].extruder_temp %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	
	{% if purge_and_brush_enabled %}
	PURGE TEMP={EXTRUDER_TEMP}
	{% endif %}

[gcode_macro _MODULE_CLEAN]
gcode = 
	
	
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set force_homing_before_brush = printer["gcode_macro _USER_VARIABLES"].force_homing_before_brush %}
	
	{% if purge_and_brush_enabled %}
	{% if force_homing_before_brush %}
	G28 Z
	{% endif %}
	CLEAN_NOZZLE
	{% endif %}

[gcode_macro _MODULE_Z_CALIB]
gcode = 
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% if bed_mesh_enabled and printer.bed_mesh.profile_name == "" %}
	COMPUTE_MESH_PARAMETERS SIZE={FL_SIZE}
	{% endif %}
	
	{% if zcalib_plugin_enabled %}
	G28 Z
	CALIBRATE_Z
	{% else %}
	G28 Z
	{% endif %}

[gcode_macro _MODULE_BED_MESH]
gcode = 
	
	
	
	
	
	{% set FL_SIZE = printer["gcode_macro START_PRINT"].fl_size %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if bed_mesh_enabled %}
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="MESHING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Bed mesh measurement..."
	{% endif %}
	
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	ADAPTIVE_BED_MESH
	{% else %}
	ADAPTIVE_BED_MESH SIZE={FL_SIZE}
	{% endif %}
	{% endif %}

[gcode_macro _MODULE_EXTRUDER_PREHEATING]
gcode = 
	
	{% set safe_extruder_temp = printer["gcode_macro _USER_VARIABLES"].safe_extruder_temp|float %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HEATING"
	{% endif %}
	{% if verbose %}
	RESPOND MSG="Pre-heating the nozzle to a safe temperature..."
	{% endif %}
	
	M109 S{safe_extruder_temp}
	
	{% if verbose %}
	RESPOND MSG="Extruder at safe temperature of {safe_extruder_temp} degrees"
	{% endif %}

[gcode_macro _MODULE_CUSTOM1]
gcode = 

[gcode_macro _MODULE_CUSTOM2]
gcode = 

[gcode_macro _MODULE_CUSTOM3]
gcode = 

[gcode_macro _CG28]
description = Homing only if necessary
gcode = 
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	{% if "xyz" not in printer.toolhead.homed_axes %}
	G28
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[homing_override]
axes = xyz
gcode = 
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled %}
	{% set homing_zhop = printer["gcode_macro _USER_VARIABLES"].homing_zhop|float %}
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed * 60 %}
	{% set homing_travel_accel = printer["gcode_macro _USER_VARIABLES"].homing_travel_accel %}
	{% set sensorless_homing_enabled = printer["gcode_macro _USER_VARIABLES"].sensorless_homing_enabled %}
	{% set sensorless_current_factor = printer["gcode_macro _USER_VARIABLES"].sensorless_current_factor / 100 %}
	{% set z_drop_speed = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	
	{% set homing_first = printer["gcode_macro _USER_VARIABLES"].homing_first|string|upper %}
	{% set x_homing_backoff, y_homing_backoff = printer["gcode_macro _USER_VARIABLES"].homing_backoff_distance_xy|map('float') %}
	
	{% set x_position_endstop = printer["configfile"].config["stepper_x"]["position_endstop"]|float %}
	{% set y_position_endstop = printer["configfile"].config["stepper_y"]["position_endstop"]|float %}
	{% set x_position_center = printer.toolhead.axis_maximum.x|int/2 - printer.toolhead.axis_minimum.x|int/2 %}
	{% set y_position_center = printer.toolhead.axis_maximum.y|int/2 - printer.toolhead.axis_minimum.y|int/2 %}
	
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	{% set X, Y, Z = False, False, False %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="HOMING"
	{% endif %}
	
	
	{% if not 'X' in params
	and not 'Y' in params
	and not 'Z' in params %}
	
	{% set X, Y, Z = True, True, True %}
	
	{% else %}
	{% if 'X' in params %}
	{% set X = True %}
	{% endif %}
	
	{% if 'Y' in params %}
	{% set Y = True %}
	{% endif %}
	
	{% if 'Z' in params %}
	{% set Z = True %}
	{% endif %}
	
	{% if 'X' in params
	and 'Y' in params
	and 'Z' in params %}
	
	
	_HOMING_VARIABLES reset=1
	{% endif %}
	
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_ENTRY_POINT FUNCTION=homing_override
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{homing_travel_accel}
	
	{% if bed_mesh_enabled %}
	BED_MESH_CLEAR
	{% endif %}
	
	G90
	
	{% if Z %}
	{% if ('z' in printer.toolhead.homed_axes) %}
	{% if (printer.toolhead.position.z < homing_zhop) %}
	{% if verbose %}
	{ action_respond_info("Z too low, performing ZHOP") }
	{% endif %}
	G0 Z{homing_zhop} F{z_drop_speed}
	{% endif %}
	{% elif ('xy' in printer.toolhead.homed_axes) %}
	{% if verbose %}
	{ action_respond_info("X and Y already homed, no ZHOP needed to home Z") }
	{% endif %}
	{% else %}
	{% if verbose %}
	{ action_respond_info("X and Y not homed, forcing full G28 to home Z properly") }
	{% endif %}
	SET_KINEMATIC_POSITION X=0 Y=0 Z=0
	G0 Z{homing_zhop} F{z_drop_speed}
	{% set X, Y, Z = True, True, True %}
	{% endif %}
	{% endif %}
	
	{% if homing_first == "X" %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% elif homing_first == "Y" %}
	{% if Y %}
	{% if verbose %}
	{ action_respond_info("Homing Y") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 Y0
	G1 Y{y_position_endstop + y_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	{% if X %}
	{% if verbose %}
	{ action_respond_info("Homing X") }
	{% endif %}
	{% if sensorless_homing_enabled %}
	{% set old_current_x = printer.configfile.config['tmc2209 stepper_x'].run_current|float %}
	{% set old_current_y = printer.configfile.config['tmc2209 stepper_y'].run_current|float %}
	{% set new_current_x = sensorless_current_factor * old_current_x %}
	{% set new_current_y = sensorless_current_factor * old_current_y %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={new_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={new_current_y}
	{% endif %}
	G28 X0
	G1 X{x_position_endstop + x_homing_backoff} F{homing_travel_speed}
	{% if sensorless_homing_enabled %}
	G4 P1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current_x}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={old_current_y}
	{% endif %}
	{% endif %}
	
	{% else %}
	{ action_respond_error("Axis homing order not valid. Choose either X or Y first in the variables.cfg file!") }
	{% endif %}
	
	
	
	{% if Z %}
	{% if verbose %}
	{ action_respond_info("Homing Z") }
	{% endif %}
	
	
	
	
	
	
	{% if printer["configfile"].config["stepper_z"]["endstop_pin"]|lower == "probe:z_virtual_endstop" %}
	
	{% if probe_type_enabled == "dockable_virtual" %}
	ACTIVATE_PROBE
	{% endif %}
	{% if bed_mesh_enabled %}
	{% set mesh_ready = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].ready %}
	{% if mesh_ready %}
	{% set mesh_center = printer["gcode_macro _ADAPTIVE_MESH_VARIABLES"].mesh_center %}
	{% set x_mesh_center, y_mesh_center = mesh_center.split(',')|map('trim')|map('float') %}
	RESPOND MSG="Z homing: a mesh is computed and ready, probing mesh center: {mesh_center}"
	G0 X{x_mesh_center} Y{y_mesh_center} F{homing_travel_speed}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	{% else %}
	G0 X{x_position_center} Y{y_position_center} F{homing_travel_speed}
	{% endif %}
	
	
	{% else %}
	_GOTO_Z_PROBE
	{% endif %}
	
	
	{% if probe_type_enabled == "vorontap" %}
	ACTIVATE_PROBE
	{% endif %}
	
	G28 Z0
	
	G91
	G0 Z{homing_zhop} F{z_drop_speed}
	G90
	
	
	
	{% if probe_type_enabled == "vorontap" or probe_type_enabled == "dockable_virtual" %}
	DEACTIVATE_PROBE
	{% endif %}
	{% endif %}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_CHECK_PROBE action=query
	{% endif %}
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if probe_type_enabled == "dockable" or probe_type_enabled == "dockable_virtual" %}
	_EXIT_POINT FUNCTION=homing_override
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _GOTO_Z_PROBE]
description = Move to z probe avoiding the probe dock
gcode = 
	
	
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% if zcalib_plugin_enabled %}
	{% set z_endstop_x, z_endstop_y = printer["configfile"].config["z_calibration"]["nozzle_xy_position"].split(',')|map('trim')|map('float') %}
	{% else %}
	{% set z_endstop_x, z_endstop_y = printer["gcode_macro _USER_VARIABLES"].zendstop_position|map('float') %}
	{% endif %}
	
	{% set homing_travel_speed = printer["gcode_macro _USER_VARIABLES"].homing_travel_speed|float * 60 %}
	
	{% set probe_dock_location_x, probe_dock_location_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_location_xy|map('float') %}
	{% set probe_dock_margin_x, probe_dock_margin_y = printer["gcode_macro _USER_VARIABLES"].probe_dock_margin_xy|map('float') %}
	
	{% set current_x = printer.toolhead.position.x|float %}
	{% set current_y = printer.toolhead.position.y|float %}
	
	SAVE_GCODE_STATE NAME=goto_ZProbe
	G90
	
	
	{% set avoid_dock = false %}
	{% if probe_dock_location_x < z_endstop_x|float %}
	
	
	{% if current_x < (probe_dock_location_x + probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% else %}
	
	
	{% if current_x > (probe_dock_location_x - probe_dock_margin_x) %}
	{% set avoid_dock = true %}
	{% endif %}
	{% endif %}
	
	
	{% if avoid_dock == true  %}
	
	G0 Y{probe_dock_location_y - probe_dock_margin_y} F{homing_travel_speed}
	
	G0 X{z_endstop_x} F{homing_travel_speed}
	{% endif %}
	
	G0 X{z_endstop_x} Y{z_endstop_y} F{homing_travel_speed}
	
	RESTORE_GCODE_STATE NAME=goto_ZProbe

[gcode_macro CALIBRATE]
description = Calibrate the printer flow or pressure advance
gcode = 
	
	{% set TYPE = params.TYPE|default("")|string|lower %}
	
	
	{% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set MATERIAL = params.MATERIAL|default("ABS")|string %}
	
	{% set center_x = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set center_y = printer.toolhead.axis_maximum.y|float / 2 %}
	
	{% if TYPE=="flow" %}
	
	{% set computed_size = (center_x - 20)|string + '_' + (center_y - 20)|string + '_' + (center_x + 20)|string + '_' + (center_y + 20)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	FLOW_MULTIPLIER_CALIBRATION EXTRUSION_WIDTH=0.471
	END_PRINT FILTER_TIME=0
	
	{% elif TYPE=="pressure_advance" %}
	
	{% set computed_size = (center_x - 60)|string + '_' + (center_y - 60)|string + '_' + (center_x + 60)|string + '_' + (center_y + 60)|string %}
	
	
	START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE={computed_size}
	PRESSURE_ADVANCE_CALIBRATION
	END_PRINT FILTER_TIME=0
	
	{% else %}
	{action_respond_info("Please call this macro using TYPE= \"flow\" or \"pressure_advance\"")}
	{action_raise_error("not enough parameters to start a calibration!")}
	
	{% endif %}

[gcode_macro _FLOW_CALIB_VARIABLES]
variable_last_shell_thickness = 0.0
variable_last_evalue = 0.0
gcode = 

[gcode_macro FLOW_MULTIPLIER_CALIBRATION]
description = Print a small tower to calibrate the extrusion flow multiplier by measuring the shell
gcode = 
	
	
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	{% set do_retract = params.DO_RECTRACT|default(0)|int %}
	{% set print_size = params.PRINT_SIZE|default(40)|int %}
	{% set print_height = params.HEIGHT|default(15)|int %}
	{% set corner_radius = params.CORNER_RADIUS|default(8)|int %}
	{% set number_of_perimeters = params.PERIMETERS|default(2)|int %}
	{% set fan_speed = params.FAN_SPEED|default(20)|int %}
	
	{% set e_multiplier = params.EXTRUSION_MULTIPLIER|default(1.00)|float %}
	{% set filament_diameter = params.FILAMENT_DIAMETER|default(1.75)|float %}
	{% set extrusion_width = params.EXTRUSION_WIDTH|default(0.4)|float %}
	{% set layer_height = params.LAYER_HEIGHT|default(0.2)|float %}
	
	{% set retract_length = params.RETRACT_LENGTH|default(0.5)|float %}
	{% set initial_purge = params.PURGE_MM|default(1)|int %}
	{% set z_hop_height  = 2 * layer_height %}
	
	{% set feedrate_print = params.CONTROL_SPEED|default(100)|int * 60 %}
	{% set feedrate_travel = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft = params.RAFT_SPEED|default(60)|int * 60 %}
	{% set feedrate_z = params.Z_LIFT_SPEED|default(20)|int * 60 %}
	{% set feedrate_retract = params.RETRACT_SPEED|default(50)|int * 60 %}
	
	
	
	
	{% set e_per_mm = ((extrusion_width - layer_height) * layer_height + 3.14159 * (layer_height / 2)**2) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set spacing = extrusion_width - layer_height * (1 - 3.14159 / 4) %}
	{% set shell_thickness = extrusion_width + (number_of_perimeters|float - 1) * spacing %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set x_start = max_x / 2 - print_size / 2 %}
	{% set y_start = max_y / 2 - print_size / 2 %}
	{% set x_end = x_start + print_size %}
	{% set y_end = y_start + print_size %}
	
	{% set num_raft_lines = ([print_size, max_x]|min / spacing)|round(0, 'floor')|int %}
	{% set raft_size = num_raft_lines * spacing %}
	
	
	
	
	{action_respond_info("")}
	{action_respond_info("Starting extrusion flow calibration print")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button to stop it if needed")}
	{action_respond_info("")}
	{action_respond_info("Exrusion multiplier used: %.4f" % e_multiplier)}
	{action_respond_info("Number of perimeters to print: %d" % number_of_perimeters)}
	{action_respond_info("THEORIC SHELL THICKNESS: %.4f" % shell_thickness)}
	{action_respond_info("")}
	{action_respond_info("Measure the shell thickness using a caliper or micrometer. Then call the computation macro with the measured value:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_respond_info("")}
	
	SAVE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION
	
	
	
	
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_shell_thickness VALUE={shell_thickness}
	SET_GCODE_VARIABLE MACRO=_FLOW_CALIB_VARIABLES VARIABLE=last_evalue VALUE={e_multiplier}
	
	
	
	
	G90
	M83
	G92 E0.0
	G0 X{x_start} Y{y_start - 5} Z{layer_height} F{feedrate_travel}
	
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{raft_size} E{raft_size * e_per_mm * 1.5} F{feedrate_raft / 2}
	G1 Y-{extrusion_width} E{extrusion_width * e_per_mm} F{feedrate_raft / 2}
	G1 X-{raft_size} E{raft_size * e_per_mm} F{feedrate_raft / 2}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G90
	G0 X{x_start} Y{y_start} F{feedrate_travel}
	G1 Z{layer_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	
	
	M221 S{e_multiplier * 100}
	
	
	
	
	{% if do_raft == 1 %}
	G91
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	G1 Y{loop.cycle(1.0, -1.0) * raft_size} E{raft_size * e_per_mm} F{feedrate_raft}
	
	
	{% if not loop.last %}
	G1 X{spacing} E{spacing * e_per_mm} F{feedrate_raft}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	
	
	
	
	G90
	M106 S{fan_speed * 255 / 100}
	
	
	{% for curr_layer in range(1, (print_height / layer_height)|round|int) %}
	G0 X{x_start + corner_radius} Y{y_start} F{feedrate_travel}
	G1 Z{(curr_layer * layer_height) + (layer_height if do_raft == 1 else 0)} F{feedrate_z}
	
	
	{% for perim_num in range(number_of_perimeters) %}
	
	{% set perim_offset = perim_num * spacing %}
	{% set perim_radius = corner_radius - (perim_num * spacing) %}
	
	
	G1 X{x_start + corner_radius} Y{y_start + perim_offset} F{feedrate_travel}
	{% if do_retract == 1 %}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	
	
	G1 X{x_end - corner_radius} Y{y_start + perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - perim_offset} Y{y_start + corner_radius} J{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_end - perim_offset} Y{y_end - corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_end - corner_radius} Y{y_end - perim_offset} I-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + corner_radius} Y{y_end - perim_offset} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + perim_offset} Y{y_end - corner_radius} J-{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	G1 X{x_start + perim_offset} Y{y_start + corner_radius} E{(print_size - (2 * corner_radius)) * e_per_mm} F{feedrate_print}
	G3 X{x_start + corner_radius} Y{y_start + perim_offset} I{perim_radius} E{(3.14159 / 2) * perim_radius * e_per_mm} F{feedrate_print}
	
	{% if do_retract == 1 %}
	G1 E-{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	
	{% if do_retract == 1 %}
	G91
	G0 Z{z_hop_height} F{feedrate_z}
	G90
	{% endif %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G91
	G0 Z20 F{feedrate_travel}
	
	RESTORE_GCODE_STATE NAME=STATE_FLOW_MULTIPLIER_CALIBRATION

[gcode_macro COMPUTE_FLOW_MULTIPLIER]
description = Compute a new flow multiplier by using the measured shell thickness on the calibration print
gcode = 
	{% set evalue = params.OLD_EXTRUSION_MULTIPLIER|default(0.0)|float %}
	{% set theorical_thickness = params.THEORICAL_THICKNESS|default(0.0)|float %}
	{% set measured_thickness = params.MEASURED_THICKNESS|default(0.0)|float %}
	
	
	{% if evalue == 0.0 %}
	{% set last_evalue = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_evalue %}
	
	
	{% if last_evalue == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_evalue = last_evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	{% else %}
	{% set final_evalue = evalue %}
	{action_respond_info("Using OLD_EXTRUSION_MULTIPLIER: %.3f" % final_evalue)}
	{% endif %}
	
	
	{% if theorical_thickness == 0.0 %}
	{% set last_shell_thickness = printer["gcode_macro _FLOW_CALIB_VARIABLES"].last_shell_thickness %}
	
	
	{% if last_shell_thickness == 0.0 %}
	{action_respond_info("It seems that no calibration print was run prior to this (or a restart of Klipper occured).")}
	{action_respond_info("You can still manually use it by calling again this macro like that:")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER OLD_EXTRUSION_MULTIPLIER=xxx.xxx THEORICAL_THICKNESS=xxx.xxx MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set final_theorical_thickness = last_shell_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	{% else %}
	{% set final_theorical_thickness = theorical_thickness %}
	{action_respond_info("Using THEORICAL_THICKNESS: %.3f" % final_theorical_thickness)}
	{% endif %}
	
	
	{% if measured_thickness == 0.0 %}
	{action_respond_info("You must use a caliper or micrometer to measure the calibration print shell thickness and call this macro with the measured value !!!")}
	{action_respond_info("COMPUTE_FLOW_MULTIPLIER MEASURED_THICKNESS=xxx.xxx")}
	{action_raise_error("not enough data to perform the computation of the new flow !")}
	{% else %}
	{% set new_evalue = final_theorical_thickness * final_evalue / measured_thickness %}
	{action_respond_info("NEW COMPUTED FLOW VALUE: %.3f" % new_evalue)}
	{action_respond_info("Use this new value as extrusion multiplier in your slicer of choice")}
	{action_respond_info("")}
	{% endif %}

[gcode_macro PRESSURE_ADVANCE_CALIBRATION]
description = Calibrate the pressure advance by printing a grid pattern
gcode = 
	
	
	
	{% set pa_start     = params.START|default(0.02)|float %}
	{% set pa_increment = params.INCREMENT|default(0.005)|float %}
	
	{% set do_raft = params.DO_RAFT|default(1)|int %}
	
	{% set print_size      = params.PRINT_SIZE|default(120)|int %}
	{% set num_bands       = params.BANDS_LIMIT|default(999)|int %}
	{% set lines_per_band  = params.LINES_PER_BAND|default(6)|int %}
	{% set e_multiplier    = params.EXTRUSION_MULTIPLIER|default(1.25 if do_raft == 1 else 1.5)|float %},
	{% set retract_length  = params.RETRACT_LENGTH|default(0.6)|float %}
	{% set initial_purge   = params.PURGE_MM|default(8)|int %}
	
	{% set feedrate_control = params.CONTROL_SPEED|default(30)|int * 60 %}
	{% set feedrate_outer   = params.OUTER_SPEED|default(40)|int * 60 %}
	{% set feedrate_inner   = params.INNER_SPEED|default(120)|int * 60 %}
	{% set feedrate_travel  = params.TRAVEL_SPEED|default(200)|int * 60 %}
	{% set feedrate_raft    = params.RAFT_SPEED|default(120)|int * 60 %}
	{% set feedrate_z       = 5 * 60 %}
	{% set feedrate_retract = 50 * 60 %}
	
	{% set spacing_line  = params.LINE_SPACING|default(0.4)|float %}
	{% set spacing_band  = 2 %}
	{% set spacing_raft  = 2 %}
	
	{% set fast_line_ratio_percent = 50 %}
	
	{% set lines_per_band    = [2, lines_per_band]|max %}
	{% set e_multiplier      = [1, e_multiplier]|max %}
	{% set num_lines_control = (lines_per_band / 2)|round(0, 'floor')|int %}
	{% set num_lines_test    = (lines_per_band / 2)|round(0, 'ceil')|int %}
	{% set spacing_line      = spacing_line * (1 + e_multiplier - 1.25) %}
	
	{% set max_x = printer.toolhead.axis_maximum.x|float %}
	{% set max_y = printer.toolhead.axis_maximum.y|float %}
	{% set nozzle_diameter = printer.configfile.config['extruder'].nozzle_diameter|float %}
	{% set line_width    = nozzle_diameter * 1.25 %}
	{% set line_height   = nozzle_diameter / 2 %}
	{% set z_hop_height  = 2 * line_height %}
	{% set e_per_mm      = (line_width * line_height) / (3.1415 * (1.75/2)**2) %}
	{% set spacing_purge = line_height * 0.8 %}
	
	{% set spacing_raft   = (spacing_raft / line_width)|round * line_width %}
	{% set num_raft_lines = ([print_size, max_x]|min / spacing_raft)|round(0, 'floor')|int %}
	{% set print_width    = num_raft_lines * spacing_raft %}
	
	{% set band_height      = lines_per_band * line_width + (lines_per_band - 1) * spacing_line + spacing_band %}
	{% set bands_per_height = (([print_size, max_y]|min  - spacing_purge - 2 * line_width + spacing_band) / band_height)|round(0, 'floor')|int %}
	{% set num_bands        = [num_bands, bands_per_height]|min %}
	{% set print_height     = num_bands * band_height - spacing_band + spacing_purge +  2 * line_width %}
	
	{% set slow_line_length = ((print_width * (1 - fast_line_ratio_percent / 100) / 2) / spacing_raft)|round * spacing_raft + spacing_raft / 2 %}
	{% set fast_line_length = print_width - slow_line_length * 2 %}
	{% set thick_raft_num1 = (slow_line_length / spacing_raft)|round|int %}
	{% set thick_raft_num2  = num_raft_lines - thick_raft_num1 + 1 %}
	
	{% set x_start = max_x / 2 - print_width  / 2 %}
	{% set y_start = max_y / 2 - print_height / 2 %}
	
	{action_respond_info("")}
	{action_respond_info("Starting Pressure Advance calibration print.")}
	{action_respond_info("")}
	{action_respond_info("This operation can not be interrupted by normal means. Hit the \"emergency stop\" button once the print starts exhibiting PA values that are obviously too high.")}
	{action_respond_info("")}
	{action_respond_info("PA of first band: %.4f" % pa_start)}
	{action_respond_info("PA of last band: %.4f" % (pa_start + ((num_bands - 1) * pa_increment)))}
	{action_respond_info("PA increment per band: %.4f" % pa_increment)}
	{action_respond_info("Number of bands: %d" % num_bands)}
	{action_respond_info("")}
	{action_respond_info("Inspect the printed model. "
	"Look at the top and bottom lines in each band, on the right side of the two vertical raft bars (where the print speeds change). "
	"Find the highest band from the bottom where the lines at its top still resemble the lines at its bottom, with no visible extrusion width irregularities. "
	"Your final Pressure Advance value would then be:"
	)}
	{action_respond_info("")}
	{action_respond_info("Assuming that first band_number is 0")}
	{action_respond_info("PA = %.4f + (%.4f * band_number)" % (pa_start, pa_increment))}
	{action_respond_info("")}
	{action_respond_info("Update your [extruder] config section and set \"pressure_advance\" to the value you calculated.")}
	{action_respond_info("")}
	
	
	
	
	
	
	
	
	
	SAVE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION
	{% set pa_saved = printer.configfile.settings['extruder'].pressure_advance %}
	SET_PRESSURE_ADVANCE ADVANCE={pa_start}
	
	
	
	
	M221 S100
	
	
	
	
	M117 Priming
	G90
	G0 X{x_start} Y{y_start} Z{line_height} F{feedrate_travel}
	G91
	G1 E{initial_purge} F{5 * 60}
	G1 X{print_width}  E{print_width * e_per_mm} F{feedrate_raft / 2}
	G1 Y{line_width}   E{line_width * e_per_mm}  F{feedrate_raft / 2}
	G1 X-{print_width} E{print_width * e_per_mm} F{feedrate_raft / 2}
	
	
	
	
	{% if do_raft == 1 %}
	G0 F{feedrate_raft}
	
	{% for curr_raft_line in range(1, num_raft_lines + 2) %}
	
	{% if curr_raft_line == thick_raft_num1 or curr_raft_line == thick_raft_num2 %}
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	G1 Y{loop.cycle(-1.0, 1.0) * print_height} E{print_height * e_per_mm}
	G1 X{line_width} E{line_width * e_per_mm}
	{% endif %}
	
	G1 Y{loop.cycle(1.0, -1.0) * print_height} E{print_height * e_per_mm}
	
	
	{% if not loop.last %}
	{% set horizontal_move = spacing_raft - (2 * line_width if curr_raft_line == thick_raft_num1 - 1 or curr_raft_line == thick_raft_num2 - 1 else 0) %}
	G1 X{horizontal_move} E{horizontal_move * e_per_mm}
	{% endif %}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	{% endif %}
	
	
	
	
	M117 Printing bands
	G90
	G0 X{x_start} Y{y_start + 2 * line_width + spacing_purge} F{feedrate_travel}
	G0 Z{line_height + (line_height if do_raft == 1 else 0)} F{feedrate_z}
	G91
	G1 E{retract_length} F{feedrate_retract}
	
	
	{% for curr_band_num in range(0, num_bands ) %}
	{% set outer_loop = loop %}
	
	{% set curr_pa_value = pa_start + curr_band_num * pa_increment %}
	SET_PRESSURE_ADVANCE ADVANCE={curr_pa_value}
	M117 Band {curr_band_num} PA {curr_pa_value|round(4)}
	
	
	{% for _ in range(num_lines_control) %}
	G1 X{print_width} E{print_width * e_per_mm * e_multiplier} F{feedrate_control}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	G0 X-{print_width} Y{spacing_line + line_width} F{feedrate_travel}
	
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endfor %}
	
	
	{% for _ in range(num_lines_test) %}
	{% for data in [{'mm': slow_line_length, 'f': feedrate_outer}, {'mm': fast_line_length, 'f': feedrate_inner}, {'mm': slow_line_length, 'f': feedrate_outer}] %}
	G1 X{data.mm} E{data.mm * e_per_mm * e_multiplier} F{data.f}
	{% endfor %}
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z{z_hop_height} F{feedrate_z}
	
	{% if not (outer_loop.last and loop.last) %}
	G0 X-{print_width} Y{(spacing_line if not loop.last else spacing_band) + line_width} F{feedrate_travel}
	G0 Z-{z_hop_height} F{feedrate_z}
	G1 E{retract_length} F{feedrate_retract}
	{% endif %}
	{% endfor %}
	{% endfor %}
	
	
	
	
	G1 E-{retract_length} F{feedrate_retract}
	G0 Z20 F{feedrate_z}
	G0 X-{print_width / 2} Y{[50, max_y - (y_start + print_height)]|min} F{feedrate_travel}
	
	M117
	SET_PRESSURE_ADVANCE ADVANCE={pa_saved}
	RESTORE_GCODE_STATE NAME=STATE_PRESSURE_ADVANCE_CALIBRATION

[gcode_macro CHANGE_FILAMENT]
description = Do a PAUSE, park the toolhead over the purge bucket and unload the filament
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	SAVE_GCODE_STATE NAME=CHANGE_FILAMENT_state
	PAUSE
	UNLOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=CHANGE_FILAMENT_state

[gcode_macro UNLOAD_FILAMENT]
description = Basic unload of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to unload filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to unload filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	
	_TIP_SHAPING
	M83
	G1 E-20 F3600
	G4 P3000
	G1 E{DISTANCE|float * -1} F3000
	
	RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament unloaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament unloaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro LOAD_FILAMENT]
description = Basic load of the filament (used with M600/CHANGE_FILAMENT)
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set DISTANCE = params.DISTANCE|default(105)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated to load filament"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated to load filament"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=LOAD_FILAMENT_state
	_LOW_TEMP_CHECK T={TEMP}
	M83
	G92 E0
	G1 E{DISTANCE|float} F200
	G1 E50 F150
	
	G92 E0
	RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament loaded, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament loaded, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro _TIP_SHAPING]
description = Filament tip shaping sequence
gcode = 
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% if verbose %}
	RESPOND MSG="Runout sensor deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for filament tip shaping"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}
	
	SAVE_GCODE_STATE NAME=TIP_SHAPING_state
	_LOW_TEMP_CHECK T={TEMP}
	
	{% set old_pressure_advance = printer.extruder.pressure_advance|default(0) %}
	
	SET_PRESSURE_ADVANCE ADVANCE=0
	
	M82
	G92 E0
	G1 E2 F3600
	G1 E0 F3600
	G1 E3 F3600
	G1 E0 F3600
	G1 E4 F3600
	G1 E0 F3600
	
	
	SET_PRESSURE_ADVANCE ADVANCE={old_pressure_advance}
	RESTORE_GCODE_STATE NAME=TIP_SHAPING_state
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, runout sensor reactivated"
	{% endif %}
	{% endif %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% if verbose %}
	RESPOND MSG="Filament tip shaping done, ERCF clog detection reactivated"
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_CHAMBER]
description = Heatsoak chamber to a specific temperature with a timeout
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set MAXTIME = params.MAXTIME|default(printer["gcode_macro _USER_VARIABLES"].print_default_chamber_max_heating_time)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% for _ in range(1, MAXTIME) %}
	_WAIT_CHAMBER_TEMP TEMP={SETPOINT_TEMP}
	{% endfor %}
	{% if verbose %}
	RESPOND MSG="Chamber temperature OK !"
	{% endif %}
	{% endif %}

[gcode_macro _WAIT_CHAMBER_TEMP]
gcode = 
	{% set chamber_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_enabled %}
	
	{% if chamber_sensor_enabled %}
	{% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_temperature_sensor_name %}
	{% set SETPOINT_TEMP = params.TEMP|default(0)|float %}
	{% set CURRENT_TEMP = printer["temperature_sensor " ~ chamber_sensor_name].temperature|float %}
	
	{% if CURRENT_TEMP <= SETPOINT_TEMP %}
	RESPOND MSG="Heating up the chamber : {CURRENT_TEMP}/{SETPOINT_TEMP}"
	G4 P{60000 * 1}
	{% endif %}
	{% endif %}

[gcode_macro HEATSOAK_BED]
description = Heatsoak bed at specified temperature and wait for a specific amount of time
gcode = 
	{% set SETPOINT_TEMP = params.TEMP|default(0)|int %}
	{% set TIME = params.SOAKTIME|default(8)|int %}
	
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	{% set heaterbed_enabled = printer["gcode_macro _USER_VARIABLES"].heaterbed_enabled %}
	
	{% if heaterbed_enabled %}
	{% if verbose %}
	RESPOND MSG="Heating up bed..."
	{% endif %}
	
	M190 S{SETPOINT_TEMP}
	
	{% if TIME > 0 %}
	{% for i in range(0, TIME) %}
	RESPOND MSG="Heatsoak bed, {TIME-i}mn left..."
	G4 P{60000 * 1}
	{% endfor %}
	{% else %}
	RESPOND MSG="No heatsoak needed, continue"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Bed temperature OK"
	{% endif %}
	
	{% else %}
	{% if verbose %}
	RESPOND MSG="No bed heater defined: nothing to do, continuing..."
	{% endif %}
	{% endif %}

[gcode_macro PRIMELINE]
gcode = 
	
	{% set prime_line_length = params.LINE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_length)|float %}
	{% set prime_line_purge_distance = params.PURGE_LENGTH|default(printer["gcode_macro _USER_VARIABLES"].prime_line_purge_distance)|float %}
	{% set prime_line_flowrate = params.FLOWRATE|default(printer["gcode_macro _USER_VARIABLES"].prime_line_flowrate)|float %}
	
	
	{% set prime_line_x, prime_line_y = printer["gcode_macro _USER_VARIABLES"].prime_line_xy|map('float') %}
	{% set prime_line_direction = printer["gcode_macro _USER_VARIABLES"].prime_line_direction|string|upper %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	
	{% set max_extrude_cross_section = printer["configfile"].config["extruder"]["max_extrude_cross_section"]|float %}
	{% set filament_diameter = printer["configfile"].config["extruder"]["filament_diameter"]|float %}
	
	{% set line_height = 0.6 %}
	
	
	{% set prime_line_x = params.START_X|default(prime_line_x)|float %}
	{% set prime_line_y = params.START_Y|default(prime_line_y)|float %}
	{% set prime_line_direction = params.LINE_DIRECTION|default(printer["gcode_macro _USER_VARIABLES"].prime_line_direction)|string|upper %}
	
	
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	
	
	
	{% if (line_height * line_width) > max_extrude_cross_section %}
	{% if verbose %}
	{action_respond_info("The prime_line_purge_distance of %.4f mm is too high and will exceed the max_extrude_cross_section!" % prime_line_purge_distance)}
	{% endif %}
	{% set prime_line_purge_distance = 0.98 * (max_extrude_cross_section * prime_line_length) / (3.14159 * (filament_diameter / 2)**2) %}
	{% set purge_volume = prime_line_purge_distance * 3.14159 * (filament_diameter / 2)**2 %}
	{% set line_width = purge_volume / (line_height * prime_line_length) %}
	{% if verbose %}
	{action_respond_info("Klippain corrected the prime_line_purge_distance to %.4f mm" % prime_line_purge_distance)}
	{% endif %}
	{% endif %}
	
	
	{% if (line_height / line_width) >= 0.5 %}
	{% if verbose %}
	{action_raise_error("The prime line will be too thin and will probably not stick properly to the bed. Increase its purge distance or decrease its length! Aborting...")}
	{% endif %}
	{% endif %}
	
	
	{% set speed = (prime_line_flowrate / (line_height * line_width)) * 60 |float %}
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection deactivated for the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection=0
	{% endif %}
	{% endif %}
	{% endif %}
	
	G91
	M83
	G1 Z5 F{Sz}
	
	
	G90
	G0 X{prime_line_x} Y{prime_line_y} F{St}
	G1 Z{line_height} F{Sz|int / 2}
	
	
	G92 E0
	G1 E18 F300
	
	
	G92 E0
	{% if prime_line_direction == "X" %}
	G1 X{prime_line_x + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% elif prime_line_direction == "Y" %}
	G1 Y{prime_line_y + prime_line_length} E{prime_line_purge_distance} F{speed}
	{% else %}
	{ action_respond_error("Prime line direction is not valid. Choose either X or Y in the variables.cfg file!") }
	{% endif %}
	
	
	G92 E0
	G1 E-0.2 F2100
	G92 E0
	G1 Z3 F{Sz}
	M400
	
	{% if klippain_ercf_enabled %}
	{% if printer.ercf.enabled %}
	{% if printer.ercf.clog_detection > 0 %}
	{% if verbose %}
	RESPOND MSG="ERCF clog detection reactivated after the prime line"
	{% endif %}
	ERCF_TEST_CONFIG enable_clog_detection={printer.ercf.clog_detection}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro CLEAN_NOZZLE]
description = Wipe the nozzle on the brush
gcode = 
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set brush_clean_accel = printer["gcode_macro _USER_VARIABLES"].brush_clean_accel %}
	{% set brush_over_y_axis = printer["gcode_macro _USER_VARIABLES"].brush_over_y_axis %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set Sc = printer["gcode_macro _USER_VARIABLES"].brush_clean_speed * 60 %}
	
	{% set Bx, By, Bz = printer["gcode_macro _USER_VARIABLES"].brush_xyz|map('float') %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Nozzle cleaning..."
	{% endif %}
	
	
	{% set saved_accel = printer.toolhead.max_accel %}
	{% set saved_decel = printer.toolhead.max_accel_to_decel %}
	M204 S{brush_clean_accel}
	
	
	G90
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP=1
	
	G1 X{Bx} Y{By} Z{Bz} F{St}
	
	
	G91
	{% if brush_over_y_axis %}
	{% for wipe in range(6) %}
	G1 Y-5 F{Sc}
	G1 Y+5 F{Sc}
	{% endfor %}
	{% endif %}
	
	G1 X+20 F{Sc}
	
	{% for wipe in range(6) %}
	G1 X-40 F{Sc}
	G1 X+40 F{Sc}
	{% endfor %}
	
	G90
	
	
	SET_VELOCITY_LIMIT ACCEL={saved_accel} ACCEL_TO_DECEL={saved_decel}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="clean"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro PURGE]
description = Purge a specific amount of filament ontop of the purge bucket
gcode = 
	{% set DISTANCE = params.DISTANCE|default(printer["gcode_macro _USER_VARIABLES"].purge_distance)|int %}
	{% set OOZE_TIME = params.OOZE_TIME|default(printer["gcode_macro _USER_VARIABLES"].purge_ooze_time)|int %}
	{% set TEMP = params.TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set status_leds_enabled = printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
	{% set motion_sensor_enabled = printer["gcode_macro _USER_VARIABLES"].motion_sensor_enabled %}
	{% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
	
	{% if purge_and_brush_enabled %}
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="CLEANING"
	{% endif %}
	
	{% if verbose %}
	RESPOND MSG="Purge filament..."
	{% endif %}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=0
	{% endif %}
	
	G90
	
	_CONDITIONAL_MOVE_TO_PURGE_BUCKET Z_DROP={Z_DROP}
	
	
	_LOW_TEMP_CHECK T={TEMP}
	G92 E0
	G1 E{DISTANCE|float} F150
	
	
	G92 E0
	G1 E-1.7 F2100
	G1 E-18.3 F150
	G92 E0
	
	
	G4 P{OOZE_TIME * 1000}
	
	{% if motion_sensor_enabled %}
	SET_FILAMENT_SENSOR SENSOR="runout_sensor" ENABLE=1
	{% endif %}
	
	{% if purgeclean_servo_enabled %}
	_SERVO_RETRACT ITEM="purge"
	{% endif %}
	{% endif %}
	
	{% if status_leds_enabled %}
	STATUS_LEDS COLOR="READY"
	{% endif %}

[gcode_macro _CONDITIONAL_MOVE_TO_PURGE_BUCKET]
description = Move over the purge bucket
gcode = 
	{% set Z_DROP = params.Z_DROP|default(1)|int %}
	
	{% set St = printer["gcode_macro _USER_VARIABLES"].travel_speed * 60 %}
	{% set Sz = printer["gcode_macro _USER_VARIABLES"].z_drop_speed * 60 %}
	{% set purge_and_brush_enabled = printer["gcode_macro _USER_VARIABLES"].purge_and_brush_enabled %}
	{% set purgeclean_servo_enabled = printer["gcode_macro _USER_VARIABLES"].purgeclean_servo_enabled %}
	{% set Px, Py, Pz = printer["gcode_macro _USER_VARIABLES"].purge_bucket_xyz|map('float') %}
	
	
	{% if purge_and_brush_enabled %}
	SAVE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	G90
	
	{% if Z_DROP == 1 %}
	{% if purgeclean_servo_enabled %}
	G1 Z{Pz} F{Sz}
	_SERVO_DEPLOY ITEM="purge"
	{% endif %}
	G1 X{Px} Y{Py} Z{Pz} F{St}
	{% else %}
	
	
	
	G1 X{Px} Y{Py} F{St}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=CONDITIONAL_MOVE_TO_PURGE_BUCKET_STATE
	{% endif %}

[gcode_macro _LOW_TEMP_CHECK]
description = Check the nozzle is at temperature and heat it if needed
gcode = 
	{% set T = params.T|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
	
	{% if printer.extruder.target != 0 %}
	{% if printer.extruder.temperature < printer.extruder.target %}
	M109 S{printer.extruder.target|float}
	{% endif %}
	{% else %}
	{% if printer.extruder.target < T %}
	M109 S{T}
	{% endif %}
	{% endif %}

[gcode_macro M701]
description = Map M701 to LOAD_FILAMENT
gcode = 
	LOAD_FILAMENT

[gcode_macro M702]
description = Map M702 to UNLOAD_FILAMENT
gcode = 
	UNLOAD_FILAMENT

[gcode_macro M600]
description = Map M600 to CHANGE_FILAMENT
gcode = 
	CHANGE_FILAMENT

[gcode_macro M125]
description = Map M125 to PARK
gcode = 
	PARK

[gcode_macro M900]
description = Map M900 to SET_PRESSURE_ADVANCE
gcode = 
	{% if 'K' in params %}
	{% if 'E' in params %}
	SET_PRESSURE_ADVANCE EXTRUDER={params.E} ADVANCE={params.K}
	{% else %}
	SET_PRESSURE_ADVANCE ADVANCE={params.K}
	{% endif %}
	{% endif %}

[gcode_macro M204]
description = Map M204 to SET_VELOCITY_LIMIT for ACCEL and ACCEL_TO_DECEL
rename_existing = M204.1
gcode = 
	{% set F = params.F|default(printer["gcode_macro _USER_VARIABLES"].accel_to_decel_factor)|float %}
	
	{% if 'S' in params %}
	{% set S = params.S|float %}
	SET_VELOCITY_LIMIT ACCEL={S} ACCEL_TO_DECEL={S * F}
	{% endif %}

[gcode_macro M205]
description = Map M205 to SET_VELOCITY_LIMIT for SQUARE_CORNER_VELOCITY
gcode = 
	{% if 'X' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.X}
	{% elif 'Y' in params %}
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.Y}
	{% endif %}

[gcode_macro G00]
gcode = 
	G0 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G01]
gcode = 
	G1 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G02]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G03]
gcode = 
	G2 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro G04]
gcode = 
	G4 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}

[gcode_macro _SEARCH_VARS]
description = Search for variables in the "printer" object from Klipper
gcode = 
	{% set search = params.S|lower %}
	{% set ns = namespace() %}
	{% for item in printer  %}
	{% if ' ' in item %}
	{% set ns.path = ['printer', "['%s']" % (item), ''] %}
	{% else %}
	{% set ns.path = ['printer.', item, ''] %}
	{% endif %}
	
	{% if search in ns.path|lower %}
	{ action_respond_info(ns.path|join) }
	{% endif %}
	
	{% if printer[item].items() %}
	{% for childkey, child in printer[item].items() recursive %}
	{% set ns.path = ns.path[:loop.depth|int + 1] %}
	
	{% if ' ' in childkey %}
	{% set null = ns.path.append("['%s']" % (childkey)) %}
	{% else %}
	{% set null = ns.path.append(".%s" % (childkey)) %}
	{% endif %}
	
	{% if child is mapping  %}
	{ loop(child.items()) }
	{% else %}
	{% if search in ns.path|lower %}
	{ action_respond_info("%s : %s" % (ns.path|join, child)) }
	{% endif %}
	{% endif %}
	
	{% endfor %}
	{% endif %}
	{% endfor %}

[delayed_gcode KLIPPAIN_STARTUP]
initial_duration = 1
gcode = 
	_KLIPPAIN_STARTUP

[gcode_macro _KLIPPAIN_STARTUP]
gcode = 
	
	RUN_SHELL_COMMAND CMD=system_info
	
	
	_INIT_MCU_VER
	
	
	{% set extruder_enabled = printer["gcode_macro _USER_VARIABLES"].extruder_enabled %}
	{% if not extruder_enabled %}
	{ action_raise_error("Klippain need to have an extruder defined to work properly. Check your printer.cfg includes!") }
	{% endif %}
	
	
	_INIT_CHECKPROBECONF
	
	
	{% set e_driver = printer["gcode_macro _USER_VARIABLES"].e_driver|string %}
	{% if e_driver == "TMC2240" %}
	_INIT_TMC2240
	{% endif %}
	
	
	{% set klippain_ercf_enabled = printer["gcode_macro _USER_VARIABLES"].klippain_ercf_enabled %}
	{% if klippain_ercf_enabled %}
	_INIT_CHECK_ERCF
	{% endif %}
	
	
	_INIT_USERCUSTOM
	
	RESPOND MSG="Klippain started and ready !"

[gcode_macro _INIT_TMC2240]
gcode = 

[gcode_macro _INIT_CHECKPROBECONF]
gcode = 
	{% set probe_type_enabled = printer["gcode_macro _USER_VARIABLES"].probe_type_enabled|string %}
	{% set zcalib_plugin_enabled = printer["gcode_macro _USER_VARIABLES"].zcalib_plugin_enabled %}
	{% set bed_mesh_enabled = printer["gcode_macro _USER_VARIABLES"].bed_mesh_enabled %}
	{% set qgl_enabled = printer["gcode_macro _USER_VARIABLES"].qgl_enabled %}
	{% set ztilt_enabled = printer["gcode_macro _USER_VARIABLES"].ztilt_enabled %}
	
	{% if zcalib_plugin_enabled %}
	{% if probe_type_enabled == "vorontap" %}
	{ action_raise_error("Voron TAP Probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "inductive" %}
	{ action_raise_error("Inductive probe and Z calibration plugin cannot be used at the same time in Klippain!") }
	{% elif probe_type_enabled == "dockable_virtual" or probe_type_enabled == "inductive_virtual" %}
	{ action_raise_error("Virtual Z endstop probes are not compatible with the Z calibration plugin!") }
	{% elif probe_type_enabled == "none" %}
	{ action_raise_error("You need a probe to use the Z calibration plugin in Klippain!") }
	{% endif %}
	{% endif %}
	
	{% if bed_mesh_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a bed mesh in Klippain!") }
	{% endif %}
	
	{% if qgl_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a quad gantry leveling in Klippain!") }
	{% endif %}
	
	{% if ztilt_enabled and probe_type_enabled == "none" %}
	{ action_raise_error("You need a to define a probe to be able to perform a Z tilt adjust in Klippain!") }
	{% endif %}

[gcode_macro _INIT_MCU_VER]
gcode = 
	{% set parameters = namespace(output = 'Currently configured MCU(s): \n') %}
	{% for name1 in printer %}
	{% for name2 in printer[name1] %}
	{% set show = ['mcu_version'] %}
	{% if name2 is in show %}
	{% set param = "%s: %s" % (name1, printer[name1][name2]) %}
	{% set parameters.output = parameters.output +  param + "\n" %}
	{% endif %}
	{% endfor %}
	{% endfor %}
	{action_respond_info(parameters.output)}

[gcode_macro _INIT_CHECK_ERCF]
gcode = 
	{% if not printer.ercf.enabled %}
	{ action_raise_error("ERCF is enabled in Klippain, but Happy Hare, the supported ERCF backend software is not detected. Please install it now from https://github.com/moggieuk/ERCF-Software-V3 !") }
	{% endif %}

[gcode_macro _INIT_USERCUSTOM]
gcode = 

[gcode_shell_command plot_graph]
command = bash /home/pi/printer_data/config/scripts/plot_graphs.sh
timeout = 500.0
verbose = True

[gcode_shell_command system_info]
command = python3 /home/pi/printer_data/config/scripts/system_info.py
timeout = 5.0
verbose = True

[save_variables]
filename = ~/printer_data/config/save_variables.cfg

[tmc2209 stepper_z]
uart_pin = Z_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z1]
uart_pin = Z1_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z2]
uart_pin = Z2_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 stepper_z3]
uart_pin = Z3_TMCUART
interpolate = False
run_current = 0.8
sense_resistor = 0.110
stealthchop_threshold = 0

[tmc2209 extruder]
uart_pin = toolhead:E_TMCUART
interpolate = false
run_current = 0.45
sense_resistor = 0.110
stealthchop_threshold = 0

[mcu]
canbus_uuid = f981df077b2c

[board_pins mcu_manufacturer]
aliases = 
	MCU_MOTOR0_STEP=PF13   , MCU_MOTOR0_DIR=PF12   , MCU_MOTOR0_ENABLE=PF14   , MCU_MOTOR0_UART=PC4    ,
	MCU_MOTOR1_STEP=PG0    , MCU_MOTOR1_DIR=PG1    , MCU_MOTOR1_ENABLE=PF15   , MCU_MOTOR1_UART=PD11   ,
	MCU_MOTOR2_1_STEP=PF11 , MCU_MOTOR2_1_DIR=PG3  , MCU_MOTOR2_1_ENABLE=PG5  , MCU_MOTOR2_1_UART=PC6  ,
	MCU_MOTOR3_STEP=PG4    , MCU_MOTOR3_DIR=PC1    , MCU_MOTOR3_ENABLE=PA0    , MCU_MOTOR3_UART=PC7    ,
	MCU_MOTOR4_STEP=PF9    , MCU_MOTOR4_DIR=PF10   , MCU_MOTOR4_ENABLE=PG2    , MCU_MOTOR4_UART=PF2    ,
	MCU_MOTOR5_STEP=PC13   , MCU_MOTOR5_DIR=PF0    , MCU_MOTOR5_ENABLE=PF1    , MCU_MOTOR5_UART=PE4    ,
	MCU_MOTOR6_STEP=PE2    , MCU_MOTOR6_DIR=PE3    , MCU_MOTOR6_ENABLE=PD4    , MCU_MOTOR6_UART=PE1    ,
	MCU_MOTOR7_STEP=PE6    , MCU_MOTOR7_DIR=PA14   , MCU_MOTOR7_ENABLE=PE0    , MCU_MOTOR7_UART=PD3    ,
	
	MCU_STOP0=PG6  , MCU_STOP1=PG9  , MCU_STOP2=PG10 , MCU_STOP3=PG11 ,
	MCU_STOP4=PG12 , MCU_STOP5=PG13 , MCU_STOP6=PG14 , MCU_STOP7=PG15 ,
	MCU_PROBE=PB7  ,
	MCU_SERVOS=PB6 ,
	
	MCU_HE0=PA2 , MCU_HE1=PA3 , MCU_HE2=PB10 , MCU_HE3=PB11 ,
	
	MCU_BED0=PA1 ,
	
	MCU_TB=PF3 ,
	MCU_T0=PF4 , MCU_T1=PF5 , MCU_T2=PF6 , MCU_T3=PF7 ,
	
	MCU_FAN0=PA8 , MCU_FAN1=PE5 , MCU_FAN2=PD12 , MCU_FAN3=PD13 , MCU_FAN4=PD14 , MCU_FAN5=PD15 ,
	
	MCU_NEOPIXEL=PB0  ,
	MCU_PS_ON=PE11    ,
	MCU_POWER_DET=PC0 ,
	
	
	EXP1_1=PE8   , EXP1_2=PE7   ,
	EXP1_3=PE9   , EXP1_4=PE10  ,
	EXP1_5=PE12  , EXP1_6=PE13  ,
	EXP1_7=PE14  , EXP1_8=PE15  ,
	EXP1_9=<GND> , EXP1_10=<5V> ,
	
	
	EXP2_1=PA6   , EXP2_2=PA5   ,
	EXP2_3=PB1   , EXP2_4=PA4   ,
	EXP2_5=PB2   , EXP2_6=PA7   ,
	EXP2_7=PC15  , EXP2_8=<RST> ,
	EXP2_9=<GND> , EXP2_10=<5V> ,

[board_pins octopus_mcu]
mcu = mcu
aliases = 
	X_STEP=MCU_MOTOR0_STEP   , X_DIR=MCU_MOTOR0_DIR   , X_ENABLE=MCU_MOTOR0_ENABLE   , X_TMCUART=MCU_MOTOR0_UART   ,
	Y_STEP=MCU_MOTOR1_STEP   , Y_DIR=MCU_MOTOR1_DIR   , Y_ENABLE=MCU_MOTOR1_ENABLE   , Y_TMCUART=MCU_MOTOR1_UART   ,
	
	Z_STEP=MCU_MOTOR2_1_STEP , Z_DIR=MCU_MOTOR2_1_DIR , Z_ENABLE=MCU_MOTOR2_1_ENABLE , Z_TMCUART=MCU_MOTOR2_1_UART ,
	Z1_STEP=MCU_MOTOR3_STEP  , Z1_DIR=MCU_MOTOR3_DIR  , Z1_ENABLE=MCU_MOTOR3_ENABLE  , Z1_TMCUART=MCU_MOTOR3_UART  ,
	Z2_STEP=MCU_MOTOR4_STEP  , Z2_DIR=MCU_MOTOR4_DIR  , Z2_ENABLE=MCU_MOTOR4_ENABLE  , Z2_TMCUART=MCU_MOTOR4_UART  ,
	Z3_STEP=MCU_MOTOR5_STEP  , Z3_DIR=MCU_MOTOR5_DIR  , Z3_ENABLE=MCU_MOTOR5_ENABLE  , Z3_TMCUART=MCU_MOTOR5_UART  ,
	
	E_STEP=MCU_MOTOR6_STEP   , E_DIR=MCU_MOTOR6_DIR   , E_ENABLE=MCU_MOTOR6_ENABLE   , E_TMCUART=MCU_MOTOR6_UART   ,
	
	X_STOP=MCU_STOP0 , Y_STOP=MCU_STOP1 , Z_STOP=MCU_STOP2 ,
	PROBE_INPUT=MCU_STOP7  ,
	RUNOUT_SENSOR=MCU_STOP3 ,
	
	E_HEATER=MCU_HE0   , E_TEMPERATURE=MCU_T0   ,
	BED_HEATER=MCU_HE1 , BED_TEMPERATURE=MCU_TB ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	CONTROLLER_FAN=MCU_FAN2        ,
	EXHAUST_FAN=MCU_FAN3           ,
	FILTER_FAN=MCU_FAN4            ,
	HOST_CONTROLLER_FAN=MCU_FAN5   ,
	
	CHAMBER_TEMPERATURE=MCU_T1 , ELECTRICAL_CABINET_TEMPERATURE=MCU_T2 ,
	
	LIGHT_OUTPUT=MCU_HE2         ,
	LIGHT_NEOPIXEL=MCU_STOP5     ,
	STATUS_NEOPIXEL=MCU_NEOPIXEL ,

[mcu toolhead]
canbus_uuid = 1b44cf5169c3

[board_pins toolhead_manufacturer]
mcu = toolhead
aliases = 
	MCU_EMOT_EN=gpio7 , MCU_EMOT_STEP=gpio9 , MCU_EMOT_DIR=gpio10 , MCU_EMOT_UART=gpio8 ,
	
	MCU_5V_ENDSTOP=gpio28 ,
	MCU_ENDSTOP=gpio29    ,
	MCU_HV_ENDSTOP=gpio25 ,
	
	MCU_FAN0=gpio13 , MCU_FAN1=gpio14 , MCU_FAN2=gpio15 ,
	
	MCU_TEMP=gpio27 , MCU_ONBOARD_NTCK100K=gpio26 ,
	
	MCU_HEAT=gpio6 ,
	
	MCU_RGB=gpio12 ,
	MCU_PWM0=gpio16 , MCU_PWM1=gpio17 ,
	
	MCU_ADXL_CS=gpio1 , MCU_ADXL_SCK=gpio0 , MCU_ADXL_MOSI=gpio3 , MCU_ADXL_MISO=gpio2 ,

[board_pins sb2040_mcu]
mcu = toolhead
aliases = 
	E_STEP=MCU_EMOT_STEP , E_DIR=MCU_EMOT_DIR , E_ENABLE=MCU_EMOT_EN , E_TMCUART=MCU_EMOT_UART ,
	
	X_STOP=MCU_ENDSTOP ,
	PROBE_INPUT=MCU_HV_ENDSTOP ,
	TOOLHEAD_SENSOR=MCU_5V_ENDSTOP ,
	
	E_HEATER=MCU_HEAT , E_TEMPERATURE=MCU_TEMP , CHAMBER_TEMPERATURE=MCU_ONBOARD_NTCK100K ,
	
	PART_FAN=MCU_FAN0 , E_FAN=MCU_FAN1 ,
	
	STATUS_NEOPIXEL=MCU_RGB ,
	
	ADXL_CS=MCU_ADXL_CS , ADXL_SCLK=MCU_ADXL_SCK , ADXL_MOSI=MCU_ADXL_MOSI , ADXL_MISO=MCU_ADXL_MISO ,

[neopixel status_leds]
pin = toolhead:STATUS_NEOPIXEL
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting CAN connect
Created a socket
webhooks client 281473455851696: New connection
webhooks client 281473455851696: Client info {'program': 'Moonraker', 'version': 'v0.8.0-92-g504a3a7'}
mcu 'mcu': got {'oid': 21, 'next_clock': 3307248512, 'value': 31335, '#name': 'analog_in_state', '#sent_time': 32.718292348, '#receive_time': 32.756187265}
mcu 'mcu': got {'oid': 25, 'next_clock': 3313968512, 'value': 7603, '#name': 'analog_in_state', '#sent_time': 32.769147265, '#receive_time': 32.79621389}
Loaded MCU 'mcu' 107 commands (v0.11.0-110-gaca0c71a / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1=PB6,PB7 BUS_PINS_i2c1a=PB8,PB9 BUS_PINS_i2c2=PB10,PB11 BUS_PINS_i2c2a=PH4,PH5 BUS_PINS_i2c3=PA8,PC9 BUS_PINS_i2c3a=PH7,PH8 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3=PB4,PB5,PB3 BUS_PINS_spi3a=PC11,PC12,PC10 BUS_PINS_spi4=PE13,PE14,PE12 CANBUS_BRIDGE=1 CLOCK_FREQ=168000000 MCU=stm32f429xx PWM_MAX=255 RECEIVE_WINDOW=192 RESERVE_PINS_CAN=PD0,PD1 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PH0,PH1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu 'toolhead': Starting CAN connect
Created a socket
mcu 'mcu': got {'oid': 21, 'next_clock': 3357648512, 'value': 31330, '#name': 'analog_in_state', '#sent_time': 33.030719556, '#receive_time': 33.056290348}
mcu 'mcu': got {'oid': 25, 'next_clock': 3364368512, 'value': 7603, '#name': 'analog_in_state', '#sent_time': 33.030719556, '#receive_time': 33.09613914}
mcu 'toolhead': got {'oid': 9, 'next_clock': 1776111984, 'value': 6962, '#name': 'analog_in_state', '#sent_time': 33.192374181, '#receive_time': 33.234150473}
mcu 'toolhead': got {'oid': 10, 'next_clock': 1776231984, 'value': 31272, '#name': 'analog_in_state', '#sent_time': 33.24350639, '#receive_time': 33.244153264999994}
mcu 'mcu': got {'oid': 21, 'next_clock': 3408048512, 'value': 31334, '#name': 'analog_in_state', '#sent_time': 33.030719556, '#receive_time': 33.356131598}
mcu 'mcu': got {'oid': 25, 'next_clock': 3414768512, 'value': 7604, '#name': 'analog_in_state', '#sent_time': 33.030719556, '#receive_time': 33.396168515}
mcu 'toolhead': got {'oid': 9, 'next_clock': 1779711984, 'value': 6968, '#name': 'analog_in_state', '#sent_time': 33.501358431999996, '#receive_time': 33.534172098}
mcu 'toolhead': got {'oid': 10, 'next_clock': 1779831984, 'value': 31294, '#name': 'analog_in_state', '#sent_time': 33.501358431999996, '#receive_time': 33.544146973}
Loaded MCU 'toolhead' 107 commands (v0.11.0-201-g37315bf3 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'toolhead' config: ADC_MAX=4095 BUS_PINS_i2c0a=gpio0,gpio1 BUS_PINS_i2c0b=gpio4,gpio5 BUS_PINS_i2c0c=gpio8,gpio9 BUS_PINS_i2c0d=gpio12,gpio13 BUS_PINS_i2c0e=gpio16,gpio17 BUS_PINS_i2c0f=gpio20,gpio21 BUS_PINS_i2c0g=gpio24,gpio25 BUS_PINS_i2c0h=gpio28,gpio29 BUS_PINS_i2c1a=gpio2,gpio3 BUS_PINS_i2c1b=gpio6,gpio7 BUS_PINS_i2c1c=gpio10,gpio11 BUS_PINS_i2c1d=gpio14,gpio15 BUS_PINS_i2c1e=gpio18,gpio19 BUS_PINS_i2c1f=gpio22,gpio23 BUS_PINS_i2c1g=gpio26,gpio27 BUS_PINS_spi0a=gpio0,gpio3,gpio2 BUS_PINS_spi0b=gpio4,gpio7,gpio6 BUS_PINS_spi0c=gpio16,gpio19,gpio18 BUS_PINS_spi0d=gpio20,gpio23,gpio22 BUS_PINS_spi1a=gpio8,gpio11,gpio10 BUS_PINS_spi1b=gpio12,gpio15,gpio14 BUS_PINS_spi1c=gpio24,gpio27,gpio26 CANBUS_FREQUENCY=1000000 CLOCK_FREQ=12000000 INITIAL_PINS=gpio24 MCU=rp2040 PWM_MAX=255 RECEIVE_WINDOW=192 RESERVE_PINS_CAN=gpio4,gpio5 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu_temperature 'mcu' nominal base=-238.014440 slope=1182.671480
mcu_temperature 'toolhead' nominal base=437.226612 slope=-1917.489831
Configured MCU 'mcu' (1024 moves)
Configured MCU 'toolhead' (1024 moves)
Starting heater checks for heater_bed
mcu 'toolhead': got {'oid': 3, 'clock': 1777229218, 'query_ticks': 530, 'next_sequence': 0, 'buffered': 0, 'fifo': 0, 'limit_count': 0, '#name': 'adxl345_status', '#sent_time': 33.619964765000006, '#receive_time': 33.622344848}
bed_mesh: generated points
Index |  Tool Adjusted  |   Probe
  0   | (25.0, 25.0)    | (25.0, 25.0)
  1   | (62.5, 25.0)    | (62.5, 25.0)
  2   | (100.0, 25.0)   | (100.0, 25.0)
  3   | (137.5, 25.0)   | (137.5, 25.0)
  4   | (175.0, 25.0)   | (175.0, 25.0)
  5   | (212.5, 25.0)   | (212.5, 25.0)
  6   | (250.0, 25.0)   | (250.0, 25.0)
  7   | (287.5, 25.0)   | (287.5, 25.0)
  8   | (325.0, 25.0)   | (325.0, 25.0)
  9   | (325.0, 62.5)   | (325.0, 62.5)
  10  | (287.5, 62.5)   | (287.5, 62.5)
  11  | (250.0, 62.5)   | (250.0, 62.5)
  12  | (212.5, 62.5)   | (212.5, 62.5)
  13  | (175.0, 62.5)   | (175.0, 62.5)
  14  | (137.5, 62.5)   | (137.5, 62.5)
  15  | (100.0, 62.5)   | (100.0, 62.5)
  16  | (62.5, 62.5)    | (62.5, 62.5)
  17  | (25.0, 62.5)    | (25.0, 62.5)
  18  | (25.0, 100.0)   | (25.0, 100.0)
  19  | (62.5, 100.0)   | (62.5, 100.0)
  20  | (100.0, 100.0)  | (100.0, 100.0)
  21  | (137.5, 100.0)  | (137.5, 100.0)
  22  | (175.0, 100.0)  | (175.0, 100.0)
  23  | (212.5, 100.0)  | (212.5, 100.0)
  24  | (250.0, 100.0)  | (250.0, 100.0)
  25  | (287.5, 100.0)  | (287.5, 100.0)
  26  | (325.0, 100.0)  | (325.0, 100.0)
  27  | (325.0, 137.5)  | (325.0, 137.5)
  28  | (287.5, 137.5)  | (287.5, 137.5)
  29  | (250.0, 137.5)  | (250.0, 137.5)
  30  | (212.5, 137.5)  | (212.5, 137.5)
  31  | (175.0, 137.5)  | (175.0, 137.5)
  32  | (137.5, 137.5)  | (137.5, 137.5)
  33  | (100.0, 137.5)  | (100.0, 137.5)
  34  | (62.5, 137.5)   | (62.5, 137.5)
  35  | (25.0, 137.5)   | (25.0, 137.5)
  36  | (25.0, 175.0)   | (25.0, 175.0)
  37  | (62.5, 175.0)   | (62.5, 175.0)
  38  | (100.0, 175.0)  | (100.0, 175.0)
  39  | (137.5, 175.0)  | (137.5, 175.0)
  40  | (175.0, 175.0)  | (175.0, 175.0)
  41  | (212.5, 175.0)  | (212.5, 175.0)
  42  | (250.0, 175.0)  | (250.0, 175.0)
  43  | (287.5, 175.0)  | (287.5, 175.0)
  44  | (325.0, 175.0)  | (325.0, 175.0)
  45  | (325.0, 212.5)  | (325.0, 212.5)
  46  | (287.5, 212.5)  | (287.5, 212.5)
  47  | (250.0, 212.5)  | (250.0, 212.5)
  48  | (212.5, 212.5)  | (212.5, 212.5)
  49  | (175.0, 212.5)  | (175.0, 212.5)
  50  | (137.5, 212.5)  | (137.5, 212.5)
  51  | (100.0, 212.5)  | (100.0, 212.5)
  52  | (62.5, 212.5)   | (62.5, 212.5)
  53  | (25.0, 212.5)   | (25.0, 212.5)
  54  | (25.0, 250.0)   | (25.0, 250.0)
  55  | (62.5, 250.0)   | (62.5, 250.0)
  56  | (100.0, 250.0)  | (100.0, 250.0)
  57  | (137.5, 250.0)  | (137.5, 250.0)
  58  | (175.0, 250.0)  | (175.0, 250.0)
  59  | (212.5, 250.0)  | (212.5, 250.0)
  60  | (250.0, 250.0)  | (250.0, 250.0)
  61  | (287.5, 250.0)  | (287.5, 250.0)
  62  | (325.0, 250.0)  | (325.0, 250.0)
  63  | (325.0, 287.5)  | (325.0, 287.5)
  64  | (287.5, 287.5)  | (287.5, 287.5)
  65  | (250.0, 287.5)  | (250.0, 287.5)
  66  | (212.5, 287.5)  | (212.5, 287.5)
  67  | (175.0, 287.5)  | (175.0, 287.5)
  68  | (137.5, 287.5)  | (137.5, 287.5)
  69  | (100.0, 287.5)  | (100.0, 287.5)
  70  | (62.5, 287.5)   | (62.5, 287.5)
  71  | (25.0, 287.5)   | (25.0, 287.5)
  72  | (25.0, 325.0)   | (25.0, 325.0)
  73  | (62.5, 325.0)   | (62.5, 325.0)
  74  | (100.0, 325.0)  | (100.0, 325.0)
  75  | (137.5, 325.0)  | (137.5, 325.0)
  76  | (175.0, 325.0)  | (175.0, 325.0)
  77  | (212.5, 325.0)  | (212.5, 325.0)
  78  | (250.0, 325.0)  | (250.0, 325.0)
  79  | (287.5, 325.0)  | (287.5, 325.0)
  80  | (325.0, 325.0)  | (325.0, 325.0)
bed_mesh: relative_reference_index 40 is (175.00, 175.00)
Config error
Traceback (most recent call last):
  File "/home/orangepi/klipper/klippy/klippy.py", line 180, in _connect
    cb()
  File "/home/orangepi/klipper/klippy/extras/z_tilt.py", line 22, in handle_connect
    raise self.printer.config_error(
configparser.Error: quad_gantry_level z_positions needs exactly 5 items
